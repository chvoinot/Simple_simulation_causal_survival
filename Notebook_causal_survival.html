<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.1">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Charlotte Voinot">
<meta name="author" content="Clément Berenfeld">
<meta name="author" content="Imke Mayer">
<meta name="author" content="Bernard Sebastien">
<meta name="author" content="Julie Josse">
<meta name="dcterms.date" content="2024-11-29">
<meta name="keywords" content="Restricted Mean Survival Time, Randomized Control Trial, Observational Study, Censoring">

<title>Causal survival analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-40a97741d360803f1a66e8f017dcaab6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-4efe1d14f391f6a00966bf3b78923550.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #FFFFFF;
      }

      .quarto-title-block .quarto-title-banner {
        color: #FFFFFF;
background: #034E79;
      }
</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title"><a href="https://computo.sfds.asso.fr">
        <img src="https://computo.sfds.asso.fr/assets/img/logo_notext_white.png" height="60px">
      </a> &nbsp; Causal survival analysis</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> source</button></div></div>
            <p class="subtitle lead">Estimation of the Average Treatment Effect (ATE): Practical Recommendations</p>
            <p><a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://i.creativecommons.org/l/by/4.0/80x15.png" alt="Creative Commons BY License"></a>
ISSN 2824-7795</p>
                </div>
  </div>
    
    <div class="quarto-title-meta-author">
      <div class="quarto-title-meta-heading">Authors</div>
      <div class="quarto-title-meta-heading">Affiliations</div>
          
          <div class="quarto-title-meta-contents">
        <a href="https://chvoinot.github.io/">Charlotte Voinot</a> 
      </div>
          
          <div class="quarto-title-meta-contents">
              <p class="affiliation">
                  <a href="https://www.sanofi.fr/fr/">
                  Sanofi R&amp;D
                  </a>
                </p>
              <p class="affiliation">
                  <a href="https://www.inria.fr/fr/premedical">
                  INRIA
                  </a>
                </p>
              <p class="affiliation">
                  <a href="https://www.inserm.fr/">
                  INSERM
                  </a>
                </p>
              <p class="affiliation">
                  <a href="https://www.umontpellier.fr/">
                  Université de Montpellier
                  </a>
                </p>
            </div>
            <div class="quarto-title-meta-contents">
        <a href="https://cberenfeld.github.io">Clément Berenfeld</a> 
      </div>
          
          <div class="quarto-title-meta-contents">
              <p class="affiliation">
                  <a href="https://www.uni-potsdam.de/en/university-of-potsdam">
                  Universität Potsdam, Potsdam, Germany
                  </a>
                </p>
            </div>
            <div class="quarto-title-meta-contents">
        Imke Mayer 
      </div>
          
          <div class="quarto-title-meta-contents">
              <p class="affiliation">
                  <a href="https://www.charite.de/">
                  Charité – Universität Berlin, Berlin, Germany
                  </a>
                </p>
            </div>
            <div class="quarto-title-meta-contents">
        Bernard Sebastien 
      </div>
          
          <div class="quarto-title-meta-contents">
              <p class="affiliation">
                  <a href="https://www.sanofi.fr/fr/">
                  Sanofi R&amp;D
                  </a>
                </p>
            </div>
            <div class="quarto-title-meta-contents">
        <a href="https://juliejosse.com/">Julie Josse</a> 
      </div>
          
          <div class="quarto-title-meta-contents">
              <p class="affiliation">
                  <a href="https://www.inria.fr/fr/premedical">
                  INRIA
                  </a>
                </p>
              <p class="affiliation">
                  <a href="https://www.inserm.fr/">
                  INSERM
                  </a>
                </p>
              <p class="affiliation">
                  <a href="https://www.umontpellier.fr/">
                  Université de Montpellier
                  </a>
                </p>
            </div>
        </div>
                    
  <div class="quarto-title-meta">
                                
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 29, 2024</p>
      </div>
    </div>
                                    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">November 29, 2024</p>
      </div>
    </div>
      
                  
      <div>
      <div class="quarto-title-meta-heading">Keywords</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Restricted Mean Survival Time, Randomized Control Trial, Observational Study, Censoring</p>
      </div>
    </div>
    
    <div>
      <div class="quarto-title-meta-heading">Status</div>
      <div class="quarto-title-meta-contents">
              <a href="https://github.com/chvoinot/Simple_simulation_causal_survival"><img src="https://github.com/chvoinot/Simple_simulation_causal_survival/actions/workflows/build.yml/badge.svg" alt="build status"></a>
                  </div>
    </div>

  </div>
                                                
  <div>
    <div class="abstract">
    <div class="abstract-title">Abstract</div>
      Causal survival analysis combines survival analysis and causal inference to evaluate the effect of a treatment or intervention on a time-to-event outcome, such as survival time. It offers an alternative to relying solely on Cox models for assessing these effects. In this paper, we present a comprehensive review of estimators for the average treatment effect measured with the restricted mean survival time, including regression-based methods, weighting approaches, and hybrid techniques. We investigate their theoretical properties and compare their performance through extensive numerical experiments. Our analysis focuses on the finite-sample behavior of these estimators, the influence of nuisance parameter selection, and their robustness and stability under model misspecification. By bridging theoretical insights with practical evaluation, we aim to equip practitioners with both state-of-the-art implementations of these methods and practical guidelines for selecting appropriate estimators for treatment effect estimation. Among the approaches considered, G-formula two-learners, AIPCW-AIPTW, Buckley-James estimators, and causal survival forests emerge as particularly promising.
    </div>
  </div>

  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#sec-intro" id="toc-sec-intro" class="nav-link active" data-scroll-target="#sec-intro"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#sec-context" id="toc-sec-context" class="nav-link" data-scroll-target="#sec-context"><span class="header-section-number">1.1</span> Context and motivations</a></li>
  <li><a href="#sec-notations" id="toc-sec-notations" class="nav-link" data-scroll-target="#sec-notations"><span class="header-section-number">1.2</span> Definition of the estimand: the RMST</a></li>
  <li><a href="#organisation-of-the-paper" id="toc-organisation-of-the-paper" class="nav-link" data-scroll-target="#organisation-of-the-paper"><span class="header-section-number">1.3</span> Organisation of the paper</a></li>
  <li><a href="#notations" id="toc-notations" class="nav-link" data-scroll-target="#notations"><span class="header-section-number">1.4</span> Notations</a></li>
  </ul></li>
  <li><a href="#sec-theoryRCT" id="toc-sec-theoryRCT" class="nav-link" data-scroll-target="#sec-theoryRCT"><span class="header-section-number">2</span> Causal survival analysis in Randomized Controlled Trials</a>
  <ul class="collapse">
  <li><a href="#sec-theoryRCT_indc" id="toc-sec-theoryRCT_indc" class="nav-link" data-scroll-target="#sec-theoryRCT_indc"><span class="header-section-number">2.1</span> Independent censoring: the Kaplan-Meier estimator</a></li>
  <li><a href="#sec-condcens" id="toc-sec-condcens" class="nav-link" data-scroll-target="#sec-condcens"><span class="header-section-number">2.2</span> Conditionally independent censoring</a>
  <ul class="collapse">
  <li><a href="#sec-Gformula" id="toc-sec-Gformula" class="nav-link" data-scroll-target="#sec-Gformula"><span class="header-section-number">2.2.1</span> The G-formula and the Cox Model</a></li>
  <li><a href="#sec-unbiasedtransfo" id="toc-sec-unbiasedtransfo" class="nav-link" data-scroll-target="#sec-unbiasedtransfo"><span class="header-section-number">2.2.2</span> Censoring unbiased transformations</a></li>
  <li><a href="#sec-tdr" id="toc-sec-tdr" class="nav-link" data-scroll-target="#sec-tdr"><span class="header-section-number">2.2.3</span> Augmented corrections</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-theoryOBS" id="toc-sec-theoryOBS" class="nav-link" data-scroll-target="#sec-theoryOBS"><span class="header-section-number">3</span> Causal survival analysis in observational studies</a>
  <ul class="collapse">
  <li><a href="#sec-obs_indcen" id="toc-sec-obs_indcen" class="nav-link" data-scroll-target="#sec-obs_indcen"><span class="header-section-number">3.1</span> Independent censoring</a></li>
  <li><a href="#sec-obscondcens" id="toc-sec-obscondcens" class="nav-link" data-scroll-target="#sec-obscondcens"><span class="header-section-number">3.2</span> Conditional independent censoring</a>
  <ul class="collapse">
  <li><a href="#iptw-ipcw-transformations" id="toc-iptw-ipcw-transformations" class="nav-link" data-scroll-target="#iptw-ipcw-transformations"><span class="header-section-number">3.2.1</span> IPTW-IPCW transformations</a></li>
  <li><a href="#iptw-bj-transformations" id="toc-iptw-bj-transformations" class="nav-link" data-scroll-target="#iptw-bj-transformations"><span class="header-section-number">3.2.2</span> IPTW-BJ transformations</a></li>
  <li><a href="#sec-AIPTW_AIPCW" id="toc-sec-AIPTW_AIPCW" class="nav-link" data-scroll-target="#sec-AIPTW_AIPCW"><span class="header-section-number">3.2.3</span> Double augmented corrections</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">4</span> Implementation</a>
  <ul class="collapse">
  <li><a href="#sec-summary" id="toc-sec-summary" class="nav-link" data-scroll-target="#sec-summary"><span class="header-section-number">4.1</span> Summary of the estimators</a></li>
  <li><a href="#implementation-of-the-estimators" id="toc-implementation-of-the-estimators" class="nav-link" data-scroll-target="#implementation-of-the-estimators"><span class="header-section-number">4.2</span> Implementation of the estimators</a></li>
  <li><a href="#sec-package" id="toc-sec-package" class="nav-link" data-scroll-target="#sec-package"><span class="header-section-number">4.3</span> Available packages</a></li>
  </ul></li>
  <li><a href="#sec-simulation" id="toc-sec-simulation" class="nav-link" data-scroll-target="#sec-simulation"><span class="header-section-number">5</span> Simulations</a>
  <ul class="collapse">
  <li><a href="#sec-simulation-RCT" id="toc-sec-simulation-RCT" class="nav-link" data-scroll-target="#sec-simulation-RCT"><span class="header-section-number">5.1</span> RCT</a></li>
  <li><a href="#sec-simulation-Obs" id="toc-sec-simulation-Obs" class="nav-link" data-scroll-target="#sec-simulation-Obs"><span class="header-section-number">5.2</span> Observational data</a></li>
  <li><a href="#mispecification-of-nuisance-components" id="toc-mispecification-of-nuisance-components" class="nav-link" data-scroll-target="#mispecification-of-nuisance-components"><span class="header-section-number">5.3</span> Mispecification of nuisance components</a></li>
  </ul></li>
  <li><a href="#sec-conclusion" id="toc-sec-conclusion" class="nav-link" data-scroll-target="#sec-conclusion"><span class="header-section-number">6</span> Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  
  
  
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Notebook_causal_survival.pdf"><i class="bi bi-file-pdf"></i>PDF (computo)</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="sec-intro" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<section id="sec-context" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="sec-context"><span class="header-section-number">1.1</span> Context and motivations</h2>
<p>Causal survival analysis is a growing field that integrates causal inference <span class="citation" data-cites="rubin_estimating_1974 hernan2010causal">(<a href="#ref-rubin_estimating_1974" role="doc-biblioref">D. B. Rubin 1974</a>; <a href="#ref-hernan2010causal" role="doc-biblioref">Hernán and Robins 2010</a>)</span> with survival analysis <span class="citation" data-cites="kalbfleisch2002statistical">(<a href="#ref-kalbfleisch2002statistical" role="doc-biblioref">Kalbfleisch and Prentice 2002</a>)</span> to evaluate the impact of treatments on time-to-event outcomes, while accounting for censoring situations where only partial information about an event’s occurrence is available.</p>
<p>Being a relatively new domain, the existing literature, though vast, remains fragmented. As a result, a clear understanding of the theoretical properties of various estimators is challenging to obtain. Moreover, the implementation of proposed methods is limited, leaving researchers confronted with a range of available estimators and the need to make numerous methodological decisions. There is a pressing need for a comprehensive survey that organizes the available methods, outlines the underlying assumptions, and provides an evaluation of estimator performance — particularly in finite sample settings. Such a survey also has the potential to help identify remaining methodological challenges that need to be addressed. This need becomes increasingly urgent as causal survival analysis gains traction in both theoretical and applied domains. For instance, its applications to external control arm analyses are particularly relevant in the context of single-arm clinical trials, where traditional comparator arms are unavailable. Regulatory guidelines have begun to acknowledge and support such semi-experimental approaches, reflecting the broader evolution of trial design and therapeutic innovation in precision medicine, see for instance <span class="citation" data-cites="EMA_RWD">(<a href="#ref-EMA_RWD" role="doc-biblioref">European Medecines Agency 2024</a>)</span>.</p>
<p>By synthesizing the theoretical foundations, assumptions, and performance of various estimators, a survey on existing causal survival analysis methods would provide researchers and practitioners with the necessary tools to make informed methodological choices. This is crucial for fostering robust and reliable applications of causal survival analysis in both academic research and practical settings, where precise and valid results are paramount.</p>
<p>In this paper, we focus our attention to the estimation of the Restricted Mean Survival Time (RMST), a popular causal measure in survival analysis which offers an intuitive interpretation of the average survival time over a specified period. In particular, we decided to not cover the estimation of Hazard Ratio (HR), which has been prominently used but often questioned due to its potential non-causal nature <span class="citation" data-cites="HR_Martinussen">(<a href="#ref-HR_Martinussen" role="doc-biblioref">Martinussen, Vansteelandt, and Andersen 2020</a>)</span>. Additionally, unlike the Hazard Ratio, the RMST has the desirable property of being a collapsible measure, meaning that the population effect can be expressed as a weighted average of subgroup effects, with positive weights that sum to one <span class="citation" data-cites="huitfeldt2019collapsibility">(<a href="#ref-huitfeldt2019collapsibility" role="doc-biblioref">Huitfeldt, Stensrud, and Suzuki 2019</a>)</span>.</p>
</section>
<section id="sec-notations" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="sec-notations"><span class="header-section-number">1.2</span> Definition of the estimand: the RMST</h2>
<p>We set the analysis in the potential outcome framework, where a patient, described by a vector of covariates <span class="math inline">X \in \mathbb{R}^p</span>, either receives a treatment (<span class="math inline">A=1</span>) or is in the control group (<span class="math inline">A=0</span>). The patient will then survive up to a certain time <span class="math inline">T(0) \in \mathbb{R}^+</span> in the control group, or up to a time <span class="math inline">T(1)\in \mathbb{R}^+</span> in the treatment group. In practice, we cannot simultaneously have access to <span class="math inline">T(0)</span> and <span class="math inline">T(1)</span>, as one patient is either treated or control, but only to <span class="math inline">T</span> defined as follows:</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Stable Unit Treatment Value Assumption: SUTVA) <span id="eq-sutva"><span class="math display">
T = AT(1) + (1-A)T(0).
\tag{1}</span></span></p>
</div>
<p>Due to potential censoring, the outcome <span class="math inline">T</span> is not completely observed. The most common form of censoring is right-censoring (also known as type II censoring), which occurs when the event of interest has not taken place by the end of the observation period, indicating that it may have occurred later if the observation had continued <span class="citation" data-cites="censoring_effect">(<a href="#ref-censoring_effect" role="doc-biblioref">Turkson, Ayiah-Mensah, and Nimoh 2021</a>)</span>. We focus in this study on this type of censoring only and we assume that we observe <span class="math inline">\tilde T= T \wedge C = \min(T,C)</span> for some censoring time <span class="math inline">C \in \mathbb{R}^+</span>. When an observation is censored, the observed time is equal to the censoring time.</p>
<p>We also assume that we know whether an outcome is censored or not. In other words, we observe the censoring status variable <span class="math inline">\Delta = \mathbb{I}\{T \leqslant C\}</span>, where <span class="math inline">\mathbb{I}\{\cdot\}</span> is the indicator function. <span class="math inline">\Delta</span> is <span class="math inline">1</span> if the true outcome is observed, and <span class="math inline">0</span> if it is censored.</p>
<p>We assume observing a <span class="math inline">n</span>-sample of variables <span class="math inline">(X,A,\widetilde T,\Delta)</span> stemming from an <span class="math inline">n</span>-sample of the partially unobservable variables <span class="math inline">(X,A,T(0),T(1),C)</span>. A toy exemple of such data is given in <a href="#tbl-exemple_data" class="quarto-xref">Table&nbsp;1</a>.</p>
<div id="tbl-exemple_data" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-exemple_data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Example of a survival dataset. In practice, only <span class="math inline">X,A,\widetilde T</span> and <span class="math inline">\Delta</span> are observed.
</figcaption>
<div aria-describedby="tbl-exemple_data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th>ID</th>
<th>Covariates</th>
<th></th>
<th></th>
<th>Treatment</th>
<th>Censoring</th>
<th>Status</th>
<th>Potential outcomes</th>
<th></th>
<th>True outcome</th>
<th>Observed outcome</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>i</td>
<td><span class="math inline">X_{1}</span></td>
<td><span class="math inline">X_{2}</span></td>
<td><span class="math inline">X_{3}</span></td>
<td><span class="math inline">A</span></td>
<td><span class="math inline">C</span></td>
<td><span class="math inline">\Delta</span></td>
<td><span class="math inline">T(0)</span></td>
<td><span class="math inline">T(1)</span></td>
<td><span class="math inline">T</span></td>
<td><span class="math inline">\tilde{T}</span></td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
<td>1.5</td>
<td>4</td>
<td>1</td>
<td>?</td>
<td>1</td>
<td>?</td>
<td>200</td>
<td>200</td>
<td>200</td>
</tr>
<tr class="odd">
<td>2</td>
<td>5</td>
<td>1</td>
<td>2</td>
<td>0</td>
<td>?</td>
<td>1</td>
<td>100</td>
<td>?</td>
<td>100</td>
<td>100</td>
</tr>
<tr class="even">
<td>3</td>
<td>9</td>
<td>0.5</td>
<td>3</td>
<td>1</td>
<td>200</td>
<td>0</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>200</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>Our aim is to estimate the Average Treatment Effect (ATE) defined as the difference between the Restricted Mean Survival Time of the treated and controls <span class="citation" data-cites="royston2013restricted">(<a href="#ref-royston2013restricted" role="doc-biblioref">Royston and Parmar 2013</a>)</span>.</p>
<div id="def-ATE" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> (Causal effect: Difference between Restricted Mean Survival Time)</p>
<p><span class="math display">
\theta_{\mathrm{RMST}} = \mathbb{E}\left[T(1) \wedge \tau - T(0) \wedge \tau\right],
</span> where <span class="math inline">a \wedge b := \min(a,b)</span> for <span class="math inline">a,b \in \mathbb{R}</span>.</p>
</div>
<p>We define the survival functions <span class="math inline">S^{(a)}(t):=\mathbb{P}(T(a) &gt; t)</span> for <span class="math inline">a \in \{0,1\}</span>, i.e., the probability that a treated or non-treated individual will survive beyond a given time <span class="math inline">t</span>. Likewise, we let <span class="math inline">S(t) := \mathbb{P}(T &gt;t)</span>, and <span class="math inline">S_C(t) := \mathbb{P}(C &gt; t)</span>. We also let <span class="math inline">G(t) := \mathbb{P}(C \geqslant t)</span> be the left-limit of the survival function <span class="math inline">S_C</span>. Because <span class="math inline">T(a) \wedge \tau</span> are non-negative random variables, one can easily express the restricted mean survival time using the survival functions:</p>
<p><span id="eq-rmstsurv"><span class="math display">
\mathbb{E}(T(a) \wedge \tau) = \int_{0}^{\infty} \mathbb{P}(T(a)\wedge \tau &gt; t)dt = \int_{0}^{\tau}S^{(a)}(t)dt.
\tag{2}</span></span></p>
<p>Consequently, <span class="math inline">\theta_{\mathrm{RMST}}</span> can be interpreted as the mean difference between the survival function of treated and control until a fixed time horizon <span class="math inline">\tau</span>. A difference in RMST <span class="math inline">\theta_{\mathrm{RMST}} = 10</span> days with <span class="math inline">\tau=200</span> means that, on average, the treatment increases the survival time by 10 days at 200 days. We give a visual interpretation of RMST in <a href="#fig-RMST" class="quarto-xref">Figure&nbsp;1</a>.</p>
<div id="fig-RMST" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-RMST-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<embed src="KM_RMST.pdf" class="img-fluid">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-RMST-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Plot of the estimated survival curves on synthetic toy-data. The <span class="math inline">\theta_{\mathrm{RMST}}</span> at <span class="math inline">\tau=50</span> corresponds to the yellow shaded area between the two survival curves. The curves have been estimated using Kaplan-Meier estimator, see <a href="#sec-theoryRCT_indc" class="quarto-xref">Section&nbsp;2.1</a>.
</figcaption>
</figure>
</div>
<p>Although the present work focuses on the estimation of the difference in RMST, we would like to stress that the causal effect can be assessed through other measures, such as for instance the difference of the survival functions <span class="math display">
\theta_{\mathrm{SP}} := S^{(1)}(\tau) - S^{(0)}(\tau)
</span> for some time <span class="math inline">\tau</span>, see for instance <span class="citation" data-cites="Ozenne20_AIPTW_AIPCW">(<a href="#ref-Ozenne20_AIPTW_AIPCW" role="doc-biblioref">Ozenne et al. 2020</a>)</span>. As mentionned in <a href="#sec-context" class="quarto-xref">Section&nbsp;1.1</a>, another widely used measure (though not necessarily causal) is the hazards ratio, defined as <span class="math display">
\theta_{\mathrm{HR}} := \frac{\lambda^{(1)}(\tau)}{\lambda^{(0)}(\tau)},
</span> where the hazard function <span class="math inline">\lambda^{(a)}</span> is defined as <span class="math display">
\lambda^{(a)}(t) := \lim_{h \to 0^+}\frac{\mathbb{P}(T(a) \in [t,t+j)|T(a) \geqslant t)}{h}.
</span> in a continuous setting, or as <span class="math inline">\lambda^{(a)}(t) := \mathbb{P}(T(a) = t|T(a) \geqslant t)</span> when the survival times are discrete. The hazard functions and the survival functions are linked through the identities <span id="eq-lambdacont"><span class="math display">
S^{(a)}(t) = \exp\left(-\Lambda^{(a)}(t)\right) \quad \text{where} \quad \Lambda^{(a)}(t) := \int_0^t \lambda^{(a)}(s)\mathop{}\!\mathrm{d}s,
\tag{3}</span></span> in the continuous case. The functions <span class="math inline">\Lambda^{(a)}</span> are call the cumulative hazard functions. In the discrete case, we have in turn <span id="eq-lambdadisc"><span class="math display">
S^{(a)}(t) = \prod_{t_k \leqslant t} \left(1-\lambda^{(a)}(t_k)\right),
\tag{4}</span></span> where <span class="math inline">\{t_1,\dots,t_K\}</span> are the atoms of <span class="math inline">T^{(a)}</span>. These hazard functions are classically used to model the survival times and the censoring times, see <a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a>.</p>
</section>
<section id="organisation-of-the-paper" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="organisation-of-the-paper"><span class="header-section-number">1.3</span> Organisation of the paper</h2>
<p>In this paper, we detail the minimal theoretical framework that allows the analysis of established RMST estimators in the context of both Randomized Controlled Trials (<a href="#sec-theoryRCT" class="quarto-xref">Section&nbsp;2</a>) and observational data (<a href="#sec-theoryOBS" class="quarto-xref">Section&nbsp;3</a>). We give their statistical properties (consistency, asymptotic normality) along with proofs when possible. We then conduct in <a href="#sec-simulation" class="quarto-xref">Section&nbsp;5</a> a numerical study of these estimators through simulations under various experimental conditions, including independent and conditionally independent censoring and correct and incorrect model specifications. We conclude in <a href="#sec-conclusion" class="quarto-xref">Section&nbsp;6</a> with practical recommendations on estimator selection, based on criteria such as asymptotic behavior, computational complexity, and efficiency.</p>
</section>
<section id="notations" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="notations"><span class="header-section-number">1.4</span> Notations</h2>
<p>We provide in <a href="#tbl-reminder_notations" class="quarto-xref">Table&nbsp;2</a> a summary of the notation used throughout the paper.</p>
<div id="tbl-reminder_notations" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-reminder_notations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Summary of the notations.
</figcaption>
<div aria-describedby="tbl-reminder_notations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 79%">
</colgroup>
<thead>
<tr class="header">
<th>Symbol</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">X</span></td>
<td>Covariates</td>
</tr>
<tr class="even">
<td><span class="math inline">A</span></td>
<td>Treatment indicator <span class="math inline">(A=1</span> for treatment, <span class="math inline">A=0</span> for control<span class="math inline">)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">T</span></td>
<td>Survival time</td>
</tr>
<tr class="even">
<td><span class="math inline">T(a), a \in \{0,1\}</span></td>
<td>Potential survival time respectively with and without treatment</td>
</tr>
<tr class="odd">
<td><span class="math inline">S^{(a)},a \in \{0,1\}</span></td>
<td>Survival function <span class="math inline">S^{(a)}(t) =\mathbb{P}(T(a) &gt; t)</span> of the potential survival times</td>
</tr>
<tr class="even">
<td><span class="math inline">\lambda^{(a)},a \in \{0,1\}</span></td>
<td>Hazard function <span class="math inline">\lambda^{(a)}(t) =\lim_{h \to 0^+}\mathbb{P}(T(a) \in [t,t+h) |T(a)\geqslant t)/h</span> of the potential survival times</td>
</tr>
<tr class="odd">
<td><span class="math inline">\Lambda^{(a)},a \in \{0,1\}</span></td>
<td>Cumulative hazard function of the potential survival times</td>
</tr>
<tr class="even">
<td><span class="math inline">C</span></td>
<td>Censoring time</td>
</tr>
<tr class="odd">
<td><span class="math inline">S_C</span></td>
<td>Survival function <span class="math inline">S_C(t) =\mathbb{P}(C &gt; t)</span> of the censoring time</td>
</tr>
<tr class="even">
<td><span class="math inline">G</span></td>
<td>Left-limit of the survival function <span class="math inline">G(t) =\mathbb{P}(C \geqslant t)</span> of the censoring time</td>
</tr>
<tr class="odd">
<td><span class="math inline">\widetilde{T}</span></td>
<td>Observed time (<span class="math inline">T \wedge C</span>)</td>
</tr>
<tr class="even">
<td><span class="math inline">\Delta</span></td>
<td>Censoring status <span class="math inline">\mathbb{I}\{T \leqslant C \}</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\Delta^{\tau}</span></td>
<td>Censoring status of the restricted time <span class="math inline">\Delta^{\tau} = \max\{\Delta, \mathbb{I}\{\widetilde{T} \geqslant\tau\}\}</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\{t_{1},t_{2},\dots,t_{K}\}</span></td>
<td>Discrete times</td>
</tr>
<tr class="odd">
<td><span class="math inline">e(x)</span></td>
<td>Propensity score <span class="math inline">\mathbb{E} [A| X = x]</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\mu(x,a), a \in \{0,1\}</span></td>
<td><span class="math inline">\mathbb{E}[T \wedge \tau \mid X=x,A=a ]</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">S(t|x,a), a \in \{0,1\}</span></td>
<td>Conditional survival function, <span class="math inline">\mathbb{P}(T &gt; t | X=x, A =a)</span>.</td>
</tr>
<tr class="even">
<td><span class="math inline">\lambda^{(a)}(t|x), a \in \{0,1\}</span></td>
<td>Conditional hazard functions of the potential survival times</td>
</tr>
<tr class="odd">
<td><span class="math inline">G(t|x,a), a \in \{0,1\}</span></td>
<td>left-limit of the conditional survival function of the censoring <span class="math inline">\mathbb{P}(C\geqslant t|X=x,A=a)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">Q_{S}(t|x,a), a \in \{0,1\}</span></td>
<td><span class="math inline">\mathbb{E}[T \wedge \tau \mid X=x,A=a, T \wedge \tau&gt;t]</span></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-theoryRCT" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Causal survival analysis in Randomized Controlled Trials</h1>
<p>Randomized Controlled Trials (RCTs) are the gold standard for establishing the effect of a treatment on an outcome, because treatment allocation is controlled through randomization, which ensures (asymptotically) the balance of covariates between treated and controls, and thus avoids problems of confounding between treatment groups. The core assumption in a classical RCT is the random assignment of the treatment <span class="citation" data-cites="rubin_estimating_1974">(<a href="#ref-rubin_estimating_1974" role="doc-biblioref">D. B. Rubin 1974</a>)</span>.</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Random treatment assignment) There holds: <span id="eq-rta"><span class="math display">
A \perp\mkern-9.5mu\perp T(0),T(1),X
\tag{5}</span></span></p>
</div>
<p>We also assume that there is a positive probability of receiving the treatment, which we rephrase under the following assumption.</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Trial positivity) <span id="eq-postrial"><span class="math display">
0 &lt; \mathbb{P}(A=1) &lt; 1
\tag{6}</span></span></p>
</div>
<p>Under Assumptions <a href="#eq-rta" class="quarto-xref">5</a> and <a href="#eq-postrial" class="quarto-xref">6</a>, classical causal identifiability equations can be written to express <span class="math inline">\theta_{\mathrm{RMST}}</span> without potential outcomes.</p>
<p><span id="eq-RMSTkm"><span class="math display">
\begin{aligned}
    \theta_{\mathrm{RMST}} &amp;=  \mathbb{E}[T(1) \wedge \tau - T(0) \wedge \tau]\\
    &amp;= \mathbb{E}[T(1) \wedge \tau | A = 1] - \mathbb{E}[ T(0) \wedge \tau| A= 0]  &amp;&amp; \tiny\text{(Random treatment assignment)} \\
       &amp;= \mathbb{E}[T \wedge \tau | A = 1] - \mathbb{E}[ T \wedge \tau| A= 0].  &amp;&amp; \tiny\text{(SUTVA)}
\end{aligned}
\tag{7}</span></span></p>
<p>However, <a href="#eq-RMSTkm" class="quarto-xref">Equation&nbsp;7</a> still depends on <span class="math inline">T</span>, which remains only partially observed due to censoring. To ensure that censoring does not compromise the identifiability of treatment effects, we must impose certain assumptions on the censoring process, standards in survival analysis, namely, independent censoring and conditionally independent censoring. These assumptions lead to different estimation approaches. We focus on two strategies: those that aim to directly estimate <span class="math inline">\mathbb{E}[T \wedge \tau | A = a]</span> directly (e.g., through censoring-unbiased transformations, see <a href="#sec-condcens" class="quarto-xref">Section&nbsp;2.2</a>), and those that first estimate the survival curves to derive RMST via <a href="#eq-rmstsurv" class="quarto-xref">Equation&nbsp;2</a> (such as the Kaplan-Meier estimator and all its variants, see the next Section).</p>
<section id="sec-theoryRCT_indc" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-theoryRCT_indc"><span class="header-section-number">2.1</span> Independent censoring: the Kaplan-Meier estimator</h2>
<p>In a first approach, one might assume that the censoring times are independent from the rest of the variables.</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Independent censoring) <span id="eq-independantcensoring"><span class="math display">
C \perp\mkern-9.5mu\perp T(0),T(1),X,A.
\tag{8}</span></span></p>
</div>
<p>Under <a href="#eq-independantcensoring" class="quarto-xref">Equation&nbsp;8</a>, subjects censored at time <span class="math inline">t</span> are representative of all subjects who remain at risk at time <span class="math inline">t</span>. <a href="#fig-RCT_ind_causalgraph" class="quarto-xref">Figure&nbsp;2</a> represents the causal graph when the study is randomized and outcomes are observed under independent censoring.</p>
<div id="fig-RCT_ind_causalgraph" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-RCT_ind_causalgraph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<embed src="causal_survival_rct_indep.pdf" class="img-fluid quarto-figure quarto-figure-center" style="width:40.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-RCT_ind_causalgraph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Causal graph in RCT survival data with independent censoring.
</figcaption>
</figure>
</div>
<p>We also assume that there is no almost-sure upper bound on the censoring time before <span class="math inline">\tau</span>, which we rephrase under the following assumption.</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Positivity of the censoring process) There exists <span class="math inline">\varepsilon&gt; 0</span> such that <span id="eq-poscen"><span class="math display">
G(t) \geqslant\varepsilon\quad \text{for all} \quad t \in [0,\tau).
\tag{9}</span></span></p>
</div>
<p>If indeed it was the case that <span class="math inline">\mathbb{P}(C &lt; t) = 1</span> for some <span class="math inline">t &lt; \tau</span>, then we would not be able to infer anything on the survival function on the interval <span class="math inline">[t,\tau]</span> as all observation times <span class="math inline">\widetilde T_i</span> would be in <span class="math inline">[0,t]</span> almost surely. In practice, adjusting the threshold time <span class="math inline">\tau</span> can help satisfy the positivity assumption. For instance, in a clinical study, if a subgroup of patients has zero probability of remaining uncensored at a given time, <span class="math inline">\tau</span> can be modified to ensure that participants have a feasible chance of remaining uncensored up to the revised threshold.</p>
<p>The two Assumptions <a href="#eq-independantcensoring" class="quarto-xref">8</a> and <a href="#eq-poscen" class="quarto-xref">9</a> together allow the distributions of <span class="math inline">T(a)</span> to be identifiable, in the sense that there exists an identity that expresses <span class="math inline">S^{(a)}</span> as a function of the joint distribution of <span class="math inline">(\widetilde T,\Delta,A=a)</span>, see for instance <span class="citation" data-cites="ebrahimi2003identifiability">Ebrahimi, Molefe, and Ying (<a href="#ref-ebrahimi2003identifiability" role="doc-biblioref">2003</a>)</span> for such a formula in a non-causal framework. This enables several estimation strategies, the most well-known being the Kaplan-Meier product-limit estimator.</p>
<p>To motivate the definition of the latter and explicit the identifiability identity, we set the analysis in the discrete case. We let <span class="math inline">\{t_k\}_{k \geqslant 1}</span> be a set of positive and increasing times and assume that <span class="math inline">T \in \{t_k\}_{k \geqslant 1}</span> almost surely. Then for any <span class="math inline">t \in [0,\tau]</span>, it holds, letting <span class="math inline">t_0 = 0</span> by convention, thanks to <a href="#eq-lambdadisc" class="quarto-xref">Equation&nbsp;4</a>,</p>
<p><span class="math display">\begin{align*}
S(t| A=a) &amp;= \mathbb{P}(T &gt; t|A=a) = \prod_{t_k \leqslant t} \left(1 - \mathbb{P}(T = t_k | T &gt; t_{k-1}, A=a)\right) \\
&amp;= \prod_{t_k \leqslant t} \left(1 - \frac{\mathbb{P}(T = t_{k}, A=a)}{\mathbb{P}(T \geqslant t_{k},A=a)}\right).
\end{align*}</span></p>
<p>Using Assumptions <a href="#eq-independantcensoring" class="quarto-xref">8</a> and <a href="#eq-poscen" class="quarto-xref">9</a>, we find that <span id="eq-kmindep"><span class="math display">
\frac{\mathbb{P}(T = t_{k}, A=a)}{\mathbb{P}(T \geqslant t_{k},A=a)} = \frac{\mathbb{P}(T = t_{k},C \geqslant t_k,A=a)}{\mathbb{P}(T \geqslant t_{k}, C\geqslant t_k,A=a)} =  \frac{\mathbb{P}(\widetilde T = t_{k}, \Delta = 1,A=a)}{\mathbb{P}( \widetilde T \geqslant t_{k},A=a)},
\tag{10}</span></span> yielding the final identity <span id="eq-kmi"><span class="math display">
S(t|A=a) = \prod_{t_k \leqslant t} \left(1-\frac{\mathbb{P}(\widetilde T = t_{k}, \Delta = 1,A=a)}{\mathbb{P}( \widetilde T \geqslant t_{k},A=a)}\right).
\tag{11}</span></span> Notice that the right hand side only depends on the distribution of the observed tuple <span class="math inline">(A,\widetilde T,\Delta)</span>. This last equation suggests in turn to introduce the quantities <span id="eq-dknk"><span class="math display">
D_k(a) := \sum_{i=1}^n \mathbb{I}(\widetilde T_i = t_k, \Delta_i = 1, A=a) \quad\text{and}\quad N_k(a) := \sum_{i=1}^n \mathbb{I}(\widetilde T_i \geqslant t_k, A=a),
\tag{12}</span></span> which correspond respectively to the number of deaths <span class="math inline">D_k(a)</span> and of individuals at risk <span class="math inline">N_k(a)</span> at time <span class="math inline">t_k</span> in the treated group (a=1) or in the control group (a=0).</p>
<div id="def-km" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 2</strong></span> (Kaplan-Meier estimator, <span class="citation" data-cites="kaplan">Kaplan and Meier (<a href="#ref-kaplan" role="doc-biblioref">1958</a>)</span>) With <span class="math inline">D_k(a)</span> and <span class="math inline">N_k(a)</span> defined in <a href="#eq-dknk" class="quarto-xref">Equation&nbsp;12</a>, we let</p>
<p><span id="eq-unadjKM"><span class="math display">
    \widehat{S}_{\mathrm{KM}}(t|A=a) := \prod_{t_k \leqslant t}\left(1-\frac{D_k(a)}{N_k(a)}\right).
\tag{13}</span></span></p>
</div>
<p>The assiociated RMST estimator is then simply defined as <span id="eq-thetaunadjKM"><span class="math display">
\widehat{\theta}_{\mathrm{KM}} = \int_{0}^{\tau}\widehat{S}_{KM}(t|A=1)-\widehat{S}_{KM}(t|A=0)dt.
\tag{14}</span></span> The Kaplan-Meier estimator is the Maximum Likelihood Estimator (MLE) of the survival functions, see for instance <span class="citation" data-cites="kaplan">Kaplan and Meier (<a href="#ref-kaplan" role="doc-biblioref">1958</a>)</span>. Furthermore, because <span class="math inline">D_k(a)</span> and <span class="math inline">N_k(a)</span> are sums of i.i.d. random variables, the Kaplan-Meier estimator inherits some convenient statistical properties.</p>
<div id="prp-km" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 1</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-postrial" class="quarto-xref">6</a>, <a href="#eq-independantcensoring" class="quarto-xref">8</a> and <a href="#eq-poscen" class="quarto-xref">9</a>, and for all <span class="math inline">t \in [0,\tau]</span>, the estimator <span class="math inline">\widehat S_{\mathrm{KM}}(t|A=a)</span> of <span class="math inline">S^{(a)}(t)</span> is strongly consistent and admits the following bounds for its bias: <span class="math display">
0 \leqslant S^{(a)}(t) - \mathbb{E}[\widehat S_\mathrm{KM}(t|A=a)] \leqslant O(\mathbb{P}(N_k(a) = 0)),
</span> where <span class="math inline">k</span> is the greatest time <span class="math inline">t_k</span> such that <span class="math inline">t \geqslant t_k</span>.</p>
</div>
<p><span class="citation" data-cites="gill1983large">Gill (<a href="#ref-gill1983large" role="doc-biblioref">1983</a>)</span> gives a more precise lower-bound on the bias in the case of continuous distributions, which was subsequently refined by <span class="citation" data-cites="zhou1988two">Zhou (<a href="#ref-zhou1988two" role="doc-biblioref">1988</a>)</span>. The bound we give, although slightly looser, still exhibits the same asymptotic regime. In particular, as soon as <span class="math inline">S^{(a)}(t) &gt; 0</span> (and Assumption <a href="#eq-poscen" class="quarto-xref">9</a> holds), then the bias decays exponentially fast towards <span class="math inline">0</span>. We give in <a href="#sec-proof21" class="quarto-xref">Section&nbsp;7.1</a> a simple proof of our bound is our context.</p>
<div id="prp-varkm" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 2</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-postrial" class="quarto-xref">6</a>, <a href="#eq-independantcensoring" class="quarto-xref">8</a> and <a href="#eq-poscen" class="quarto-xref">9</a>, and for all <span class="math inline">t \in [0,\tau]</span>, <span class="math inline">\widehat S_{\mathrm{KM}}(t|A=a)</span> is asymptotically normal and <span class="math inline">\sqrt{n}\left(\widehat S_{\mathrm{KM}}(t|A=a) - S^{(a)}(t)\right)</span> converges in distribution towards a centered Gaussian of variance <span class="math display">
V_{\mathrm{KM}}(t|A=a) := S^{(a)}(t)^2 \sum_{t_k \leqslant t} \frac{1-s_k(a)}{s_k(a) r_k(a)},
</span> where <span class="math inline">s_k(a) = S^{(a)}(t_k)/S^{(a)}(t_{k-1})</span> and <span class="math inline">r_k(a) = \mathbb{P}(\widetilde T \geqslant t_k, A=a)</span>.</p>
</div>
<p>The proof of <a href="#prp-varkm" class="quarto-xref">Proposition&nbsp;2</a> can be found in <a href="#sec-proof21" class="quarto-xref">Section&nbsp;7.1</a>. Because <span class="math inline">D_k(a)/N_k(a)</span> is a natural estimator of <span class="math inline">1-s_k(a)</span> and, <span class="math inline">\frac{1}{n} N_k(a)</span> a natural estimator for <span class="math inline">r_k(a)</span>, the asymptotic variance of the Kaplan-Meier estimator can be estimated with the so-called Greenwood formula, as already derived heuristically in <span class="citation" data-cites="kaplan">Kaplan and Meier (<a href="#ref-kaplan" role="doc-biblioref">1958</a>)</span>:</p>
<p><span id="eq-varkm"><span class="math display">
\widehat{\mathrm{Var}} \left(\widehat{S}_{\mathrm{KM}}(t|A=a)\right) := \widehat{S}_{\mathrm{KM}}(t|A=a)^2 \sum_{t_k \leqslant t} \frac{D_k(a)}{N_k(a)(N_k(a)-D_k(a))}.
\tag{15}</span></span></p>
<p>We finally mention that the KM estimator as defined in <a href="#def-km" class="quarto-xref">Definition&nbsp;2</a> still makes sense in a non-discrete setting, and one only needs to replace the fixed grid <span class="math inline">\{t_k\}</span> by the values at which we observed an event <span class="math inline">(\widetilde T_i = t_k, \Delta_i =1)</span>. We refer to <span class="citation" data-cites="Kaplan_consistency_breslow74">Breslow and Crowley (<a href="#ref-Kaplan_consistency_breslow74" role="doc-biblioref">1974</a>)</span> for a study of this estimator in the continuous case and to <span class="citation" data-cites="Aalen2008">Aalen, Borgan, and Gjessing (<a href="#ref-Aalen2008" role="doc-biblioref">2008</a>)</span>, Sec 3.2 for a general study of the KM estimator through the prism of point processes.</p>
</section>
<section id="sec-condcens" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sec-condcens"><span class="header-section-number">2.2</span> Conditionally independent censoring</h2>
<p>An alternative hypothesis in survival analysis that relaxes the assumption of independent censoring is conditionally independent censoring, also refered sometimes as <em>informative censoring</em>. It allows to model more realistic censoring processes, in particular in situations where there are reasons to believe that <span class="math inline">C</span> may be dependent from <span class="math inline">A</span> and <span class="math inline">X</span> (for instance, if patient is more like to leave the study when treated because of side-effects of the treatment).</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Conditionally independent censoring) <span id="eq-condindepcensoring"><span class="math display">
C \perp\mkern-9.5mu\perp T(0),T(1) ~ | ~X,A
\tag{16}</span></span></p>
</div>
<p>Under <a href="#eq-condindepcensoring" class="quarto-xref">Equation&nbsp;16</a>, subjects within a same stratum defined by <span class="math inline">X=x</span> and <span class="math inline">A=a</span> have equal probability of censoring at time <span class="math inline">t</span>, for all <span class="math inline">t</span>. In case of conditionally independent censoring, we also need to assume that all subjects have a positive probability to remain uncensored at their time-to-event.</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Positivity / Overlap for censoring) There exists <span class="math inline">\varepsilon&gt; 0</span> such that for all <span class="math inline">t\in [0,\tau)</span>, it almost surely holds <span id="eq-positivitycensoring"><span class="math display">
G(t|A,X) \geqslant\varepsilon.
\tag{17}</span></span></p>
</div>
<p><a href="#fig-RCT_dep_causalgraph" class="quarto-xref">Figure&nbsp;3</a> represents the causal graph when the study is randomized with conditionally independent censoring.</p>
<div id="fig-RCT_dep_causalgraph" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-RCT_dep_causalgraph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<embed src="causal_survival_rct_dep.pdf" class="img-fluid quarto-figure quarto-figure-center" style="width:40.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-RCT_dep_causalgraph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Causal graph in RCT survival data with dependent censoring.
</figcaption>
</figure>
</div>
<p>Under dependent censoring, the Kaplan-Meier estimator as defined in <a href="#def-km" class="quarto-xref">Definition&nbsp;2</a> can fail to estimate survival, in particular because <a href="#eq-kmindep" class="quarto-xref">Equation&nbsp;10</a> does not hold anymore. Alternatives include plug-in G-formula estimators (<a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a>) and unbiased transformations (<a href="#sec-unbiasedtransfo" class="quarto-xref">Section&nbsp;2.2.2</a>).</p>
<section id="sec-Gformula" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="sec-Gformula"><span class="header-section-number">2.2.1</span> The G-formula and the Cox Model</h3>
<p>Because the censoring is now independent from the potential outcome conditionally to the covariates, it would seem natural to model the response of the survival time conditionally to these covariates too: <span class="math display">
\mu(x,a) := \mathbb{E}[T \wedge \tau |X = x, A = a].
</span></p>
<p>Building on <a href="#eq-RMSTkm" class="quarto-xref">Equation&nbsp;7</a>, one can express the RMST as a function of <span class="math inline">\mu</span>: <span class="math display">\begin{align*}
\theta_{\mathrm{RMST}} = \mathbb{E}\left[\mathbb{E}[T \wedge \tau |X, A = 1]\right] - \mathbb{E}\left[ T \wedge \tau|X, A= 0]\right] = \mathbb{E}[\mu(X,1)-\mu(X,0)].
\end{align*}</span></p>
<p>An estimator <span class="math inline">\widehat\mu</span> of <span class="math inline">\mu</span> would then straightforwardly yield an estimator of the difference in RMST through the so-called <em>G-formula</em> plug-in estimator:</p>
<p><span id="eq-gformula"><span class="math display"> \widehat{\theta}_{\mathrm{G-formula}} = \frac{1}{n} \sum_{i=1}^n \widehat\mu\left(X_i, 1\right)-\widehat\mu\left(X_i, 0\right).  \tag{18}</span></span></p>
<p>We would like to stress that a G-formula approach works also in a observational context as the one introduced in <a href="#sec-obscondcens" class="quarto-xref">Section&nbsp;3.2</a>. However, because the estimation strategies presented in the next sections relies on estimating nuisance parameters, and that this latter task is often done in the same way as we estimate the conditional response <span class="math inline">\mu</span>, we decided to not delay the introduction of the G-formula any further, and we present below a few estimation methods for <span class="math inline">\mu</span>. These methods are sub-divised in two categories: <em><span class="math inline">T</span>-learners</em>, where <span class="math inline">\mu(\cdot,1)</span> is estimated separately from <span class="math inline">\mu(\cdot,0)</span>, and _<span class="math inline">S</span>-learners, where <span class="math inline">\widehat\mu</span> is obtained by fitting a single model based on covariates <span class="math inline">(X,A)</span>.</p>
<p><strong>Cox’s Model</strong>. There are many ways to model <span class="math inline">\mu</span> in a survival context, the most notorious of which being the Cox proportional hazards model <span class="citation" data-cites="Cox_1972">(<a href="#ref-Cox_1972" role="doc-biblioref">Cox 1972</a>)</span>. It relies on a semi-parametric modelling the conditional hazard functions <span class="math inline">\lambda^{(a)}(t|X)</span> as <span class="math display">
\lambda^{(a)}(t|X) = \lambda_0^{(a)}(t) \exp(X^\top\beta^{(a)}),
</span> where <span class="math inline">\lambda^{(a)}_0</span> is a baseline hazard function and <span class="math inline">\beta^{(a)}</span> has the same dimension as the vector of covariate <span class="math inline">X</span>. The conditional survival function then take the simple form (in the continuous case) <span class="math display">
S^{(a)}(t|X) = S^{(a)}_0(t)^{\exp(X^\top\beta^{(a)})},
</span> where <span class="math inline">S^{(a)}_0(t)</span> is the survival function associated with <span class="math inline">\lambda_0^{(a)}</span>. The vector <span class="math inline">\beta^{(a)}</span> is classically estimated by maximizing the so-called <em>partial likelihood</em> function as introduced in the original paper of <span class="citation" data-cites="Cox_1972">Cox (<a href="#ref-Cox_1972" role="doc-biblioref">1972</a>)</span>: <span class="math display">
\mathcal{L}(\beta) := \prod_{\Delta_i = 1} \frac{\exp(X_i^\top \beta)}{\displaystyle\sum_{\widetilde T_j \geqslant\widetilde T_i} \exp(X_j^\top \beta)},
</span></p>
<p>while the cumulative baseline hazard function can be estimated through the Breslow’s estimator <span class="citation" data-cites="Breslow_approx1974">(<a href="#ref-Breslow_approx1974" role="doc-biblioref">Breslow 1974</a>)</span>: <span class="math display">
\widehat\Lambda_0^{(a)}(t) = \sum_{\Delta_i = 1, \widetilde T_i \leqslant t} \frac{1}{\displaystyle\sum_{\widetilde T_j \geqslant\widetilde T_i} \exp(X_j^\top \widehat\beta^{(a)})}
</span> where <span class="math inline">\widehat\beta^{(a)}</span> is a partial likelihood maximizer. One can show that <span class="math inline">(\widehat\beta^{(a)},\widehat\Lambda_0^{(a)})</span> is the MLE of the true likelihood, when <span class="math inline">\widehat\Lambda_0^{(a)}</span> is optimized over all step fonctions of the form <span class="math display">
\Lambda_0(t) := \sum_{\Delta_i=1} h_i, \quad h_i \in \mathbb{R}^+.
</span> This fact was already hinted in the original paper by Cox and made rigorous in many subsequent papers, see for instance <span class="citation" data-cites="fan2010high">Fan, Feng, and Wu (<a href="#ref-fan2010high" role="doc-biblioref">2010</a>)</span>. Furthermore, if the true distribution follows a Cox model, then both <span class="math inline">\widehat\beta^{(a)}</span> and <span class="math inline">\widehat\Lambda_0^{(a)}</span> are strongly consistent and asymptotically normal estimator of the true parameters <span class="math inline">\beta^{(a)}</span> and <span class="math inline">\Lambda^{(a)}</span>, see <span class="citation" data-cites="kalbfleisch2002statistical">Kalbfleisch and Prentice (<a href="#ref-kalbfleisch2002statistical" role="doc-biblioref">2002</a>)</span>, Sec 5.7. When using a <span class="math inline">T</span>-learner approach, one simply finds <span class="math inline">(\widehat\beta^{(a)},\widehat\Lambda_0^{(a)})</span> for <span class="math inline">a \in \{0,1\}</span> by considering the control group and the treated group separately. When using a <span class="math inline">S</span>-learner approach, the treatment status <span class="math inline">A</span> becomes a covariate a the model becomes <span id="eq-coxslearner"><span class="math display">
\lambda(t|X,A) = \lambda_0(t) \exp(X^\top\beta+\alpha A).
\tag{19}</span></span> for some <span class="math inline">\alpha \in \mathbb{R}</span>. One main advantage of Cox’s model is that it makes it very easy to interpret the effect of a covariate on the survival time. If indeed <span class="math inline">\alpha &gt; 0</span>, then the treatment has a negative effect of the survival times. Likewise, if <span class="math inline">\beta_i &gt;0</span>, then the <span class="math inline">i</span>-th coordinate of <span class="math inline">X</span> has a negative effect as well. We finally mention that the hazard ratio takes a particularly simple form under the later model since <span class="math display">
\theta_{\mathrm{HR}} = e^{\alpha}.
</span> In particular, it does not depends on the time horizon <span class="math inline">\tau</span>, and is thus sometimes refered to as <em>proportional hazard</em>. <a href="#fig-gf" class="quarto-xref">Figure&nbsp;4</a> illustrates the estimation of the difference in Restricted Mean Survival Time using G-formula with Cox models.</p>
<div id="fig-gf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<embed src="G_formula_RCT.pdf" class="img-fluid" style="width:110.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Illustration of the G-formula for estimating <span class="math inline">\theta_{\mathrm{RMST}}</span> in an RCT when only one covariate <span class="math inline">X_1</span> influences the outcome.
</figcaption>
</figure>
</div>
<p><strong>Weibull Model</strong>. A popular parametric model for survival is the Weibull Model, which amounts to assume that <span class="math display">
\lambda^{(a)}(t|X) = \lambda_0^{(a)}(t) \exp(X^\top\beta)
</span> where <span class="math inline">\lambda_0^{(a)}(t)</span> is the instant hazard function of a Weibull distribution, that is to say a function proportional to <span class="math inline">t^{\gamma}</span> for some shape parameter <span class="math inline">\gamma &gt;0</span>. We refer to <span class="citation" data-cites="zhang2016parametric">Zhang (<a href="#ref-zhang2016parametric" role="doc-biblioref">2016</a>)</span> for a study of this model.</p>
<p><strong>Survival Forests</strong>. On the non-parametric front, we mention the existence of survival forests <span class="citation" data-cites="ishwaran2008random">(<a href="#ref-ishwaran2008random" role="doc-biblioref">Ishwaran et al. 2008</a>)</span>.</p>
</section>
<section id="sec-unbiasedtransfo" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="sec-unbiasedtransfo"><span class="header-section-number">2.2.2</span> Censoring unbiased transformations</h3>
<p>Censoring unbiased transformations involve applying a transformation to <span class="math inline">T</span>. Specifically, we compute a new time <span class="math inline">T^*</span> of the form <span id="eq-defcut"><span class="math display">
T^* := T^*(\widetilde T,X,A,\Delta) = \begin{cases}
\phi_0(\widetilde T \wedge \tau,X,A) \quad &amp;\text{if} \quad \Delta^\tau = 0, \\
\phi_1(\widetilde T \wedge \tau,X,A) \quad &amp;\text{if} \quad \Delta^\tau = 1.
\end{cases}
\tag{20}</span></span> for two wisely chosen transformations <span class="math inline">\phi_0</span> and <span class="math inline">\phi_1</span>, and where <span id="eq-defdeltatau"><span class="math display">\Delta^{\tau}:=\mathbb{I}\{T \wedge \tau \leqslant C\} = \Delta+(1-\Delta)\mathbb{I}(\widetilde T \geqslant\tau)
\tag{21}</span></span> is the indicator of the event where the individual is either uncensored or censored after time <span class="math inline">\tau</span>. The idea behind the introduction of <span class="math inline">\Delta^\tau</span> is that because we are only interested in computed the expectation of the survival time thresholded by <span class="math inline">\tau</span>, any censored observation coming after time <span class="math inline">\tau</span> can in fact be considered as uncensored (<span class="math inline">\Delta^\tau = 1</span>).</p>
<p>A censoring unbiased transformation <span class="math inline">T^*</span> shall satisfy: for <span class="math inline">a \in \{0,1\}</span>, it holds <span id="eq-cut"><span class="math display">
\mathbb{E}[T^*|A=a,X] = \mathbb{E}[T(a) \wedge \tau |X] \quad\text{almost surely.}
\tag{22}</span></span> A notable advantage of this approach is that it enables the use of the full transformed dataset <span class="math inline">(X_i,A_i,T^*_i)</span> as if no censoring occured. Because it holds <span id="eq-cutcond"><span class="math display">
\mathbb{E}[\mathbb{E}[T^*|A=a,X]] = \mathbb{E}\left[\frac{\mathbb{I}\{A=a\}}{\mathbb{P}(A=a)} T^*\right],
\tag{23}</span></span> there is a very natural way to derive an estimator of the difference in RMST from any censoring unbiased transformation <span class="math inline">T^*</span> as: <span id="eq-cutest"><span class="math display">
\widehat\theta = \frac1n\sum_{i=1}^n \left(\frac{A_i}{\pi}-\frac{1-A_i}{1-\pi} \right) T^*_i
\tag{24}</span></span> where <span class="math inline">\pi = \mathbb{P}(A=1) \in (0,1)</span> by Assumption <a href="#eq-postrial" class="quarto-xref">6</a> and where <span class="math inline">T^*_i = T^*(\widetilde T_i,X_i,A_i,\Delta_i)</span>. We easily get the following result.</p>
<div id="prp-cutest" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 3</strong></span> Under Assumptions <a href="#eq-rta" class="quarto-xref">5</a> and <a href="#eq-postrial" class="quarto-xref">6</a>, the estimator <span class="math inline">\widehat\theta</span> derived as in <a href="#eq-cutest" class="quarto-xref">Equation&nbsp;24</a> from a square integrable censoring unbiased transformations satisfying <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a> is an unbiased, strongly consistent, and asymptotically normal estimator of the difference in RMST.</p>
</div>
<p>Square integrability will be ensured any time the transformnation is bounded, which will always be the case of the ones considered in this work. It is natural in a RCT setting to assume that probability of being treated <span class="math inline">\pi</span> is known. If not, it is usual to replace <span class="math inline">\pi</span> by its empirical counterpart <span class="math inline">\widehat\pi = n_1/n</span> where <span class="math inline">n_a = \sum_{i} \mathbb{1}\{A=a\}</span>. The resulting estimator takes the form <span id="eq-cutestnopi"><span class="math display">
\widehat\theta = \frac1{n_1}\sum_{A_i = 1}  T^*_i - \frac1{n_0}\sum_{A_i = 0}  T^*_i.
\tag{25}</span></span> Note however that this estimator is slighlty biased due to the estimation of <span class="math inline">\pi</span> (see for instance <span class="citation" data-cites="colnet2022reweighting">Colnet et al. (<a href="#ref-colnet2022reweighting" role="doc-biblioref">2022</a>)</span>, Lemma 2), but it is still strongly consistent and asymptotically normal, and its biased is exponentially small in <span class="math inline">n</span>.</p>
<div id="prp-cutestnopi" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 4</strong></span> Under Assumptions <a href="#eq-rta" class="quarto-xref">5</a> and <a href="#eq-postrial" class="quarto-xref">6</a>, the estimator <span class="math inline">\widehat\theta</span> derived as in <a href="#eq-cutestnopi" class="quarto-xref">Equation&nbsp;25</a> from a square integrable censoring unbiased transformations satisfying <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a> is a strongly consistent, and asymptotically normal estimator of the difference in RMST.</p>
</div>
<p>The two most popular transformations are Inverse-Probability-of-Censoring Weighting (<span class="citation" data-cites="IPCtransKoul81">Koul, Susarla, and Ryzin (<a href="#ref-IPCtransKoul81" role="doc-biblioref">1981</a>)</span>) and Buckley-James (<span class="citation" data-cites="Buckley_james_79">Buckley and James (<a href="#ref-Buckley_james_79" role="doc-biblioref">1979</a>)</span>), both illustrated in <a href="#fig-trans" class="quarto-xref">Figure&nbsp;5</a> and detailed below. In the former, only non-censored observations are considered and they are weighted while in the latter, censored observations are imputed with an estimated survival time.</p>
<div id="fig-trans" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-trans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<embed src="schema_transformation.pdf" class="img-fluid">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-trans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Illustration of Inverse-Probability-of-Censoring and Buckley-James transformations.
</figcaption>
</figure>
</div>
<p><strong>The Inverse-Probability-of-Censoring Weighted transformation</strong></p>
<p>The Inverse-Probability-of-Censoring Weighted (IPCW) transformation, introduced by (<span class="citation" data-cites="IPCtransKoul81">Koul, Susarla, and Ryzin (<a href="#ref-IPCtransKoul81" role="doc-biblioref">1981</a>)</span>) in the context of censored linear regression, involves discarding censored observations and applying weights to uncensored data. More precisely, we let <span id="eq-defipcw"><span class="math display">
T^*_{\mathrm{IPCW}}=\frac{\Delta^\tau}{G(\widetilde{T}\wedge \tau|X,A)} \widetilde{T} \wedge \tau,
\tag{26}</span></span> where we recall that <span class="math inline">G(t|X,A) :=\mathbb{P}(C \geqslant t|X,A)</span> is the left limit of the conditional survival function of the censoring. This estimator assigns higher weights to uncensored subjects within a covariate group that is highly prone to censoring, thereby correcting for conditionally independent censoring and reducing selection bias <span class="citation" data-cites="Howe2016SelectionBD">(<a href="#ref-Howe2016SelectionBD" role="doc-biblioref">Howe et al. 2016</a>)</span>.</p>
<div id="prp-ipcw" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 5</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-postrial" class="quarto-xref">6</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, the IPCW transform <a href="#eq-defipcw" class="quarto-xref">26</a> is a censoring unbiased transformation in the sense of <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a>.</p>
</div>
<p>The proof of <a href="#prp-ipcw" class="quarto-xref">Proposition&nbsp;5</a> is in <a href="#sec-proof22" class="quarto-xref">Section&nbsp;7.2</a>. The IPCW depends on the unknown conditional survival function of the censoring <span class="math inline">G(\cdot|X,A)</span>, which thus needs to be estimated. Estimating conditional censoring or the conditional survival function can be approached similarly, as both involve estimating a time—whether for survival or censoring. Consequently, we can use semi-parametric methods, such as the Cox model, or non-parametric approaches like survival forests, and we refer to <a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a> for a development on these approaches. Once an estimator <span class="math inline">\widehat G(\cdot|A,X)</span> of the later is provided, one can construct an estimator of the difference in RMST based on <a href="#eq-cutest" class="quarto-xref">Equation&nbsp;24</a> or <a href="#eq-cutestnopi" class="quarto-xref">Equation&nbsp;25</a> <span id="eq-ipcwdef"><span class="math display">
\widehat\theta_{\mathrm{IPCW}} = \frac1n \sum_{i=1}^n \left(\frac{A_i}{\pi}-\frac{1-A_i}{1-\pi}\right) T^*_{\mathrm{IPCW},i},
\tag{27}</span></span> or <span id="eq-ipcwdefnopi"><span class="math display">
\widehat\theta_{\mathrm{IPCW}} = \frac1{n_1}\sum_{A_i = 1}  T^*_{\mathrm{IPCW},i} - \frac1{n_0}\sum_{A_i = 0}  T^*_{\mathrm{IPCW},i}.
\tag{28}</span></span> where we recall that <span class="math inline">n_a := \#\{i \in [n]~|~A_i=a\}</span>. By <a href="#prp-cutest" class="quarto-xref">Proposition&nbsp;3</a>, <a href="#prp-cutestnopi" class="quarto-xref">Proposition&nbsp;4</a> and <a href="#prp-ipcw" class="quarto-xref">Proposition&nbsp;5</a>, we easily deduce that <span class="math inline">\widehat\theta_{\mathrm{IPCW}}</span> is asymptotically consistent as soon as <span class="math inline">\widehat G</span> is.</p>
<div id="cor-ipcwcons" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 1</strong></span> Under Assumptions<a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-postrial" class="quarto-xref">6</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, if <span class="math inline">\widehat G</span> is uniformly weakly (resp. strongly) consistent then so is <span class="math inline">\widehat\theta_{\mathrm{IPCW}}</span>, either as in defined in <a href="#eq-ipcwdef" class="quarto-xref">Equation&nbsp;27</a> or in <a href="#eq-ipcwdefnopi" class="quarto-xref">Equation&nbsp;28</a>.</p>
</div>
<p>This result simply comes from the fact that <span class="math inline">\widehat\theta_{\mathrm{IPCW}}</span> depends continuously on <span class="math inline">\widehat G</span> and that <span class="math inline">G</span> is lower-bounded (Assumption <a href="#eq-positivitycensoring" class="quarto-xref">17</a>). Surprisingly, we found limited use of this estimator in the literature, beside its first introduction in <span class="citation" data-cites="IPCtransKoul81">Koul, Susarla, and Ryzin (<a href="#ref-IPCtransKoul81" role="doc-biblioref">1981</a>)</span>. This could potentially be explained by the fact that, empirically, we observed that this estimator is highly variable. Consequently, we do not explore its properties further and will not include it in the numerical experiments. A related and more popular estimator is the IPCW-Kaplan-Meier, defined as follows.</p>
<div id="def-ipcwkm" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 3</strong></span> (IPCW-Kaplan-Meier) We let again <span class="math inline">\widehat G(\cdot|X,A)</span> be an estimator of the (left limit of) the conditional censoring survival function and we introduce</p>
<p><span class="math display">\begin{align*}
D_k^{\mathrm{IPCW}}(a) &amp;:= \sum_{i=1}^n \frac{\Delta_i^\tau}{\widehat G(\widetilde T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\widetilde T_i = t_k, A_i=a) \\
\quad\text{and}\quad N^{\mathrm{IPCW}}_k(a) &amp;:= \sum_{i=1}^n \frac{\Delta_i^\tau}{\widehat G(\widetilde T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\widetilde T_i \geqslant t_k, A_i=a),
\end{align*}</span></p>
<p>be the weight-corrected numbers of deaths and of individual at risk at time <span class="math inline">t_k</span>. The IPCW version of the KM estimator is then defined as: <span class="math display">
\begin{aligned}
\widehat{S}_{\mathrm{IPCW}}(t | A=a) &amp;= \prod_{t_k \leqslant t}\left(1-\frac{D_k^{\mathrm{IPCW}}(a)}{N_k^{\mathrm{IPCW}}(a)}\right).
\end{aligned}
</span></p>
</div>
<p>Note that the quantity <span class="math inline">\pi</span> is not present in the definition of <span class="math inline">D_k^{\mathrm{IPCW}}(a)</span> and <span class="math inline">N_k^{\mathrm{IPCW}}(a)</span> because it would simply disappear in the ratio <span class="math inline">D_k^{\mathrm{IPCW}}(a)/N_k^{\mathrm{IPCW}}(a)</span>. The subsequent RMST estimator then take the form <span id="eq-thetaIPCWKM"><span class="math display">
\widehat{\theta}_{\mathrm{IPCW-KM}} = \int_{0}^{\tau}\widehat{S}_{\mathrm{IPCW}}(t|A=1)-\widehat{S}_{\mathrm{IPCW}}(t|A=0)dt.
\tag{29}</span></span> Like before for the classical KM estimator, this new reweighted KM estimator enjoys good statistical properties.</p>
<div id="prp-ipcwkm" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 6</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-postrial" class="quarto-xref">6</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, and for all <span class="math inline">t \in [0,\tau]</span>, the oracle estimator <span class="math inline">S^*_{\mathrm{IPCW}}(t|A=a)</span> defined as in <a href="#def-ipcwkm" class="quarto-xref">Definition&nbsp;3</a> with <span class="math inline">\widehat G = G</span> is a stronlgy consistent and asymptotically normal estimator of <span class="math inline">S^{(a)}(t)</span> .</p>
</div>
<p>The proof of <a href="#prp-ipcwkm" class="quarto-xref">Proposition&nbsp;6</a> can be found in <a href="#sec-proof22" class="quarto-xref">Section&nbsp;7.2</a>. Because the evaluation of <span class="math inline">N_k^{\textrm{IPCW}}(a)</span> now depends on information gathered after time <span class="math inline">t_k</span> (through the computation of the weights), the previous proofs on the absence of bias and on the derivation of the asymptotic variance unfortunately do not carry over in this case. Whether its bias is exponentially small and whether the asymptotic variance can be derived in a closed form are questions left open. We are also not aware of any estimation schemes for the asymptotic variance in this context. In the case where we do not have access to the oracle survival function <span class="math inline">G</span>, we can again still achieve consistency if the estimator <span class="math inline">\widehat G(\cdot|A,X)</span> that we provide is consistent.</p>
<div id="cor-ipcwkmcons" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 2</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, if <span class="math inline">\widehat G</span> is uniformly weakly (resp. strongly) consistent then so is <span class="math inline">\widehat S_{\mathrm{IPCW}}(t|A=a)</span>.</p>
</div>
<p>This corollary ensures that the corresponding RMST estimator defined in <a href="#eq-thetaIPCWKM" class="quarto-xref">Equation&nbsp;29</a> will be consistent as well.</p>
<p><strong>The Buckley-James transformation</strong></p>
<p>One weakness of the IPCW transformation is that it discards all censored data. The Buckley-James (BJ) transformation, introduced by (<span class="citation" data-cites="Buckley_james_79">Buckley and James (<a href="#ref-Buckley_james_79" role="doc-biblioref">1979</a>)</span>), takes a different path by leaving all uncensored values untouched, while replacing the censored ones by an extrapolated value. Formally, it is defined as follows:</p>
<p><span id="eq-defbj"><span class="math display">
\begin{aligned}
T^*_{\mathrm{BJ}} &amp;= \Delta^\tau (\widetilde{T}\wedge\tau) + (1-\Delta^\tau) Q_S(\widetilde T \wedge \tau|X,A),
\end{aligned}
\tag{30}</span></span></p>
<p>where, for <span class="math inline">t \leqslant\tau</span>, <span class="math display">Q_S(t|X,A) :=\mathbb{E}[T \wedge \tau | X,A,T \wedge \tau &gt; t]= \frac{1}{S(t|X,A)}\int_{t}^{\tau} S(u|X,A) \mathop{}\!\mathrm{d}u</span> where <span class="math inline">S(t|X,A=a) := \mathbb{P}(T(a) &gt; t|X)</span> is the conditional survival function. We refer again to <a href="#fig-trans" class="quarto-xref">Figure&nbsp;5</a> for a diagram of this transformation.</p>
<div id="prp-bj" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 7</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, the BJ transform <a href="#eq-defbj" class="quarto-xref">30</a> is a censoring unbiased transformation in the sense of <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a>.</p>
</div>
<p>The proof of <a href="#prp-bj" class="quarto-xref">Proposition&nbsp;7</a> can be found in <a href="#sec-proof22" class="quarto-xref">Section&nbsp;7.2</a>. Again, the BJ transformation depends on a nuisance parameter (here <span class="math inline">Q_S(\cdot|X,A)</span>) that needs to be estimated. We again refer to <a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a> for a brief overview of possible estimation strategies for <span class="math inline">Q_S</span>. Once provided with an estimator <span class="math inline">\widehat Q_S(\cdot|A,X)</span>, a very natural estimator of the RMST based on the BJ transformation and on <a href="#eq-cutest" class="quarto-xref">Equation&nbsp;24</a> or <a href="#eq-cutestnopi" class="quarto-xref">Equation&nbsp;25</a> would be <span id="eq-BJ"><span class="math display">
\widehat\theta_{\mathrm{BJ}} = \frac1n \sum_{i=1}^n \left(\frac{A_i}{\pi}-\frac{1-A_i}{1-\pi}\right) T^*_{\mathrm{BJ},i},
\tag{31}</span></span> or <span id="eq-BJnopi"><span class="math display">
\widehat\theta_{\mathrm{BJ}} = \frac1{n_1} \sum_{A_i=1}  T^*_{\mathrm{BJ},i}-\frac1{n_0} \sum_{A_0=1}  T^*_{\mathrm{BJ},i}.
\tag{32}</span></span> Like for the IPCW transformation, the BJ transformation yields a consistent estimate of the RMST as soon as the model is well-specified.</p>
<div id="cor-bjcons" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 3</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, if <span class="math inline">\widehat Q_S</span> is uniformly weakly (resp. strongly) consistent then so is <span class="math inline">\widehat\theta_{\mathrm{BJ}}</span> defined as in <a href="#eq-BJ" class="quarto-xref">Equation&nbsp;31</a> or <a href="#eq-BJnopi" class="quarto-xref">Equation&nbsp;32</a>.</p>
</div>
<p>The proof is again a mere application of Propositions <a href="#prp-cutest" class="quarto-xref">3</a>, <a href="#prp-cutestnopi" class="quarto-xref">4</a> and <a href="#prp-bj" class="quarto-xref">7</a>, and relies on the continuity of <span class="math inline">S \mapsto Q_S</span>. The BJ transformation is considered as the best censoring transformation of the original response in the following sense.</p>
<div id="thm-bj" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1</strong></span> For any transformation <span class="math inline">T^*</span> of the form <a href="#eq-defcut" class="quarto-xref">20</a>, it holds <span class="math display">
\mathbb{E}[(T^*_{\mathrm{BJ}}-T \wedge \tau)^2] \leqslant\mathbb{E}[(T^*-T \wedge \tau)^2].
</span></p>
</div>
<p>This result is stated in <span class="citation" data-cites="LocalLinear_Fan94">Fan and Gijbels (<a href="#ref-LocalLinear_Fan94" role="doc-biblioref">1994</a>)</span> but without a proof. We detail it in <a href="#sec-proof22" class="quarto-xref">Section&nbsp;7.2</a> for completeness.</p>
</section>
<section id="sec-tdr" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="sec-tdr"><span class="header-section-number">2.2.3</span> Augmented corrections</h3>
<p>The main disadvantage of the two previous transformations is that they heavily rely on the specification of good estimator <span class="math inline">\widehat G</span> (for IPCW) or <span class="math inline">\widehat S</span> (for BJ). In order to circumvent this limitation, <span class="citation" data-cites="DoublyR_transformation">D. Rubin and Laan (<a href="#ref-DoublyR_transformation" role="doc-biblioref">2007</a>)</span> proposed the following transformations, whose expression is based on theory of semi-parametric estimation developed in <span class="citation" data-cites="vanderLaan2003">Laan and Robins (<a href="#ref-vanderLaan2003" role="doc-biblioref">2003</a>)</span>,<br>
<span id="eq-TDR"><span class="math display">
T^*_\mathrm{DR} = \frac{\Delta^\tau \widetilde T\wedge \tau}{G(\widetilde T \wedge \tau|X,A)} + \frac{(1-\Delta^\tau)Q_S(\widetilde T \wedge \tau |X,A)}{G(\widetilde T \wedge \tau |X,A)}- \int_0^{\widetilde T \wedge \tau} \frac{Q_S(t|X,A)}{G(t|X,A)^2} \mathop{}\!\mathrm{d}\mathbb{P}_C(t|X,A),
\tag{33}</span></span> where <span class="math inline">\mathop{}\!\mathrm{d}\mathbb{P}_C(t|X,A)</span> is the distribution of <span class="math inline">C</span> conditional on the covariates <span class="math inline">X</span> and <span class="math inline">A</span>. We stress that this distribution is entirely determined by the <span class="math inline">G(\cdot|X,A)</span>, so that this transformation only depends on the knowledge of both conditional survival functions <span class="math inline">G</span> and <span class="math inline">S</span>, will be thus sometimes denoted <span class="math inline">T^*_\mathrm{DR}(G,S)</span> to underline this dependency. This transformation is not only a censoring unbiased transform in the sense of <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a>, but is also doubly robust in the following sense.</p>
<div id="prp-tdr" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 8</strong></span> We let <span class="math inline">F,R</span> be two conditional survival functions. Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-rta" class="quarto-xref">5</a>, <a href="#eq-postrial" class="quarto-xref">6</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, if <span class="math inline">F</span> also satisfies Assumption <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, and if <span class="math inline">F(\cdot|X,A)</span> is absolutely continuous wrt <span class="math inline">G(\cdot|X,A)</span>, then the transformation <span class="math inline">T^*_\mathrm{DR} = T^*_\mathrm{DR}(F,R)</span> is a censoring unbiased transformation in the sense of <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a> whenever <span class="math inline">F = G</span> or <span class="math inline">R=S</span>.</p>
</div>
<p>The statement and proof of this results is found in <span class="citation" data-cites="DoublyR_transformation">D. Rubin and Laan (<a href="#ref-DoublyR_transformation" role="doc-biblioref">2007</a>)</span> in the case where <span class="math inline">C</span> and <span class="math inline">T</span> are continuous. A careful examination of the proofs show that the proof translates straight away to our discrete setting.</p>
</section>
</section>
</section>
<section id="sec-theoryOBS" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Causal survival analysis in observational studies</h1>
<p>Unlike RCT, observational data — such as from registries, electronic health records, or national healthcare systems — are collected without controlled randomized treatment allocation. In such cases, treated and control groups are likely unbalanced due to the non-randomized design, which results in the treatment effect being confounded by variables influencing both the survival outcome <span class="math inline">T</span> and the treatment allocation <span class="math inline">A</span>. To enable identifiability of the causal effect, additional standard assumptions are needed.</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Conditional exchangeability / Unconfoundedness) It holds <span id="eq-unconf"><span class="math display">
A \perp\mkern-9.5mu\perp T(0),T(1) | X
\tag{34}</span></span></p>
</div>
<p>Under <a href="#eq-unconf" class="quarto-xref">Equation&nbsp;34</a>, the treatment assignment is randomly assigned conditionally on the covariates <span class="math inline">X</span>. This assumption ensures that there are no unmeasured confounder as the latter would make it impossible to distinguish correlation from causality.</p>
<div class="assumption">
<p><strong>Assumption.</strong> (Positivity / Overlap for treatment) Letting <span class="math inline">e(X) := \mathbb{P}(A=1|X)</span> be the <em>propensity score</em>, there holds <span id="eq-positivitytreat"><span class="math display">
0 &lt; e(X) &lt;1 \quad \text{almost surely.}
\tag{35}</span></span></p>
</div>
<p>The <a href="#eq-positivitytreat" class="quarto-xref">Equation&nbsp;35</a> assumption requires adequate overlap in covariate distributions between treatment groups, meaning every observation must have a non-zero probability of being treated. Because Assumption <a href="#eq-rta" class="quarto-xref">5</a> does not hold anymore, neither does the previous idenfiability <a href="#eq-RMSTkm" class="quarto-xref">Equation&nbsp;7</a>. In this new context, we can write</p>
<p><span id="eq-identcond"><span class="math display">
\begin{aligned}
    \theta_{\mathrm{RMST}} &amp;=  \mathbb{E}[T(1) \wedge \tau - T(0) \wedge \tau]\\
    &amp;= \mathbb{E}\left[\mathbb{E}[T(1) \wedge \tau|X] - \mathbb{E}[T(0) \wedge \tau|X] \right]  &amp;&amp;  \\
    &amp;=\mathbb{E}\left[\mathbb{E}[T(1) \wedge \tau|X, A=1] - \mathbb{E}[T(0) \wedge \tau|X, A=0]\right]   &amp;&amp; \tiny\text{(unconfoundness)} \\
       &amp;= \mathbb{E}\left[\mathbb{E}[T \wedge \tau|X, A=1] - \mathbb{E}[T \wedge \tau|X, A=0]\right].  &amp;&amp; \tiny\text{(SUTVA)}
\end{aligned}
\tag{36}</span></span> In another direction, one could wish to identify the treatment effect through the survival curve as in <a href="#eq-rmstsurv" class="quarto-xref">Equation&nbsp;2</a>: <span id="eq-kmcond"><span class="math display">
S^{(a)}(t) = \mathbb{P}(T(a) &gt; t) = \mathbb{E}\left[\mathbb{P}(T &gt; t | X, A=a)\right].
\tag{37}</span></span> Again, both identities still depend on the unknown quantity <span class="math inline">T</span> and suggest two different estimation strategies. These strategies differ according to the censoring assumptions and are detailed below.</p>
<section id="sec-obs_indcen" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sec-obs_indcen"><span class="header-section-number">3.1</span> Independent censoring</h2>
<p><a href="#fig-causalgraph_obs_ind" class="quarto-xref">Figure&nbsp;6</a> illustrates a causal graph in observational survival data with independent censoring (Assumption <a href="#eq-independantcensoring" class="quarto-xref">8</a>).</p>
<div id="fig-causalgraph_obs_ind" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-causalgraph_obs_ind-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<embed src="causal_survival_obs_indep.pdf" class="img-fluid quarto-figure quarto-figure-center" style="width:40.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-causalgraph_obs_ind-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Causal graph in observational survival data with independent censoring.
</figcaption>
</figure>
</div>
<p>Under Assumption <a href="#eq-independantcensoring" class="quarto-xref">8</a>, we saw in <a href="#sec-theoryRCT_indc" class="quarto-xref">Section&nbsp;2.1</a> that the Kaplan-Meier estimator could conveniently handle censoring. Building on <a href="#eq-kmcond" class="quarto-xref">Equation&nbsp;37</a>, we can write <span class="math display">
S^{(1)}(t) = \mathbb{E}\left[\frac{\mathbb{E}[\mathbb{I}\{A=1,T &gt; t\}|X]}{\mathbb{E}[\mathbb{I}\{A=1\}|X]} \right]=\mathbb{E}\left[\frac{A\mathbb{I}\{T &gt; t\}}{e(X)} \right],
</span> which suggests to adapt the classical KM estimator by reweighting it by the propensity score. The use of propensity score in causal inference has been initially introduced by <span class="citation" data-cites="Propensity_causality">Rosenbaum and Rubin (<a href="#ref-Propensity_causality" role="doc-biblioref">1983</a>)</span> and further developed in <span class="citation" data-cites="hirano2003efficient">Hirano, Imbens, and Ridder (<a href="#ref-hirano2003efficient" role="doc-biblioref">2003</a>)</span>. It was extended to survival analysis by <span class="citation" data-cites="IPTW">Xie and Liu (<a href="#ref-IPTW" role="doc-biblioref">2005</a>)</span> through the adjusted Kaplan-Meier estimator as defined below.</p>
<div id="def-iptwkm" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 4</strong></span> (IPTW Kaplan-Meier estimator) We let <span class="math inline">\widehat e(\cdot)</span> be an estimator of the propensity score <span class="math inline">e(\cdot)</span>. We introduce</p>
<p><span class="math display">\begin{align*}
D_k^{\mathrm{IPTW}}(a) &amp;:= \sum_{i=1}^n \left(\frac{a}{\widehat e(X_i)}+\frac{1-a}{1- \widehat e(X_i)}\right)\mathbb{I}(\widetilde T_i = t_k, \Delta_i = 1, A_i=a) \\
\quad\text{and}\quad N^{\mathrm{IPTW}}_k(a) &amp;:= \sum_{i=1}^n \left(\frac{a}{\widehat e(X_i)}+\frac{1-a}{1- \widehat e(X_i)}\right) \mathbb{I}(\widetilde T_i \geqslant t_k, A_i=a),
\end{align*}</span></p>
<p>be the numbers of deaths and of individual at risk at time <span class="math inline">t_k</span>, reweighted by the propensity score. The Inverse-Probability-of-Treatment Weighting (IPTW) version of the KM estimator is then defined as: <span id="eq-IPTWKM"><span class="math display">
\begin{aligned}
\widehat{S}_{\mathrm{IPTW}}(t | A=a) &amp;= \prod_{t_k \leqslant t}\left(1-\frac{D_k^{\mathrm{IPTW}}(a)}{N_k^{\mathrm{IPTW}}(a)}\right).
\end{aligned}
\tag{38}</span></span></p>
</div>
<p>We let <span class="math inline">S^*_{\mathrm{IPTW}}(t | A=a)</span> be the oracle KM-estimator defined as above with <span class="math inline">\widehat e(\cdot) = e(\cdot)</span>. Although the reweighting slightly changes the analysis, the good properties of the classical KM carry on to this setting.</p>
<div id="prp-iptwkm" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 9</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-independantcensoring" class="quarto-xref">8</a> and <a href="#eq-poscen" class="quarto-xref">9</a> The oracle IPTW Kaplan-Meier estimator <span class="math inline">S^*_{\mathrm{IPTW}}(t | A=a)</span> is a strongly consistent and asymptotically normal estimator of <span class="math inline">S^{(a)}(t)</span>.</p>
</div>
<p>The proof of this result simply relies again on the law of large number and the <span class="math inline">\delta</span>-method and can be found in <a href="#sec-proof31" class="quarto-xref">Section&nbsp;7.3</a>. Because now <span class="math inline">S^*_{\mathrm{IPTW}}</span> is a continuous function of <span class="math inline">e(\cdot)</span>, and because <span class="math inline">e</span> and <span class="math inline">1-e</span> are lower-bounded as per Assumptions <a href="#eq-positivitytreat" class="quarto-xref">35</a>, we easily derive the following corollary.</p>
<div id="cor-iptwkm" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 4</strong></span> Under the same assumptions as <a href="#prp-iptwkm" class="quarto-xref">Proposition&nbsp;9</a>, if <span class="math inline">\widehat e(\cdot)</span> satisfies <span class="math inline">\|\widehat e-e\|_{\infty} \to 0</span> almost surely (resp. in probability), then the IPTW Kaplan-Meier estimator <span class="math inline">\hat S_{\mathrm{IPTW}}(t | A=a)</span> is a strongly (resp. weakly) consistent estimator of <span class="math inline">S^{(a)}(t)</span>.</p>
</div>
<p>The resulting RMST estimator simply takes the form: <span id="eq-RMST_IPTWKM"><span class="math display">
\widehat{\theta}_{\mathrm{IPTW-KM}} = \int_{0}^{\tau}\widehat{S}_{\mathrm{IPTW}}(t|A=1)-\widehat{S}_{\mathrm{IPTW}}(t|A=0)dt.
\tag{39}</span></span> which will be consistent under the same Assumptions as the previous Corollary. Note that, we are not aware of any formal results concerning the bias and the asymptotic variance of the oracle estimator <span class="math inline">S^*_{\mathrm{IPTW}}(t | A=a)</span>, and we refer to <span class="citation" data-cites="IPTW">Xie and Liu (<a href="#ref-IPTW" role="doc-biblioref">2005</a>)</span> for heuristics concerning these questions.</p>
</section>
<section id="sec-obscondcens" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-obscondcens"><span class="header-section-number">3.2</span> Conditional independent censoring</h2>
<p>Under Assumptions <a href="#eq-unconf" class="quarto-xref">34</a> (uncounfoundedness) and <a href="#eq-condindepcensoring" class="quarto-xref">16</a> (conditional independent censoring), the causal effect is affected both by confounding variables and by conditional censoring. The associated causal graph is depicted in <a href="#fig-causalgraph_obs_dep" class="quarto-xref">Figure&nbsp;7</a>. In this setting, one can still use the <span class="math inline">G</span>-formula exactly as in <a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a>.</p>
<p>A natural alternative approach is to weight the IPCW and BJ transformations from <a href="#sec-unbiasedtransfo" class="quarto-xref">Section&nbsp;2.2.2</a> by the propensity score to disentangle both confounding effects and censoring at the same time.</p>
<div id="fig-causalgraph_obs_dep" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-causalgraph_obs_dep-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<embed src="causal_survival_obs_dep.pdf" class="img-fluid quarto-figure quarto-figure-center" style="width:40.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-causalgraph_obs_dep-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Causal graph in observational survival data with dependent censoring.
</figcaption>
</figure>
</div>
<p>We mention that the G-formula approach developed in <a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a> does work in that context. In particular, <span class="citation" data-cites="RMST">Chen and Tsiatis (<a href="#ref-RMST" role="doc-biblioref">2001</a>)</span> prove consistency and asymptotic normality results for Cox estimators in a observational study, and they give an explicit formulation of the asymptotic variance as a function of the parameters of the Cox model. In the non-parametric world, <span class="citation" data-cites="Foster_2011">Foster, Taylor, and Ruberg (<a href="#ref-Foster_2011" role="doc-biblioref">2011</a>)</span> and <span class="citation" data-cites="Soren_2019">Künzel et al. (<a href="#ref-Soren_2019" role="doc-biblioref">2019</a>)</span> empirically study this estimator using survival forests, with the former employing it as a T-learner (referred to as <em>Virtual Twins</em>) and the latter as an S-learner.</p>
<section id="iptw-ipcw-transformations" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="iptw-ipcw-transformations"><span class="header-section-number">3.2.1</span> IPTW-IPCW transformations</h3>
<p>One can check that the IPCW transformation as introduced in <a href="#eq-defipcw" class="quarto-xref">Equation&nbsp;26</a> is also a censoring unbiased transformation in that context.</p>
<div id="prp-iptwipcw" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 10</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, the IPTW-IPCW transform <a href="#eq-defipcw" class="quarto-xref">26</a> is a censoring unbiased transformation in the sense of <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a>.</p>
</div>
<p>The proof of <a href="#prp-iptwipcw" class="quarto-xref">Proposition&nbsp;10</a> can be found in <a href="#sec-proof32" class="quarto-xref">Section&nbsp;7.4</a>. Deriving an estimator of the difference in RMST is however slightly different in that context. In particular, <a href="#eq-cutcond" class="quarto-xref">Equation&nbsp;23</a> rewrites <span class="math display">
\mathbb{E}[\mathbb{E}[T^*|X,A=1]] = \mathbb{E}\left[\frac{A}{e(X)} T^*\right],
</span> Which in turn suggests to define <span id="eq-iptwipcw"><span class="math display">
\widehat\theta_{\mathrm{IPTW-IPCW}} = \frac1n\sum_{i=1}^n  \left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right) T^*_{\mathrm{IPCW},i}.
\tag{40}</span></span></p>
<p>This transformation now depends on two nuisance parameters, namely the conditional survival function of the censoring (through <span class="math inline">T^*_{\mathrm{IPCW}}</span>) and the propensity score. Once estimators of these quantities are provided, one could look at the corresponding quantity computed with these estimators.</p>
<div id="prp-consiptwipcw" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 11</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, and if <span class="math inline">\widehat G(\cdot|X,A)</span> and <span class="math inline">\widehat e (\cdot)</span> are uniformly weakly (resp. strongly) consistent estimators, then estimator <a href="#eq-iptwipcw" class="quarto-xref">40</a> defined with <span class="math inline">\widehat e</span> and <span class="math inline">\widehat G</span> is a weakly (resp. strongly) consistent estimator of the difference in RMST.</p>
</div>
<p>The proof of <a href="#prp-consiptwipcw" class="quarto-xref">Proposition&nbsp;11</a> can be found in <a href="#sec-proof32" class="quarto-xref">Section&nbsp;7.4</a>. We can also use the same strategy as for the IPCW transformation and incorporate the new weights into a Kaplan-Meier estimator.</p>
<div id="def-iptwipcwkm" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 5</strong></span> (IPTW-IPCW-Kaplan-Meier) We let again <span class="math inline">\widehat G(\cdot|X,A)</span> and <span class="math inline">\widehat e(\cdot)</span> be estimators of the conditional censoring survival function and of the propensity score. We introduce</p>
<p><span class="math display">\begin{align*}
D_k^{\mathrm{IPTW-IPCW}}(a) &amp;:= \sum_{i=1}^n \left(\frac{A_i}{\widehat e(X_i)}+\frac{1-A_i}{1-\widehat e(X_i)} \right)\frac{\Delta_i^\tau}{\widehat G(\widetilde T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\widetilde T_i = t_k, A_i=a) \\
\quad\text{and}\quad N^{\mathrm{IPTW-IPCW}}_k(a) &amp;:= \sum_{i=1}^n \left(\frac{A_i}{\widehat e(X_i)}+\frac{1-A_i}{1-\widehat e(X_i)} \right)\frac{\Delta_i^\tau}{\widehat G(\widetilde T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\widetilde T_i \geqslant t_k, A_i=a),
\end{align*}</span></p>
<p>be the weight-corrected numbers of deaths and of individual at risk at time <span class="math inline">t_k</span>. The IPTW-IPCW version of the KM estimator is then defined as: <span class="math display">
\begin{aligned}
\widehat{S}_{\mathrm{IPTW-IPCW}}(t | A=a) &amp;= \prod_{t_k \leqslant t}\left(1-\frac{D_k^{\mathrm{IPTW-IPCW}}(a)}{N_k^{\mathrm{IPTW-IPCW}}(a)}\right).
\end{aligned}
</span></p>
</div>
<p>The difference in RMST estimated with IPTW-IPCW-Kaplan-Meier survival curves is then simply as</p>
<p><span id="eq-RMST_IPTW_IPCWKM"><span class="math display">
\widehat{\theta}_{\mathrm{IPTW-IPCW-KM}} = \int_{0}^{\tau}\widehat{S}_{\mathrm{IPTW-IPCW}}(t|A=1)-\widehat{S}_{\mathrm{IPTW-IPCW}}(t|A=0)dt.
\tag{41}</span></span></p>
<div id="prp-iptwipcwkm" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 12</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, and for all <span class="math inline">t \in [0,\tau]</span>, if the oracle estimator <span class="math inline">S^*_{\mathrm{IPTW-IPCW}}(t | A=a)</span> defined as in <a href="#def-iptwipcwkm" class="quarto-xref">Definition&nbsp;5</a> with <span class="math inline">\widehat G(\cdot|A,X) = G(\cdot|A,X)</span> and <span class="math inline">\widehat e = e</span> is a strongly consistent and asymptotically normal estimator of <span class="math inline">S^{(a)}(t)</span> .</p>
</div>
<p>The proof of <a href="#prp-iptwipcwkm" class="quarto-xref">Proposition&nbsp;12</a> can be found in <a href="#sec-proof32" class="quarto-xref">Section&nbsp;7.4</a>. Under consistency of the estimators of the nuisance parameters, the previous proposition implies that this reweighted Kaplan-Meier is a consistent estimator of the survival curve, which in turn implies consistency of <span class="math inline">\widehat{\theta}_{\mathrm{IPTW-IPCW-KM}}</span>.</p>
<div id="cor-consiptwipcwkm" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 5</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, and for all <span class="math inline">t \in [0,\tau]</span>, if the nuisance estimators <span class="math inline">\widehat G(\cdot|A,X)</span> and <span class="math inline">\widehat e</span> are weakly (resp. strongly) uniformly consistent, then <span class="math inline">\widehat{S}_{\mathrm{IPTW-IPCW}}(t | A=a)</span> is a weakly (resp. strongly) consistent estimator of <span class="math inline">S^{(a)}(t)</span>.</p>
</div>
<p>We are not aware of general formula for the asymptotic variances in this context. We mention nonetheless that <span class="citation" data-cites="Schaubel2011">Schaubel and Wei (<a href="#ref-Schaubel2011" role="doc-biblioref">2011</a>)</span> have been able to derive asymptotic laws in this framework in the particular case of Cox-models.</p>
</section>
<section id="iptw-bj-transformations" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="iptw-bj-transformations"><span class="header-section-number">3.2.2</span> IPTW-BJ transformations</h3>
<p>Like IPCW tranformation, BJ transformation is again a censoring unbiased transformation in an observational context.</p>
<div id="prp-iptwbj" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 13</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, the IPTW-BJ transform <a href="#eq-defbj" class="quarto-xref">30</a> is a censoring unbiased transformation in the sense of <a href="#eq-cut" class="quarto-xref">Equation&nbsp;22</a>.</p>
</div>
<p>The proof of <a href="#prp-iptwbj" class="quarto-xref">Proposition&nbsp;13</a> can be found in <a href="#sec-proof32" class="quarto-xref">Section&nbsp;7.4</a>. The corresponding estimator of the difference in RMST is <span id="eq-iptwbj"><span class="math display">
\hat \theta_{\mathrm{IPTW-BJ}} = \frac1n\sum_{i=1}^n  \left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right) T^*_{\mathrm{BJ},i}.
\tag{42}</span></span></p>
<p>This transformation depends on the conditional survival function <span class="math inline">S</span> (through <span class="math inline">T^*_{\mathrm{BJ}}</span>) and the propensity score. Consistency of the nuisance parameter estimators implies again consistency of the RMST estimator.</p>
<div id="prp-consiptwbj" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 14</strong></span> Under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, and if <span class="math inline">\widehat S(\cdot|X,A)</span> and <span class="math inline">\widehat e (\cdot)</span> are uniformly weakly (resp. strongly) consistent estimators, then <span class="math inline">\widehat\theta_{\mathrm{IPTW-BJ}}</span> defined with <span class="math inline">\widehat S</span> and <span class="math inline">\widehat e</span> is a weakly (resp. strongly) consistent estimator of the RMST.</p>
</div>
<p>The proof of <a href="#prp-consiptwbj" class="quarto-xref">Proposition&nbsp;14</a> can be found in <a href="#sec-proof32" class="quarto-xref">Section&nbsp;7.4</a>.</p>
</section>
<section id="sec-AIPTW_AIPCW" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="sec-AIPTW_AIPCW"><span class="header-section-number">3.2.3</span> Double augmented corrections</h3>
<p>Building on the classical doubly-robust AIPTW estimator from causal inference <span class="citation" data-cites="robins1994estimation">(<a href="#ref-robins1994estimation" role="doc-biblioref">Robins, Rotnitzky, and Zhao 1994</a>)</span>, we could incorporate the doubly-robust transformations of <a href="#sec-tdr" class="quarto-xref">Section&nbsp;2.2.3</a> to obtain a <em>quadruply robust</em> tranformation <span class="math display">
\Delta^*_{\mathrm{QR}} = \Delta^*_{\mathrm{QR}}(G,S,\mu,e)  := \left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)}\right)(T^*_{\mathrm{DR}}(G,S)-\mu(X,A))+\mu(X,1)-\mu(X,0),
</span> where we recall that <span class="math inline">T^*_{\mathrm{DR}}</span> is defined in <a href="#sec-tdr" class="quarto-xref">Section&nbsp;2.2.3</a>. This transformations depends on four nuisance parameters: <span class="math inline">G</span> and <span class="math inline">S</span> through <span class="math inline">T^*_{\mathrm{DR}}</span>, and now the propensity score <span class="math inline">e</span> and the conditional response <span class="math inline">\mu</span>. This transformation doesn’t really fall into the scope of censoring unbiased transform, but it is easy to show that <span class="math inline">\Delta^*_{\mathrm{QR}}</span> is quadruply robust in the following sense.</p>
<div id="prp-tqr" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 15</strong></span> Let <span class="math inline">F,R</span> be two conditional survival function, <span class="math inline">p</span> be a propensity score, and <span class="math inline">\nu</span> be a conditional response. Then, under the same assumption on <span class="math inline">F,R</span> as in <a href="#prp-tdr" class="quarto-xref">Proposition&nbsp;8</a>, and under Assumptions <a href="#eq-sutva" class="quarto-xref">1</a>, <a href="#eq-unconf" class="quarto-xref">34</a>, <a href="#eq-positivitytreat" class="quarto-xref">35</a>, <a href="#eq-condindepcensoring" class="quarto-xref">16</a> and <a href="#eq-positivitycensoring" class="quarto-xref">17</a>, the transformations <span class="math inline">\Delta^*_{\mathrm{QR}} = \Delta^*_{\mathrm{QR}}(F,R,p,\nu)</span> satisfies, fo <span class="math inline">a \in {0,1}</span>, <span class="math display">
\mathbb{E}[ \Delta^*_\mathrm{QR} |X] = \mathbb{E}[T(1)\wedge \tau-T(0)\wedge \tau |X]\quad\text{if}\quad  
\begin{cases} F = G \quad &amp;\text{or}\quad R=S \quad \text{and} \\
p=e \quad &amp;\text{or}\quad \nu=\mu.
\end{cases}
</span></p>
</div>
<p>This result is similar to <span class="citation" data-cites="Ozenne20_AIPTW_AIPCW">Ozenne et al. (<a href="#ref-Ozenne20_AIPTW_AIPCW" role="doc-biblioref">2020</a>)</span>, Thm 1, and its proof can be found in <a href="#sec-proof32" class="quarto-xref">Section&nbsp;7.4</a>. Based on estimators <span class="math inline">(\widehat G, \widehat S, \widehat\mu, \widehat e)</span> of <span class="math inline">(G,S,\mu,e)</span>, one can then propose the following estimator of the RMST, coined the AIPTW-AIPCW estimator in <span class="citation" data-cites="Ozenne20_AIPTW_AIPCW">Ozenne et al. (<a href="#ref-Ozenne20_AIPTW_AIPCW" role="doc-biblioref">2020</a>)</span>: <span id="eq-AIPTW_AIPCW"><span class="math display">
\begin{aligned}
\widehat\theta_{\mathrm{AIPTW-AIPCW}} &amp;:= \frac1n \sum_{i=1}^n \Delta_{\mathrm{QR},i}^*(\widehat G, \widehat S, \widehat\mu, \widehat e)
\\
&amp;=\frac1n \sum_{i=1}^n \left(\frac{A_i}{\widehat e(X_i)}-\frac{1-A_i}{1-\widehat e(X_i)}\right)(T^*_{\mathrm{DR}}(\widehat G,\widehat S)_i-\widehat\mu(X_i,A_i)) + \widehat\mu(X_i,1)-\widehat\mu(X_i,0).
\end{aligned}
\tag{43}</span></span> This estimator enjoys good asymptotic properties under parametric models, as detailed in <span class="citation" data-cites="Ozenne20_AIPTW_AIPCW">Ozenne et al. (<a href="#ref-Ozenne20_AIPTW_AIPCW" role="doc-biblioref">2020</a>)</span>.</p>
</section>
</section>
</section>
<section id="implementation" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Implementation</h1>
<p>In this section, we first summarize the various estimators and their properties. We then provide custom implementations for all estimators, even those already available in existing packages. These manual implementations serve two purposes: first, to make the methods accessible to the community when no existing implementation is available; and second, to facilitate a deeper understanding of the methods by detailing each step, even when a package solution exists. Finally, we present the packages available for directly computing <span class="math inline">\theta_{\mathrm{RMST}}</span>.</p>
<section id="sec-summary" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-summary"><span class="header-section-number">4.1</span> Summary of the estimators</h2>
<p><a href="#tbl-nuisance" class="quarto-xref">Table&nbsp;3</a> provides an overview of the estimators introduced in this paper, along with the corresponding nuisance parameters needed for their estimation and an overview of their statistical properties in particular regarding their sensitivity to misspecification of the nuisance parameters.</p>
<div id="tbl-nuisance" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-nuisance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Estimators of the difference in RMST and nuisance parameters needed to compute each estimator. Empty boxes indicate that the nuisance parameter is not needed in the estimator thus misspecification has no impact. Estimators in italic are those that are already implemented in available packages.
</figcaption>
<div aria-describedby="tbl-nuisance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Estimator</th>
<th>RCT</th>
<th>Obs</th>
<th>Ind Cens</th>
<th>Dep Cens</th>
<th>Outcome model</th>
<th>Censoring model</th>
<th>Treatment model</th>
<th>Robustness</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><em>Unadjusted KM</em></td>
<td><span class="math inline">\color{green}X</span></td>
<td></td>
<td><span class="math inline">\color{green}X</span></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>IPCW-KM</td>
<td><span class="math inline">\color{green}X</span></td>
<td></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td></td>
<td><span class="math inline">G</span></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>BJ</td>
<td><span class="math inline">\color{green}X</span></td>
<td></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">S</span></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><em>IPTW-KM</em></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td></td>
<td></td>
<td></td>
<td><span class="math inline">e</span></td>
<td></td>
</tr>
<tr class="odd">
<td>IPCW-IPTW-KM</td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td></td>
<td><span class="math inline">G</span></td>
<td><span class="math inline">e</span></td>
<td></td>
</tr>
<tr class="even">
<td>IPTW-BJ</td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">S</span></td>
<td></td>
<td><span class="math inline">e</span></td>
<td></td>
</tr>
<tr class="odd">
<td><em>G-formula</em></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\mu</span></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>AIPTW-AIPCW</td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">\color{green}X</span></td>
<td><span class="math inline">{\color{green}X}</span></td>
<td><span class="math inline">S,\mu</span></td>
<td><span class="math inline">G</span></td>
<td><span class="math inline">e</span></td>
<td><span class="math inline">\color{green}X</span> (Prp <a href="#prp-tqr" class="quarto-xref">15</a>)</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="implementation-of-the-estimators" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="implementation-of-the-estimators"><span class="header-section-number">4.2</span> Implementation of the estimators</h2>
<p>Across different implementations, we use the following shared functions provided in the <span class="math inline">\texttt{utilitary.R}</span> file.</p>
<ul>
<li><p><span class="math inline">\texttt{estimate\_propensity\_score}</span>: function to estimate propensity scores <span class="math inline">e(X)</span> using either parametric (i.e.&nbsp;logistic regression with the argument <span class="math inline">\texttt{type\_of\_model = "glm"}</span>) or non-parametric methods (i.e.&nbsp;probability forest with the argument <span class="math inline">\texttt{type\_of\_model ="probability forest"}</span> based on the <span class="math inline">\texttt{probability\_forest}</span> function from the <a href="https:%20//cran.r-project.org/web/packages/grf/index.html">grf</a> <span class="citation" data-cites="Tibshirani_Athey_Sverdrup_Wager_2017">(<a href="#ref-Tibshirani_Athey_Sverdrup_Wager_2017" role="doc-biblioref">Tibshirani et al. 2017</a>)</span> package). This latter can include cross-fitting (<span class="math inline">\texttt{n.folds\&gt;1}</span>).</p></li>
<li><p><span class="math inline">\texttt{estimate\_survival\_function}</span>: function to estimate the conditional survival model, which supports either Cox models (argument <span class="math inline">\texttt{type\_of\_model = "cox"}</span>) or survival forests (argument <span class="math inline">\texttt{type\_of\_model = "survival forest"}</span>) which uses the function <span class="math inline">\texttt{survival\_forest}</span> from the <a href="https:%20//cran.r-project.org/web/packages/grf/index.html">grf</a> <span class="citation" data-cites="Tibshirani_Athey_Sverdrup_Wager_2017">(<a href="#ref-Tibshirani_Athey_Sverdrup_Wager_2017" role="doc-biblioref">Tibshirani et al. 2017</a>)</span> package. This latter can include cross-fitting (<span class="math inline">\texttt{n.folds\&gt;1}</span>). The estimation can be done with a single learner (argument <span class="math inline">\texttt{learner = "S-learner"}</span>) or two learners (argument <span class="math inline">\texttt{learner = "T-learner"}</span>).</p></li>
<li><p><span class="math inline">\texttt{estimate\_hazard\_function}</span>: function to estimate the instantaneous hazard function by deriving the cumulative hazard function at each time point. This cumulative hazard function is estimated from the negative logarithm of the survival function.</p></li>
<li><p><span class="math inline">\texttt{Q\_t\_hat}</span>: function to estimate the remaining survival function at all time points and for all individuals which uses the former <span class="math inline">\texttt{estimate\_survival\_function}</span>.</p></li>
<li><p><span class="math inline">\texttt{Q\_Y}</span>: function to select the value of the remaining survival function from <span class="math inline">\texttt{Q\_t\_hat}</span> at the specific time-to-event.</p></li>
<li><p><span class="math inline">\texttt{integral\_rectangles}</span>: function to estimate the integral of a decreasing step function using the rectangle method.</p></li>
<li><p><span class="math inline">\texttt{expected\_survival}</span>: function to estimate the integral with <span class="math inline">x,y</span> coordinate (estimated survival function) using the trapezoidal method.</p></li>
<li><p><span class="math inline">\texttt{integrate}</span>: function to estimate the integral at specific time points <span class="math inline">\texttt{Y.grid}</span> of a given <span class="math inline">\texttt{integrand}</span> function which takes initially its values on <span class="math inline">\texttt{times}</span> using the trapezoidal method.</p></li>
</ul>
<p><strong>Unadjusted Kaplan-Meier</strong></p>
<p>Although Kaplan-Meier is implemented in the <span class="math inline">\texttt{survival}</span> package <span class="citation" data-cites="Therneau_2001">(<a href="#ref-Therneau_2001" role="doc-biblioref">Therneau 2001</a>)</span>, we provide a custom implementation, <span class="math inline">\texttt{Kaplan\_meier\_handmade}</span>, for completeness. The difference in Restricted Mean Survival Time, estimated using Kaplan-Meier as in <a href="#eq-thetaunadjKM" class="quarto-xref">Equation&nbsp;14</a> can then be calculated with the <span class="math inline">\texttt{RMST\_1}</span> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"utilitary.R"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaplan-Meier estimator handmade implementation</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The database 'data' must be in the same form as that shown in </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># notation (Table 1) and with the same variable names (status, T_obs) </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>Kaplan_meier_handmade <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">status =</span> data<span class="sc">$</span>status, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">T_obs =</span> data<span class="sc">$</span>T_obs) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort unique observed times</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(T_obs))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize vectors for number of events, number at risk, and survival </span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># probability</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(Y.grid))  <span class="co"># Number of events at time Y.grid[i]</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(Y.grid))  <span class="co"># Number at risk just before time Y.grid[i]</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(Y.grid))  <span class="co"># Survival probability at time Y.grid[i]</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over each unique observed time</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Y.grid)) {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    d[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(T_obs <span class="sc">==</span> Y.grid[i] <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)  <span class="co"># Count events</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    n[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(T_obs <span class="sc">&gt;=</span> Y.grid[i])  <span class="co"># Count at risk</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate survival probability</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    S[i] <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> d <span class="sc">/</span> n)[i]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a dataframe with the results</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">d =</span> d, <span class="at">n =</span> n, <span class="at">S =</span> S, <span class="at">T =</span> Y.grid)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate RMST (Restricted Mean Survival Time):</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Two possibilities for computing RMST: </span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># - in using directly S_A1 and S_A0 (survival function of treated and control)</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># - in using the dataframe and the function computes the survival functions</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>RMST_1 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">data =</span> <span class="cn">NULL</span>, <span class="at">A1 =</span> <span class="dv">1</span>, <span class="at">A0 =</span> <span class="dv">0</span>, tau, <span class="at">S_A1 =</span> <span class="cn">NULL</span>, <span class="at">S_A0 =</span> <span class="cn">NULL</span>) {</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(S_A1) <span class="sc">&amp;</span> <span class="fu">is.null</span>(S_A0)) {</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset data for treatment groups</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    data1 <span class="ot">&lt;-</span> data[data<span class="sc">$</span>A <span class="sc">==</span> A1,]</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    data0 <span class="ot">&lt;-</span> data[data<span class="sc">$</span>A <span class="sc">==</span> A0,]</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Kaplan-Meier survival estimates</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    S_A1 <span class="ot">&lt;-</span> <span class="fu">Kaplan_meier_handmade</span>(data1, <span class="at">status =</span> data1<span class="sc">$</span>status, </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">T_obs =</span> data1<span class="sc">$</span>T_obs)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    S_A0 <span class="ot">&lt;-</span> <span class="fu">Kaplan_meier_handmade</span>(data0, <span class="at">status =</span> data0<span class="sc">$</span>status, </span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">T_obs =</span> data0<span class="sc">$</span>T_obs)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Restrict observations to those less than or equal to tau</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    Y.grid1 <span class="ot">&lt;-</span> data1<span class="sc">$</span>T_obs[data1<span class="sc">$</span>T_obs <span class="sc">&lt;=</span> tau]</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    Y.grid0 <span class="ot">&lt;-</span> data0<span class="sc">$</span>T_obs[data0<span class="sc">$</span>T_obs <span class="sc">&lt;=</span> tau]</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Restrict observations to those less than or equal to tau</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    Y.grid1 <span class="ot">&lt;-</span> S_A1<span class="sc">$</span>T[S_A1<span class="sc">$</span>T <span class="sc">&lt;=</span> tau]</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    Y.grid0 <span class="ot">&lt;-</span> S_A0<span class="sc">$</span>T[S_A0<span class="sc">$</span>T <span class="sc">&lt;=</span> tau]</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter survival estimates to restricted observations</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  S_A1 <span class="ot">&lt;-</span> S_A1 <span class="sc">%&gt;%</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(T <span class="sc">%in%</span> Y.grid1)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  S_A0 <span class="ot">&lt;-</span> S_A0 <span class="sc">%&gt;%</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(T <span class="sc">%in%</span> Y.grid0)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if there is any event at tau for S_A1</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(S_A1<span class="sc">$</span>T <span class="sc">==</span> tau)) {</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    new_row <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">T =</span> tau, <span class="at">S =</span> S_A1<span class="sc">$</span>S[<span class="fu">nrow</span>(S_A1)])</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    S_A1 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(S_A1, new_row)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if there is any event at tau for S_A0</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(S_A0<span class="sc">$</span>T <span class="sc">==</span> tau)) {</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    new_row <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">T =</span> tau, <span class="at">S =</span> S_A0<span class="sc">$</span>S[<span class="fu">nrow</span>(S_A0)])</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    S_A0 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(S_A0, new_row)</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate integrals from 0 to tau of survival probabilities</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  intA1 <span class="ot">&lt;-</span> <span class="fu">integral_rectangles</span>(S_A1<span class="sc">$</span>T, S_A1<span class="sc">$</span>S)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  intA0 <span class="ot">&lt;-</span> <span class="fu">integral_rectangles</span>(S_A0<span class="sc">$</span>T, S_A0<span class="sc">$</span>S)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  RMST1 <span class="ot">&lt;-</span> intA1 <span class="sc">-</span> intA0</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">RMST=</span>RMST1, <span class="at">intA1=</span>intA1,<span class="at">intA0=</span>intA0))</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As an alternative, one can also use the <span class="math inline">\texttt{survfit}</span> function in the survival package <span class="citation" data-cites="Therneau_2001">(<a href="#ref-Therneau_2001" role="doc-biblioref">Therneau 2001</a>)</span> for Kaplan-Meier and specify the <span class="math inline">\texttt{rmean}</span> argument equal to <span class="math inline">\tau</span> in the corresponding summary function:</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative code to estimate Kaplan-Meier estimator with survival package</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># instead of handmade KM</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>RMST_alternative <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">A1 =</span> <span class="dv">1</span>, <span class="at">A0 =</span> <span class="dv">0</span>, tau){</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate Kaplan-Meier estimator with survfit function on data subset</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Groupe A = 0</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  fit0 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T_obs, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> data[data<span class="sc">$</span>A <span class="sc">==</span> A0,]) </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Groupe A = 1</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  fit1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T_obs, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> data[data<span class="sc">$</span>A <span class="sc">==</span> A1,])  </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate the RMST with rmean</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  summary_fit0 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit0, <span class="at">rmean =</span> tau)  <span class="co"># RMST for A = 0</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  summary_fit1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit1, <span class="at">rmean =</span> tau)  <span class="co"># RMST for A = 1</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the RMST from the summary objects</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  rmst0 <span class="ot">&lt;-</span> summary_fit0<span class="sc">$</span>table[<span class="st">"rmean"</span>][[<span class="dv">1</span>]]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  rmst1 <span class="ot">&lt;-</span> summary_fit1<span class="sc">$</span>table[<span class="st">"rmean"</span>][[<span class="dv">1</span>]]</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the difference of RMST between the two groups</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  difference_rmst <span class="ot">&lt;-</span> rmst1 <span class="sc">-</span> rmst0</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(difference_rmst)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>IPCW Kaplan-Meier</strong></p>
<p>We first provide an <span class="math inline">\texttt{adjusted.KM}</span> function which is then used in the <span class="math inline">\texttt{IPCW\_Kaplan\_meier}</span> function to estimate the difference in RMST <span class="math inline">\hat{\theta}_{\mathrm{IPCW}}</span> as in <a href="#eq-thetaIPCWKM" class="quarto-xref">Equation&nbsp;29</a>. The survival censoring function <span class="math inline">G(t|X)</span> is computed with the <span class="math inline">\texttt{estimate\_survival\_function}</span> utility function from the <span class="math inline">\texttt{utilitary.R}</span> file.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaplan-Meier adjusted</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Times of event </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Failures:  1 if event, 0 if censored</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable:  1 if treated, 0 if control</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights:  Weight of the individual</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>adjusted.KM <span class="ot">&lt;-</span> <span class="cf">function</span>(times, failures, variable, <span class="at">weights =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sanity checks</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">sum</span>(times <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error: times must be positive"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(weights) <span class="sc">&amp;&amp;</span> <span class="fu">sum</span>(weights <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error: weights must be superior to 0"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">sum</span>(failures <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> failures <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Error: failures must be a vector of 0 or 1"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If 'weights' is NULL, initialize 'w' with ones of the same length as 'times', </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># otherwise use 'weights'</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(weights)) <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(times)) <span class="cf">else</span> weights</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a DataFrame 'data' with columns t (times), f (failures), </span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># v (stratification variable: often treatment variable), and w (weights)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">t =</span> times, <span class="at">f =</span> failures, <span class="at">v =</span> variable, <span class="at">w =</span> w)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows from the DataFrame where the stratification variable is NA</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data[<span class="sc">!</span><span class="fu">is.na</span>(data<span class="sc">$</span>v),]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty DataFrame to store the Kaplan-Meier results</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  table_KM <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">times =</span> <span class="cn">NULL</span>, <span class="at">n.risk =</span> <span class="cn">NULL</span>, <span class="at">n.event =</span> <span class="cn">NULL</span>, </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">survival =</span> <span class="cn">NULL</span>, <span class="at">variable =</span> <span class="cn">NULL</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over each unique value of the stratification variable</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(variable)) {</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset the data for the current stratification variable value</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> data[data<span class="sc">$</span>v <span class="sc">==</span> i,]</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a sorted vector of unique event times, including time 0 and the </span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># maximum time</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    tj <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">sort</span>(<span class="fu">unique</span>(d<span class="sc">$</span>t[d<span class="sc">$</span>f <span class="sc">==</span> <span class="dv">1</span>])), <span class="fu">max</span>(d<span class="sc">$</span>t))</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the number of events at each time point</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    dj <span class="ot">&lt;-</span> <span class="fu">sapply</span>(tj, <span class="cf">function</span>(x) {</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(d<span class="sc">$</span>w[d<span class="sc">$</span>t <span class="sc">==</span> x <span class="sc">&amp;</span> d<span class="sc">$</span>f <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the number of individuals at risk at each time point</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    nj <span class="ot">&lt;-</span> <span class="fu">sapply</span>(tj, <span class="cf">function</span>(x) {</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(d<span class="sc">$</span>w[d<span class="sc">$</span>t <span class="sc">&gt;=</span> x])</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the cumulative product for the survival probabilities</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    st <span class="ot">&lt;-</span> <span class="fu">cumprod</span>((nj <span class="sc">-</span> dj) <span class="sc">/</span> nj)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append the results to the Kaplan-Meier table</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    table_KM <span class="ot">&lt;-</span> <span class="fu">rbind</span>(table_KM, <span class="fu">data.frame</span>(<span class="at">T =</span> tj, <span class="at">n =</span> nj, <span class="at">d =</span> dj, </span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">S =</span> st, <span class="at">variable =</span> i))</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(table_KM)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="co"># IPCW Kaplan-Meier estimator with restricted tau</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>IPCW_Kaplan_meier <span class="ot">&lt;-</span> <span class="cf">function</span>(data, tau, </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                              X.names.censoring, </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute of truncated T_obs, status and censored status</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T_obs)</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>censor.status_tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>                                             (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>                                  (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate probability of remaining uncensored based on nuisance model </span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  S_C_hat <span class="ot">&lt;-</span> <span class="fu">estimate_survival_function</span>(<span class="at">data =</span> data, <span class="at">X.names =</span> X.names.censoring,</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.grid =</span> Y.grid, <span class="at">T_obs =</span> <span class="st">"T_obs_tau"</span>,</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">status =</span> <span class="st">"censor.status_tau"</span>,</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">type_of_model =</span> nuisance_censoring,</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds =</span> n.folds)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select the probability of censoring for each observed T_obs_tau from the </span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># curve</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>S_C <span class="ot">&lt;-</span> S_C_hat<span class="sc">$</span>S_hat[<span class="fu">cbind</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="fu">match</span>(data<span class="sc">$</span>T_obs_tau, Y.grid))]</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute IPC weights</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>weights <span class="ot">&lt;-</span> data<span class="sc">$</span>status_tau <span class="sc">/</span> data<span class="sc">$</span>S_C</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the adjusted IPCW Kaplan-Meier</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">adjusted.KM</span>(<span class="at">times =</span> data<span class="sc">$</span>T_obs, <span class="at">failures =</span> data<span class="sc">$</span>status, </span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>                   <span class="at">variable =</span> data<span class="sc">$</span>A, <span class="at">weights =</span> data<span class="sc">$</span>weights)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute differenceof RMST between the two groups</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>  RMST <span class="ot">&lt;-</span> <span class="fu">RMST_1</span>(<span class="at">S_A1 =</span> S[S<span class="sc">$</span>variable <span class="sc">==</span> <span class="dv">1</span>,], <span class="at">S_A0 =</span> S[S<span class="sc">$</span>variable <span class="sc">==</span> <span class="dv">0</span>,], <span class="at">tau =</span> tau)</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">RMST =</span> RMST<span class="sc">$</span>RMST,</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>              <span class="at">intA1 =</span> RMST<span class="sc">$</span>intA1,</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>              <span class="at">intA0 =</span> RMST<span class="sc">$</span>intA0,</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>              <span class="at">weights =</span> data<span class="sc">$</span>weights))</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>One could also use the <span class="math inline">\texttt{survfit}</span> function in the survival package <span class="citation" data-cites="Therneau_2001">(<a href="#ref-Therneau_2001" role="doc-biblioref">Therneau 2001</a>)</span> in adding IPCW weights for treated and control group and specify the <span class="math inline">\texttt{rmean}</span> argument equal to <span class="math inline">\tau</span> in the corresponding summary function:</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative code to estimate IPCW Kaplan-Meier, IPTW Kaplan-Meier or </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># IPTW-IPCW Kaplan-Meier estimator with survival package instead of using </span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># handmade adjusted.KM function (the weights need to be calculated before).</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights0 corresponds to weights of the control and weights1 of treated</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>Adjusted_Kaplan_meier_alternative <span class="ot">&lt;-</span> <span class="cf">function</span>(data, <span class="at">A1 =</span> <span class="dv">1</span>, <span class="at">A0 =</span> <span class="dv">0</span>, tau, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                          weights0, weights1){</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate Kaplan-Meier estimator with survfit function on data subset </span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Groupe A = 0</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  fit0 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T_obs, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> data[data<span class="sc">$</span>A <span class="sc">==</span> A0,], <span class="at">weights =</span> weights0)  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Groupe A = 1</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  fit1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T_obs, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> data[data<span class="sc">$</span>A <span class="sc">==</span> A1,], <span class="at">weights =</span> weights1)  </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate the RMST with rmean</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  summary_fit0 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit0, <span class="at">rmean =</span> tau)  <span class="co"># RMST for A = 0</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  summary_fit1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit1, <span class="at">rmean =</span> tau)  <span class="co"># RMST for A = 1</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the RMST from the summary objects</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  rmst0 <span class="ot">&lt;-</span> summary_fit0<span class="sc">$</span>table[<span class="st">"rmean"</span>][[<span class="dv">1</span>]]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  rmst1 <span class="ot">&lt;-</span> summary_fit1<span class="sc">$</span>table[<span class="st">"rmean"</span>][[<span class="dv">1</span>]]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the difference in RMST between the two groups</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  difference_rmst <span class="ot">&lt;-</span> rmst1 <span class="sc">-</span> rmst0</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(difference_rmst)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This alternative approach for IPCW Kaplan-Meier would also be valid for IPTW and IPTW-IPCW Kaplan-Meier.</p>
<p><strong>Buckley-James based estimator </strong></p>
<p>The function <span class="math inline">\texttt{BJ}</span> estimates <span class="math inline">\theta_{\mathrm{RMST}}</span> by implementing the Buckley-James estimator as in <a href="#eq-BJ" class="quarto-xref">Equation&nbsp;31</a>. It uses two functions available in the <span class="math inline">\texttt{utilitary.R}</span> file, namely <span class="math inline">\texttt{Q\_t\_hat}</span> and <span class="math inline">\texttt{Q\_Y}</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the Restricted Mean Survival Time (RMST) difference</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>BJ <span class="ot">&lt;-</span> <span class="cf">function</span>(data, tau, <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">nuisance =</span> <span class="st">"cox"</span>, <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Truncate observed times at tau</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T_obs)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Censoring status at tau</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                                (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Q_t for all time points</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  Q_t <span class="ot">&lt;-</span> <span class="fu">Q_t_hat</span>(data, tau, X.names.outcome, nuisance, n.folds)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Q_y <span class="ot">&lt;-</span> <span class="fu">Q_Y</span>(data, tau, Q_t)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Split data by treatment group</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  data_treated <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(A <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  data_not_treated <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(A <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate Restricted Survival Time (RST) for each group</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  data_treated<span class="sc">$</span>RST <span class="ot">&lt;-</span> data_treated<span class="sc">$</span>status_tau <span class="sc">*</span> data_treated<span class="sc">$</span>T_obs_tau <span class="sc">+</span> </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                      (<span class="dv">1</span> <span class="sc">-</span> data_treated<span class="sc">$</span>status_tau) <span class="sc">*</span> data_treated<span class="sc">$</span>Q_y</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  data_not_treated<span class="sc">$</span>RST <span class="ot">&lt;-</span> data_not_treated<span class="sc">$</span>status_tau <span class="sc">*</span> data_not_treated<span class="sc">$</span>T_obs_tau <span class="sc">+</span> </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                          (<span class="dv">1</span> <span class="sc">-</span> data_not_treated<span class="sc">$</span>status_tau) <span class="sc">*</span> data_not_treated<span class="sc">$</span>Q_y</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate RMST difference between treated and not treated</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  RMST <span class="ot">&lt;-</span> <span class="fu">mean</span>(data_treated<span class="sc">$</span>RST) <span class="sc">-</span> <span class="fu">mean</span>(data_not_treated<span class="sc">$</span>RST)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return RMST and other relevant metrics</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMST =</span> RMST, </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">ATE_treated =</span> <span class="fu">mean</span>(data_treated<span class="sc">$</span>RST), </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">ATE_not_treated =</span> <span class="fu">mean</span>(data_not_treated<span class="sc">$</span>RST)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>IPTW Kaplan-Meier</strong></p>
<p>The function <span class="math inline">\texttt{IPTW\_Kaplan\_meier}</span> implements the IPTW-KM estimator in <a href="#eq-RMST_IPTWKM" class="quarto-xref">Equation&nbsp;39</a>. It uses the <span class="math inline">\texttt{estimate\_propensity\_score}</span> function from the <span class="math inline">\texttt{utilitary.R}</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate IPTW Kaplan-Meier</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>IPTW_Kaplan_meier <span class="ot">&lt;-</span> <span class="cf">function</span>(data, tau, X.names.propensity, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>, <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate propensity scores</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>e_hat <span class="ot">&lt;-</span> <span class="fu">estimate_propensity_score</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_covariates =</span> X.names.propensity,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">type_of_model =</span> nuisance_propensity,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.folds =</span> n.folds)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Truncate observed times at tau</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">pmin</span>(data<span class="sc">$</span>T_obs, tau)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define censoring status at tau</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                                (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate weights</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>weights <span class="ot">&lt;-</span> (data<span class="sc">$</span>A) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> data<span class="sc">$</span>e_hat) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>e_hat)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjusted Kaplan-Meier estimator</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">adjusted.KM</span>(</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> data<span class="sc">$</span>T_obs, </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">failures =</span> data<span class="sc">$</span>status,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> data<span class="sc">$</span>A, </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> data<span class="sc">$</span>weights)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate RMST from the adjusted survival curves</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  RMST <span class="ot">&lt;-</span> <span class="fu">RMST_1</span>(<span class="at">S_A1 =</span> S[S<span class="sc">$</span>variable <span class="sc">==</span> <span class="dv">1</span>,], </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>                 <span class="at">S_A0 =</span> S[S<span class="sc">$</span>variable <span class="sc">==</span> <span class="dv">0</span>,], </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                 <span class="at">tau =</span> tau)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">"intA0"</span> <span class="ot">=</span> RMST<span class="sc">$</span>intA0, <span class="st">"intA1"</span> <span class="ot">=</span> RMST<span class="sc">$</span>intA1, <span class="st">"RMST"</span> <span class="ot">=</span> RMST<span class="sc">$</span>RMST))</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>G-formula</strong></p>
<p>We implement two versions of the G-formula: <span class="math inline">\texttt{g\_formula\_T\_learner}</span> and <span class="math inline">\texttt{g\_formula\_S\_learner}</span>. In <span class="math inline">\texttt{g\_formula\_T\_learner}</span>, separate models estimate survival curves for treated and control groups, whereas <span class="math inline">\texttt{g\_formula\_S\_learner}</span> uses a single model incorporating both covariates and treatment status to estimate survival time. The latter approach is also available in the RISCA package but is limited to Cox models.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to estimate the g-formula Two-learner.</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>g_formula_T_learner <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                X.names.outcome, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                tau, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute min(T_obs,tau)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T_obs)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Y.grid is the grid of time points where we want to estimate the </span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># survival function.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  S_hat <span class="ot">&lt;-</span> <span class="fu">estimate_survival_function</span>(data, X.names.outcome, </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                                      Y.grid, </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">type_of_model =</span> nuisance_survival,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">T_obs =</span> <span class="st">"T_obs"</span>, </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">status =</span> <span class="st">"status"</span>, </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds =</span> n.folds)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the area under each survival curve up to max(Y.grid) = tau.</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  E_hat1 <span class="ot">&lt;-</span> <span class="fu">expected_survival</span>(S_hat<span class="sc">$</span>S_hat1, Y.grid)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  E_hat0 <span class="ot">&lt;-</span> <span class="fu">expected_survival</span>(S_hat<span class="sc">$</span>S_hat0, Y.grid)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the mean difference.</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  theta_g_formula <span class="ot">&lt;-</span> <span class="fu">mean</span>(E_hat1 <span class="sc">-</span> E_hat0)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(theta_g_formula)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to estimate the g-formula Single-learner.</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>g_formula_S_learner <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                                X.names.outcome, </span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                                tau, </span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                                <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute min(T_obs,tau)</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T_obs)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Y.grid is the grid of time points where we want to estimate the </span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># survival function.</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  S_hat <span class="ot">&lt;-</span> <span class="fu">estimate_survival_function</span>(data, X.names.outcome, </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>                                      Y.grid, </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">type_of_model =</span> nuisance_survival,</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">learner =</span> <span class="st">"S-learner"</span>,</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">T_obs =</span> <span class="st">"T_obs"</span>, </span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">status =</span> <span class="st">"status"</span>, </span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds =</span> n.folds)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the area under each survival curve until max(Y.grid) = tau.</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  E_hat1 <span class="ot">&lt;-</span> <span class="fu">expected_survival</span>(S_hat<span class="sc">$</span>S_hat1, Y.grid)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  E_hat0 <span class="ot">&lt;-</span> <span class="fu">expected_survival</span>(S_hat<span class="sc">$</span>S_hat0, Y.grid)</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the mean difference.</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  theta_g_formula <span class="ot">&lt;-</span> <span class="fu">mean</span>(E_hat1 <span class="sc">-</span> E_hat0)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(theta_g_formula)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>IPTW-IPCW Kaplan-Meier</strong></p>
<p>The <span class="math inline">\texttt{IPTW\_IPCW\_Kaplan\_meier}</span> function implements the IPTW-IPCW Kaplan Meier estimator from <a href="#eq-RMST_IPTW_IPCWKM" class="quarto-xref">Equation&nbsp;41</a>. It uses the utilitary functions from the <span class="math inline">\texttt{utilitary.R}</span> file <span class="math inline">\texttt{estimate\_propensity\_score}</span> and <span class="math inline">\texttt{estimate\_survival\_function}</span> to estimate the nuisance parameters, and the function <span class="math inline">\texttt{adjusted.KM}</span> which computes an adjusted Kaplan Meier estimator using the appropriate weight.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>IPTW_IPCW_Kaplan_meier <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                                   X.names.propensity, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                                   X.names.censoring, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                                   tau,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Censoring time to tau if observed time exceeds tau</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T_obs)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create censoring status for tau</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>censor.status_tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                                           (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create status at tau</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>                                (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Grid of unique observed times truncated at tau</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate propensity scores</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>e_hat <span class="ot">&lt;-</span> <span class="fu">estimate_propensity_score</span>(data,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">treatment_covariates =</span> X.names.propensity,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">type_of_model =</span> nuisance_propensity,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">n.folds =</span> n.folds)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate survival function for censoring</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  S_C_hat <span class="ot">&lt;-</span> <span class="fu">estimate_survival_function</span>(data, <span class="at">X.names =</span> X.names.censoring,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.grid =</span> Y.grid, <span class="at">T_obs =</span> <span class="st">"T_obs_tau"</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">status =</span> <span class="st">"censor.status_tau"</span>,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">type_of_model =</span> nuisance_censoring,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds =</span> n.folds)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get estimated survival probabilities for censoring</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>S_C <span class="ot">&lt;-</span> S_C_hat<span class="sc">$</span>S_hat[<span class="fu">cbind</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="fu">match</span>(data<span class="sc">$</span>T_obs_tau, Y.grid))]</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate weights</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>weights <span class="ot">&lt;-</span> data<span class="sc">$</span>status_tau <span class="sc">/</span> data<span class="sc">$</span>S_C <span class="sc">*</span> </span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                  (data<span class="sc">$</span>A <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> data<span class="sc">$</span>e_hat) <span class="sc">+</span> </span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                     (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>e_hat)))</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute adjusted Kaplan-Meier estimator</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">adjusted.KM</span>(<span class="at">times =</span> data<span class="sc">$</span>T_obs, </span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                   <span class="at">failures =</span> data<span class="sc">$</span>status, </span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>                   <span class="at">variable =</span> data<span class="sc">$</span>A, </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                   <span class="at">weights =</span> data<span class="sc">$</span>weights)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Restricted Mean Survival Time (RMST)</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  RMST <span class="ot">&lt;-</span> <span class="fu">RMST_1</span>(<span class="at">S_A1 =</span> S[S<span class="sc">$</span>variable <span class="sc">==</span> <span class="dv">1</span>, ], </span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                 <span class="at">S_A0 =</span> S[S<span class="sc">$</span>variable <span class="sc">==</span> <span class="dv">0</span>, ],</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                 <span class="at">tau =</span> tau)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return RMST and ATE for treated and not treated groups</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">RMST =</span> RMST<span class="sc">$</span>RMST, <span class="at">ATE_treated =</span> RMST<span class="sc">$</span>intA1, </span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">ATE_not_treated =</span> RMST<span class="sc">$</span>intA0))</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>IPTW-BJ estimator</strong></p>
<p>The <span class="math inline">\texttt{IPTW\_BJ}</span> implements the IPTW-BJ estimator in <a href="#eq-iptwbj" class="quarto-xref">Equation&nbsp;42</a>. It uses the utilitary functions, from the <span class="math inline">\texttt{utilitary.R}</span> file, <span class="math inline">\texttt{estimate\_propensity\_score}</span>, <span class="math inline">\texttt{Q\_t\_hat}</span> and <span class="math inline">\texttt{Q\_Y}</span> to estimate the nuisance parameters.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>IPTW_BJ <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                    X.names.propensity,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                    X.names.outcome, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                    tau,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nuisance =</span> <span class="st">"cox"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Minimum of T_obs and tau</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T_obs)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Grid of unique observed times truncated at tau</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Indicator for min(T, tau) &lt; C</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                                (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate propensity scores</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>e_hat <span class="ot">&lt;-</span> <span class="fu">estimate_propensity_score</span>(data,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">treatment_covariates =</span> X.names.propensity,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">type_of_model =</span> nuisance_propensity,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">n.folds =</span> n.folds)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimation of Q_s</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  Q_t <span class="ot">&lt;-</span> <span class="fu">Q_t_hat</span>(data, tau, X.names.outcome, nuisance, n.folds)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Q_y <span class="ot">&lt;-</span>  <span class="fu">Q_Y</span>(data,tau,Q_t)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># BJ transformation</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Y <span class="ot">&lt;-</span>  data<span class="sc">$</span>status_tau <span class="sc">*</span> data<span class="sc">$</span>T_obs_tau <span class="sc">+</span> </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                             (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>status_tau) <span class="sc">*</span> data<span class="sc">$</span>Q_y</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># IPTW on BJ transformation </span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>RST <span class="ot">&lt;-</span> data<span class="sc">$</span>Y <span class="sc">*</span> (data<span class="sc">$</span>A<span class="sc">/</span>data<span class="sc">$</span>e_hat<span class="sc">-</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>A)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>e_hat))</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  RMST <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>RST)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return RMST</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(RMST)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>AIPTW-AIPCW</strong></p>
<p>The <span class="math inline">\texttt{AIPTW\_AIPCW}</span> function implements the AIPTW_AIPCW estimator in <a href="#eq-AIPTW_AIPCW" class="quarto-xref">Equation&nbsp;43</a> using the utilitary function from the <span class="math inline">\texttt{utilitary.R}</span> file <span class="math inline">\texttt{estimate\_propensity\_score}</span>, <span class="math inline">\texttt{Q\_t\_hat}</span>, <span class="math inline">\texttt{Q\_Y}</span>, and <span class="math inline">\texttt{estimate\_survival\_function}</span> to estimate the nuisance parameters.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DR censoring transformation</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>AIPCW <span class="ot">&lt;-</span><span class="cf">function</span>(data,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                 tau,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">nuisance_Qt =</span> <span class="st">"cox"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n.folds =</span> <span class="cn">NULL</span>, </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">h_C_hat =</span> <span class="cn">NULL</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method_aipw =</span> <span class="dv">1</span>) {</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Truncate observed times at tau</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">pmin</span>(data<span class="sc">$</span>T_obs, tau)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define status at tau</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>status_tau <span class="ot">&lt;-</span>  <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;</span> tau) <span class="sc">|</span> </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                                  (data<span class="sc">$</span>T_obs <span class="sc">&lt;=</span> tau <span class="sc">&amp;</span>  data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span> ))  </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>censor.status_tau <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span> <span class="fu">as.numeric</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    (data<span class="sc">$</span>T_obs <span class="sc">&gt;</span> tau) <span class="sc">|</span> (data<span class="sc">$</span>T_obs <span class="sc">&lt;=</span> tau <span class="sc">&amp;</span>  data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span> ))</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate survival function for censoring</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  S_C_hat <span class="ot">&lt;-</span> <span class="fu">estimate_survival_function</span>(<span class="at">data =</span> data,X.names.censoring,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">type_of_model =</span> nuisance_censoring,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds =</span> n.folds,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.grid =</span> Y.grid,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">T_obs =</span> <span class="st">"T_obs_tau"</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">status =</span> <span class="st">"censor.status_tau"</span>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  Y.index <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(data<span class="sc">$</span>T_obs_tau, Y.grid)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>S_C_hat_T_obs_tau <span class="ot">&lt;-</span> S_C_hat<span class="sc">$</span>S_hat[<span class="fu">cbind</span>(<span class="fu">seq_along</span>(Y.index), Y.index)]</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(h_C_hat)) {</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>      h_C_hat <span class="ot">&lt;-</span> <span class="fu">estimate_hazard_function</span>(S_C_hat<span class="sc">$</span>S_hat,Y.grid)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Q.t.hat</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  Q.t.hat <span class="ot">&lt;-</span> <span class="fu">Q_t_hat</span>(<span class="at">data =</span> data,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                     <span class="at">X.names =</span> X.names.outcome,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tau =</span> tau,</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nuisance =</span> nuisance_Qt,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">n.folds =</span> n.folds)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Q.Y.hat</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>Q.Y.hat <span class="ot">&lt;-</span> <span class="fu">Q_Y</span>(<span class="at">data =</span> data, tau, Q.t.hat)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute first term</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>first_term <span class="ot">&lt;-</span> (data<span class="sc">$</span>T_obs_tau <span class="sc">*</span> data<span class="sc">$</span>status_tau) <span class="sc">/</span> </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>S_C_hat_T_obs_tau</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute second term</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>second_term <span class="ot">&lt;-</span> (data<span class="sc">$</span>Q.Y.hat <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>status_tau)) <span class="sc">/</span> </span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>S_C_hat_T_obs_tau</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>  Y.diff <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, Y.grid))</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute integrand for the third term</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>  integrand <span class="ot">&lt;-</span> <span class="fu">sweep</span>( ( (h_C_hat) <span class="sc">/</span> S_C_hat<span class="sc">$</span>S_hat )<span class="sc">*</span> (Q.t.hat), <span class="dv">2</span>, Y.diff, <span class="st">"*"</span>)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute third term</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>third_term <span class="ot">&lt;-</span> <span class="fu">integrate</span>(integrand, Y.grid, data<span class="sc">$</span>T_obs_tau)</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute pseudo outcome</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>  pseudo_outcome <span class="ot">&lt;-</span> data<span class="sc">$</span>first_term <span class="sc">+</span> data<span class="sc">$</span>second_term <span class="sc">-</span> data<span class="sc">$</span>third_term</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pseudo_outcome) </span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>AIPTW_AIPCW <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>                        tau, </span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>                        <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>                        <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>                        <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>,</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nuisance_regression =</span> <span class="st">"cox"</span>,</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>,</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nuisance_Qt =</span> <span class="st">"cox"</span>,</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n.folds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate propensity scores</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>e_hat <span class="ot">&lt;-</span> <span class="fu">estimate_propensity_score</span>(</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data, </span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_covariates =</span> X.names.propensity, </span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">type_of_model =</span> nuisance_propensity, </span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.folds =</span> n.folds</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare data for censoring model</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T_obs_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T_obs)</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>censor.status_tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>                                             (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((data<span class="sc">$</span>T_obs <span class="sc">&gt;=</span> tau) <span class="sc">|</span> </span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>                                  (data<span class="sc">$</span>T_obs <span class="sc">&lt;</span> tau <span class="sc">&amp;</span> data<span class="sc">$</span>status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create unique time grid</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>  Y.grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>T_obs_tau))</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>  S_hat <span class="ot">&lt;-</span> <span class="fu">estimate_survival_function</span>(data, X.names.outcome, </span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">type_of_model =</span> nuisance_regression, </span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">Y.grid =</span> Y.grid,</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">T_obs=</span> <span class="st">"T_obs"</span>, </span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">status =</span> <span class="st">"status"</span>, </span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds =</span> n.folds)</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute area under the survival curve up to tau</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>E_hat1 <span class="ot">&lt;-</span> <span class="fu">expected_survival</span>(S_hat<span class="sc">$</span>S_hat1, Y.grid)</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>E_hat0 <span class="ot">&lt;-</span> <span class="fu">expected_survival</span>(S_hat<span class="sc">$</span>S_hat0, Y.grid)</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute IPW-weighted residuals</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>IPW_res <span class="ot">&lt;-</span> data<span class="sc">$</span>E_hat1 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A <span class="sc">/</span> data<span class="sc">$</span>e_hat) <span class="sc">-</span> </span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>E_hat0 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>e_hat))</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute AIPCW weights</span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>  TDR <span class="ot">&lt;-</span> <span class="fu">AIPCW</span>(</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data, </span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> tau,</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">nuisance_Qt =</span> nuisance_Qt, </span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">nuisance_censoring =</span> nuisance_censoring, </span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.folds =</span> n.folds</span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>TDR <span class="ot">&lt;-</span> TDR</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute AIPCW-weighted residuals</span></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>AIPCW_w <span class="ot">&lt;-</span> data<span class="sc">$</span>TDR <span class="sc">*</span> (data<span class="sc">$</span>A <span class="sc">/</span> data<span class="sc">$</span>e_hat <span class="sc">-</span> </span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>                                (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>e_hat))</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute regression residuals</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>reg <span class="ot">&lt;-</span> data<span class="sc">$</span>E_hat1 <span class="sc">-</span> data<span class="sc">$</span>E_hat0</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>reg_res <span class="ot">&lt;-</span> data<span class="sc">$</span>A <span class="sc">/</span> data<span class="sc">$</span>e_hat <span class="sc">*</span> (data<span class="sc">$</span>TDR <span class="sc">-</span> data<span class="sc">$</span>E_hat1) <span class="sc">-</span> </span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>A) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> data<span class="sc">$</span>e_hat) <span class="sc">*</span> (data<span class="sc">$</span>TDR <span class="sc">-</span> data<span class="sc">$</span>E_hat0)</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute estimators</span></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># na.rm = TRUE to remove NA for the mean calculation</span></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>  AIPTW_AIPCW_IPW_res <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>AIPCW_w <span class="sc">+</span> data<span class="sc">$</span>IPW_res, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>  AIPTW_AIPCW_reg_res <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>reg <span class="sc">+</span> data<span class="sc">$</span>reg_res, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">AIPTW_AIPCW_reg_res =</span> AIPTW_AIPCW_reg_res, </span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>              <span class="at">AIPTW_AIPCW_IPW_res =</span> AIPTW_AIPCW_IPW_res))</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sec-package" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="sec-package"><span class="header-section-number">4.3</span> Available packages</h2>
<p>Currently, there are few sustained implementations available for estimating RMST in the presence of right censoring. Notable exceptions include the packages <a href="https:%20//cran.r-project.org/web/packages/survRM2/index.html">survRM2</a> <span class="citation" data-cites="SurvRM2_2015">(<a href="#ref-SurvRM2_2015" role="doc-biblioref">Hajime et al. 2015</a>)</span>, <a href="https:%20//cran.r-project.org/web/packages/grf/index.html">grf</a> <span class="citation" data-cites="Tibshirani_Athey_Sverdrup_Wager_2017">(<a href="#ref-Tibshirani_Athey_Sverdrup_Wager_2017" role="doc-biblioref">Tibshirani et al. 2017</a>)</span> and <a href="https://cran.r-project.org/web/packages/RISCA/index.html">RISCA</a> <span class="citation" data-cites="Foucher_Le_Borgne_Chatton_2019">(<a href="#ref-Foucher_Le_Borgne_Chatton_2019" role="doc-biblioref">Foucher, Le Borgne, and Chatton 2019</a>)</span>. Those packages are implemented in the <span class="math inline">\texttt{utilitary.R}</span> files.</p>
<p><strong>SurvRM2</strong></p>
<p>The difference in RMST with Unadjusted Kaplan-Meier <span class="math inline">\hat \theta_{KM}</span> (<a href="#eq-thetaunadjKM" class="quarto-xref">Equation&nbsp;14</a>) can be obtained using the function <span class="math inline">\texttt{rmst2}</span> which takes as arguments the observed time-to-event, the status, the arm which corresponds to the treatment and <span class="math inline">\tau</span>.</p>
<p><strong>RISCA</strong></p>
<p>The RISCA package provides several methods for estimating <span class="math inline">\theta_{\mathrm{RMST}}</span>. The difference in RMST with Unadjusted Kaplan-Meier <span class="math inline">\hat \theta_{KM}</span> (<a href="#eq-thetaunadjKM" class="quarto-xref">Equation&nbsp;14</a>) can be derived using the <span class="math inline">\texttt{survfit}</span> function from the the survival package <span class="citation" data-cites="Therneau_2001">(<a href="#ref-Therneau_2001" role="doc-biblioref">Therneau 2001</a>)</span> which estimates Kaplan-Meier survival curves for treated and control groups, and then the <span class="math inline">\texttt{rmst}</span> function calculates the RMST by integrating these curves, applying the rectangle method (type=“s”), which is well-suited for step functions.</p>
<p>The IPTW Kaplan-Meier (<a href="#eq-IPTWKM" class="quarto-xref">Equation&nbsp;38</a>) can be applied using the <span class="math inline">\texttt{ipw.survival}</span> and <span class="math inline">\texttt{rmst}</span> functions. The ipw.survival function requires user-specified weights (i.e.&nbsp;propensity scores). To streamline this process, we define the <span class="math inline">\texttt{RISCA\_iptw}</span> function, which combines these steps and utilizes the <span class="math inline">\texttt{estimate\_propensity\_score}</span> from the <span class="math inline">\texttt{utilitary.R}</span> file.</p>
<p>A single-learner version of the G-formula, as introduced in <a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a>, can be implemented using the <span class="math inline">\texttt{gc.survival}</span> function. This function requires as input the conditional survival function which should be estimated beforehand with a Cox model via the <span class="math inline">\texttt{coxph}</span> function from the <span class="math inline">\texttt{survival}</span> package <span class="citation" data-cites="Therneau_2001">(<a href="#ref-Therneau_2001" role="doc-biblioref">Therneau 2001</a>)</span>. Specifically, the single-learner approach applies a single Cox model incorporating both covariates and treatment, rather than separate models for each treatment arm. We provide a function <span class="math inline">\texttt{RISCA\_gf}</span> that consolidates these steps.</p>
<p><strong>grf</strong></p>
<p>The <span class="math inline">\texttt{grf}</span> package <span class="citation" data-cites="Tibshirani_Athey_Sverdrup_Wager_2017">(<a href="#ref-Tibshirani_Athey_Sverdrup_Wager_2017" role="doc-biblioref">Tibshirani et al. 2017</a>)</span> enables estimation of the difference between RMST using the Causal Survival Forest approach <span class="citation" data-cites="HTE_causal_survival_forests">(<a href="#ref-HTE_causal_survival_forests" role="doc-biblioref">Cui et al. 2023</a>)</span>, which extends the non-parametric causal forest framework to survival data. The RMST can be estimated with the <span class="math inline">\texttt{causal\_survival\_forest}</span> function, requiring covariates <span class="math inline">X</span>, observed event times, event status, treatment assignment, and the time horizon <span class="math inline">\tau</span> as inputs. The <span class="math inline">\texttt{average\_treatment\_effect}</span> function then evaluates the treatment effect based on predictions from the fitted forest.</p>
</section>
</section>
<section id="sec-simulation" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Simulations</h1>
<p>We compare the behaviors and performances of the estimators through simulations conducted across various experiemental contexts. These contexts include scenarios based on RCTs and observational data, with both independent and dependent censoring. We also use semi-parametric and non-parametric models to generate censoring and survival times, as well as logistic and nonlinear models to simulate treatment assignment.</p>
<section id="sec-simulation-RCT" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="sec-simulation-RCT"><span class="header-section-number">5.1</span> RCT</h2>
<p><strong>Data Generating Process</strong></p>
<p>We generate RCTs with independent censoring (Scenario 1) and conditionally independent censoring (Scenario 2). <!-- The survival time and the censoring time (when there is dependency --> <!-- between the censoring time and the covariates) is simulated using the --> <!-- cumulative hazard inversion method for exponential models [@Leemis_1990; @Bender_2005].  --> We sample <span class="math inline">n</span> iid datapoints <span class="math inline">(X_{i},A_{i},C,T_{i}(0), T_{i}(1))_{i \in [n]}</span> where <span class="math inline">T_{i}(0), T_{i}(1)</span> and <span class="math inline">C</span> follows Cox’s models. More specifically, we set</p>
<ul>
<li><p><span class="math inline">X \sim \mathcal{N}\left(\mu,\Sigma\right)</span> where <span class="math inline">\mu = (1,1,-1,1)</span> and <span class="math inline">\Sigma = \mathrm{Id}_4</span>.</p></li>
<li><p>The hazard function of <span class="math inline">T(0)</span> is <span class="math display">\lambda^{(0)}(t|X)= 0.01  \exp \left\{ \beta_0^\top X\right\} \quad \text{where} \quad \beta_0 = (0.5,0.5,-0.5,0.5).
</span></p></li>
<li><p>The survival times in the treatment group are given by <span class="math inline">T(1) = T(0) + 10</span>.</p></li>
<li><p>The hazard function of the censoring time <span class="math inline">C</span> is simply taken as <span class="math inline">\lambda_C(t|X)=0.03</span> in Scenario 1, and in Scenario 2 as <span class="math display">\lambda_C(t|X)=0.03 \cdot \exp \left\{\beta_C^\top X\right\} \quad \text{where} \quad \beta_C = (0.7,0.7,-0.25,-0.1).</span></p></li>
<li><p>The treatment allocation is independent of <span class="math inline">X</span>: <span class="math inline">e(X)=0.5</span>.</p></li>
</ul>
<!-- -   the survival time is $T=A T(1)+(1-A) T(0)$. -->
<!-- -   The observed time is $\widetilde{T}=\min (T, C)$. -->
<!-- -   The status is $\Delta=1(T \leq C)$. -->
<ul>
<li>The threshold time <span class="math inline">\tau</span> is set to 25.</li>
</ul>
<!-- The observed samples are $(X_{i},A_{i},\Delta_{i},\widetilde{T_{i}})$. -->
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">############ RCT </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># RCT1:  Random treatment assignment + independent censoring</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># RCT2:  Random treatment assignment + dependent censoring (conditional on X </span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># and A)</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>simulate_data_RCT <span class="ot">&lt;-</span> <span class="cf">function</span>(n, <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sigma =</span> <span class="fu">diag</span>(<span class="dv">4</span>), </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">colnames_cov =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                              tau, </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">coefT0 =</span> <span class="fl">0.01</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsS =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>), </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">coefC =</span> <span class="fl">0.03</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="sc">-</span><span class="fl">0.1</span>), </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC_A =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>), </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">scenario =</span> <span class="st">"RCT2"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mis_specification=</span><span class="st">"none"</span>) {</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate X from a multivariate normal distribution</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n, mu, sigma)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(X)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> colnames_cov</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Treatment variable selection: all X</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  X_treatment <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Propensity score: constant for random assignment</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.5</span>, n)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Random treatment assignment</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">sapply</span>(e, <span class="at">FUN =</span> <span class="cf">function</span>(p) <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, p))</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome variable selection: all X</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  X_outcome <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate the outcome using the cumulative hazard inversion method</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">1e-8</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  T0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(epsilon) <span class="sc">/</span> (coefT0 <span class="sc">*</span> <span class="fu">exp</span>(X_outcome <span class="sc">%*%</span> parsS))</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"RCT1"</span>) {</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate independent censoring time</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    epsilon <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">1e-8</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    C <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(epsilon) <span class="sc">/</span> coefC</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"RCT2"</span>) {</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulate dependent censoring time</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    X_censoring <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(X,A))</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    parsC <span class="ot">&lt;-</span> <span class="fu">c</span>(parsC,parsC_A)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    epsilon <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">1e-8</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    C <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(epsilon) <span class="sc">/</span> (coefC <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">rowSums</span>(X_censoring <span class="sc">%*%</span> <span class="fu">diag</span>(parsC))))</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># T(1) = T(0) + 10</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  T1 <span class="ot">&lt;-</span> T0 <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True survival time</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  T_true <span class="ot">&lt;-</span> A <span class="sc">*</span> T1 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">*</span> T0</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observed time</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  T_obs <span class="ot">&lt;-</span> <span class="fu">pmin</span>(T_true, C)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Status indicator</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  status <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(T_true <span class="sc">&lt;=</span> C)</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  censor.status <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(T_true <span class="sc">&gt;</span> C)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restricted survival time</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>  T_obs_tau <span class="ot">&lt;-</span> <span class="fu">pmin</span>(T_obs, tau)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>  status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((T_obs <span class="sc">&gt;</span> tau) <span class="sc">|</span> (T_obs <span class="sc">&lt;=</span> tau <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all data into a single data frame</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>  data_target_population <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X, tau, A, T0, T1, C, T_obs, T_obs_tau, </span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                                       status, censor.status, status_tau, e)</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data_target_population)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The descriptive statistics of the two datasets are displayed in Annex (<a href="#sec-stat_RCT" class="quarto-xref">Section&nbsp;8.1</a>). The graph of the difference in RMST as a function of <span class="math inline">\tau</span> for the two scenarii are displayed below; <span class="math inline">\theta_{\mathrm{RMST}}</span> is the same in both setting.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate ground truth for RCT and Observational data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ground_truth <span class="ot">&lt;-</span> <span class="cf">function</span>(tau, </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                         data) {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute RMST with the true T1</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T1_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T1 <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T1)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute RMST with the true T0</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>T0_tau <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(data<span class="sc">$</span>T0 <span class="sc">&gt;=</span> tau, tau, data<span class="sc">$</span>T0)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the difference in RMST if everyone had the treatment </span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and if everyone had the control</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  truth <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>T1_tau) <span class="sc">-</span> <span class="fu">mean</span>(data<span class="sc">$</span>T0_tau)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(truth)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Notebook_causal_survival_files/figure-html/unnamed-chunk-13-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The ground truth for RCT scenario 1 and 2 at time 25 is 7.1"</code></pre>
</div>
</div>
<p><strong>Estimation of the RMST</strong></p>
<p>For each Scenario, we estimate the difference in RMST using the methods summarized in <a href="#sec-summary" class="quarto-xref">Section&nbsp;4.1</a>. The methods used to estimate the nuisance components are indicated in brackets: either logistic regression or random forests for propensity scores and either cox models or survival random forests for survival and censoring models. A naive estimator where censored observations are simply removed and the survival time is averaged for treated and controls is also provided for a naive baseline.</p>
<p><a href="#fig-rct1" class="quarto-xref">Figure&nbsp;8</a> shows the distribution of the difference in RMST for 100 simulations in Scenario 1 and different sample sizes: 500, 1000, 2000, 4000. The true value of <span class="math inline">\theta_{\mathrm{RMST}}</span> is indicated by red dotted line.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to launch the previous implemented functions in a </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># specified scenario, sample size.</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>all_estimates <span class="ot">&lt;-</span> <span class="cf">function</span>(data, sample.size, tau, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                           X.names.propensity,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                           X.names.censoring,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                           X.names.outcome,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds =</span> <span class="cn">NULL</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">estimator =</span> <span class="st">"all"</span>) {</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of available estimators</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  available_estimators <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Naive"</span>, <span class="st">"KM"</span>, <span class="st">"IPTW KM"</span>, <span class="st">"IPCW KM"</span>, <span class="st">"BJ"</span>, </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"IPTW-IPCW KM"</span>, <span class="st">"IPTW-BJ"</span>, <span class="st">"G_formula (T-learners)"</span>, </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G_formula (S-learner)"</span>, <span class="st">"AIPTW-AIPCW"</span>, <span class="st">"SurvRM2 - KM"</span>, </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grf - Causal Survival Forest"</span>, <span class="st">"RISCA - IPTW KM"</span>, </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RISCA - G_formula (S-learner)"</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If estimator is "all", we select all the estimators in </span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># available_estimators</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"all"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    estimator <span class="ot">&lt;-</span> available_estimators</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter the selected estimators</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  estimator <span class="ot">&lt;-</span> <span class="fu">intersect</span>(estimator, available_estimators)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the results in a data frame</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample.size"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimate"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimator"</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">character</span>()</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to extract variable names from I() for squared terms and interaction terms</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  extract_vars <span class="ot">&lt;-</span> <span class="cf">function</span>(names) {</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract names from squared terms</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    extracted_squared <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"I</span><span class="sc">\\</span><span class="st">((.*)</span><span class="sc">\\</span><span class="st">^2</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, names)  <span class="co"># Replace "I(X^2)" with "X"</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract names from interaction terms (e.g., "X1:X2" becomes "X1" and "X2")</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    result_vector <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(extracted_squared, <span class="st">":"</span>)))</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">unique</span>(result_vector))</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all vectors</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  all_names <span class="ot">&lt;-</span> <span class="fu">c</span>(X.names.propensity, X.names.outcome, X.names.censoring)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply the extraction function</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  X.names <span class="ot">&lt;-</span> <span class="fu">extract_vars</span>(all_names)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each estimator is computed if selected</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Naive estimator</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"Naive"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    ATE_naive <span class="ot">&lt;-</span> <span class="fu">Naive</span>(data, tau)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_naive, </span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"Naive"</span>, <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with undajusted KM</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    ATE_km_rct <span class="ot">&lt;-</span> <span class="fu">RMST_1</span>(data, <span class="at">tau =</span> tau)</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_km_rct<span class="sc">$</span>RMST, </span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"KM"</span>, <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPTW KM</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPTW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>      ATE_km_adj <span class="ot">&lt;-</span> <span class="fu">IPTW_Kaplan_meier</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW KM ("</span>, propensity_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_km_adj<span class="sc">$</span>RMST, </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, <span class="st">"nuisance"</span> <span class="ot">=</span> propensity_method</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPCW KM</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPCW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (censoring_method <span class="cf">in</span> nuisance_censoring) {</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>      ATE_IPCW <span class="ot">&lt;-</span> <span class="fu">IPCW_Kaplan_meier</span>(data, <span class="at">X.names.censoring =</span> X.names.censoring, </span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">tau =</span> tau, </span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">nuisance_censoring =</span> censoring_method, </span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (censoring_method <span class="sc">==</span> <span class="st">"survival forest"</span>){censoring_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{censoring_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPCW KM ("</span>, censoring_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_IPCW<span class="sc">$</span>RMST, </span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name , <span class="st">"nuisance"</span> <span class="ot">=</span> censoring_method</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with BJ pseudo observations</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"BJ"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>      ATE_bj <span class="ot">&lt;-</span> <span class="fu">BJ</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>                   <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nuisance =</span> survival_method, </span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"BJ ("</span>, survival_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_bj<span class="sc">$</span>RMST, </span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, <span class="st">"nuisance"</span> <span class="ot">=</span> survival_method</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with g-formula two-learners</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"G_formula (T-learners)"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>      ATE_g_formula_t <span class="ot">&lt;-</span> <span class="fu">g_formula_T_learner</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.outcome =</span> X.names.outcome, </span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_survival =</span> survival_method, </span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"G-formula ("</span>, survival_name, <span class="st">"/ T-learners)"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_g_formula_t, </span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nuisance"</span> <span class="ot">=</span> survival_method</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with g-formula single learner</span></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"G_formula (S-learner)"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>      ATE_g_formula_s <span class="ot">&lt;-</span> <span class="fu">g_formula_S_learner</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.outcome =</span> X.names.outcome, </span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_survival =</span> survival_method, </span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"G-formula ("</span>, survival_name, <span class="st">"/ S-learner)"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_g_formula_s, </span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nuisance"</span> <span class="ot">=</span> survival_method</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPTW with pseudo observations (BJ transformation)</span></span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPTW-BJ"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>        ATE_IPTW_bj <span class="ot">&lt;-</span> <span class="fu">IPTW_BJ</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>                               <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>                               <span class="at">X.names.outcome =</span> X.names.outcome, </span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nuisance =</span> survival_method, </span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_name  <span class="sc">==</span> survival_name){</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-BJ ("</span>, survival_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-BJ ("</span>, survival_name,<span class="st">" &amp; "</span>, propensity_name , <span class="st">")"</span>, </span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sep =</span> <span class="st">""</span>)}</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_IPTW_bj, </span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>          <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>          <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">paste</span>(survival_method, propensity_method, <span class="at">sep =</span> <span class="st">", "</span>)</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPTW-IPCW KM</span></span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPTW-IPCW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (censoring_method <span class="cf">in</span> nuisance_censoring) {</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>        ATE_iptw_ipcw_km <span class="ot">&lt;-</span> <span class="fu">IPTW_IPCW_Kaplan_meier</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">X.names.censoring =</span> X.names.censoring, </span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nuisance_censoring =</span> censoring_method, </span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (censoring_method <span class="sc">==</span> <span class="st">"survival forest"</span>){censoring_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{censoring_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_name  <span class="sc">==</span> censoring_name){</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-IPCW KM ("</span>, censoring_name , <span class="st">")"</span>, </span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-IPCW KM ("</span>, censoring_name,<span class="st">" &amp; "</span>, propensity_name , <span class="st">")"</span>, </span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sep =</span> <span class="st">""</span>)}</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_iptw_ipcw_km<span class="sc">$</span>RMST, </span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>          <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>          <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">paste</span>(censoring_method, propensity_method, <span class="at">sep =</span> <span class="st">", "</span>)</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with AIPTW with pseudo observations (AIPCW transformation)</span></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"AIPTW-AIPCW"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (censoring_method <span class="cf">in</span> nuisance_censoring) {</span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>          ATE_aiptw_aipcw <span class="ot">&lt;-</span> <span class="fu">AIPTW_AIPCW</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">X.names.censoring =</span> X.names.censoring, </span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">nuisance_censoring =</span> censoring_method, </span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">nuisance_Qt =</span> survival_method, </span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">n.folds =</span> n.folds)</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>            propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (censoring_method <span class="sc">==</span> <span class="st">"survival forest"</span>){</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>            censoring_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{censoring_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (censoring_name <span class="sc">==</span> propensity_name <span class="sc">&amp;</span> censoring_name <span class="sc">==</span> survival_name){</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>            est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"AIPTW-AIPCW ("</span>, survival_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{</span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>            est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"AIPTW-AIPCW ("</span>, survival_name,<span class="st">" &amp; "</span>, </span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>                              censoring_name ,<span class="st">" &amp; "</span>, propensity_name , <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)}</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>          results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, </span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimate"</span> <span class="ot">=</span> ATE_aiptw_aipcw<span class="sc">$</span>AIPTW_AIPCW_IPW_res, </span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>            <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">paste</span>(survival_method, </span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>                               censoring_method, </span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>                               propensity_method , <span class="at">sep =</span> <span class="st">", "</span>)</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>          ))</span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unadjusted estimate using package from SurvRM2</span></span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"SurvRM2 - KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>    ATE_pack <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theta_rmst_survrm2</span>(data, <span class="at">tau =</span> tau)</span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error in ATE_pack: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_pack, </span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"SurvRM2 - KM"</span>, <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate using survival random forest from grf</span></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CSF can have a misspecification only on all nuisance parameters</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"grf - Causal Survival Forest"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>    ATE_RF <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If there is no misspecification, X.names has to be defined as the </span></span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>      <span class="co"># union of all the covariates which influence nuisance models</span></span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>      <span class="fu">CSRF</span>(data, X.names, <span class="at">tau =</span> tau)</span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error in ATE_RF: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_RF, </span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"grf - Causal Survival Forest"</span>, </span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>      <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"RISCA - IPTW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>      <span class="co"># IPTW estimate from RISCA</span></span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>      ATE_RISCA_iptw <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>        <span class="fu">RISCA_iptw</span>(data, X.names.propensity, propensity_method, <span class="at">tau =</span> tau, </span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.folds=</span>n.folds)</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Error in ATE_RISCA_iptw: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"RISCA - IPTW KM ("</span>, propensity_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_RISCA_iptw, </span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nuisance"</span> <span class="ot">=</span> propensity_method</span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Only support Cox object</span></span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"RISCA - G_formula (S-learner)"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>    <span class="co"># G-formula estimate from RISCA</span></span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>    ATE_RISCA_gf <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RISCA_gf</span>(data, X.names.outcome, <span class="at">tau =</span> tau)</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error in ATE_RISCA_gf: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_RISCA_gf, </span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"RISCA - G_formula (S-learner)"</span>, </span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>      <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">"Cox"</span></span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute estimators for multiple simulations and sample sizes</span></span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>compute_estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(n_sim, tau, <span class="at">scenario =</span> <span class="st">"RCT1"</span>, </span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>                              X.names.propensity, </span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>                              X.names.outcome,</span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>                              X.names.censoring,</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>, </span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.folds_propensity =</span> <span class="cn">NULL</span>,</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.folds_censoring =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.folds_survival =</span> <span class="cn">NULL</span>, <span class="at">coefC =</span> <span class="cn">NULL</span>, </span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC =</span> <span class="cn">NULL</span>,</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC_A =</span> <span class="cn">NULL</span>,</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>                              <span class="at">estimator =</span> <span class="st">"all"</span>,</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sample_sizes =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">4000</span>, <span class="dv">8000</span>)) {</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>  pb_n <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">length</span>(sample_sizes), </span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>                         <span class="at">style =</span> <span class="dv">3</span>, <span class="at">initial =</span> <span class="dv">0</span>, <span class="at">char =</span> <span class="st">"#"</span>)</span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">on.exit</span>(<span class="fu">close</span>(pb_n))</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample.size"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimate"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimator"</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">character</span>()</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through each sample size</span></span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (idx_n <span class="cf">in</span> <span class="fu">seq_along</span>(sample_sizes)) {</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> sample_sizes[idx_n]</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Progress bar for simulations</span></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>    pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> n_sim, <span class="at">style =</span> <span class="dv">3</span>, <span class="at">initial =</span> <span class="dv">0</span>, <span class="at">char =</span> <span class="st">"#"</span>)</span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">on.exit</span>(<span class="fu">close</span>(pb))</span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each simulation</span></span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sim) {</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Simulate data based on the scenario</span></span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"RCT1"</span>) {</span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_RCT</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"RCT1"</span>)</span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"RCT2"</span>) {</span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_RCT</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"RCT2"</span>, </span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">coefC =</span> coefC, </span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parsC =</span> parsC,</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parsC_A =</span> parsC_A)</span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Obs1"</span>) {</span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"Obs1"</span>)</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Obs2"</span>) {</span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"Obs2"</span>, </span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">coefC =</span> coefC, </span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parsC =</span> parsC)</span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Complex"</span>) {</span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_complex</span>(n, </span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">tau =</span> tau,</span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">parsC =</span> parsC)</span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Mis"</span>) {</span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_mis</span>(n, <span class="at">tau =</span> tau)</span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute all estimates for the simulated data</span></span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>      all <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>                           X.names.propensity, </span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>                           X.names.outcome,</span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>                           X.names.censoring,</span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>                           nuisance_propensity, </span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>                           nuisance_censoring,</span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>                           nuisance_survival, </span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>                           estimator)</span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(all, results)</span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>    <span class="fu">close</span>(pb)</span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setTxtProgressBar</span>(pb_n, idx_n)</span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of simulations and tau value</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># RCT1 simulation</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>simulation_rct1 <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"RCT1"</span>, </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>), </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"glm"</span>, <span class="st">"probability forest"</span>), </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">n.folds_propensity =</span> <span class="dv">5</span>,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">n.folds_censoring =</span> <span class="dv">5</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">n.folds_survival =</span> <span class="dv">5</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">coefC =</span> <span class="fl">0.03</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_rct1, <span class="at">file =</span> <span class="st">"simulation_rct1.RData"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co"># RCT2 simulation with specific coefficients and parameters</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>simulation_rct2 <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"RCT2"</span>, </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>), </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"glm"</span>, <span class="st">"probability forest"</span>), </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_propensity =</span> <span class="dv">5</span>,</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_censoring =</span> <span class="dv">5</span>,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_survival =</span> <span class="dv">5</span>,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefC =</span> <span class="fl">0.03</span>, </span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">parsC =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="sc">-</span><span class="fl">0.1</span>), </span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">parsC_A =</span> <span class="dv">0</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_rct2, <span class="at">file =</span> <span class="st">"simulation_rct2.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_rct1.RData"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_rct2.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the theme to center the plot title</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_update</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the desired order of the estimators</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>desired_order <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Naive"</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"KM"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SurvRM2 - KM"</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPTW KM (Log. Reg.)"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RISCA - IPTW KM (Log. Reg.)"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPCW KM (Cox)"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"BJ (Cox)"</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPTW-BJ (Cox &amp; Log. Reg.)"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPTW-IPCW KM (Cox &amp; Log. Reg.)"</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"G-formula (Cox/ T-learners)"</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"G-formula (Cox/ S-learner)"</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RISCA - G_formula (S-learner)"</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AIPTW-AIPCW (Cox &amp; Cox &amp; Log. Reg.)"</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"grf - Causal Survival Forest"</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPTW KM (Forest)"</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RISCA - IPTW KM (Forest)"</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPCW KM (Forest)"</span>,</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"BJ (Forest)"</span>,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPTW-BJ (Forest)"</span>,</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IPTW-IPCW KM (Forest)"</span>,</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"G-formula (Forest/ T-learners)"</span>,</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"G-formula (Forest/ S-learner)"</span>,</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AIPTW-AIPCW (Forest)"</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert sample size to a factor with levels sorted in decreasing order</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>simulation_rct1<span class="sc">$</span>sample.size <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  simulation_rct1<span class="sc">$</span>sample.size, </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(simulation_rct1<span class="sc">$</span>sample.size), <span class="at">decreasing =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert estimator column to a factor with the specified order</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>simulation_rct1<span class="sc">$</span>estimator <span class="ot">&lt;-</span> <span class="fu">factor</span>(simulation_rct1<span class="sc">$</span>estimator, </span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">levels =</span> desired_order)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot for RCT + independent censoring</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>simulation_graph_rct1 <span class="ot">&lt;-</span> simulation_rct1 <span class="sc">%&gt;%</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> estimator, <span class="at">y =</span> estimate,  </span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">factor</span>(sample.size, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">levels</span>(sample.size)))</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Accent"</span>) <span class="sc">+</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span>  <span class="co"># Change x-axis label</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"ATE"</span>) <span class="sc">+</span>  <span class="co"># Change y-axis label</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_boxplot</span>(<span class="at">geom =</span> <span class="st">"errorbar"</span>) <span class="sc">+</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">yintercept =</span> truth_tau1, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, </span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.8</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.box =</span> <span class="st">"vertical"</span>, <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">35</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>),  </span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust text angle for better visibility</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">r =</span> <span class="dv">10</span>, <span class="at">b =</span> <span class="dv">50</span>, <span class="at">l =</span> <span class="dv">10</span>)  <span class="co"># Add margin</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span>    </span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>simulation_graph_rct1 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-rct1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rct1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Notebook_causal_survival_files/figure-html/fig-rct1-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rct1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Results of the ATE for the simulation of a RCT with independent censoring.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In this setting, and in accordance with the theory, the simplest estimator (unadjusted KM) performs just as well as the others, and presents an extremely small bias (as derived in <a href="#sec-theoryRCT_indc" class="quarto-xref">Section&nbsp;2.1</a>).</p>
<p>The naive estimator is biased, as expected, and the bias in both the G-formula (RISCA) and the manual G-formula S-learner arises because the treatment effect is additive <span class="math inline">T(1) = T(0) + 10</span> and violates the assumption that <span class="math inline">T</span> would follow a Cox model in the variables <span class="math inline">(X,A)</span>. However, <span class="math inline">T|A=a</span> is a Cox-model for <span class="math inline">a \in \{0,1\}</span>, which explain the remarkable performance of G-formula (Cox/T-learners) and some of the other models based on a Cox estimation of <span class="math inline">S</span>.</p>
<p>Other estimators (IPTW KM (Reg.Log), IPCW KM (Cox), IPTW-IPCW KM (Cox &amp; Log.Reg), IPTW-BJ (Cox &amp; Log.Reg), AIPTW-AIPCW (Cox &amp; Cox &amp; Log.Reg)) involve unnecessary nuisance parameter estimates, such as propensity scores or censoring models. Despite this, their performance remains relatively stable in terms of variability, and there are roughly no differences between using (semi-)parametric or non-parametric estimation methods for nuisance parameters except for IPCW KM and IPTW-IPCW KM where there is a slight bias when using forest-based methods.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>simulation_graph_rct2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-rct2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rct2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Notebook_causal_survival_files/figure-html/fig-rct2-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rct2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Estimation results of the ATE for the simulation of a RCT with dependent censoring.
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-rct2" class="quarto-xref">Figure&nbsp;9</a> shows the results for the RCT simulation with conditionally independent censoring (Scenario 2). In this setting, the Naive estimator remains biased. Similarly, both the unadjusted Kaplan-Meier (KM) and its SurvRM2 equivalent, as well as the treatment-adjusted IPTW KM and its RISCA equivalent, are biased due to their failure to account for dependent censoring. As in Scenario 1, G-formula (Cox/ S-learner) and its RISCA equivalent also remain biased. The IPCW KM (Cox) is slightly biased up to 4,000 observations and quite variable due to extreme censoring probabilities. IPTW-IPCW KM (Cox &amp; Log.Reg.) is not biased but shows high variance. In contrast, the Buckley-James estimator BJ (Cox) is unbiased even with as few as 500 observations. The BJ estimator also demonstrates smaller variance than IPCW methods. G-formula (Cox/ T-learners) and AIPCW-AIPTW (Cox &amp; Cox &amp; Log.Reg.) estimators seem to perform well, even in small samples. The forest versions of these estimators seem more biased, except Causal Survival Forest and the AIPTW-AIPCW (Forest). Notably, all estimators exhibit higher variability compared to Scenario 1.</p>
</section>
<section id="sec-simulation-Obs" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="sec-simulation-Obs"><span class="header-section-number">5.2</span> Observational data</h2>
<p><strong>Data Generating Process</strong></p>
<p>As for Scenarii 1 and 2, we carry out two simulations of an observational study with both independent and conditional independent censoring. The only difference lies in the simulation of the propensity score, which is no longer constant. For the simulation, an iid <span class="math inline">n</span>-sample <span class="math inline">(X_{i},A_{i},C,T_{i}(0), T_{i}(1))_{i \in [n]}</span> is generated as in <a href="#sec-simulation-RCT" class="quarto-xref">Section&nbsp;5.1</a>, except for the treatment allocation process that is given by:</p>
<p><span class="math display">
\operatorname{logit}(e(X))= \beta_A^\top X \quad \text{where} \quad \beta_A = (-1,-1,-2.5,-1),
</span><br>
where we recall that <span class="math inline">\operatorname{logit}(p) = \log(p/(1-p))</span>. The descriptive statistics for the two observational data with independent (<span class="math inline">\texttt{Obs1}</span>) and conditionally independent censoring (<span class="math inline">\texttt{Obs2}</span>) are displayed in Appendix (<a href="#sec-stat_obs" class="quarto-xref">Section&nbsp;8.2</a>). Note that we did not modify the survival distribution, the target difference in RMST is thus the same.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obs1:  Treatment assignment dependent on X + independent censoring</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Obs2:  Treatment assignment dependent on X + dependent censoring (conditional </span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># on X)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to simulate observational data for two scenarios: Obs1 and Obs2</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>simulate_data_obs <span class="ot">&lt;-</span> <span class="cf">function</span>(n, </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sigma =</span> <span class="fu">diag</span>(<span class="dv">4</span>), </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">colnames_cov =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                              tau,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">coefT0 =</span> <span class="fl">0.01</span>, </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsS =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsA =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="fl">2.5</span>, <span class="sc">-</span><span class="dv">1</span>), </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC_A =</span> <span class="fu">c</span>(<span class="dv">0</span>), </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>                              <span class="at">coefC =</span> <span class="fl">0.03</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="sc">-</span><span class="fl">0.1</span>), </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                              <span class="at">scenario =</span> <span class="st">"Obs2"</span>) {</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate covariates X from a multivariate normal distribution</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(n, mu, sigma)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(X)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> colnames_cov</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Propensity score model based on X</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">as.matrix</span>(X) <span class="sc">%*%</span> <span class="fu">diag</span>(parsA))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">plogis</span>(e)  <span class="co"># Transform to probability scale</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Treatment assignment based on the propensity score</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">sapply</span>(e, <span class="at">FUN =</span> <span class="cf">function</span>(p) <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p))</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome model based on X</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  X_outcome <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">0.00000001</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  T0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(epsilon) <span class="sc">/</span> (coefT0 <span class="sc">*</span> <span class="fu">exp</span>(X_outcome <span class="sc">%*%</span> parsS))</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define treatment effect (shift in survival time due to treatment)</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  T1 <span class="ot">&lt;-</span> T0 <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Obs1"</span>) {</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scenario 1: Independent censoring</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    C <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">0.00000001</span>, <span class="at">max =</span> <span class="dv">1</span>)) <span class="sc">/</span> coefC</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Obs2"</span>) {</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scenario 2: Dependent censoring based on X</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    X_censoring <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(X,A))</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    parsC <span class="ot">&lt;-</span> <span class="fu">c</span>(parsC,parsC_A)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    C <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">0.00000001</span>, <span class="at">max =</span> <span class="dv">1</span>)) <span class="sc">/</span> </span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>      (coefC <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">rowSums</span>(X_censoring <span class="sc">%*%</span> <span class="fu">diag</span>(parsC))))</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid scenario. Choose 'Obs1' or 'Obs2'."</span>)</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the true survival time based on treatment</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>  T_true <span class="ot">&lt;-</span> A <span class="sc">*</span> T1 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">*</span> T0</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observed time is the minimum of the true survival time and censoring time</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  T_obs <span class="ot">&lt;-</span> <span class="fu">pmin</span>(T_true, C)</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Status indicator: 1 if the event (death) occurred, 0 if censored</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>  status <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(T_true <span class="sc">&lt;=</span> C)</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restricted survival time (censored at tau)</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>  T_obs_tau <span class="ot">&lt;-</span> <span class="fu">pmin</span>(T_obs, tau)</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((T_obs <span class="sc">&gt;</span> tau) <span class="sc">|</span> (T_obs <span class="sc">&lt;=</span> tau <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compile the simulated data into a data frame</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  DATA_target_population <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X, tau, A, T0, T1, C, T_obs, T_obs_tau, </span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>                                       status, status_tau, e)</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(DATA_target_population)</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation for scenario Obs1</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>data_Obs1 <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(<span class="at">n =</span> <span class="dv">100000</span>, <span class="at">tau =</span> <span class="dv">25</span>, <span class="at">scenario =</span> <span class="st">"Obs1"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_ground_truth(data_Obs1, </span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                  vec_tau, </span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                  tau, </span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                  c(0, 10),</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                  "True difference in RMST for Obs #scenario 1")</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>truth_tau3 <span class="ot">&lt;-</span>  <span class="fu">ground_truth</span>(data_Obs1, <span class="at">tau =</span> <span class="dv">25</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The ground truth for Obs scenario 1 at time 25 is "</span>, <span class="fu">round</span>(truth_tau3, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The ground truth for Obs scenario 1 at time 25 is 7.1"</code></pre>
</div>
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation for scenario Obs2 with specific coefficients and parameters</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>data_Obs2 <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">100000</span>, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Obs2"</span>, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefC =</span> <span class="fl">0.03</span>, <span class="at">parsC =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="sc">-</span><span class="fl">0.1</span>))</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_ground_truth(data_Obs2, </span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                  vec_tau, </span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                  tau, </span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">#                  c(0, 10),</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                  "True difference in RMST for Obs #scenario 2")</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>truth_tau4 <span class="ot">&lt;-</span> <span class="fu">ground_truth</span>(data_Obs2, <span class="at">tau =</span> <span class="dv">25</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The ground truth for Obs scenario 2 at #time 25 is "</span>, <span class="fu">round</span>(truth_tau4, <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The ground truth for Obs scenario 2 at #time 25 is 7.1"</code></pre>
</div>
</div>
<p><strong>Estimation of the RMST</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obs1 simulation</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>simulation_obs1 <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Obs1"</span>, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>), </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"glm"</span>, <span class="st">"probability forest"</span>), </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_propensity =</span> <span class="dv">5</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_censoring =</span> <span class="dv">5</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_survival =</span> <span class="dv">5</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefC =</span> <span class="fl">0.03</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_obs1, <span class="at">file =</span> <span class="st">"simulation_obs1.RData"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Obs2 simulation with specific coefficients and parameters</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>simulation_obs2 <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Obs2"</span>, </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>), </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"glm"</span>, <span class="st">"probability forest"</span>), </span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"cox"</span>, <span class="st">"survival forest"</span>), </span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_propensity =</span> <span class="dv">5</span>,</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_censoring =</span> <span class="dv">5</span>,</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_survival =</span> <span class="dv">5</span>,</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefC =</span> <span class="fl">0.03</span>, </span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">parsC =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="sc">-</span><span class="fl">0.1</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_obs2, <span class="at">file =</span> <span class="st">"simulation_obs2.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_obs1.RData"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_obs2.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><a href="#fig-obs1" class="quarto-xref">Figure&nbsp;10</a> below shows the distribution of the estimators of <span class="math inline">\theta_{\mathrm{RMST}}</span> for the observational study with independent censoring.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>simulation_graph_obs1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-obs1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-obs1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Notebook_causal_survival_files/figure-html/fig-obs1-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-obs1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Estimation results of the ATE for the simulation of an observational study with independent censoring.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In the simulation of an observational study with independent censoring, confounding bias is introduced, setting it apart from RCT simulations. As expected, estimators that fail to adjust for this bias, such as unadjusted Kaplan-Meier (KM), IPCW KM (Cox), and their equivalents, are biased. However, estimators like IPTW KM (Log.Reg.), IPTW-IPCW KM (Cox &amp; Log. Reg.) are unbiased, even if the latter estimate unnecessary nuisance components. Results with IPTW BJ (Cox &amp; Log.Reg) are extremely variable.</p>
<p>The top-performing estimators in this scenario are G-formula (Cox/ T-learners) and AIPCW-AIPTW (Cox &amp; Cox &amp; Log.Reg.), which are unbiased even with 500 observations. The former has the lowest variance. All estimators that use forests to estimate nuisance parameters are biased across sample sizes from 500 to 8000. Although Causal Survival Forest and AIPW-AIPCW (Forest) are expected to eventually converge, they remain extremely demanding in terms of sample size. This setting thus highlights that one should either have an a priori knowledge on the specification of the models or large sample size.</p>
<p><a href="#fig-obs2" class="quarto-xref">Figure&nbsp;11</a> below shows the distribution of the <span class="math inline">\theta_{\mathrm{RMST}}</span> estimates for the observational study with conditionally independent censoring. The red dashed line represents the true <span class="math inline">\theta_{\mathrm{RMST}}</span> for <span class="math inline">\tau=25</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>simulation_graph_obs2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-obs2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-obs2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Notebook_causal_survival_files/figure-html/fig-obs2-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-obs2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Estimation results of the ATE for the simulation of an observational study with dependent censoring.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In the simulation of an observational study with conditionally independent censoring, estimators that do not account for both censoring and confounding bias, such as KM, IPCW KM, IPTW KM, and their package equivalents, are biased. The top-performing estimators in this scenario are G-formula (Cox/ T-learners) and AIPCW-AIPTW (Cox &amp; Cox &amp; Log.Reg.), which are unbiased even with 500 observations. The former has the lowest variance as expected, see <a href="#sec-Gformula" class="quarto-xref">Section&nbsp;2.2.1</a>. Surprisingly, the G-formula (Cox/S-learner) and its equivalent from the RISCA package perform quite competitively, showing only a slight bias despite the violation of the proportional hazards assumption. All estimators that use forests to estimate nuisance parameters are biased across sample sizes from 500 to 8000. Although Causal Survival Forest and AIPTW-AIPCW (Forest) are expected to eventually converge, they remain extremely demanding in terms of sample size.</p>
</section>
<section id="mispecification-of-nuisance-components" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="mispecification-of-nuisance-components"><span class="header-section-number">5.3</span> Mispecification of nuisance components</h2>
<p><strong>Data Generating Process</strong></p>
<p>We generate an observational study with covariate interactions and conditionally independent censoring. The objective is to assess the impact of misspecifying nuisance components; specifically, we will use models that omit interactions to estimate these components. This approach enables us to evaluate the robustness properties of various estimators. In addition, in this setting forest based methods are expected to behave better.</p>
<p>We generate <span class="math inline">n</span> samples <span class="math inline">(X_{i},A_{i},C,T_{i}(0), T_{i}(1))</span> as follows:</p>
<ul>
<li><p><span class="math inline">X \sim \mathcal{N}\left(\mu, \Sigma\right)</span> and <span class="math inline">\mu = (0.5,0.5,0.7,0.5)</span>, <span class="math inline">\Sigma = \mathrm{Id}_4</span>.</p></li>
<li><p>The hazard function of <span class="math inline">T(0)</span> is given by <span class="math display">
\begin{aligned}
\lambda^{(0)}(t|X) = \exp\{\beta_0^\top Y\} \quad \text{where} \quad \beta_0 &amp;= (0.2,0.3,0.1,0.1,1,0,0,0,0,1), \\
\text{and} \quad Y &amp;= (X_1^2,X_2^2,X_3^2,X_4^2,X_1 X_2,X_1X_3,X_1X_4,X_2 X_3,X_2X_4, X_3 X_4).
\end{aligned}
</span></p></li>
<li><p>The distribution of <span class="math inline">T(1)</span> is the one of <span class="math inline">T(0)</span> but shifted: <span class="math inline">T(1) = T(0)+1</span>.</p></li>
<li><p>The hazard function of <span class="math inline">C</span> is given by <span class="math display">
\begin{aligned}
\lambda_C(t|X) = \exp\{\beta_C^\top Y\} \quad \text{where} \quad \beta_C &amp;= (0.05,0.05,-0.1,0.1,0,1,0,-1,0,0).
\end{aligned}
</span></p></li>
<li><p>The propensity score is <span class="math display">
\begin{aligned}
\mathrm{logit}(e(x)) = \beta_A^\top Y \quad \text{where} \quad \beta_A= (0.05,-0.1,0.5,-0.1,1,0,1,0,0,0).
\end{aligned}
</span> When the model is well-specified, the full vector <span class="math inline">(X,Y)</span> is given as an input of the nuisance parameter models. When it is not, only <span class="math inline">X</span> and the first half of <span class="math inline">Y</span> corresponding to <span class="math inline">(X_1^2,X_2^2,X_3^2,X_4^2)</span> is given as an input.</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DGP for misspecification </span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>simulate_data_mis <span class="ot">&lt;-</span> <span class="cf">function</span>(n, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mu =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.5</span>),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sigma =</span>  <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                                                <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                                                <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>                                                <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">colnames_cov =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsA =</span>  <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.1</span>),</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>                              tau){</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate X from a multivariate normal distribution</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n, mu, sigma)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(X)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> colnames_cov</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Treatment variable selection: all X</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  X_treatment <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Propensity score model based on X</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> parsA[<span class="dv">1</span>]<span class="sc">*</span>X_treatment[, <span class="st">"X1"</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> parsA[<span class="dv">2</span>]<span class="sc">*</span>X_treatment[, <span class="st">"X2"</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    parsA[<span class="dv">3</span>]<span class="sc">*</span>X_treatment[, <span class="st">"X3"</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> parsA[<span class="dv">4</span>]<span class="sc">*</span>X_treatment[, <span class="st">"X4"</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    X_treatment[, <span class="st">"X1"</span>]<span class="sc">*</span>X_treatment[, <span class="st">"X2"</span>] <span class="sc">+</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    X_treatment[, <span class="st">"X1"</span>]<span class="sc">*</span>X_treatment[, <span class="st">"X4"</span>]</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Logistic regression</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">plogis</span>(e)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Treatment assignment based on the propensity score</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">sapply</span>(e, <span class="at">FUN =</span> <span class="cf">function</span>(p) <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p))</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome variable selection: all X</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  X_outcome <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.2</span><span class="sc">*</span>X[,<span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>X[,<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span>X[,<span class="dv">3</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span>X[,<span class="dv">4</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>    X[,<span class="dv">1</span>] <span class="sc">*</span> X[,<span class="dv">2</span>] <span class="sc">+</span> X[,<span class="dv">3</span>] <span class="sc">*</span> X[,<span class="dv">4</span>])</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate the outcome using the cumulative hazard inversion method</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">1e-8</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>  T0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(epsilon) <span class="sc">/</span> lambda</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate independent censoring time</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>  censoring_lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.05</span><span class="sc">*</span>X[,<span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.05</span><span class="sc">*</span>X[,<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span><span class="fl">-0.1</span><span class="sc">*</span>X[,<span class="dv">3</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.1</span><span class="sc">*</span>X[,<span class="dv">4</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>    X[,<span class="dv">3</span>] <span class="sc">*</span> X[,<span class="dv">1</span>] <span class="sc">-</span> X[,<span class="dv">2</span>]<span class="sc">*</span>X[,<span class="dv">4</span>])</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="fl">1e-8</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(epsilon) <span class="sc">/</span> censoring_lambda</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># T(1) = T(0) + 1</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>  T1 <span class="ot">&lt;-</span> T0 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True survival time</span></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>  T_true <span class="ot">&lt;-</span> A <span class="sc">*</span> T1 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> A) <span class="sc">*</span> T0</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observed time</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>  T_obs <span class="ot">&lt;-</span> <span class="fu">pmin</span>(T_true, C)</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Status indicator</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>  status <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(T_true <span class="sc">&lt;=</span> C)</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>  censor.status <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(T_true <span class="sc">&gt;</span> C)</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restricted survival time</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>  T_obs_tau <span class="ot">&lt;-</span> <span class="fu">pmin</span>(T_obs, tau)</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>  status_tau <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>((T_obs <span class="sc">&gt;</span> tau) <span class="sc">|</span> (T_obs <span class="sc">&lt;=</span> tau <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compile the simulated data into a data frame</span></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>  DATA_target_population <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X, tau, A, T0, T1, C, T_obs, T_obs_tau, </span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>                                       status, status_tau, censor.status, e)</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(DATA_target_population)</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to estimate RMST for each misspecification context</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>compute_estimator_mispec <span class="ot">&lt;-</span> <span class="cf">function</span>(n_sim, tau, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                                     X.names.propensity_mis, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                                     X.names.propensity, </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                                     X.names.outcome,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                                     X.names.outcome_mis,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>                                     X.names.censoring,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>                                     X.names.censoring_mis,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>, </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">n.folds_propensity =</span> <span class="cn">NULL</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">n.folds_censoring =</span> <span class="cn">NULL</span>, </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">n.folds_survival =</span> <span class="cn">NULL</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">estimator =</span> <span class="st">"all"</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">sample_sizes =</span> <span class="fu">c</span>(<span class="dv">8000</span>)) {</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  pb_n <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">length</span>(sample_sizes) <span class="sc">*</span> n_sim, </span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>                         <span class="at">style =</span> <span class="dv">3</span>, <span class="at">initial =</span> <span class="dv">0</span>, <span class="at">char =</span> <span class="st">"#"</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">on.exit</span>(<span class="fu">close</span>(pb_n))</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize data frame for each misspecification</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  simulation_mis <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  simulation_mistreat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  simulation_misout <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  simulation_miscens <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  simulation_mistreat_out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  simulation_miscens_out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  simulation_mistreat_cens <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  simulation_misall <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to compute estimators for multiple simulations and sample sizes</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> sample_sizes) {</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sim) {</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setTxtProgressBar</span>(pb_n, (<span class="fu">which</span>(sample_sizes <span class="sc">==</span> n) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> n_sim <span class="sc">+</span> i)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">&lt;-</span> <span class="fu">simulate_data_mis</span>(n, <span class="at">tau =</span> tau)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute all estimates for the simulated data</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>      res_all_mis <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_propensity =</span> nuisance_propensity, </span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_survival =</span> nuisance_survival, </span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>                                   estimator)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>      res_all_mistreat <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">nuisance_survival =</span> nuisance_survival,  </span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>                                        estimator)</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>      res_all_misout <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_survival =</span> nuisance_survival,  </span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>                                      estimator)</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>      res_all_miscens <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nuisance_survival =</span> nuisance_survival,  </span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>                                       estimator)</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>      res_all_mistreat_out <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>                                            estimator)</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>      res_all_miscens_out <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>                                           estimator)</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>      res_all_mistreat_cens <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>                                             estimator)</span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>      res_all_misall <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>                                      estimator)</span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Store the results</span></span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>      simulation_mis <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mis, res_all_mis)</span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a>      simulation_mistreat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mistreat, res_all_mistreat)</span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a>      simulation_misout <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_misout, res_all_misout)</span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>      simulation_miscens <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_miscens, res_all_miscens)</span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>      simulation_mistreat_out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mistreat_out, res_all_mistreat_out)</span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>      simulation_miscens_out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_miscens_out, res_all_miscens_out)</span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>      simulation_mistreat_cens <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mistreat_cens, res_all_mistreat_cens)</span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a>      simulation_misall <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_misall, res_all_misall)</span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fusion of dataframe</span></span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mis =</span> simulation_mis,</span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mistreat =</span> simulation_mistreat,</span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_misout =</span> simulation_misout,</span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_miscens =</span> simulation_miscens,</span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mistreat_out =</span> simulation_mistreat_out,</span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_miscens_out =</span> simulation_miscens_out,</span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mistreat_cens =</span> simulation_mistreat_cens,</span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_misall =</span> simulation_misall</span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The descriptive statistics are given in Appendix (<a href="#sec-stat_inter" class="quarto-xref">Section&nbsp;8.3</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mis scenario </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>tau_mis <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>vec_tau_complex <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>data_mis <span class="ot">&lt;-</span> <span class="fu">simulate_data_mis</span>(<span class="at">n =</span> <span class="dv">150000</span>, <span class="at">tau =</span> tau_mis)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_ground_truth(data_mis,</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                  vec_tau_complex, </span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                  tau_mis, </span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">#                  c(0, 1), </span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                  "True difference in RMST for Mis scenario")</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>truth_complex_mis <span class="ot">&lt;-</span> <span class="fu">ground_truth</span>(data_mis, <span class="at">tau =</span> tau_mis)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The ground truth for mis scenario at time 0.45 is "</span>, <span class="fu">round</span>(truth_complex_mis,<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The ground truth for mis scenario at time 0.45 is 0.26"</code></pre>
</div>
</div>
<p><strong>Estimation of the RMST</strong></p>
<p>First, we estimate <span class="math inline">\theta_{\mathrm{RMST}}</span> without any model misspecification to confirm the consistency of the estimators under correctly specified nuisance models. More specifically, it means that for parametric propensity score models, semi-parametric censoring and survival models, we use models including interactions and squared assuming knowledge on the data generating process.</p>
<p>Next, we introduce misspecification individually for the treatment model, censoring model, and outcome model (<a href="#fig-mis" class="quarto-xref">Figure&nbsp;13</a>), i.e., we use models without interaction to estimate parametric and semi-parametric nuisance components while the data are generated with interactions.<br>
We further examine combined misspecifications for pairs of models: treatment and censoring, treatment and outcome, and outcome and censoring. Finally, we assess the impact of misspecifying all nuisance models simultaneously (<a href="#fig-mis2" class="quarto-xref">Figure&nbsp;14</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>simulation_mis <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Mis"</span>, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,<span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>, </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"X1*X2"</span>,<span class="st">"X1*X4"</span>),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,<span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>, </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"X1:X2"</span>, <span class="st">"X3:X4"</span>),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,<span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>, </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"X1:X3"</span>, <span class="st">"X2:X4"</span>),</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"glm"</span>), </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"cox"</span>), </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"cox"</span>), </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_propensity =</span> <span class="cn">NULL</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_censoring =</span> <span class="cn">NULL</span>,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_survival =</span> <span class="cn">NULL</span>,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_sizes =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">4000</span>, <span class="dv">8000</span>),</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimator =</span> <span class="fu">c</span>(<span class="st">"Naive"</span>, <span class="st">"KM"</span>, <span class="st">"IPTW KM"</span>, <span class="st">"IPCW KM"</span>, <span class="st">"BJ"</span>, </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">"IPTW-IPCW KM"</span>, <span class="st">"IPTW-BJ"</span>, <span class="st">"G_formula (T-learners)"</span>, </span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">"G_formula (S-learner)"</span>, <span class="st">"AIPTW-AIPCW"</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_mis, <span class="at">file=</span><span class="st">"simulation_mis.RData"</span>) </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>simulation_mis_c <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Mis"</span>, </span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"probability forest"</span>), </span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"survival forest"</span>), </span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"survival forest"</span>), </span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_propensity =</span> <span class="dv">5</span>,</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_censoring =</span> <span class="dv">5</span>,</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_survival =</span> <span class="dv">5</span>,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_sizes =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">4000</span>, <span class="dv">8000</span>),</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimator =</span> <span class="fu">c</span>(<span class="st">"IPTW KM"</span>, <span class="st">"IPCW KM"</span>, <span class="st">"BJ"</span>, </span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">"IPTW-IPCW KM"</span>, <span class="st">"IPTW-BJ"</span>, <span class="st">"G_formula (T-learners)"</span>, </span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">"G_formula (S-learner)"</span>, <span class="st">"AIPTW-AIPCW"</span>,</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"grf - Causal Survival Forest"</span>)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_mis_c, <span class="at">file=</span><span class="st">"simulation_mis_c.RData"</span>) </span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>simulation_mis_c_16000 <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>  n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Mis"</span>, </span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>,<span class="st">"X3"</span>,<span class="st">"X4"</span>),</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"probability forest"</span>), </span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"survival forest"</span>), </span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"survival forest"</span>), </span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_propensity =</span> <span class="dv">5</span>,</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_censoring =</span> <span class="dv">5</span>,</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds_survival =</span> <span class="dv">5</span>,</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_sizes =</span> <span class="dv">16000</span>,</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimator =</span> <span class="fu">c</span>(<span class="st">"IPTW KM"</span>, <span class="st">"G_formula (T-learners)"</span>)</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_mis_c_16000, <span class="at">file=</span><span class="st">"simulations/results magellan 4/simulation_mis_c_16000.RData"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mis.RData"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mis_c.RData"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 4/simulation_mis_c_16000.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>simulation_graph_mis</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mis3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mis3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Notebook_causal_survival_files/figure-html/fig-mis3-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mis3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Estimation results of the ATE for the simulation of an observational study with dependent censoring and non linear relationships.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>mis <span class="ot">&lt;-</span> <span class="fu">compute_estimator_mispec</span>(n_sim, <span class="at">tau =</span> tau, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>, </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">"X1*X2"</span>,<span class="st">"X1*X4"</span>),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                                                       <span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>, </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>                                                       <span class="st">"X1:X2"</span>, <span class="st">"X3:X4"</span>),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>                                                         <span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>, </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>                                                         <span class="st">"X1:X3"</span>, <span class="st">"X2:X4"</span>),</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.propensity_mis =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>,<span class="st">"I(X2^2)"</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>                                                              <span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>),</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.outcome_mis =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>),</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.censoring_mis =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>                                                             <span class="st">"I(X3^2)"</span>, <span class="st">"I(X4^2)"</span>),</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_propensity =</span> <span class="fu">c</span>(<span class="st">"glm"</span>), </span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_censoring =</span> <span class="fu">c</span>(<span class="st">"cox"</span>), </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_survival =</span> <span class="fu">c</span>(<span class="st">"cox"</span>),</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">estimator =</span> estimators,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">sample_size =</span> <span class="dv">8000</span>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to decompose the results</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>merged_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="co"># All the defined sceanario</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"simulation_mis"</span>, <span class="st">"simulation_mistreat"</span>, <span class="st">"simulation_misout"</span>,</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>               <span class="st">"simulation_miscens"</span>, <span class="st">"simulation_mistreat_out"</span>, </span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>               <span class="st">"simulation_miscens_out"</span>, <span class="st">"simulation_mistreat_cens"</span>, </span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>               <span class="st">"simulation_misall"</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through all scenarios</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> scenarios) {</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize an empty dataframe</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>  scenario_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through all sample sizes</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(sample_sizes)) {</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append the results for the given scenario and sample size </span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    scenario_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(scenario_results, results[[i]][[s]])</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the results for the given scenario to the results list </span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>  merged_results[[s]] <span class="ot">&lt;-</span> scenario_results</span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the final results for the given scenario in an .RData file</span></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assign</span>(<span class="fu">paste0</span>(s), scenario_results)</span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(<span class="at">list =</span> <span class="fu">paste0</span>(s), <span class="at">file =</span> <span class="fu">sprintf</span>(<span class="st">"%s.RData"</span>, s))</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(simulation_graph_mis2, simulation_graph_mis_miscens, simulation_graph_mis_misout, simulation_graph_mis_mistreat, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Notebook_causal_survival_files/figure-html/fig-mis-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Estimation results of the ATE for an observational study with dependent censoring in case of a single misspecification.
</figcaption>
</figure>
</div>
</div>
</div>
<p>When there is no misspecification in <a href="#fig-mis3" class="quarto-xref">Figure&nbsp;12</a>, as expected, IPTW-BJ (Cox &amp; Log.Reg), G-formula (Cox/ T-learners) and AIPTW-AIPCW (Cox &amp; Cox &amp; Reg.Log) are unbiased. IPTW-IPCW KM (Cox &amp; Log.Reg) exhibits a bias but seems to converge at larger sample size. Regarding forest-based methods, IPTW-BJ (Forest), AIPTW-AIPCW (Forest) and Causal Survival Forest estimate accurately the difference in RMST. Surprisingly, G-formula (Forest/ T-learners), G-formula (Forest/ S-learner) and IPTW-IPCW KM (Forest) exhibit small bias but are expected to eventually converge at large sample size.</p>
<p><a href="#fig-mis" class="quarto-xref">Figure&nbsp;13</a> shows that AIPTW-AIPCW (Cox &amp; Cox &amp; Reg.Log) is convergent when there is one nuisance misspecification. In contrary, the other estimators are biased when one of its nuisance parameter is misspecified.</p>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mistreat_out.RData"</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_miscens_out.RData"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mistreat_cens.RData"</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_misall.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>simulation_mis_mistreat_cens <span class="ot">&lt;-</span> <span class="fu">compute_estimator</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  n_sim, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Mis"</span>, </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.propensity =</span> <span class="fu">c</span>(<span class="st">"X2"</span>), </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.outcome =</span> <span class="fu">c</span>(<span class="st">"I(X1^2)"</span>, <span class="st">"I(X2^2)"</span>, <span class="st">"X1:X2"</span>),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">X.names.censoring =</span> <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefC =</span> <span class="cn">NULL</span>, </span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">parsC =</span> <span class="cn">NULL</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.folds =</span> <span class="cn">NULL</span>,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">mis_specification =</span> <span class="st">"none"</span>,</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">4000</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(simulation_mis_mistreat_cens,<span class="at">file=</span><span class="st">"simulations/results magellan 2/simulation_mis_mistreat_cens.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(simulation_graph_mis_mistreat_out, simulation_graph_mis_miscens_out, simulation_graph_mis_mistreat_cens, simulation_graph_mis_all, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mis2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mis2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Notebook_causal_survival_files/figure-html/fig-mis2-1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mis2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Estimation results of the ATE for an observational study with dependent censoring in case of a two or more misspecifications.
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-mis2" class="quarto-xref">Figure&nbsp;14</a> shows that, as expected, when all nuisance models are misspecified, all estimators exhibit bias. AIPTW-AIPCW (Cox &amp; Cox &amp; Reg.Log) seems to converge in case where either the outcome and censoring models, or the treatment and censoring models are misspecificed which deviates from initial expectations. It was anticipated that AIPTW-AIPCW would converge solely when both the censoring and treatment models were misspecified.</p>
</section>
</section>
<section id="sec-conclusion" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Conclusion</h1>
<p>Based on the simulations and theoretical results, it might be advisable to stay away from the IPCW and IPTW-IPCW estimators, as they often exhibit excessive variability. Instead, we recommend implementing BJ which seems like a more stable transformation as IPCW, as well as Causal Survival Forest, G-formula (T-learners), IPTW-BJ, and AIPTW-AIPCW in both their Cox, Logistic Regression and forest versions. By qualitatively combining the results from these more robust estimators, we can expect to gain a fairly accurate understanding of the treatment effect.</p>
<p>It is important to note that our simulations utilize large sample sizes with relatively simple relationships, which may not fully capture the complexity of real-world scenarios. In practice, most survival analysis datasets tend to be smaller and more intricate, meaning the stability of certain estimators observed in our simulations may not generalize to real-world applications. Testing these methods on real-world datasets would provide a more comprehensive evaluation of their performance in practical settings.</p>
<p>An interesting direction for future work would be to focus on variable selection. Indeed, there is no reason to assume that the variables related to censoring should be the same as those linked to survival or treatment allocation. We could explore differentiating these sets of variables and study the impact on the estimators’ variance. Similarly to causal inference settings without survival data, we might expect, for instance, that adding precision variables—-those solely related to the outcome—-could reduce the variance of the estimators.</p>
<p>Additionally, the estimators of the Restricted Mean Survival Time (RMST) provide a valuable alternative to the Hazard Ratio. The analysis and code provided with this article enables further exploration of the advantages of the estimators of RMST for causal analysis in survival studies. This could lead to a deeper understanding of how these estimators can offer more stable and interpretable estimates of treatment effects, particularly in complex real-world datasets.</p>
</section>
<section id="references" class="level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Aalen2008" class="csl-entry" role="listitem">
Aalen, O., O. Borgan, and H. Gjessing. 2008. <em>Survival and Event History Analysis: A Process Point of View</em>. Statistics for Biology and Health. Springer New York. <a href="https://books.google.de/books?id=wEi26X-VuCIC">https://books.google.de/books?id=wEi26X-VuCIC</a>.
</div>
<div id="ref-Breslow_approx1974" class="csl-entry" role="listitem">
Breslow, N. 1974. <span>“Covariance Analysis of Censored Survival Data.”</span> <em>Biometrics</em> 30 (1): 89–99. <a href="http://www.jstor.org/stable/2529620">http://www.jstor.org/stable/2529620</a>.
</div>
<div id="ref-Kaplan_consistency_breslow74" class="csl-entry" role="listitem">
Breslow, N., and J. Crowley. 1974. <span>“<span class="nocase">A Large Sample Study of the Life Table and Product Limit Estimates Under Random Censorship</span>.”</span> <em>The Annals of Statistics</em> 2 (3): 437–53. <a href="https://doi.org/10.1214/aos/1176342705">https://doi.org/10.1214/aos/1176342705</a>.
</div>
<div id="ref-Buckley_james_79" class="csl-entry" role="listitem">
Buckley, and James. 1979. <span>“<span class="nocase">Linear regression with censored data</span>.”</span> <em>Biometrika</em> 66 (3): 429–36. <a href="https://doi.org/10.1093/biomet/66.3.429">https://doi.org/10.1093/biomet/66.3.429</a>.
</div>
<div id="ref-RMST" class="csl-entry" role="listitem">
Chen, Pei-Yun, and Anastasios A. Tsiatis. 2001. <span>“Causal Inference on the Difference of the Restricted Mean Lifetime Between Two Groups.”</span> <em>Biometrics</em> 57 (4): 1030–38. <a href="https://doi.org/10.1111/j.0006-341X.2001.01030.x">https://doi.org/10.1111/j.0006-341X.2001.01030.x</a>.
</div>
<div id="ref-colnet2022reweighting" class="csl-entry" role="listitem">
Colnet, Bénédicte, Julie Josse, Gaël Varoquaux, and Erwan Scornet. 2022. <span>“Reweighting the RCT for Generalization: Finite Sample Error and Variable Selection.”</span> <em>arXiv Preprint arXiv:2208.07614</em>.
</div>
<div id="ref-Cox_1972" class="csl-entry" role="listitem">
Cox, D. R. 1972. <span>“Regression Models and Life-Tables.”</span> <em>Journal of the Royal Statistical Society: Series B (Methodological)</em> 34 (2): 187–202. <a href="https://doi.org/10.1111/j.2517-6161.1972.tb00899.x">https://doi.org/10.1111/j.2517-6161.1972.tb00899.x</a>.
</div>
<div id="ref-HTE_causal_survival_forests" class="csl-entry" role="listitem">
Cui, Yifan, Michael R Kosorok, Erik Sverdrup, Stefan Wager, and Ruoqing Zhu. 2023. <span>“<span class="nocase">Estimating heterogeneous treatment effects with right-censored data via causal survival forests</span>.”</span> <em>Journal of the Royal Statistical Society Series B: Statistical Methodology</em> 85 (2): 179–211. <a href="https://doi.org/10.1093/jrsssb/qkac001">https://doi.org/10.1093/jrsssb/qkac001</a>.
</div>
<div id="ref-ebrahimi2003identifiability" class="csl-entry" role="listitem">
Ebrahimi, Nader, Daniel Molefe, and Zhiliang Ying. 2003. <span>“Identifiability and Censored Data.”</span> <em>Biometrika</em> 90 (3): 724–27.
</div>
<div id="ref-EMA_RWD" class="csl-entry" role="listitem">
European Medecines Agency, EMA. 2024. <span>“Reflection Paper on Use of Real-World Data in Non-Interventional Studies to Generate Real-World Evidence.”</span> <a href="https://www.ema.europa.eu/en/reflection-paper-use-real-world-data-non-interventional-studies-generate-real-world-evidence-scientific-guideline">https://www.ema.europa.eu/en/reflection-paper-use-real-world-data-non-interventional-studies-generate-real-world-evidence-scientific-guideline</a>.
</div>
<div id="ref-fan2010high" class="csl-entry" role="listitem">
Fan, Jianqing, Yang Feng, and Yichao Wu. 2010. <span>“High-Dimensional Variable Selection for Cox’s Proportional Hazards Model.”</span> In <em>Borrowing Strength: Theory Powering Applications–a Festschrift for Lawrence d. Brown</em>, 6:70–87. Institute of Mathematical Statistics.
</div>
<div id="ref-LocalLinear_Fan94" class="csl-entry" role="listitem">
Fan, Jianqing, and Irène Gijbels. 1994. <span>“Censored Regression: Local Linear Approximations and Their Applications.”</span> <em>Journal of the American Statistical Association</em> 89 (426): 560–70. <a href="https://doi.org/10.1080/01621459.1994.10476781">https://doi.org/10.1080/01621459.1994.10476781</a>.
</div>
<div id="ref-Foster_2011" class="csl-entry" role="listitem">
Foster, Jared C., Jeremy M. G. Taylor, and Stephen J. Ruberg. 2011. <span>“Subgroup Identification from Randomized Clinical Trial Data.”</span> <em>Statistics in Medicine</em> 30 (24): 2867–80. <a href="https://doi.org/10.1002/sim.4322">https://doi.org/10.1002/sim.4322</a>.
</div>
<div id="ref-Foucher_Le_Borgne_Chatton_2019" class="csl-entry" role="listitem">
Foucher, Yohann, Florent Le Borgne, and Arthur Chatton. 2019. <span>“RISCA: Causal Inference and Prediction in Cohort-Based Analyses.”</span> <em>CRAN: Contributed Packages</em>. The R Foundation. <a href="https://doi.org/10.32614/cran.package.risca">https://doi.org/10.32614/cran.package.risca</a>.
</div>
<div id="ref-gill1983large" class="csl-entry" role="listitem">
Gill, Richard. 1983. <span>“Large Sample Behaviour of the Product-Limit Estimator on the Whole Line.”</span> <em>The Annals of Statistics</em>, 49–58.
</div>
<div id="ref-SurvRM2_2015" class="csl-entry" role="listitem">
Hajime, Uno, Tian Lu, Horiguchi Miki, Cronin Angel, Battioui Chakib, and Bell James. 2015. <span>“survRM2: Comparing Restricted Mean Survival Time.”</span> <em>CRAN: Contributed Packages</em>. The R Foundation. <a href="https://doi.org/10.32614/cran.package.survrm2">https://doi.org/10.32614/cran.package.survrm2</a>.
</div>
<div id="ref-hernan2010causal" class="csl-entry" role="listitem">
Hernán, Miguel A, and James M Robins. 2010. <span>“Causal Inference.”</span> CRC Boca Raton, FL.
</div>
<div id="ref-hirano2003efficient" class="csl-entry" role="listitem">
Hirano, Keisuke, Guido W Imbens, and Geert Ridder. 2003. <span>“Efficient Estimation of Average Treatment Effects Using the Estimated Propensity Score.”</span> <em>Econometrica</em> 71 (4): 1161–89.
</div>
<div id="ref-Howe2016SelectionBD" class="csl-entry" role="listitem">
Howe, Chanelle J, Stephen R. Cole, Bryan Lau, Sonia Napravnik, and Joseph J. Eron. 2016. <span>“Selection Bias Due to Loss to Follow up in Cohort Studies.”</span> <em>Epidemiology</em> 27 1: 91–97. <a href="https://api.semanticscholar.org/CorpusID:21993915">https://api.semanticscholar.org/CorpusID:21993915</a>.
</div>
<div id="ref-huitfeldt2019collapsibility" class="csl-entry" role="listitem">
Huitfeldt, A., M. Stensrud, and E. Suzuki. 2019. <span>“On the Collapsibility of Measures of Effect in the Counterfactual Causal Framework.”</span> <em>Emerging Themes in Epidemiology</em> 16: 1–12.
</div>
<div id="ref-ishwaran2008random" class="csl-entry" role="listitem">
Ishwaran, Hemant, Udaya B. Kogalur, Eugene H. Blackstone, and Michael S. Lauer. 2008. <span>“<span class="nocase">Random survival forests</span>.”</span> <em>The Annals of Applied Statistics</em> 2 (3): 841–60. <a href="https://doi.org/10.1214/08-AOAS169">https://doi.org/10.1214/08-AOAS169</a>.
</div>
<div id="ref-kalbfleisch2002statistical" class="csl-entry" role="listitem">
Kalbfleisch, John D, and Ross L Prentice. 2002. <em>The Statistical Analysis of Failure Time Data</em>. John Wiley &amp; Sons.
</div>
<div id="ref-kaplan" class="csl-entry" role="listitem">
Kaplan, E. L., and Paul Meier. 1958. <span>“Nonparametric Estimation from Incomplete Observations.”</span> <em>Journal of the American Statistical Association</em> 53 (282): 457–81. <a href="https://doi.org/10.1080/01621459.1958.10501452">https://doi.org/10.1080/01621459.1958.10501452</a>.
</div>
<div id="ref-IPCtransKoul81" class="csl-entry" role="listitem">
Koul, H., V. Susarla, and J. Van Ryzin. 1981. <span>“<span class="nocase">Regression Analysis with Randomly Right-Censored Data</span>.”</span> <em>The Annals of Statistics</em> 9 (6): 1276–88. <a href="https://doi.org/10.1214/aos/1176345644">https://doi.org/10.1214/aos/1176345644</a>.
</div>
<div id="ref-Soren_2019" class="csl-entry" role="listitem">
Künzel, Sören R., Jasjeet S. Sekhon, Peter J. Bickel, and Bin Yu. 2019. <span>“Metalearners for Estimating Heterogeneous Treatment Effects Using Machine Learning.”</span> <em>Proceedings of the National Academy of Sciences</em> 116 (10): 4156–65. <a href="https://doi.org/10.1073/pnas.1804597116">https://doi.org/10.1073/pnas.1804597116</a>.
</div>
<div id="ref-vanderLaan2003" class="csl-entry" role="listitem">
Laan, Mark J. van der, and James M. Robins. 2003. <span>“Introduction.”</span> In <em>Unified Methods for Censored Longitudinal Data and Causality</em>, 8–101. New York, NY: Springer New York. <a href="https://doi.org/10.1007/978-0-387-21700-0_1">https://doi.org/10.1007/978-0-387-21700-0_1</a>.
</div>
<div id="ref-HR_Martinussen" class="csl-entry" role="listitem">
Martinussen, Torben, Stijn Vansteelandt, and Per Andersen. 2020. <span>“Subtleties in the Interpretation of Hazard Contrasts.”</span> <em>Lifetime Data Analysis</em> 26 (October). <a href="https://doi.org/10.1007/s10985-020-09501-5">https://doi.org/10.1007/s10985-020-09501-5</a>.
</div>
<div id="ref-Ozenne20_AIPTW_AIPCW" class="csl-entry" role="listitem">
Ozenne, Brice Maxime Hugues, Thomas Harder Scheike, Laila Stærk, and Thomas Alexander Gerds. 2020. <span>“On the Estimation of Average Treatment Effects with Right-Censored Time to Event Outcome and Competing Risks.”</span> <em>Biometrical Journal</em> 62 (3): 751–63. <a href="https://doi.org/10.1002/bimj.201800298">https://doi.org/10.1002/bimj.201800298</a>.
</div>
<div id="ref-robins1994estimation" class="csl-entry" role="listitem">
Robins, James M., Andrea Rotnitzky, and Lue Ping Zhao. 1994. <span>“Estimation of Regression Coefficients When Some Regressors Are Not Always Observed.”</span> <em>Journal of the American Statistical Association</em> 89 (427): 846–66.
</div>
<div id="ref-Propensity_causality" class="csl-entry" role="listitem">
Rosenbaum, Paul R., and Donald B. Rubin. 1983. <span>“<span class="nocase">The central role of the propensity score in observational studies for causal effects</span>.”</span> <em>Biometrika</em> 70 (1): 41–55. <a href="https://doi.org/10.1093/biomet/70.1.41">https://doi.org/10.1093/biomet/70.1.41</a>.
</div>
<div id="ref-royston2013restricted" class="csl-entry" role="listitem">
Royston, Patrick, and Mahesh KB Parmar. 2013. <span>“Restricted Mean Survival Time: An Alternative to the Hazard Ratio for the Design and Analysis of Randomized Trials with a Time-to-Event Outcome.”</span> <em>BMC Medical Research Methodology</em> 13: 1–15.
</div>
<div id="ref-DoublyR_transformation" class="csl-entry" role="listitem">
Rubin, Daniel, and Mark J. van der Laan. 2007. <em>The International Journal of Biostatistics</em> 3 (1). <a href="https://doi.org/10.2202/1557-4679.1052">https://doi.org/10.2202/1557-4679.1052</a>.
</div>
<div id="ref-rubin_estimating_1974" class="csl-entry" role="listitem">
Rubin, Donald B. 1974. <span>“Estimating Causal Effects of Treatments in Randomized and Nonrandomized Studies.”</span> <em>Journal of Educational Psychology</em> 66 (5): 688–701. <a href="https://doi.org/10.1037/h0037350">https://doi.org/10.1037/h0037350</a>.
</div>
<div id="ref-Schaubel2011" class="csl-entry" role="listitem">
Schaubel, Douglas E., and Guanghui Wei. 2011. <span>“<span class="nocase">Double Inverse-Weighted Estimation of Cumulative Treatment Effects under Nonproportional Hazards and Dependent Censoring</span>.”</span> <em>Biometrics</em> 67 (1): 29–38. <a href="https://doi.org/10.1111/j.1541-0420.2010.01449.x">https://doi.org/10.1111/j.1541-0420.2010.01449.x</a>.
</div>
<div id="ref-Therneau_2001" class="csl-entry" role="listitem">
Therneau, Terry M. 2001. <span>“Survival: Survival Analysis.”</span> <em>CRAN: Contributed Packages</em>. The R Foundation. <a href="https://doi.org/10.32614/cran.package.survival">https://doi.org/10.32614/cran.package.survival</a>.
</div>
<div id="ref-Tibshirani_Athey_Sverdrup_Wager_2017" class="csl-entry" role="listitem">
Tibshirani, Julie, Susan Athey, Erik Sverdrup, and Stefan Wager. 2017. <span>“Grf: Generalized Random Forests.”</span> <em>CRAN: Contributed Packages</em>. The R Foundation. <a href="https://doi.org/10.32614/cran.package.grf">https://doi.org/10.32614/cran.package.grf</a>.
</div>
<div id="ref-censoring_effect" class="csl-entry" role="listitem">
Turkson, Anthony, Francis Ayiah-Mensah, and Vivian Nimoh. 2021. <span>“Handling Censoring and Censored Data in Survival Analysis: A Standalone Systematic Literature Review.”</span> <em>International Journal of Mathematics and Mathematical Sciences</em> 2021 (September): 1–16. <a href="https://doi.org/10.1155/2021/9307475">https://doi.org/10.1155/2021/9307475</a>.
</div>
<div id="ref-IPTW" class="csl-entry" role="listitem">
Xie, Jun, and Chaofeng Liu. 2005. <span>“Adjusted Kaplan–Meier Estimator and Log-Rank Test with Inverse Probability of Treatment Weighting for Survival Data.”</span> <em>Statistics in Medicine</em> 24 (20): 3089–3110. <a href="https://doi.org/10.1002/sim.2174">https://doi.org/10.1002/sim.2174</a>.
</div>
<div id="ref-zhang2016parametric" class="csl-entry" role="listitem">
Zhang, Zhongheng. 2016. <span>“Parametric Regression Model for Survival Data: Weibull Regression Model as an Example.”</span> <em>Annals of Translational Medicine</em> 4 (24).
</div>
<div id="ref-zhou1988two" class="csl-entry" role="listitem">
Zhou, M. 1988. <span>“Two-Sided Bias Bound of the Kaplan-Meier Estimator.”</span> <em>Probability Theory and Related Fields</em> 79 (2): 165–73.
</div>
</div>
</section>




<div id="quarto-appendix" class="default"><section id="appendix-a-proofs" class="level1 appendix" data-number="7"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">7</span> Appendix A: Proofs</h2><div class="quarto-appendix-contents">

<section id="sec-proof21" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="sec-proof21"><span class="header-section-number">7.1</span> Proofs of <a href="#sec-theoryRCT_indc" class="quarto-xref">Section&nbsp;2.1</a></h2>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-km" class="quarto-xref">Proposition&nbsp;1</a>).</em> Consistency is a trivial consequence of the law of large number and the identity <a href="#eq-kmi" class="quarto-xref">11</a>. To show that <span class="math inline">\widehat S_{\mathrm{KM}}</span> is unbiased, let us introduce <span class="math inline">\mathcal{F}_k</span> be the filtration generated by the set of variables <span class="math display">
\{A_i, \mathbb{I}\{\widetilde T_i = t_j\}, \mathbb{I}\{\widetilde T_i = t_j, \Delta_i=1\}~|~j \in [k], i \in [n]\}.
</span> which corresponds to the known information up to time <span class="math inline">t_k</span>, so that <span class="math inline">D_k(a)</span> is <span class="math inline">\mathcal{F}_k</span>-measurable but <span class="math inline">N_k(a)</span> is <span class="math inline">\mathcal{F}_{k-1}</span>-measurable. One can write that, for <span class="math inline">k\geqslant 2</span> <span class="math display">\begin{align*}
\mathbb{E}[\mathbb{I}\{\widetilde T_i = t_k, \Delta_i = 1, A_i=a\}~|~\mathcal{F}_{k-1}] &amp;= \mathbb{E}[\mathbb{I}\{\widetilde T_i = t_k, \Delta_i = 1, A_i=a\}~|~\mathbb{I}\{\widetilde T_i \geqslant t_k\},A_i]  \\
&amp;= \mathbb{I}\{A_i=a\} \mathbb{E}[\mathbb{I}\{T_i = t_k, C_i \geqslant t_k\}~|~\mathbb{I}\{T_i \geqslant t_k, C_i \geqslant t_k\}, A_i] \\
&amp;=  \mathbb{I}\{A_i=a\} \mathbb{I}\{C_i \geqslant t_k\} \mathbb{E}[\mathbb{I}\{T_i = t_k\} ~|~ \mathbb{I}\{T_i \geqslant t_k\}, A_i] \\
&amp;= \mathbb{I}\{\widetilde T_i \geqslant t_k, A_i=a\}\left(1- \frac{S^{(a)}(t_{k})}{S^{(a)}(t_{k-1})}\right),
\end{align*}</span> where we used that <span class="math inline">T_i(a)</span> is idependant from <span class="math inline">A_i</span> by Assumption <a href="#eq-rta" class="quarto-xref">5</a>. We then easily derive from this that <span class="math display">
\mathbb{E}\left[\left(1-\frac{D_k(a)}{N_k(a)} \right) \mathbb{I}\{N_k(a) &gt;0\}\middle |\mathcal{F}_{k-1}\right] = \frac{S^{(a)}(t_k)}{S^{(a)}(t_{k-1})} \mathbb{I}\{N_k(a) &gt;0\},
</span> and then that <span class="math display">
\mathbb{E}\left[\widehat S_{\mathrm{KM}}(t_k|A=a)\middle |\mathcal{F}_{k-1}\right] =  \frac{S^{(a)}(t_k)}{S^{(a)}(t_{k-1})} \widehat S_{\mathrm{KM}}(t_{k-1}|A=a) + O(\mathbb{I}\{N_k(a) =0\}),
</span></p>
<p>By induction, we easily find that <span class="math display">
\mathbb{E}[\widehat S_{\mathrm{KM}}(t|A=a)] = \prod_{t_j \leqslant t} \frac{S^{(a)}(t_j)}{S^{(a)}(t_{j-1})} + O\left(\sum_{t_j \leqslant t}\mathbb{P}(N_j(a) =0)\right)= S^{(a)}(t) + O(\mathbb{P}(N_k(a) =0))
</span> where <span class="math inline">t_k</span> is the greatest time such that <span class="math inline">t_k \leqslant t</span>.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-varkm" class="quarto-xref">Proposition&nbsp;2</a>).</em> The asymptotic normality is a mere consequence of the joint asymptotic normality of <span class="math inline">(N_k(a),D_k(a))_{t_k \leqslant t}</span> with an application of the <span class="math inline">\delta</span>-method. To access the asymptotic variance, notice that, using a similar reasonning as in the previous proof: <span class="math display">\begin{align*}
\mathbb{E}[(1-D_k(a)/N_k(a))^2|\mathcal{F}_{k-1}] &amp;= \mathbb{E}[1-D_k(a)/N_k(a)|\mathcal{F}_{k-1}(a)]^2+\frac{1}{N_k(a)^2}\mathrm{Var}(D_k(a)|\mathcal{F}_{k-1}) \\
&amp;= s_k^2(a)+ \frac{s_k(a)(1-s_k(a))}{N_k(a)}\mathbb{I}\{N_k(a) &gt; 0\} + O(\mathbb{I}\{N_k(a) = 0\}).
\end{align*}</span> Now we know that <span class="math inline">N_k(a) = n r_k(a) + \sqrt{n} O_{\mathbb{P}}(1)</span>, with the <span class="math inline">O_{\mathbb{P}}(1)</span> having uniformly bounded moments. So that we deduce that <span class="math display">
\begin{aligned}
\mathbb{E}[(1-D_k(a)/N_k(a))^2|\mathcal{F}_{k-1}] &amp;= s_k^2(a)+ \frac{s_k(a)(1-s_k(a))}{n r_k(a)} +  \frac{1}{n^{3/2}} O_{\mathbb{P}}(1),
\end{aligned}
</span> where <span class="math inline">O_{\mathbb{P}}(1)</span> has again bounded moments. Using this identity, we find that <span class="math display">
\begin{aligned}
n \mathrm{Var}\widehat S_{\mathrm{KM}} (t|A=a) &amp;= n \left(\mathbb{E}S_{\mathrm{KM}} (t|A=a)^2 -  S^{(a)} (t)^2 \right) \\
&amp;= n S^{(a)}(t)^2 \left(\mathbb{E}\left[\prod_{t_k \leqslant t}  \left(1+\frac1n\frac{1-s_k(a)}{s_k(a) r_k(a)} +   \frac{1}{n^{3/2}} O_{\mathbb{P}}(1) \right)\right]-1\right).
\end{aligned}
</span> Expending the product and using that the <span class="math inline">O_{\mathbb{P}}(1)</span>’s have bounded moments, we finally deduce that <span class="math display">
\begin{aligned}
\mathbb{E}\left[\prod_{t_k \leqslant t}  \left(1+\frac1n\frac{1-s_k(a)}{s_k(a) r_k(a)} +   \frac{1}{n^{3/2}} O_{\mathbb{P}}(1) \right)\right]-1 =   \frac1n \sum_{t_k \leqslant t}\frac{1-s_k(a)}{s_k(a) r_k(a)} +   \frac{1}{n^{3/2}} O(1),
\end{aligned}
</span></p>
<p><span class="math display">
n\mathrm{Var}\widehat S_{\mathrm{KM}} (t|A=a) = V_{\mathrm{KM}}(t|A=a) + O(n^{-1/2}),  
</span> which is what we wanted to show.</p>
</div>
</section>
<section id="sec-proof22" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="sec-proof22"><span class="header-section-number">7.2</span> Proofs of <a href="#sec-condcens" class="quarto-xref">Section&nbsp;2.2</a></h2>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-ipcw" class="quarto-xref">Proposition&nbsp;5</a>).</em> Assumption <a href="#eq-positivitycensoring" class="quarto-xref">17</a> allows the tranformation to be well-defined. Furthermore, it holds <span class="math display">\begin{align*}
E[T^*_{\mathrm{IPCW}}|A=a,X]
&amp;= E\left[\frac{ \Delta^\tau \times\widetilde T \wedge \tau}{G(\widetilde T \wedge \tau | A,X)} \middle | A = a,X\right]  \\
&amp;= E\left[\frac{ \Delta^\tau \times T(a) \wedge \tau}{G(T(a) \wedge \tau | A,X)} \middle | A = a,X\right]\\
&amp;= E\left[ E\left[\frac{ \mathbb{I}\{T(a)\wedge \tau \leqslant C \} \times T(a) \wedge \tau}{G(T(a) \wedge \tau | A,X)}\middle| A, X,T(1) \right] \middle | A = a,X\right] \\
&amp;= E\left[T(a) \wedge \tau|A=a, X\right] \\
&amp;= E\left[T(a) \wedge \tau | X \right].
\end{align*}</span> We used in the second equality that on the event <span class="math inline">\{\Delta^\tau=1, A=a\}</span>, it holds <span class="math inline">\widetilde T \wedge \tau =  T \wedge \tau = T(a) \wedge \tau</span>. We used in the fourth equality that <span class="math inline">G(T(a) \wedge \tau | A,X) = E[\mathbb{I}\{T(a) \wedge \tau \leqslant C\}|X,T(a),A]</span> thanks to Assumption <a href="#eq-condindepcensoring" class="quarto-xref">16</a>, and in the last one that <span class="math inline">A</span> is idependent from <span class="math inline">X</span> and <span class="math inline">T(a)</span> thanks to Assumption <a href="#eq-rta" class="quarto-xref">5</a>.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-ipcwkm" class="quarto-xref">Proposition&nbsp;6</a>).</em> Similarly to the computations done in the proof of <a href="#prp-ipcw" class="quarto-xref">Proposition&nbsp;5</a>, it is easy to show that <span class="math display">
\mathbb{E}\left[\frac{\Delta_i^\tau}{G(\widetilde T \wedge\tau | X,A)} \mathbb{I}(\widetilde T_i = t_k, A=a)\right] = \mathbb{P}(A=a) \mathbb{P}(T(a) = t_k),
</span> and likewise that <span class="math display">
\mathbb{E}\left[\frac{\Delta_i^\tau}{G(\widetilde T \wedge\tau | X,A)} \mathbb{I}(\widetilde T_i \geqslant t_k, A=a)\right] = \mathbb{P}(A=a) \mathbb{P}(T(a) \geqslant t_k),
</span> so that <span class="math inline">\widehat S_{\mathrm{IPCW}}(t)</span> converges almost surely towards the product limit <span class="math display">
\prod_{t_k \leqslant t} \left(1-\frac{\mathbb{P}(T(a) = t_k)}{\mathbb{P}(T(a) \geqslant t_k)}\right) = S^{(a)}(t),
</span> yielding strong consistency. Asymptotic normality is straightforward.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-bj" class="quarto-xref">Proposition&nbsp;7</a>).</em> There holds <span class="math display">
\begin{aligned}
\mathbb{E}[T_{\mathrm{BJ}}^*|X,A=a] &amp;= \mathbb{E}\left[\Delta^\tau T(a) \wedge \tau + (1-\Delta^\tau)\frac{\mathbb{E}[T \wedge \tau \times \mathbb{I}\{T \wedge \tau &gt; C\}|C,A,X]}{\mathbb{P}(T &gt; C|C,A,X)} \middle | X,A=a \right] \\
&amp;= \mathbb{E}[\Delta^\tau T(a) \wedge \tau | X ] +  \underbrace{\mathbb{E}\left[ \mathbb{I}\{T \wedge \tau &gt; C\} \frac{\mathbb{E}[T \wedge \tau \times \mathbb{I}\{T \wedge \tau &gt; C\}|C,A,X]}{\mathbb{E}[\mathbb{I}\{T \wedge \tau \geqslant C\}|C,A,X]}\middle | X,A=a \right]}_{(\star)}.
\end{aligned}
</span> Now we easily see that conditionning wrt <span class="math inline">X</span> in the second term yields <span class="math display">\begin{align*}
(\star) &amp;= \mathbb{E}\left[ \mathbb{E}[T \wedge \tau \times \mathbb{I}\{T \wedge \tau &gt; C\}|C,A,X] \middle | X,A=a \right] \\
&amp;= \mathbb{E}[(1-\Delta^\tau) T \wedge \tau | X,A=a ]  \\
&amp;= \mathbb{E}[(1-\Delta^\tau)  T(a) \wedge \tau | X],
\end{align*}</span> ending the proof.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#thm-bj" class="quarto-xref">Theorem&nbsp;1</a>).</em> We let <span class="math inline">T^* = \Delta^\tau \phi_1 + (1-\Delta^\tau)\phi_0</span> be a transformation of the form <a href="#eq-defcut" class="quarto-xref">Equation&nbsp;20</a>. There holds <span class="math display">
\mathbb{E}[(T^*-T \wedge \tau)^2] = \mathbb{E}[\Delta^\tau (\phi_1-T \wedge \tau)^2] + \mathbb{E}[(1-\Delta^\tau)(\phi_0-T \wedge \tau)^2].
</span> The first term is non negative and is zero for the BJ transformation. Since <span class="math inline">\phi_0</span> is a function of <span class="math inline">(\widetilde T, X, A)</span> and that <span class="math inline">\widetilde T = C</span> on <span class="math inline">\{\Delta^\tau = 0\}</span>, the second term can be rewritten in the following way. We let <span class="math inline">R</span> be a generic quantity that does not depend on <span class="math inline">\phi_0</span>. <span class="math display">\begin{align*}
\mathbb{E}&amp;[(1-\Delta^\tau)(\phi_0-T)^2] = \mathbb{E}\left[\mathbb{I}\{T\wedge \tau &gt; C\} \phi_0^2 - 2 \mathbb{I}\{T\wedge \tau &gt; C\} \phi_0 T \wedge \tau\right]  + R \\
&amp;= \mathbb{E}\left[ \mathbb{P}(T\wedge \tau &gt; C|C,A,X) \phi_0^2 - 2 \mathbb{E}[T\wedge \tau \mathbb{I}\{T\wedge \tau &gt; C\}|C,A,X] \phi_0 \right] + R \\
&amp;= \mathbb{E}\left[\mathbb{P}(T\wedge \tau &gt; C|C,A,X) \left(\phi_0- \frac{\mathbb{E}[T\wedge \tau \mathbb{I}\{T\wedge \tau &gt; C\}|C,A,X]}{\mathbb{P}(T\wedge \tau &gt; C|C,A,X) }\right)^2\right] + R.
\end{align*}</span> Now the first term in the right hand side is always non-negative, and is zero for the BJ tranformation.</p>
</div>
</section>
<section id="sec-proof31" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="sec-proof31"><span class="header-section-number">7.3</span> Proofs of <a href="#sec-obs_indcen" class="quarto-xref">Section&nbsp;3.1</a></h2>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-iptwkm" class="quarto-xref">Proposition&nbsp;9</a>).</em> The fact that it is strongly consistent and asymptotically normal is again a simple application of the law of large number and of the <span class="math inline">\delta</span>-method. We indeed find that, for <span class="math inline">t_k \leqslant\tau</span> <span class="math display">
\begin{aligned}
\mathbb{E}\left[\frac{1}{e(X_i)} \mathbb{1}\{\widetilde T_i = t_k, \Delta_i = 1, A_i=1\}\right] &amp;= \mathbb{E}\left[\frac{A_i}{e(X_i)} \mathbb{1}\{T_i = t_k, C_i \geqslant t_k\}\right] \\
&amp;=\mathbb{E}\left[ \mathbb{E}\left[ \frac{A_i}{e(X_i)} \mathbb{1}\{T_i = t_k, C_i \geqslant t_k\} \middle |X_i \right]\right] \\
&amp;= \mathbb{E}\left[ \mathbb{E}\left[\frac{A_i}{e(X_i)}\middle | X_i\right] \mathbb{P}(T_i = t_k |X_i) \mathbb{P}( C_i \geqslant t_k)\right] \\
&amp;= \mathbb{P}(T_i = t_k) \mathbb{P}( C_i \geqslant t_k),
\end{aligned}
</span> where we used that <span class="math inline">A</span> is independent from <span class="math inline">T</span> conditionnaly on <span class="math inline">X</span>, and that <span class="math inline">C</span> is independent from everything. Likewise, one would get that <span class="math display">
\begin{aligned}
\mathbb{E}\left[\frac{1}{e(X_i)} \mathbb{1}\{\widetilde T_i \geqslant t_k, A_i=1\}\right] =
&amp;= \mathbb{P}(T_i \geqslant t_k) \mathbb{P}( C_i \geqslant t_k).
\end{aligned}
</span> Similar computations hold for <span class="math inline">A=0</span>, ending the proof.</p>
</div>
<!-- ::: {.proof} -->
<!-- _(@prp-variptwkm)._ -->
<!-- We let  -->
<!-- $$ -->
<!-- s_k(X) := \frac{S^{(1)}(t_k|X)}{S^{(1)}(t_{k-1}|X)}. -->
<!-- $$ -->
<!-- Similar computation as in the proof of @prp-varkm show that -->
<!-- $$ -->
<!-- \bbE\left[\left(1-\frac{D_k^{\mathrm{IPTW}}(1)}{N_k^{\mathrm{IPTW}}(1)}\right)^2\right | \cF_{k-1},\cX] = -->
<!-- $$ -->
<!-- ::: -->
<!-- ::: {.proof} -->
<!-- _(@prp-tdr)._ -->
<!-- ::: -->
</section>
<section id="sec-proof32" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="sec-proof32"><span class="header-section-number">7.4</span> Proofs of <a href="#sec-obscondcens" class="quarto-xref">Section&nbsp;3.2</a></h2>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-iptwipcw" class="quarto-xref">Proposition&nbsp;10</a>).</em> On the event <span class="math inline">\{\Delta^\tau=1, A=1\}</span>, there holds <span class="math inline">\widetilde T \wedge \tau = T \wedge \tau = T(1) \wedge \tau</span>, whence we find that, <span class="math display">
\begin{aligned}
\mathbb{E}[ T^*_{\mathrm{IPCW}}|X,A=1] &amp;= \mathbb{E}\left[\frac{A}{e(X)} \frac{\mathbb{I}\{T(1) \wedge \tau \leqslant C\}}{G(T(1) \wedge \tau|X,A)} T(1) \wedge \tau\middle|X\right] \\
&amp;= \mathbb{E}\left[ \frac{A}{e(X)} \mathbb{E}\left[\frac{\mathbb{I}\{T(1) \wedge \tau \leqslant C\}}{G(T(1) \wedge \tau|X,A)} \middle| X,A, T(1) \right]T(1) \wedge \tau\middle|X\right] \\
&amp;=\mathbb{E}\left[ \frac{A}{e(X)} T(1) \wedge \tau\middle|X\right] \\
&amp;=\mathbb{E}\left[T(1) \wedge \tau\middle|X\right],
\end{aligned}
</span> and the same holds on the event <span class="math inline">A=0</span>.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-consiptwipcw" class="quarto-xref">Proposition&nbsp;11</a>).</em> By consistency of <span class="math inline">\widehat G(\cdot|X,A)</span> and <span class="math inline">\widehat e</span> and by continuity, it suffices to look at the asymptotic behavior of the oracle estimator <span class="math display">
\theta^*_{\mathrm{IPTW-IPCW}} = \frac1n\sum_{i=1}^n  \left(\frac{A_i}{ e(X_i)}-\frac{1-A_i}{1-e(X_i)} \right)\frac{\Delta_i^\tau}{G(\widetilde T_i \wedge \tau | A_i,X_i)} \widetilde T_i \wedge \tau.
</span> The later is converging almost towards its mean, which, following similar computations as in the previous proof, write <span class="math display">
\begin{aligned}
\mathbb{E}\left[\left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right)\frac{\Delta^\tau}{G(\widetilde T \wedge \tau | A,X)} \widetilde T \wedge \tau\right]  
&amp;= \mathbb{E}\left[\left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right) T \wedge \tau\right] \\
&amp;= \mathbb{E}\left[T(1) \wedge \tau\right]-\mathbb{E}\left[T(0) \wedge \tau\right].
\end{aligned}
</span></p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-iptwipcwkm" class="quarto-xref">Proposition&nbsp;12</a>).</em> Asymptotic normality comes from a mere application of the <span class="math inline">\delta</span>-method, while strong consistency follows from the law of large number and the follozing computations. Like for the proof of <a href="#prp-ipcwkm" class="quarto-xref">Proposition&nbsp;6</a>, one find, by first conditionning wrt <span class="math inline">X,A,T(a)</span>, that, for <span class="math inline">t_k \leqslant\tau</span>, <span class="math display">
\begin{aligned}
\mathbb{E}\left[\left(\frac{A}{e(X)}+\frac{1-A}{1-e(X)} \right)\frac{\Delta^\tau}{G(\widetilde T \wedge \tau | A,X)} \mathbb{I}\{\widetilde T = t_k, A=a\}\right] = \mathbb{P}(T(a)=t_k)
\end{aligned}
</span> and likewise that <span class="math display">
\begin{aligned}
\mathbb{E}\left[\left(\frac{A}{e(X)}+\frac{1-A}{1-e(X)} \right)\frac{\Delta^\tau}{G(\widetilde T \wedge \tau | A,X)} \mathbb{I}\{\widetilde T \geqslant t_k, A=a\}\right] = \mathbb{P}(T(a)\geqslant t_k)
\end{aligned}
</span> so that indeed <span class="math inline">S^*_{\mathrm{IPTW-IPCW}} (t|A=a)</span> converges almost surely towards <span class="math inline">S^{(a)}(t)</span>.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-iptwbj" class="quarto-xref">Proposition&nbsp;13</a>).</em> We write <span class="math display">
\begin{aligned}
\mathbb{E}[ T^*_{\mathrm{IPTW-BJ}}|X,A=1] &amp;= \mathbb{E}\left[\frac{A}{e(X)} \Delta^\tau \times \widetilde T \wedge \tau\middle|X\right] + \mathbb{E}\left[\frac{A}{e(X)} (1-\Delta^\tau) Q_S(\widetilde T \wedge \tau|A,X) \middle| X\right].
\end{aligned}
</span> On the event <span class="math inline">\{\Delta^\tau=1, A=1\}</span>, there holds <span class="math inline">\widetilde T \wedge \tau = T \wedge \tau = T(1) \wedge \tau</span>, whence we find that the first term on the the right hand side is equal to <span class="math display">
\begin{aligned}
\mathbb{E}\left[\frac{A}{e(X)} \Delta^\tau \times \widetilde T \wedge \tau\middle|X\right] &amp;= \mathbb{E}\left[\frac{A}{e(X)} \Delta^\tau \times T(1) \wedge \tau\middle|X\right] \\
&amp;= \mathbb{E}\left[\Delta^\tau \times T(1) \wedge \tau\middle|X\right].
\end{aligned}
</span> For the second term in the right hand side, notice that on the event <span class="math inline">\{\Delta^\tau=0, A=1\}</span>, there holds <span class="math inline">\widetilde T = C &lt; T(1) \wedge \tau</span>, so that <span class="math display">
\begin{aligned}
\mathbb{E}&amp;\left[\frac{A}{e(X)} \mathbb{I}\{C &lt; T(1) \wedge \tau\} \frac{\mathbb{E}[T(1) \wedge \tau \times \mathbb{I}\{C &lt; T(1) \wedge \tau\}|X,A,C]}{\mathbb{P}(C &lt; T(1) \wedge \tau | C,X,A)} \middle| X\right] \\
&amp;= \mathbb{E}\left[\frac{A}{e(X)} \mathbb{E}[T(1) \wedge \tau \times \mathbb{I}\{C &lt; T(1) \wedge \tau\}|X,A,C] \middle| X\right] \\
&amp;= \mathbb{E}\left[T(1) \wedge \tau \times \mathbb{I}\{C &lt; T(1) \wedge \tau\} \middle| X\right] \\
&amp;= \mathbb{E}\left[(1-\Delta^\tau) T(1) \wedge \tau  \middle| X\right],
\end{aligned}
</span> and the sane holds on the event <span class="math inline">\{A=0\}</span>, which ends the proof.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-consiptwbj" class="quarto-xref">Proposition&nbsp;14</a>).</em> By consistency of <span class="math inline">\widehat G(\cdot|X,A)</span> and <span class="math inline">\widehat e</span> and by continuity, it suffices to look at the asymptotic behavior of the oracle estimator <span class="math display">
\theta^*_{\mathrm{IPTW-BJ}} = \frac1n\sum_{i=1}^n  \left(\frac{A_i}{ e(X_i)}-\frac{1-A_i}{1-e(X_i)} \right)\left(\Delta_i^\tau \times \widetilde T_i \wedge \tau + (1-\Delta_i^\tau) Q_S(\widetilde T_i \wedge \tau|A_i,X_i)\right).
</span> The later is converging almost towards its mean, which, following similar computations as in the previous proof, is simply equal to the difference in RMST.</p>
</div>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><em>(<a href="#prp-tqr" class="quarto-xref">Proposition&nbsp;15</a>).</em> We can write that <span class="math display">
\Delta^*_{\mathrm{QR}} = \underbrace{\frac{A}{p(X)}(T^*_{\mathrm{DR}}(F,R)-\nu(X,1))+ \nu(X,1)}_{(\mathrm{A})} - \left(\underbrace{\frac{1-A}{1-p(X)}(T^*_{\mathrm{DR}}(F,R)-\nu(X,0))+ \nu(X,0)}_{(\mathrm{B})} \right).
</span> Focusing on term <span class="math inline">(\mathrm{A})</span>, we easily find that <span class="math display">
\begin{aligned}
\mathbb{E}[(\mathrm{A}) |X] &amp;= \mathbb{E}\left[\frac{A}{p(X)}(T^*_{\mathrm{DR}}(F,R)-\nu(X,1))+ \nu(X,1) \middle|X\right] \\
&amp;= \frac{e(X)}{p(X)}(\mu(X,1)-\nu(X,1)) + \nu(X,1).
\end{aligned}
</span> Where we used that <span class="math inline">T^*_{\mathrm{DR}}(F,R)</span> is a censoring unbiased transform when <span class="math inline">F=G</span> or <span class="math inline">R=S</span>. Now we see that if <span class="math inline">p(X) = e(X)</span>, then <span class="math display">
\mathbb{E}[(\mathrm{A}) |X] = \mu(X,1)-\nu(X,1) + \nu(X,1) = \mu(X,1),
</span> and if <span class="math inline">\nu(X,1) = \mu(X,1)</span>, then <span class="math display">
\mathbb{E}[(\mathrm{A}) |X] = \frac{e(X)}{p(X)} \times 0 + \mu(X,1) = \mu(X,1).
</span> Likewise, we would show that <span class="math inline">\mathbb{E}[(\mathrm{B}) |X] = \mu(X,0)</span> under either alternative, ending the proof.</p>
</div>
</section>
</div></section><section id="appendix-b-descriptive-statistics" class="level1 appendix" data-number="8"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">8</span> Appendix B: Descriptive statistics</h2><div class="quarto-appendix-contents">

<section id="sec-stat_RCT" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="sec-stat_RCT"><span class="header-section-number">8.1</span> RCT</h2>
<p>The summary by group of treatment of the generated (observed and unobserved) RCT with independent censoring is displayed below:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=0:   1006"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                X4         
 Min.   :-2.3909   Min.   :-2.2838   Min.   :-3.9407   Min.   :-2.5444  
 1st Qu.: 0.3194   1st Qu.: 0.3741   1st Qu.:-1.6243   1st Qu.: 0.2510  
 Median : 0.9794   Median : 1.0272   Median :-0.9104   Median : 0.9498  
 Mean   : 0.9967   Mean   : 1.0386   Mean   :-0.9586   Mean   : 0.9545  
 3rd Qu.: 1.6256   3rd Qu.: 1.6676   3rd Qu.:-0.2659   3rd Qu.: 1.6546  
 Max.   : 3.9503   Max.   : 4.5021   Max.   : 2.5108   Max.   : 4.4835  
       C                  T1               T0              status      
 Min.   :  0.0988   Min.   : 10.00   Min.   :  0.002   Min.   :0.0000  
 1st Qu.:  9.6126   1st Qu.: 12.98   1st Qu.:  2.983   1st Qu.:0.0000  
 Median : 23.4157   Median : 18.84   Median :  8.836   Median :1.0000  
 Mean   : 32.9507   Mean   : 31.84   Mean   : 21.837   Mean   :0.6769  
 3rd Qu.: 46.6683   3rd Qu.: 33.71   3rd Qu.: 23.711   3rd Qu.:1.0000  
 Max.   :207.6049   Max.   :459.25   Max.   :449.247   Max.   :1.0000  
     T_tild      
 Min.   : 0.002  
 1st Qu.: 2.246  
 Median : 5.998  
 Mean   :11.291  
 3rd Qu.:15.223  
 Max.   :94.193  </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=1:   994"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                X4         
 Min.   :-1.9288   Min.   :-2.5581   Min.   :-4.3078   Min.   :-2.7048  
 1st Qu.: 0.3775   1st Qu.: 0.3222   1st Qu.:-1.6876   1st Qu.: 0.3757  
 Median : 1.0360   Median : 1.0165   Median :-1.0136   Median : 1.0233  
 Mean   : 1.0282   Mean   : 0.9895   Mean   :-1.0087   Mean   : 1.0423  
 3rd Qu.: 1.7247   3rd Qu.: 1.6329   3rd Qu.:-0.2814   3rd Qu.: 1.6958  
 Max.   : 4.0894   Max.   : 4.1541   Max.   : 2.1174   Max.   : 4.1552  
       C                   T1               T0               status     
 Min.   :  0.00737   Min.   : 10.00   Min.   :  0.0048   Min.   :0.000  
 1st Qu.:  8.74666   1st Qu.: 12.59   1st Qu.:  2.5943   1st Qu.:0.000  
 Median : 22.46584   Median : 18.13   Median :  8.1321   Median :0.000  
 Mean   : 32.67881   Mean   : 33.18   Mean   : 23.1791   Mean   :0.498  
 3rd Qu.: 45.77309   3rd Qu.: 32.82   3rd Qu.: 22.8230   3rd Qu.:1.000  
 Max.   :181.15089   Max.   :871.87   Max.   :861.8721   Max.   :1.000  
     T_tild         
 Min.   :  0.00737  
 1st Qu.:  8.74666  
 Median : 12.36487  
 Mean   : 15.84864  
 3rd Qu.: 19.43464  
 Max.   :178.62365  </code></pre>
</div>
</div>
<p>Covariates are balanced between groups, and censoring times are the same (independent censoring). However, there are more censored observations in the treated group (<span class="math inline">A=1</span>) than in the control group (<span class="math inline">A=0</span>). This is due to the higher instantaneous hazard of the event in the treated group (with <span class="math inline">T_1=T_0+10</span>) compared to the constant hazard of censoring.</p>
<p>The summary of the generated (observed and unobserved) RCT with conditionally independent censoring stratified by treatment is displayed below.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=0:   990"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                X4         
 Min.   :-2.3092   Min.   :-2.6927   Min.   :-4.1894   Min.   :-1.9255  
 1st Qu.: 0.3694   1st Qu.: 0.3191   1st Qu.:-1.7150   1st Qu.: 0.3336  
 Median : 0.9755   Median : 0.9396   Median :-1.0222   Median : 1.0040  
 Mean   : 0.9854   Mean   : 0.9672   Mean   :-1.0255   Mean   : 0.9971  
 3rd Qu.: 1.6103   3rd Qu.: 1.6229   3rd Qu.:-0.2861   3rd Qu.: 1.6375  
 Max.   : 4.0790   Max.   : 4.3783   Max.   : 1.7836   Max.   : 4.7378  
       C                 T1               T0               status      
 Min.   :  0.000   Min.   : 10.02   Min.   :  0.0216   Min.   :0.0000  
 1st Qu.:  2.316   1st Qu.: 13.17   1st Qu.:  3.1655   1st Qu.:0.0000  
 Median :  6.214   Median : 18.93   Median :  8.9325   Median :0.0000  
 Mean   : 13.744   Mean   : 31.39   Mean   : 21.3933   Mean   :0.4404  
 3rd Qu.: 16.076   3rd Qu.: 34.63   3rd Qu.: 24.6332   3rd Qu.:1.0000  
 Max.   :214.662   Max.   :445.76   Max.   :435.7566   Max.   :1.0000  
   status_tau         T_tild       
 Min.   :0.0000   Min.   :  0.000  
 1st Qu.:0.0000   1st Qu.:  1.325  
 Median :0.0000   Median :  3.726  
 Mean   :0.4798   Mean   :  7.691  
 3rd Qu.:1.0000   3rd Qu.:  8.890  
 Max.   :1.0000   Max.   :170.882  </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=1:   1010"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                X4         
 Min.   :-1.7532   Min.   :-2.0714   Min.   :-4.0806   Min.   :-2.1428  
 1st Qu.: 0.3145   1st Qu.: 0.3224   1st Qu.:-1.7123   1st Qu.: 0.3173  
 Median : 0.9699   Median : 0.9920   Median :-1.0540   Median : 0.9837  
 Mean   : 0.9677   Mean   : 0.9933   Mean   :-1.0373   Mean   : 0.9925  
 3rd Qu.: 1.6093   3rd Qu.: 1.6349   3rd Qu.:-0.3774   3rd Qu.: 1.6318  
 Max.   : 3.8603   Max.   : 4.0556   Max.   : 2.1473   Max.   : 4.2040  
       C                   T1               T0                status      
 Min.   :  0.02708   Min.   : 10.01   Min.   :  0.00695   Min.   :0.0000  
 1st Qu.:  3.34304   1st Qu.: 12.88   1st Qu.:  2.88129   1st Qu.:0.0000  
 Median :  8.42606   Median : 18.36   Median :  8.35552   Median :0.0000  
 Mean   : 18.52760   Mean   : 30.59   Mean   : 20.59076   Mean   :0.2248  
 3rd Qu.: 20.25945   3rd Qu.: 33.39   3rd Qu.: 23.38510   3rd Qu.:0.0000  
 Max.   :307.95425   Max.   :294.48   Max.   :284.48171   Max.   :1.0000  
   status_tau         T_tild         
 Min.   :0.0000   Min.   :  0.02708  
 1st Qu.:0.0000   1st Qu.:  3.34304  
 Median :0.0000   Median :  8.42606  
 Mean   :0.2812   Mean   : 12.08535  
 3rd Qu.:1.0000   3rd Qu.: 14.45017  
 Max.   :1.0000   Max.   :157.61008  </code></pre>
</div>
</div>
<p>Covariates are balanced between the two groups. However, censoring times differ between groups due to conditionally independent censoring based on covariates and treatment group. Indeed, the distribution of <span class="math inline">C</span> is different between the treatment group.</p>
</section>
<section id="sec-stat_obs" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="sec-stat_obs"><span class="header-section-number">8.2</span> Observational study with linear relationship</h2>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Observational data with no informative censoring</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>data_obs1 <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">tau =</span> <span class="dv">25</span>, <span class="at">scenario =</span> <span class="st">"Obs1"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Observational data simulation with dependent censoring</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>data_obs2 <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(<span class="at">n =</span> <span class="dv">2000</span>, <span class="at">tau =</span> <span class="dv">25</span>, <span class="at">scenario =</span> <span class="st">"Obs2"</span>, </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">coefC =</span> <span class="fl">0.03</span>, <span class="at">parsC =</span> <span class="fu">c</span>(<span class="fl">0.7</span>,<span class="fl">0.3</span>,<span class="sc">-</span><span class="fl">0.25</span>,<span class="sc">-</span><span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The summary of the generated (observed and unobserved) data set observational study with independent censoring stratified by treatment is displayed below to enhance the difference with the other scenario.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=0:   1133"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                 X4         
 Min.   :-2.0610   Min.   :-2.1403   Min.   :-3.18773   Min.   :-1.7673  
 1st Qu.: 0.5442   1st Qu.: 0.4975   1st Qu.:-1.02055   1st Qu.: 0.5739  
 Median : 1.1994   Median : 1.1738   Median :-0.52253   Median : 1.2738  
 Mean   : 1.1800   Mean   : 1.1647   Mean   :-0.48929   Mean   : 1.2411  
 3rd Qu.: 1.7933   3rd Qu.: 1.8317   3rd Qu.: 0.05328   3rd Qu.: 1.8861  
 Max.   : 4.1118   Max.   : 3.7848   Max.   : 2.96673   Max.   : 4.3718  
       C                   T1               T0               status      
 Min.   :  0.00344   Min.   : 10.01   Min.   :  0.0055   Min.   :0.0000  
 1st Qu.:  8.75637   1st Qu.: 12.82   1st Qu.:  2.8153   1st Qu.:0.0000  
 Median : 20.98902   Median : 18.28   Median :  8.2800   Median :1.0000  
 Mean   : 31.32095   Mean   : 30.41   Mean   : 20.4052   Mean   :0.6787  
 3rd Qu.: 40.95419   3rd Qu.: 31.65   3rd Qu.: 21.6496   3rd Qu.:1.0000  
 Max.   :258.06643   Max.   :391.60   Max.   :381.5966   Max.   :1.0000  
     T_tild         
 Min.   :  0.00344  
 1st Qu.:  2.10156  
 Median :  5.67427  
 Mean   :  9.86465  
 3rd Qu.: 13.05016  
 Max.   :110.47656  </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=1:   867"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                X4          
 Min.   :-2.0227   Min.   :-2.2953   Min.   :-4.1198   Min.   :-2.57657  
 1st Qu.: 0.1199   1st Qu.: 0.1408   1st Qu.:-2.2198   1st Qu.: 0.03349  
 Median : 0.7162   Median : 0.7801   Median :-1.6483   Median : 0.73129  
 Mean   : 0.7599   Mean   : 0.7688   Mean   :-1.6872   Mean   : 0.71553  
 3rd Qu.: 1.4029   3rd Qu.: 1.3979   3rd Qu.:-1.1071   3rd Qu.: 1.39100  
 Max.   : 3.9044   Max.   : 4.1164   Max.   : 0.5709   Max.   : 3.57717  
       C                   T1               T0              status      
 Min.   :  0.05884   Min.   : 10.02   Min.   :  0.016   Min.   :0.0000  
 1st Qu.:  8.75840   1st Qu.: 12.67   1st Qu.:  2.673   1st Qu.:0.0000  
 Median : 22.03018   Median : 18.25   Median :  8.248   Median :1.0000  
 Mean   : 31.49177   Mean   : 29.49   Mean   : 19.495   Mean   :0.5017  
 3rd Qu.: 43.20394   3rd Qu.: 31.77   3rd Qu.: 21.767   3rd Qu.:1.0000  
 Max.   :170.33859   Max.   :364.84   Max.   :354.837   Max.   :1.0000  
     T_tild         
 Min.   :  0.05884  
 1st Qu.:  8.75840  
 Median : 12.70186  
 Mean   : 15.98146  
 3rd Qu.: 19.74720  
 Max.   :104.00692  </code></pre>
</div>
</div>
<p>The covariates between the two groups of treatment are unbalanced because of dependent treatment assignation. The mean of <span class="math inline">X1</span>, <span class="math inline">X2</span>, <span class="math inline">X3</span> and <span class="math inline">X4</span> is bigger in the control group than in the treated group. The censoring times have the same distribution (independent censoring). There are more censored observation in the treated group (A=1) than in the control group (A=0) for the same reason than in the RCT scenario.</p>
<p>The summary of the generated (observed and unobserved) data set observational study with conditionally independent censoring stratified by treatment is displayed below.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=0:   1084"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                 X4         
 Min.   :-1.8482   Min.   :-2.4825   Min.   :-3.54829   Min.   :-2.5937  
 1st Qu.: 0.5488   1st Qu.: 0.6387   1st Qu.:-1.07544   1st Qu.: 0.5572  
 Median : 1.1648   Median : 1.2394   Median :-0.50525   Median : 1.2332  
 Mean   : 1.1705   Mean   : 1.2394   Mean   :-0.49931   Mean   : 1.2096  
 3rd Qu.: 1.8142   3rd Qu.: 1.8695   3rd Qu.: 0.06295   3rd Qu.: 1.8858  
 Max.   : 4.1505   Max.   : 4.5839   Max.   : 2.04760   Max.   : 4.7556  
       C                   T1               T0               status      
 Min.   :  0.00781   Min.   : 10.01   Min.   :  0.0116   Min.   :0.0000  
 1st Qu.:  2.28144   1st Qu.: 12.88   1st Qu.:  2.8801   1st Qu.:0.0000  
 Median :  6.28868   Median : 18.42   Median :  8.4209   Median :0.0000  
 Mean   : 13.57181   Mean   : 30.86   Mean   : 20.8595   Mean   :0.4262  
 3rd Qu.: 15.58777   3rd Qu.: 31.42   3rd Qu.: 21.4245   3rd Qu.:1.0000  
 Max.   :285.53825   Max.   :457.86   Max.   :447.8563   Max.   :1.0000  
   status_tau         T_obs                 e            
 Min.   :0.0000   Min.   :  0.00781   Min.   :0.0000068  
 1st Qu.:0.0000   1st Qu.:  1.26077   1st Qu.:0.0210543  
 Median :0.0000   Median :  3.60106   Median :0.0979536  
 Mean   :0.4557   Mean   :  7.51995   Mean   :0.2065925  
 3rd Qu.:1.0000   3rd Qu.:  8.65062   3rd Qu.:0.3234377  
 Max.   :1.0000   Max.   :285.53825   Max.   :0.9929121  </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=1:   916"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                 X2                 X3                X4         
 Min.   :-2.76790   Min.   :-2.15820   Min.   :-4.4883   Min.   :-2.3684  
 1st Qu.: 0.07203   1st Qu.: 0.09154   1st Qu.:-2.1709   1st Qu.: 0.1257  
 Median : 0.72968   Median : 0.70291   Median :-1.5940   Median : 0.7569  
 Mean   : 0.72850   Mean   : 0.72817   Mean   :-1.6304   Mean   : 0.7891  
 3rd Qu.: 1.36939   3rd Qu.: 1.34747   3rd Qu.:-1.0960   3rd Qu.: 1.4713  
 Max.   : 4.11626   Max.   : 3.41779   Max.   : 0.7984   Max.   : 3.8144  
       C                 T1                T0                status      
 Min.   :  0.001   Min.   :  10.00   Min.   :   0.0011   Min.   :0.0000  
 1st Qu.:  2.577   1st Qu.:  13.01   1st Qu.:   3.0145   1st Qu.:0.0000  
 Median :  7.365   Median :  18.77   Median :   8.7699   Median :0.0000  
 Mean   : 17.683   Mean   :  34.07   Mean   :  24.0724   Mean   :0.1834  
 3rd Qu.: 17.234   3rd Qu.:  34.94   3rd Qu.:  24.9442   3rd Qu.:0.0000  
 Max.   :495.726   Max.   :1156.24   Max.   :1146.2398   Max.   :1.0000  
   status_tau         T_obs                 e          
 Min.   :0.0000   Min.   :  0.00096   Min.   :0.01288  
 1st Qu.:0.0000   1st Qu.:  2.57737   1st Qu.:0.60845  
 Median :0.0000   Median :  7.36545   Median :0.84878  
 Mean   :0.2402   Mean   : 11.80718   Mean   :0.75504  
 3rd Qu.:0.0000   3rd Qu.: 13.39888   3rd Qu.:0.95594  
 Max.   :1.0000   Max.   :265.52245   Max.   :0.99993  </code></pre>
</div>
</div>
<p>The covariates between the two groups are unbalanced. The censoring time is dependent on the covariates also, as the covariates are unbalanced between the two groups, the censoring time is also unbalanced. In particular, the mean of <span class="math inline">X1</span>, <span class="math inline">X2</span>, <span class="math inline">X3</span> and <span class="math inline">X4</span> is bigger in the control group than in the treated group. Also, the number of events is bigger in the control than treated group.</p>
<!-- ### Observational study with non-linear relationship {#sec-stat_complex} -->
<!-- ```{r, message=FALSE, warning=FALSE} -->
<!-- complex <- simulate_data_complex(n=2000,tau=2) -->
<!-- ``` -->
<!-- The summary of the generated (observed and unobserved) data set -->
<!-- observational study with nonlinear relationships and conditionally -->
<!-- independent censoring, stratified by treatment is displayed below. -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- # Stratification by treatment  -->
<!-- group_0 <- complex %>% -->
<!--   dplyr:: filter(A == 0)%>% -->
<!--   dplyr:: select(X1,X2,X3,C,T1,T0,status,T_obs,status_tau,e) -->
<!-- group_1 <- complex %>% -->
<!--   dplyr:: filter(A == 1)%>% -->
<!--   dplyr:: select(X1,X2,X3,C,T1,T0,status,T_obs,status_tau,e) -->
<!-- # Summary statistics -->
<!-- summary_group_0 <- summary(group_0) -->
<!-- summary_group_1 <- summary(group_1) -->
<!-- print(paste("Descriptive statistics for group A=0:  ",nrow(group_0))) -->
<!-- print(summary_group_0) -->
<!-- print(paste("Descriptive statistics for group A=1:  ",nrow(group_1))) -->
<!-- print(summary_group_1) -->
<!-- ``` -->
<!-- The observations are the same than the previous scenario: The covariates -->
<!-- and the censoring time between the two groups are unbalanced. -->
<!-- To be able to evaluate the estimators, we need to know the true -->
<!-- $\theta_{\mathrm{RMST}}$ at time $\tau$. -->
</section>
<section id="sec-stat_inter" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="sec-stat_inter"><span class="header-section-number">8.3</span> Observational study with interaction</h2>
<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>mis <span class="ot">&lt;-</span> <span class="fu">simulate_data_mis</span>(<span class="at">n=</span><span class="dv">2000</span>,<span class="at">tau=</span><span class="fl">0.5</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                 X4         
 Min.   :-2.3874   Min.   :-3.0521   Min.   :-3.05751   Min.   :-2.9265  
 1st Qu.:-0.1520   1st Qu.:-0.1540   1st Qu.:-0.03021   1st Qu.:-0.1445  
 Median : 0.5042   Median : 0.5147   Median : 0.69000   Median : 0.5307  
 Mean   : 0.5113   Mean   : 0.4973   Mean   : 0.67302   Mean   : 0.4971  
 3rd Qu.: 1.1674   3rd Qu.: 1.1605   3rd Qu.: 1.40139   3rd Qu.: 1.1620  
 Max.   : 3.8931   Max.   : 3.5542   Max.   : 4.00235   Max.   : 4.4912  
      tau            A               T0                  T1         
 Min.   :0.5   Min.   :0.000   Min.   :  0.00000   Min.   :  1.000  
 1st Qu.:0.5   1st Qu.:0.000   1st Qu.:  0.03151   1st Qu.:  1.032  
 Median :0.5   Median :1.000   Median :  0.18547   Median :  1.185  
 Mean   :0.5   Mean   :0.576   Mean   :  1.07165   Mean   :  2.072  
 3rd Qu.:0.5   3rd Qu.:1.000   3rd Qu.:  0.70373   3rd Qu.:  1.704  
 Max.   :0.5   Max.   :1.000   Max.   :264.78348   Max.   :265.783  
       C                T_obs             T_obs_tau             status     
 Min.   :   0.000   Min.   : 0.000001   Min.   :0.0000011   Min.   :0.000  
 1st Qu.:   0.138   1st Qu.: 0.050879   1st Qu.:0.0508792   1st Qu.:0.000  
 Median :   0.488   Median : 0.233077   Median :0.2330767   Median :0.000  
 Mean   :   9.774   Mean   : 0.524990   Mean   :0.2620332   Mean   :0.458  
 3rd Qu.:   1.716   3rd Qu.: 0.849109   3rd Qu.:0.5000000   3rd Qu.:1.000  
 Max.   :7206.989   Max.   :14.669780   Max.   :0.5000000   Max.   :1.000  
   status_tau     censor.status         e            
 Min.   :0.0000   Min.   :0.000   Min.   :0.0001518  
 1st Qu.:0.0000   1st Qu.:0.000   1st Qu.:0.4139383  
 Median :1.0000   Median :1.000   Median :0.5857742  
 Mean   :0.5945   Mean   :0.542   Mean   :0.5871264  
 3rd Qu.:1.0000   3rd Qu.:1.000   3rd Qu.:0.8092507  
 Max.   :1.0000   Max.   :1.000   Max.   :0.9999798  </code></pre>
</div>
</div>
<p>The summary of the generated (observed and unobserved) data set complex observational study (conditionally independent censoring) stratified by treatment is displayed below.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=0:   848"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                 C           
 Min.   :-2.3874   Min.   :-2.5104   Min.   :-2.22274   Min.   :  0.0000  
 1st Qu.:-0.1377   1st Qu.: 0.1064   1st Qu.:-0.09507   1st Qu.:  0.1355  
 Median : 0.4918   Median : 0.7416   Median : 0.46821   Median :  0.5157  
 Mean   : 0.5209   Mean   : 0.7189   Mean   : 0.45108   Mean   :  4.9347  
 3rd Qu.: 1.1904   3rd Qu.: 1.3786   3rd Qu.: 1.01885   3rd Qu.:  1.5994  
 Max.   : 3.8931   Max.   : 3.5542   Max.   : 3.08552   Max.   :989.6272  
       T1               T0              status           T_obs          
 Min.   : 1.000   Min.   : 0.0000   Min.   :0.0000   Min.   : 0.000001  
 1st Qu.: 1.023   1st Qu.: 0.0228   1st Qu.:0.0000   1st Qu.: 0.014737  
 Median : 1.143   Median : 0.1426   Median :1.0000   Median : 0.088545  
 Mean   : 1.625   Mean   : 0.6251   Mean   :0.6851   Mean   : 0.257297  
 3rd Qu.: 1.534   3rd Qu.: 0.5337   3rd Qu.:1.0000   3rd Qu.: 0.296521  
 Max.   :46.618   Max.   :45.6176   Max.   :1.0000   Max.   :14.669780  
   status_tau           e            
 Min.   :0.0000   Min.   :0.0001518  
 1st Qu.:0.0000   1st Qu.:0.2365906  
 Median :1.0000   Median :0.4448225  
 Mean   :0.7429   Mean   :0.4190735  
 3rd Qu.:1.0000   3rd Qu.:0.5695830  
 Max.   :1.0000   Max.   :0.9943589  </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Descriptive statistics for group A=1:   1152"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       X1                X2                X3                 C           
 Min.   :-2.2847   Min.   :-3.0521   Min.   :-3.05751   Min.   :   0.000  
 1st Qu.:-0.1693   1st Qu.:-0.3298   1st Qu.: 0.06058   1st Qu.:   0.142  
 Median : 0.5113   Median : 0.3493   Median : 0.92602   Median :   0.448  
 Mean   : 0.5042   Mean   : 0.3341   Mean   : 0.83640   Mean   :  13.337  
 3rd Qu.: 1.1558   3rd Qu.: 0.9905   3rd Qu.: 1.64480   3rd Qu.:   1.924  
 Max.   : 3.4847   Max.   : 3.2579   Max.   : 4.00235   Max.   :7206.989  
       T1                T0                status           T_obs         
 Min.   :  1.000   Min.   :  0.00001   Min.   :0.0000   Min.   :0.000085  
 1st Qu.:  1.045   1st Qu.:  0.04548   1st Qu.:0.0000   1st Qu.:0.141843  
 Median :  1.221   Median :  0.22104   Median :0.0000   Median :0.447671  
 Mean   :  2.400   Mean   :  1.40037   Mean   :0.2908   Mean   :0.722042  
 3rd Qu.:  1.856   3rd Qu.:  0.85600   3rd Qu.:1.0000   3rd Qu.:1.053985  
 Max.   :265.783   Max.   :264.78348   Max.   :1.0000   Max.   :9.549808  
   status_tau           e          
 Min.   :0.0000   Min.   :0.01213  
 1st Qu.:0.0000   1st Qu.:0.55049  
 Median :0.0000   Median :0.74408  
 Mean   :0.4852   Mean   :0.71083  
 3rd Qu.:1.0000   3rd Qu.:0.90105  
 Max.   :1.0000   Max.   :0.99998  </code></pre>
</div>
</div>
<p>The observations are the same than the previous scenario: The covariates and the censoring time between the two groups are unbalanced. To be able to evaluate the estimators, we need to know the true <span class="math inline">\theta_{\mathrm{RMST}}</span> at time <span class="math inline">\tau</span>.</p>
</section>
</div></section><section id="session-information" class="level1 appendix unnumbered"><h2 class="anchored quarto-appendix-heading">Session information</h2><div class="quarto-appendix-contents">

<div class="cell">
<details class="code-fold">
<summary>Hide/Show the code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.2.2 (2022-10-31)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 22.04.5 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so

locale:
 [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       
 [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   
 [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          
[10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   

attached base packages:
[1] splines   stats     graphics  grDevices datasets  utils     methods  
[8] base     

other attached packages:
 [1] gridExtra_2.3     rms_6.8-1         Hmisc_5.1-3       MASS_7.3-60.0.1  
 [5] grf_2.3.2         RISCA_1.0.5       mosaicData_0.20.4 ggformula_0.12.0 
 [9] dplyr_1.1.4       Matrix_1.6-5      ggplot2_3.5.1     lattice_0.22-5   
[13] tune_1.2.1        reticulate_1.39.0 relsurv_2.2-9     date_1.2-42      
[17] survRM2_1.0-4     survival_3.5-8   

loaded via a namespace (and not attached):
  [1] TH.data_1.1-2        cubature_2.1.1       colorspace_2.1-1    
  [4] class_7.3-22         ggridges_0.5.6       htmlTable_2.4.3     
  [7] base64enc_0.1-3      rstudioapi_0.16.0    farver_2.1.2        
 [10] listenv_0.9.1        furrr_0.3.1          MatrixModels_0.5-3  
 [13] dials_1.3.0          prodlim_2024.06.25   fansi_1.0.6         
 [16] mvtnorm_1.3-1        lubridate_1.9.3      mosaic_1.9.1        
 [19] codetools_0.2-19     doParallel_1.0.17    knitr_1.48          
 [22] Formula_1.2-5        jsonlite_1.8.9       workflows_1.1.4     
 [25] pROC_1.18.5          caret_6.0-94         cluster_2.1.6       
 [28] kernlab_0.9-33       png_0.1-8            yardstick_1.3.1     
 [31] compiler_4.2.2       backports_1.5.0      fastmap_1.2.0       
 [34] cli_3.6.3            quantreg_5.98        htmltools_0.5.8.1   
 [37] tools_4.2.2          gtable_0.3.5         glue_1.7.0          
 [40] reshape2_1.4.4       Rcpp_1.0.13          SuperLearner_2.0-29 
 [43] DiceDesign_1.10      vctrs_0.6.5          nlme_3.1-164        
 [46] iterators_1.0.14     parsnip_1.2.1        timeDate_4041.110   
 [49] gower_1.0.1          xfun_0.47            stringr_1.5.1       
 [52] globals_0.16.3       timechange_0.3.0     lifecycle_1.0.4     
 [55] mosaicCore_0.9.4.0   renv_1.0.11          statmod_1.5.0       
 [58] polspline_1.1.25     future_1.34.0        zoo_1.8-12          
 [61] scales_1.3.0         ipred_0.9-15         hms_1.1.3           
 [64] sandwich_3.1-1       parallel_4.2.2       SparseM_1.84-2      
 [67] RColorBrewer_1.1-3   yaml_2.3.10          labelled_2.13.0     
 [70] rpart_4.1.23         gam_1.22-5           stringi_1.8.4       
 [73] foreach_1.5.2        checkmate_2.3.2      lhs_1.2.0           
 [76] hardhat_1.4.0        lava_1.8.0           shape_1.4.6.1       
 [79] rlang_1.1.4          pkgconfig_2.0.3      rsample_1.2.1       
 [82] evaluate_1.0.0       purrr_1.0.2          labeling_0.4.3      
 [85] recipes_1.1.0        htmlwidgets_1.6.4    tidyselect_1.2.1    
 [88] parallelly_1.38.0    plyr_1.8.9           magrittr_2.0.3      
 [91] R6_2.5.1             generics_0.1.3       nnls_1.5            
 [94] multcomp_1.4-26      pillar_1.9.0         haven_2.5.4         
 [97] foreign_0.8-86       withr_3.0.1          nnet_7.3-19         
[100] tibble_3.2.1         future.apply_1.11.2  utf8_1.2.4          
[103] rmarkdown_2.28       grid_4.2.2           data.table_1.16.0   
[106] forcats_1.0.0        ModelMetrics_1.2.2.2 digest_0.6.37       
[109] tidyr_1.3.1          stats4_4.2.2         GPfit_1.0-8         
[112] munsell_0.5.1        glmnet_4.1-8        </code></pre>
</div>
</div>


<!-- -->

</div></section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/chvoinot\.github\.io\/Simple_simulation_causal_survival\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb66" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co">  "Causal survival analysis"</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co">  "Estimation of the Average Treatment Effect (ATE): Practical Recommendations"</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co">  </span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - name:  Charlotte Voinot</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co">    corresponding:  true</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co">    email:  charlotte.voinot@sanofi.com</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co">    url:  https://chvoinot.github.io/</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:  </span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  Sanofi R&amp;D</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co">        department:  CMEI</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.sanofi.fr/fr/</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  INRIA</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="co">        department:  Premedical</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.inria.fr/fr/premedical</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  INSERM</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.inserm.fr/</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  Université de Montpellier</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.umontpellier.fr/</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Clément Berenfeld</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="co">    corresponding: true </span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="co">    email: clement.berenfeld@uni-potsdam.de</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a><span class="co">    url: https://cberenfeld.github.io</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations: </span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Universität Potsdam, Potsdam, Germany</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="co">        departement: Institut für Mathematik</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a><span class="co">        url: https://www.uni-potsdam.de/en/university-of-potsdam</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Imke Mayer</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a><span class="co">    corresponding: true </span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a><span class="co">    email: imke.mayer@owkin.com, now affiliated with Owkin</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations: </span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: Charité -- Universität Berlin, Berlin, Germany</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="co">        departement: Institut für Public Health</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="co">        url: https://www.charite.de/</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a><span class="co">  - name:  Bernard Sebastien</span></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="co">    corresponding:  true</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a><span class="co">    email:  bernard.sebastien@sanofi.com</span></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:  </span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  Sanofi R&amp;D</span></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a><span class="co">        department:  CMEI</span></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.sanofi.fr/fr/</span></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a><span class="co">  - name:  Julie Josse</span></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a><span class="co">    corresponding:  true</span></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a><span class="co">    email:  julie.josse@inria.fr</span></span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a><span class="co">    url:  https://juliejosse.com/</span></span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:  </span></span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  INRIA</span></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="co">        department:  Premedical</span></span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.inria.fr/fr/premedical</span></span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  INSERM</span></span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.inserm.fr/</span></span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a><span class="co">      - name:  Université de Montpellier</span></span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a><span class="co">        url:  https://www.umontpellier.fr/</span></span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a><span class="co"> </span></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co">  last-modified</span></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a><span class="an">date-modified:</span><span class="co">  last-modified</span></span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a><span class="an">abstract:</span><span class="co"> Causal survival analysis combines survival analysis and causal inference to evaluate the effect of a treatment or intervention on a time-to-event outcome, such as survival time. It offers an alternative to relying solely on Cox models for assessing these effects. In this paper, we present a comprehensive review of estimators for the average treatment effect measured with the restricted mean survival time, including regression-based methods, weighting approaches, and hybrid techniques. We investigate their theoretical properties and compare their performance through extensive numerical experiments. Our analysis focuses on the finite-sample behavior of these estimators, the influence of nuisance parameter selection, and their robustness and stability under model misspecification. By bridging theoretical insights with practical evaluation, we aim to equip practitioners with both state-of-the-art implementations of these methods and practical guidelines for selecting appropriate estimators for treatment effect estimation. Among the approaches considered, G-formula two-learners, AIPCW-AIPTW, Buckley-James estimators, and causal survival forests emerge as particularly promising.</span></span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> [Restricted Mean Survival Time, Randomized Control Trial, Observational Study, Censoring]</span></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co">  references.bib</span></span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a><span class="an">github-user:</span><span class="co">  chvoinot</span></span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a><span class="an">repo:</span><span class="co">  "Simple_simulation_causal_survival"</span></span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co">  false # set to false once the build is running</span></span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a><span class="an">published:</span><span class="co">  false # will be set to true once accepted</span></span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co">  </span></span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a><span class="co">  computo-html:  default</span></span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a><span class="co">  computo-pdf: </span></span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a><span class="co">    header-includes:</span></span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a><span class="co">      - |</span></span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\bbR}{\mathbb{R}}</span></span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\bbE}{\mathbb{E}}</span></span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\bbP}{\mathbb{P}}</span></span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand\wt{\widetilde}</span></span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand\wh{\widehat}</span></span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\ve}{\varepsilon}</span></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a><span class="co">        \renewcommand{\epsilon}{\varepsilon}</span></span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a><span class="co">        \renewcommand\leq{\leqslant}</span></span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a><span class="co">        \renewcommand\geq{\geqslant}</span></span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\mand}{\quad\text{and}\quad}</span></span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\where}{\quad\text{where}\quad}</span></span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\with}{\quad\text{with}\quad}</span></span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand{\Var}{\mathrm{Var}}</span></span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a><span class="co">        \renewcommand{\(}{$}</span></span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a><span class="co">        \renewcommand{\)}{$}</span></span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand*\diff{\mathop{}\!\mathrm{d}}</span></span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand\cF{\mathcal{F}}</span></span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a><span class="co">        \newcommand\cX{\mathcal{X}}</span></span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a><span class="co">        \usepackage{amsmath}</span></span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true" tabindex="-1"></a><span class="co">        \usepackage{amssymb}</span></span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co">  </span></span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a><span class="co">  markdown:  </span></span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a><span class="co">    wrap:  7</span></span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a>::: {.content-hidden}</span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a>{{&lt; include _macro.tex &gt;}}</span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction {#sec-intro}</span></span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a><span class="fu">## Context and motivations {#sec-context}</span></span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a>Causal survival analysis is a growing field that integrates causal inference <span class="co">[</span><span class="ot">@rubin_estimating_1974; @hernan2010causal</span><span class="co">]</span> with survival analysis <span class="co">[</span><span class="ot">@kalbfleisch2002statistical</span><span class="co">]</span> to evaluate the impact of treatments on time-to-event outcomes, while accounting for censoring situations where only partial information about an event's occurrence is available. </span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a>Being a relatively new domain, the existing literature, though vast, remains fragmented. As a result, a clear understanding of the theoretical properties of various estimators is challenging to obtain. Moreover, the implementation of proposed methods is limited, leaving researchers confronted with a range of available estimators and the need to make numerous methodological decisions. There is a pressing need for a comprehensive survey that organizes the available methods, outlines the underlying assumptions, and provides an evaluation of estimator performance --- particularly in finite sample settings. Such a survey also has the potential to help identify remaining methodological challenges that need to be addressed.</span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a>This need becomes increasingly urgent as causal survival analysis gains traction in both theoretical and applied domains. For instance, its applications to external control arm analyses are particularly relevant in the context of single-arm clinical trials, where traditional comparator arms are unavailable. Regulatory guidelines have begun to acknowledge and support such semi-experimental approaches, reflecting the broader evolution of trial design and therapeutic innovation in precision medicine, see for instance <span class="co">[</span><span class="ot">@EMA_RWD</span><span class="co">]</span>.</span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a>By synthesizing the theoretical foundations, assumptions, and performance of various estimators, a survey on existing causal survival analysis methods would provide researchers and practitioners with the necessary tools to make informed methodological choices. This is crucial for fostering robust and reliable applications of causal survival analysis in both academic research and practical settings, where precise and valid results are paramount.</span>
<span id="cb66-113"><a href="#cb66-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-114"><a href="#cb66-114" aria-hidden="true" tabindex="-1"></a>In this paper, we focus our attention to the estimation of the Restricted Mean Survival Time (RMST), a popular causal measure in survival analysis which offers an intuitive interpretation of the average survival time over a specified period. In particular, we decided to not cover the estimation of Hazard Ratio (HR), which has been prominently used but often questioned due to its potential non-causal nature <span class="co">[</span><span class="ot">@HR_Martinussen</span><span class="co">]</span>. Additionally, unlike the Hazard Ratio, the RMST has the desirable property of being a collapsible measure, meaning that the population effect can be expressed as a weighted average of subgroup effects, with positive weights that sum to one <span class="co">[</span><span class="ot">@huitfeldt2019collapsibility</span><span class="co">]</span>.</span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a><span class="fu">## Definition of the estimand: the RMST {#sec-notations} </span></span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-119"><a href="#cb66-119" aria-hidden="true" tabindex="-1"></a>We set the analysis in the potential outcome framework, where a patient, described by a vector of covariates $X \in \mathbb{R}^p$, either receives a treatment ($A=1$) or is in the control group ($A=0$). The patient will then survive up to a certain time $T(0) \in \bbR^+$ in the control group, or up to a time $T(1)\in \bbR^+$ in the treatment group. In practice, we cannot simultaneously have access to  $T(0)$ and  $T(1)$, as one patient is either treated or control, but only to $T$ defined as follows: </span>
<span id="cb66-120"><a href="#cb66-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-121"><a href="#cb66-121" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-122"><a href="#cb66-122" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Stable Unit</span>
<span id="cb66-123"><a href="#cb66-123" aria-hidden="true" tabindex="-1"></a>Treatment Value Assumption: SUTVA)</span>
<span id="cb66-124"><a href="#cb66-124" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-125"><a href="#cb66-125" aria-hidden="true" tabindex="-1"></a>T = AT(1) + (1-A)T(0).</span>
<span id="cb66-126"><a href="#cb66-126" aria-hidden="true" tabindex="-1"></a>$$ {#eq-sutva}</span>
<span id="cb66-127"><a href="#cb66-127" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-128"><a href="#cb66-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-129"><a href="#cb66-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-130"><a href="#cb66-130" aria-hidden="true" tabindex="-1"></a>Due to potential censoring, the outcome $T$ is not completely observed. The most common form of censoring is right-censoring (also known as type II censoring), which occurs when the event of interest has not taken place by the end of the observation period, indicating that it may have occurred later if the observation had continued <span class="co">[</span><span class="ot">@censoring_effect</span><span class="co">]</span>. We focus in this study on this type of censoring only and we assume that we observe $\tilde T= T \wedge C = \min(T,C)$ for some censoring time $C \in \mathbb{R}^+$. When an observation is censored, the observed time is equal to the censoring time.</span>
<span id="cb66-131"><a href="#cb66-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-132"><a href="#cb66-132" aria-hidden="true" tabindex="-1"></a>We also assume that we know whether an outcome is censored or not. In other words, we observe the censoring status variable $\Delta = \mathbb{I}<span class="sc">\{</span>T \leq C<span class="sc">\}</span>$, where $\mathbb{I}<span class="sc">\{</span>\cdot<span class="sc">\}</span>$ is the indicator function. $\Delta$ is $1$ if the true outcome is observed, and $0$ if it is censored.</span>
<span id="cb66-133"><a href="#cb66-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-134"><a href="#cb66-134" aria-hidden="true" tabindex="-1"></a>We assume observing a $n$-sample of variables $(X,A,\wt T,\Delta)$ stemming from an $n$-sample of the partially unobservable variables $(X,A,T(0),T(1),C)$. A toy exemple of such data is given in @tbl-exemple_data. </span>
<span id="cb66-135"><a href="#cb66-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-136"><a href="#cb66-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-137"><a href="#cb66-137" aria-hidden="true" tabindex="-1"></a>| ID | Covariates | | | Treatment | Censoring | Status | Potential outcomes | |  True outcome | Observed outcome |</span>
<span id="cb66-138"><a href="#cb66-138" aria-hidden="true" tabindex="-1"></a>|--|--|--|--|--|--|--|--|--|--|--|</span>
<span id="cb66-139"><a href="#cb66-139" aria-hidden="true" tabindex="-1"></a>| i | $X_{1}$ | $X_{2}$ | $X_{3}$ | $A$ | $C$ | $\Delta$ | $T(0)$ | $T(1)$ | $T$ | $\tilde{T}$ |</span>
<span id="cb66-140"><a href="#cb66-140" aria-hidden="true" tabindex="-1"></a>| 1 | 1 | 1.5 | 4 | 1 | ? | 1 | ? | 200 | 200 | 200 |</span>
<span id="cb66-141"><a href="#cb66-141" aria-hidden="true" tabindex="-1"></a>| 2 | 5 | 1 | 2 | 0 | ? | 1 | 100 | ? | 100 | 100 |</span>
<span id="cb66-142"><a href="#cb66-142" aria-hidden="true" tabindex="-1"></a>| 3 | 9 | 0.5 | 3 | 1 | 200 | 0 | ? | ? | ? | 200 |</span>
<span id="cb66-143"><a href="#cb66-143" aria-hidden="true" tabindex="-1"></a>: Example of a survival dataset. In practice, only $X,A,\wt T$ and $\Delta$ are observed. {#tbl-exemple_data}</span>
<span id="cb66-144"><a href="#cb66-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-145"><a href="#cb66-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-146"><a href="#cb66-146" aria-hidden="true" tabindex="-1"></a>Our aim is to estimate the Average Treatment Effect (ATE) defined as the difference between the Restricted Mean Survival Time of the treated and controls <span class="co">[</span><span class="ot">@royston2013restricted</span><span class="co">]</span>.</span>
<span id="cb66-147"><a href="#cb66-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-148"><a href="#cb66-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-149"><a href="#cb66-149" aria-hidden="true" tabindex="-1"></a>::: {#def-ATE}</span>
<span id="cb66-150"><a href="#cb66-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-151"><a href="#cb66-151" aria-hidden="true" tabindex="-1"></a>(Causal effect: Difference between Restricted Mean Survival Time)</span>
<span id="cb66-152"><a href="#cb66-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-153"><a href="#cb66-153" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-154"><a href="#cb66-154" aria-hidden="true" tabindex="-1"></a>\theta_{\mathrm{RMST}} = \mathbb{E}\left<span class="co">[</span><span class="ot">T(1) \wedge \tau - T(0) \wedge \tau\right</span><span class="co">]</span>, </span>
<span id="cb66-155"><a href="#cb66-155" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-156"><a href="#cb66-156" aria-hidden="true" tabindex="-1"></a>where $a \wedge b := \min(a,b)$ for $a,b \in \bbR$. </span>
<span id="cb66-157"><a href="#cb66-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-158"><a href="#cb66-158" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-159"><a href="#cb66-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-160"><a href="#cb66-160" aria-hidden="true" tabindex="-1"></a>We define the survival functions $S^{(a)}(t):=\mathbb{P}(T(a) &gt; t)$ for $a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$, i.e., the probability that a</span>
<span id="cb66-161"><a href="#cb66-161" aria-hidden="true" tabindex="-1"></a>treated or non-treated individual will survive beyond a given time $t$. Likewise, we let $S(t) := \bbP(T &gt;t)$, and $S_C(t) := \bbP(C &gt; t)$. We also let $G(t) := \bbP(C \geq t)$ be the left-limit of the survival function $S_C$.</span>
<span id="cb66-162"><a href="#cb66-162" aria-hidden="true" tabindex="-1"></a>Because $T(a) \wedge \tau$ are non-negative random variables, one can easily express the restricted mean survival time using the survival functions:</span>
<span id="cb66-163"><a href="#cb66-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-164"><a href="#cb66-164" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-165"><a href="#cb66-165" aria-hidden="true" tabindex="-1"></a>\mathbb{E}(T(a) \wedge \tau) = \int_{0}^{\infty} \mathbb{P}(T(a)\wedge \tau &gt; t)dt = \int_{0}^{\tau}S^{(a)}(t)dt.</span>
<span id="cb66-166"><a href="#cb66-166" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rmstsurv}</span>
<span id="cb66-167"><a href="#cb66-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-168"><a href="#cb66-168" aria-hidden="true" tabindex="-1"></a>Consequently, $\theta_{\mathrm{RMST}}$ can be interpreted as the mean</span>
<span id="cb66-169"><a href="#cb66-169" aria-hidden="true" tabindex="-1"></a>difference between the survival function of treated and control until a</span>
<span id="cb66-170"><a href="#cb66-170" aria-hidden="true" tabindex="-1"></a>fixed time horizon $\tau$.  A</span>
<span id="cb66-171"><a href="#cb66-171" aria-hidden="true" tabindex="-1"></a>difference in RMST $\theta_{\mathrm{RMST}} = 10$ days with $\tau=200$</span>
<span id="cb66-172"><a href="#cb66-172" aria-hidden="true" tabindex="-1"></a>means that, on average, the treatment increases the survival time by 10</span>
<span id="cb66-173"><a href="#cb66-173" aria-hidden="true" tabindex="-1"></a>days at 200 days. We give a visual interpretation of RMST in @fig-RMST.</span>
<span id="cb66-174"><a href="#cb66-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-175"><a href="#cb66-175" aria-hidden="true" tabindex="-1"></a>![Plot of the estimated survival curves on synthetic toy-data. The</span>
<span id="cb66-176"><a href="#cb66-176" aria-hidden="true" tabindex="-1"></a> $\theta_{\mathrm{RMST}}$ at $\tau=50$ corresponds to the yellow shaded area between the two survival curves. The curves have been estimated using Kaplan-Meier estimator, see @sec-theoryRCT_indc.](KM_RMST.pdf){#fig-RMST}</span>
<span id="cb66-177"><a href="#cb66-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-178"><a href="#cb66-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-179"><a href="#cb66-179" aria-hidden="true" tabindex="-1"></a>Although the present work focuses on the estimation of the difference in RMST, we would like to stress that the causal effect can be assessed through other measures, such as for instance the difference of the survival functions</span>
<span id="cb66-180"><a href="#cb66-180" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-181"><a href="#cb66-181" aria-hidden="true" tabindex="-1"></a>\theta_{\mathrm{SP}} := S^{(1)}(\tau) - S^{(0)}(\tau) </span>
<span id="cb66-182"><a href="#cb66-182" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-183"><a href="#cb66-183" aria-hidden="true" tabindex="-1"></a>for some time $\tau$, see for instance <span class="co">[</span><span class="ot">@Ozenne20_AIPTW_AIPCW</span><span class="co">]</span>. As mentionned in @sec-context, another widely used measure (though not necessarily causal) is the hazards ratio, defined as </span>
<span id="cb66-184"><a href="#cb66-184" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-185"><a href="#cb66-185" aria-hidden="true" tabindex="-1"></a>\theta_{\mathrm{HR}} := \frac{\lambda^{(1)}(\tau)}{\lambda^{(0)}(\tau)},</span>
<span id="cb66-186"><a href="#cb66-186" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-187"><a href="#cb66-187" aria-hidden="true" tabindex="-1"></a>where the hazard function $\lambda^{(a)}$ is defined as </span>
<span id="cb66-188"><a href="#cb66-188" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-189"><a href="#cb66-189" aria-hidden="true" tabindex="-1"></a>\lambda^{(a)}(t) := \lim_{h \to 0^+}\frac{\bbP(T(a) \in [t,t+j)|T(a) \geq t)}{h}.</span>
<span id="cb66-190"><a href="#cb66-190" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-191"><a href="#cb66-191" aria-hidden="true" tabindex="-1"></a>in a continuous setting, or as $\lambda^{(a)}(t) := \bbP(T(a) = t|T(a) \geq t)$ when the survival times are discrete. The hazard functions and the survival functions are linked through the identities</span>
<span id="cb66-192"><a href="#cb66-192" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-193"><a href="#cb66-193" aria-hidden="true" tabindex="-1"></a>S^{(a)}(t) = \exp\left(-\Lambda^{(a)}(t)\right) \quad \text{where} \quad \Lambda^{(a)}(t) := \int_0^t \lambda^{(a)}(s)\diff s,</span>
<span id="cb66-194"><a href="#cb66-194" aria-hidden="true" tabindex="-1"></a>$$ {#eq-lambdacont}</span>
<span id="cb66-195"><a href="#cb66-195" aria-hidden="true" tabindex="-1"></a>in the continuous case. The functions $\Lambda^{(a)}$ are call the cumulative hazard functions. In the discrete case, we have in turn</span>
<span id="cb66-196"><a href="#cb66-196" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-197"><a href="#cb66-197" aria-hidden="true" tabindex="-1"></a>S^{(a)}(t) = \prod_{t_k \leq t} \left(1-\lambda^{(a)}(t_k)\right),</span>
<span id="cb66-198"><a href="#cb66-198" aria-hidden="true" tabindex="-1"></a>$$ {#eq-lambdadisc}</span>
<span id="cb66-199"><a href="#cb66-199" aria-hidden="true" tabindex="-1"></a>where $<span class="sc">\{</span>t_1,\dots,t_K<span class="sc">\}</span>$ are the atoms of $T^{(a)}$. These hazard functions are classically used to model the survival times and the censoring times, see @sec-Gformula. </span>
<span id="cb66-200"><a href="#cb66-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-201"><a href="#cb66-201" aria-hidden="true" tabindex="-1"></a><span class="fu">## Organisation of the paper</span></span>
<span id="cb66-202"><a href="#cb66-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-203"><a href="#cb66-203" aria-hidden="true" tabindex="-1"></a>In this paper, we detail the minimal theoretical framework that allows the analysis of established RMST estimators in the context of both Randomized Controlled Trials (@sec-theoryRCT) and observational data (@sec-theoryOBS). We give their statistical properties (consistency, asymptotic normality) along with proofs when possible.</span>
<span id="cb66-204"><a href="#cb66-204" aria-hidden="true" tabindex="-1"></a>We then conduct in @sec-simulation a numerical study of these estimators through simulations under various experimental conditions, including independent and conditionally independent censoring and correct and incorrect model specifications. We conclude in @sec-conclusion with practical recommendations on estimator selection, based on criteria such as asymptotic behavior, computational complexity, and efficiency.</span>
<span id="cb66-205"><a href="#cb66-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-206"><a href="#cb66-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-207"><a href="#cb66-207" aria-hidden="true" tabindex="-1"></a><span class="fu">## Notations</span></span>
<span id="cb66-208"><a href="#cb66-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-209"><a href="#cb66-209" aria-hidden="true" tabindex="-1"></a>We provide in @tbl-reminder_notations a summary of the notation used throughout the paper.</span>
<span id="cb66-210"><a href="#cb66-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-211"><a href="#cb66-211" aria-hidden="true" tabindex="-1"></a>| Symbol                      | Description                                                                                                                                                    |</span>
<span id="cb66-212"><a href="#cb66-212" aria-hidden="true" tabindex="-1"></a>|---------------|---------------------------------------------------------|</span>
<span id="cb66-213"><a href="#cb66-213" aria-hidden="true" tabindex="-1"></a>| $X$                         | Covariates                                                                                                                                                     |</span>
<span id="cb66-214"><a href="#cb66-214" aria-hidden="true" tabindex="-1"></a>| $A$                         | Treatment indicator $(A=1$ for treatment, $A=0$ for control$)$                                                                                                 |</span>
<span id="cb66-215"><a href="#cb66-215" aria-hidden="true" tabindex="-1"></a>| $T$                         | Survival time                                                                                                                                                  |</span>
<span id="cb66-216"><a href="#cb66-216" aria-hidden="true" tabindex="-1"></a>| $T(a), a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                 | Potential survival time respectively with and without treatment                                                |</span>
<span id="cb66-217"><a href="#cb66-217" aria-hidden="true" tabindex="-1"></a>| $S^{(a)},a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                   | Survival function $S^{(a)}(t) =\bbP(T(a) &gt; t)$ of the potential survival times                                                    |</span>
<span id="cb66-218"><a href="#cb66-218" aria-hidden="true" tabindex="-1"></a>| $\lambda^{(a)},a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                   | Hazard function $\lambda^{(a)}(t) =\lim_{h \to 0^+}\mathbb{P}(T(a) \in [t,t+h) |T(a)\geq t)/h$ of the potential survival times                                                    |</span>
<span id="cb66-219"><a href="#cb66-219" aria-hidden="true" tabindex="-1"></a>| $\Lambda^{(a)},a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                   | Cumulative hazard function of the potential survival times                                                    |</span>
<span id="cb66-220"><a href="#cb66-220" aria-hidden="true" tabindex="-1"></a>| $C$                         | Censoring time                                                                                                                                                 |</span>
<span id="cb66-221"><a href="#cb66-221" aria-hidden="true" tabindex="-1"></a>| $S_C$                         | Survival function $S_C(t) =\mathbb{P}(C &gt; t)$ of the censoring time |</span>
<span id="cb66-222"><a href="#cb66-222" aria-hidden="true" tabindex="-1"></a>| $G$                         | Left-limit of the survival function $G(t) =\mathbb{P}(C \geq t)$ of the censoring time |</span>
<span id="cb66-223"><a href="#cb66-223" aria-hidden="true" tabindex="-1"></a>| $\widetilde{T}$             | Observed time ($T \wedge C$)                                                                                         |</span>
<span id="cb66-224"><a href="#cb66-224" aria-hidden="true" tabindex="-1"></a>| $\Delta$                    | Censoring status $\mathbb{I}<span class="sc">\{</span>T \leq C <span class="sc">\}</span>$                                                                                                    |</span>
<span id="cb66-225"><a href="#cb66-225" aria-hidden="true" tabindex="-1"></a>| $\Delta^{\tau}$             | Censoring status of the restricted time $\Delta^{\tau} = \max<span class="sc">\{</span>\Delta, \mathbb{I}<span class="sc">\{</span>\widetilde{T} \geq \tau<span class="sc">\}\}</span>$ |</span>
<span id="cb66-226"><a href="#cb66-226" aria-hidden="true" tabindex="-1"></a>| $<span class="sc">\{</span>t_{1},t_{2},\dots,t_{K}<span class="sc">\}</span>$ | Discrete times                                                                                    |</span>
<span id="cb66-227"><a href="#cb66-227" aria-hidden="true" tabindex="-1"></a>| $e(x)$                      | Propensity score $\mathbb{E} <span class="co">[</span><span class="ot">A| X = x</span><span class="co">]</span>$                                                                                                                       |</span>
<span id="cb66-228"><a href="#cb66-228" aria-hidden="true" tabindex="-1"></a>| $\mu(x,a), a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                    | $\mathbb{E}<span class="co">[</span><span class="ot">T \wedge \tau \mid X=x,A=a </span><span class="co">]</span>$                                                                                                                      |</span>
<span id="cb66-229"><a href="#cb66-229" aria-hidden="true" tabindex="-1"></a>| $S(t|x,a), a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                  | Conditional survival function, $\bbP(T &gt; t | X=x, A =a)$.                                                                             |</span>
<span id="cb66-230"><a href="#cb66-230" aria-hidden="true" tabindex="-1"></a>| $\lambda^{(a)}(t|x), a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                   | Conditional hazard functions of the potential survival times                                                    |</span>
<span id="cb66-231"><a href="#cb66-231" aria-hidden="true" tabindex="-1"></a>| $G(t|x,a), a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$                | left-limit of the conditional survival function of the censoring $\bbP(C\geq t|X=x,A=a)$                                                                                   |</span>
<span id="cb66-232"><a href="#cb66-232" aria-hidden="true" tabindex="-1"></a>| $Q_{S}(t|x,a), a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$              | $\mathbb{E}<span class="co">[</span><span class="ot">T \wedge \tau \mid X=x,A=a, T \wedge \tau&gt;t</span><span class="co">]</span>$                                                                                                      |</span>
<span id="cb66-233"><a href="#cb66-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-234"><a href="#cb66-234" aria-hidden="true" tabindex="-1"></a>: Summary of the notations. {#tbl-reminder_notations}</span>
<span id="cb66-235"><a href="#cb66-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-236"><a href="#cb66-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-237"><a href="#cb66-237" aria-hidden="true" tabindex="-1"></a><span class="fu"># Causal survival analysis in Randomized Controlled Trials {#sec-theoryRCT}</span></span>
<span id="cb66-238"><a href="#cb66-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-239"><a href="#cb66-239" aria-hidden="true" tabindex="-1"></a>Randomized Controlled Trials (RCTs) are the gold standard for establishing</span>
<span id="cb66-240"><a href="#cb66-240" aria-hidden="true" tabindex="-1"></a>the effect of a treatment on an outcome, because treatment allocation is controlled through randomization, which ensures (asymptotically) the balance of covariates</span>
<span id="cb66-241"><a href="#cb66-241" aria-hidden="true" tabindex="-1"></a>between treated and controls, and thus avoids problems of confounding</span>
<span id="cb66-242"><a href="#cb66-242" aria-hidden="true" tabindex="-1"></a>between treatment groups. The core assumption in a classical RCT is the</span>
<span id="cb66-243"><a href="#cb66-243" aria-hidden="true" tabindex="-1"></a>random assignment of the treatment <span class="co">[</span><span class="ot">@rubin_estimating_1974</span><span class="co">]</span>.</span>
<span id="cb66-244"><a href="#cb66-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-245"><a href="#cb66-245" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-246"><a href="#cb66-246" aria-hidden="true" tabindex="-1"></a>**Assumption.**</span>
<span id="cb66-247"><a href="#cb66-247" aria-hidden="true" tabindex="-1"></a>(Random treatment assignment) There holds:</span>
<span id="cb66-248"><a href="#cb66-248" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-249"><a href="#cb66-249" aria-hidden="true" tabindex="-1"></a>A \perp\mkern-9.5mu\perp T(0),T(1),X</span>
<span id="cb66-250"><a href="#cb66-250" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rta}</span>
<span id="cb66-251"><a href="#cb66-251" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-252"><a href="#cb66-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-253"><a href="#cb66-253" aria-hidden="true" tabindex="-1"></a>We also assume that there is a positive probability of receiving the treatment, which we rephrase under the following assumption. </span>
<span id="cb66-254"><a href="#cb66-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-255"><a href="#cb66-255" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-256"><a href="#cb66-256" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Trial positivity)</span>
<span id="cb66-257"><a href="#cb66-257" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-258"><a href="#cb66-258" aria-hidden="true" tabindex="-1"></a>0 &lt; \mathbb{P}(A=1) &lt; 1</span>
<span id="cb66-259"><a href="#cb66-259" aria-hidden="true" tabindex="-1"></a>$$ {#eq-postrial}</span>
<span id="cb66-260"><a href="#cb66-260" aria-hidden="true" tabindex="-1"></a>::: </span>
<span id="cb66-261"><a href="#cb66-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-262"><a href="#cb66-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-263"><a href="#cb66-263" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-rta</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-postrial</span><span class="co">]</span>, classical causal identifiability equations can be written to express  $\theta_{\mathrm{RMST}}$ without potential outcomes. </span>
<span id="cb66-264"><a href="#cb66-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-265"><a href="#cb66-265" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-266"><a href="#cb66-266" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-267"><a href="#cb66-267" aria-hidden="true" tabindex="-1"></a>    \theta_{\mathrm{RMST}} &amp;=  \mathbb{E}<span class="co">[</span><span class="ot">T(1) \wedge \tau - T(0) \wedge \tau</span><span class="co">]</span><span class="sc">\\</span></span>
<span id="cb66-268"><a href="#cb66-268" aria-hidden="true" tabindex="-1"></a>    &amp;= \mathbb{E}<span class="co">[</span><span class="ot">T(1) \wedge \tau | A = 1</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot"> T(0) \wedge \tau| A= 0</span><span class="co">]</span>  &amp;&amp; \tiny\text{(Random treatment assignment)} <span class="sc">\\</span></span>
<span id="cb66-269"><a href="#cb66-269" aria-hidden="true" tabindex="-1"></a>       &amp;= \mathbb{E}<span class="co">[</span><span class="ot">T \wedge \tau | A = 1</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot"> T \wedge \tau| A= 0</span><span class="co">]</span>.  &amp;&amp; \tiny\text{(SUTVA)}</span>
<span id="cb66-270"><a href="#cb66-270" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-271"><a href="#cb66-271" aria-hidden="true" tabindex="-1"></a>$$ {#eq-RMSTkm}</span>
<span id="cb66-272"><a href="#cb66-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-273"><a href="#cb66-273" aria-hidden="true" tabindex="-1"></a>However, @eq-RMSTkm still depends on $T$, which remains only partially observed due to censoring. To ensure that censoring does not compromise the identifiability of treatment effects, we must impose certain assumptions on the censoring process,</span>
<span id="cb66-274"><a href="#cb66-274" aria-hidden="true" tabindex="-1"></a>standards in survival analysis, namely, independent censoring and conditionally independent censoring. These assumptions lead to different estimation approaches. We focus on two strategies: those that aim to directly estimate  $\mathbb{E}<span class="co">[</span><span class="ot">T \wedge \tau | A = a</span><span class="co">]</span>$ directly (e.g., through censoring-unbiased transformations, see @sec-condcens), and those that first estimate the survival curves to derive RMST via @eq-rmstsurv (such as the Kaplan-Meier estimator and all its variants, see the next Section).</span>
<span id="cb66-275"><a href="#cb66-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-276"><a href="#cb66-276" aria-hidden="true" tabindex="-1"></a><span class="fu">## Independent censoring: the Kaplan-Meier estimator {#sec-theoryRCT_indc}</span></span>
<span id="cb66-277"><a href="#cb66-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-278"><a href="#cb66-278" aria-hidden="true" tabindex="-1"></a>In a first approach, one might assume that the censoring times are independent from the rest of the variables.</span>
<span id="cb66-279"><a href="#cb66-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-280"><a href="#cb66-280" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-281"><a href="#cb66-281" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Independent censoring)</span>
<span id="cb66-282"><a href="#cb66-282" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-283"><a href="#cb66-283" aria-hidden="true" tabindex="-1"></a>C \perp\mkern-9.5mu\perp T(0),T(1),X,A.</span>
<span id="cb66-284"><a href="#cb66-284" aria-hidden="true" tabindex="-1"></a>$$ {#eq-independantcensoring}</span>
<span id="cb66-285"><a href="#cb66-285" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-286"><a href="#cb66-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-287"><a href="#cb66-287" aria-hidden="true" tabindex="-1"></a>Under @eq-independantcensoring, subjects censored at time $t$ are representative of all subjects who remain at risk at time $t$.</span>
<span id="cb66-288"><a href="#cb66-288" aria-hidden="true" tabindex="-1"></a>@fig-RCT_ind_causalgraph represents the causal graph when the</span>
<span id="cb66-289"><a href="#cb66-289" aria-hidden="true" tabindex="-1"></a>study is randomized and outcomes are observed under independent censoring. </span>
<span id="cb66-290"><a href="#cb66-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-291"><a href="#cb66-291" aria-hidden="true" tabindex="-1"></a>![Causal graph in RCT survival data with</span>
<span id="cb66-292"><a href="#cb66-292" aria-hidden="true" tabindex="-1"></a>independent censoring.](causal_survival_rct_indep.pdf){#fig-RCT_ind_causalgraph fig-align="center" width="40%"}</span>
<span id="cb66-293"><a href="#cb66-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-294"><a href="#cb66-294" aria-hidden="true" tabindex="-1"></a>We also assume that there is no almost-sure upper bound on the censoring time before $\tau$, which we rephrase under the following assumption. </span>
<span id="cb66-295"><a href="#cb66-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-296"><a href="#cb66-296" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-297"><a href="#cb66-297" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Positivity of the censoring process) There exists $\ve &gt; 0$ such that</span>
<span id="cb66-298"><a href="#cb66-298" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-299"><a href="#cb66-299" aria-hidden="true" tabindex="-1"></a>G(t) \geq \ve \quad \text{for all} \quad t \in [0,\tau).</span>
<span id="cb66-300"><a href="#cb66-300" aria-hidden="true" tabindex="-1"></a>$$ {#eq-poscen}</span>
<span id="cb66-301"><a href="#cb66-301" aria-hidden="true" tabindex="-1"></a>::: </span>
<span id="cb66-302"><a href="#cb66-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-303"><a href="#cb66-303" aria-hidden="true" tabindex="-1"></a>If indeed it was the case that $\bbP(C &lt; t) = 1$ for some $t &lt; \tau$, then we would not be able to infer anything on the survival function on the interval $<span class="co">[</span><span class="ot">t,\tau</span><span class="co">]</span>$ as all observation times $\wt T_i$ would be in $<span class="co">[</span><span class="ot">0,t</span><span class="co">]</span>$ almost surely. In practice, adjusting the threshold time $\tau$</span>
<span id="cb66-304"><a href="#cb66-304" aria-hidden="true" tabindex="-1"></a>can help satisfy the positivity assumption. For instance, in a clinical study, if a subgroup of patients has zero probability of remaining uncensored at a given time, $\tau$ can be modified to ensure that participants have a feasible chance of remaining uncensored up to the revised threshold. </span>
<span id="cb66-305"><a href="#cb66-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-306"><a href="#cb66-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-307"><a href="#cb66-307" aria-hidden="true" tabindex="-1"></a>The two Assumptions <span class="co">[</span><span class="ot">-@eq-independantcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-poscen</span><span class="co">]</span> together allow the distributions of $T(a)$ to be identifiable, in the sense that there exists an identity that expresses $S^{(a)}$ as a function of the joint distribution of $(\wt T,\Delta,A=a)$, see for instance @ebrahimi2003identifiability for such a formula in a non-causal framework. This enables several estimation strategies, the most well-known being the Kaplan-Meier product-limit estimator.</span>
<span id="cb66-308"><a href="#cb66-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-309"><a href="#cb66-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-310"><a href="#cb66-310" aria-hidden="true" tabindex="-1"></a>To motivate the definition of the latter and explicit the identifiability identity, we set the analysis in the discrete case. We let $<span class="sc">\{</span>t_k<span class="sc">\}</span>_{k \geq 1}$ be a set of positive and increasing times and assume that $T \in \{t_k\}_{k \geq 1}$ almost surely. Then for any $t \in <span class="co">[</span><span class="ot">0,\tau</span><span class="co">]</span>$, it holds, letting $t_0 = 0$ by convention, thanks to @eq-lambdadisc,</span>
<span id="cb66-311"><a href="#cb66-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-312"><a href="#cb66-312" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-313"><a href="#cb66-313" aria-hidden="true" tabindex="-1"></a>S(t| A=a) &amp;= \bbP(T &gt; t|A=a) = \prod_{t_k \leq t} \left(1 - \bbP(T = t_k | T &gt; t_{k-1}, A=a)\right) <span class="sc">\\</span></span>
<span id="cb66-314"><a href="#cb66-314" aria-hidden="true" tabindex="-1"></a>&amp;= \prod_{t_k \leq t} \left(1 - \frac{\bbP(T = t_{k}, A=a)}{\bbP(T \geq t_{k},A=a)}\right).</span>
<span id="cb66-315"><a href="#cb66-315" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-316"><a href="#cb66-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-317"><a href="#cb66-317" aria-hidden="true" tabindex="-1"></a>Using Assumptions <span class="co">[</span><span class="ot">-@eq-independantcensoring,-@eq-postrial</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-poscen</span><span class="co">]</span>, we find that </span>
<span id="cb66-318"><a href="#cb66-318" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-319"><a href="#cb66-319" aria-hidden="true" tabindex="-1"></a>\frac{\bbP(T = t_{k}, A=a)}{\bbP(T \geq t_{k},A=a)} = \frac{\bbP(T = t_{k},C \geq t_k,A=a)}{\bbP(T \geq t_{k}, C\geq t_k,A=a)} =  \frac{\bbP(\wt T = t_{k}, \Delta = 1,A=a)}{\bbP( \wt T \geq t_{k},A=a)},</span>
<span id="cb66-320"><a href="#cb66-320" aria-hidden="true" tabindex="-1"></a>$$ {#eq-kmindep}</span>
<span id="cb66-321"><a href="#cb66-321" aria-hidden="true" tabindex="-1"></a>yielding the final identity</span>
<span id="cb66-322"><a href="#cb66-322" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-323"><a href="#cb66-323" aria-hidden="true" tabindex="-1"></a>S(t|A=a) = \prod_{t_k \leq t} \left(1-\frac{\bbP(\wt T = t_{k}, \Delta = 1,A=a)}{\bbP( \wt T \geq t_{k},A=a)}\right).</span>
<span id="cb66-324"><a href="#cb66-324" aria-hidden="true" tabindex="-1"></a>$${#eq-kmi}</span>
<span id="cb66-325"><a href="#cb66-325" aria-hidden="true" tabindex="-1"></a>Notice that the right hand side only depends on the distribution of the observed tuple $(A,\wt T,\Delta)$. This last equation suggests in turn to introduce the quantities</span>
<span id="cb66-326"><a href="#cb66-326" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-327"><a href="#cb66-327" aria-hidden="true" tabindex="-1"></a>D_k(a) := \sum_{i=1}^n \mathbb{I}(\wt T_i = t_k, \Delta_i = 1, A=a) \mand N_k(a) := \sum_{i=1}^n \mathbb{I}(\wt T_i \geq t_k, A=a),</span>
<span id="cb66-328"><a href="#cb66-328" aria-hidden="true" tabindex="-1"></a>$$ {#eq-dknk}</span>
<span id="cb66-329"><a href="#cb66-329" aria-hidden="true" tabindex="-1"></a>which correspond respectively to the number of deaths $D_k(a)$ and of individuals at risk $N_k(a)$ at time $t_k$ in the treated group (a=1) or in the control group (a=0). </span>
<span id="cb66-330"><a href="#cb66-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-331"><a href="#cb66-331" aria-hidden="true" tabindex="-1"></a>::: {#def-km}</span>
<span id="cb66-332"><a href="#cb66-332" aria-hidden="true" tabindex="-1"></a>(Kaplan-Meier estimator, @kaplan)</span>
<span id="cb66-333"><a href="#cb66-333" aria-hidden="true" tabindex="-1"></a>With $D_k(a)$ and  $N_k(a)$ defined in @eq-dknk, we let</span>
<span id="cb66-334"><a href="#cb66-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-335"><a href="#cb66-335" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-336"><a href="#cb66-336" aria-hidden="true" tabindex="-1"></a>    \wh{S}_{\mathrm{KM}}(t|A=a) := \prod_{t_k \leq t}\left(1-\frac{D_k(a)}{N_k(a)}\right).</span>
<span id="cb66-337"><a href="#cb66-337" aria-hidden="true" tabindex="-1"></a>$$ {#eq-unadjKM}</span>
<span id="cb66-338"><a href="#cb66-338" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-339"><a href="#cb66-339" aria-hidden="true" tabindex="-1"></a>The assiociated RMST estimator is then simply defined as</span>
<span id="cb66-340"><a href="#cb66-340" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-341"><a href="#cb66-341" aria-hidden="true" tabindex="-1"></a>\wh{\theta}_{\mathrm{KM}} = \int_{0}^{\tau}\wh{S}_{KM}(t|A=1)-\wh{S}_{KM}(t|A=0)dt.</span>
<span id="cb66-342"><a href="#cb66-342" aria-hidden="true" tabindex="-1"></a>$$ {#eq-thetaunadjKM}</span>
<span id="cb66-343"><a href="#cb66-343" aria-hidden="true" tabindex="-1"></a>The Kaplan-Meier estimator is the Maximum Likelihood Estimator (MLE) of the survival functions, see for instance @kaplan. Furthermore, because $D_k(a)$ and $N_k(a)$ are sums of i.i.d. random variables, the Kaplan-Meier estimator inherits some convenient statistical properties. </span>
<span id="cb66-344"><a href="#cb66-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-345"><a href="#cb66-345" aria-hidden="true" tabindex="-1"></a>::: {#prp-km}</span>
<span id="cb66-346"><a href="#cb66-346" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva; -@eq-rta; -@eq-postrial; -@eq-independantcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-poscen</span><span class="co">]</span>, and for all $t \in <span class="co">[</span><span class="ot">0,\tau</span><span class="co">]</span>$, the estimator $\wh S_{\mathrm{KM}}(t|A=a)$  of  $S^{(a)}(t)$ is strongly consistent and admits the following bounds for its bias:</span>
<span id="cb66-347"><a href="#cb66-347" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-348"><a href="#cb66-348" aria-hidden="true" tabindex="-1"></a>0 \leq S^{(a)}(t) - \bbE<span class="co">[</span><span class="ot">\wh S_\mathrm{KM}(t|A=a)</span><span class="co">]</span> \leq O(\bbP(N_k(a) = 0)),</span>
<span id="cb66-349"><a href="#cb66-349" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-350"><a href="#cb66-350" aria-hidden="true" tabindex="-1"></a>where $k$ is the greatest time $t_k$ such that $t \geq t_k$.</span>
<span id="cb66-351"><a href="#cb66-351" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-352"><a href="#cb66-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-353"><a href="#cb66-353" aria-hidden="true" tabindex="-1"></a>@gill1983large gives a more precise lower-bound on the bias in the case of continuous distributions, which was subsequently refined by @zhou1988two. The bound we give, although slightly looser, still exhibits the same asymptotic regime. In particular, as soon as $S^{(a)}(t) &gt; 0$ (and Assumption <span class="co">[</span><span class="ot">-@eq-poscen</span><span class="co">]</span> holds), then the bias decays exponentially fast towards $0$. We give in @sec-proof21 a simple proof of our bound is our context.</span>
<span id="cb66-354"><a href="#cb66-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-355"><a href="#cb66-355" aria-hidden="true" tabindex="-1"></a>::: {#prp-varkm}</span>
<span id="cb66-356"><a href="#cb66-356" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva; -@eq-rta; -@eq-postrial; -@eq-independantcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-poscen</span><span class="co">]</span>, and for all $t \in <span class="co">[</span><span class="ot">0,\tau</span><span class="co">]</span>$, $\wh S_{\mathrm{KM}}(t|A=a)$ is asymptotically normal and $\sqrt{n}\left(\wh S_{\mathrm{KM}}(t|A=a) - S^{(a)}(t)\right)$ converges in distribution towards a centered Gaussian of variance</span>
<span id="cb66-357"><a href="#cb66-357" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-358"><a href="#cb66-358" aria-hidden="true" tabindex="-1"></a>V_{\mathrm{KM}}(t|A=a) := S^{(a)}(t)^2 \sum_{t_k \leq t} \frac{1-s_k(a)}{s_k(a) r_k(a)},</span>
<span id="cb66-359"><a href="#cb66-359" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-360"><a href="#cb66-360" aria-hidden="true" tabindex="-1"></a>where $s_k(a) = S^{(a)}(t_k)/S^{(a)}(t_{k-1})$ and $r_k(a) = \bbP(\wt T \geq t_k, A=a)$.</span>
<span id="cb66-361"><a href="#cb66-361" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-362"><a href="#cb66-362" aria-hidden="true" tabindex="-1"></a>The proof of @prp-varkm can be found in @sec-proof21. Because $D_k(a)/N_k(a)$ is a natural estimator of $1-s_k(a)$ and, $\frac{1}{n} N_k(a)$ a natural estimator for $r_k(a)$, the asymptotic variance of the Kaplan-Meier estimator can be estimated with the so-called Greenwood formula, as already derived heuristically in @kaplan:</span>
<span id="cb66-363"><a href="#cb66-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-364"><a href="#cb66-364" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-365"><a href="#cb66-365" aria-hidden="true" tabindex="-1"></a>\wh{\Var} \left(\wh{S}_{\mathrm{KM}}(t|A=a)\right) := \wh{S}_{\mathrm{KM}}(t|A=a)^2 \sum_{t_k \leq t} \frac{D_k(a)}{N_k(a)(N_k(a)-D_k(a))}.</span>
<span id="cb66-366"><a href="#cb66-366" aria-hidden="true" tabindex="-1"></a>$$ {#eq-varkm}</span>
<span id="cb66-367"><a href="#cb66-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-368"><a href="#cb66-368" aria-hidden="true" tabindex="-1"></a>We finally mention that the KM estimator as defined in @def-km still makes sense in a non-discrete setting, and one only needs to replace the fixed grid  $<span class="sc">\{</span>t_k<span class="sc">\}</span>$ by the values at which we observed an event $(\wt T_i = t_k, \Delta_i =1)$. We refer to @Kaplan_consistency_breslow74 for a study of this estimator in the continuous case and to @Aalen2008, Sec 3.2 for a general study of the KM estimator through the prism of point processes.</span>
<span id="cb66-369"><a href="#cb66-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-370"><a href="#cb66-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-371"><a href="#cb66-371" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conditionally independent censoring {#sec-condcens}</span></span>
<span id="cb66-372"><a href="#cb66-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-373"><a href="#cb66-373" aria-hidden="true" tabindex="-1"></a>An alternative hypothesis in survival analysis that relaxes the assumption of independent censoring is conditionally independent censoring, also refered sometimes as _informative censoring_. It allows to model more realistic censoring processes, in particular in situations where there are reasons to believe that $C$ may be dependent from $A$ and $X$ (for instance,  if patient is more like to leave the study when treated because of side-effects of the treatment).</span>
<span id="cb66-374"><a href="#cb66-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-375"><a href="#cb66-375" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-376"><a href="#cb66-376" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Conditionally independent censoring)</span>
<span id="cb66-377"><a href="#cb66-377" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-378"><a href="#cb66-378" aria-hidden="true" tabindex="-1"></a>C \perp\mkern-9.5mu\perp T(0),T(1) ~ | ~X,A</span>
<span id="cb66-379"><a href="#cb66-379" aria-hidden="true" tabindex="-1"></a>$$ {#eq-condindepcensoring}</span>
<span id="cb66-380"><a href="#cb66-380" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-381"><a href="#cb66-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-382"><a href="#cb66-382" aria-hidden="true" tabindex="-1"></a>Under @eq-condindepcensoring, subjects within a same stratum defined by $X=x$ and $A=a$ have equal probability of censoring at time $t$, for all $t$.</span>
<span id="cb66-383"><a href="#cb66-383" aria-hidden="true" tabindex="-1"></a>In case of conditionally independent censoring,  we also need to assume that all subjects have a positive probability to remain uncensored at their time-to-event.</span>
<span id="cb66-384"><a href="#cb66-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-385"><a href="#cb66-385" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-386"><a href="#cb66-386" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Positivity / Overlap for censoring)</span>
<span id="cb66-387"><a href="#cb66-387" aria-hidden="true" tabindex="-1"></a>There exists $\ve &gt; 0$ such that for all $t\in [0,\tau)$, it almost surely holds</span>
<span id="cb66-388"><a href="#cb66-388" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-389"><a href="#cb66-389" aria-hidden="true" tabindex="-1"></a>G(t|A,X) \geq \epsilon.</span>
<span id="cb66-390"><a href="#cb66-390" aria-hidden="true" tabindex="-1"></a>$$ {#eq-positivitycensoring}</span>
<span id="cb66-391"><a href="#cb66-391" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-392"><a href="#cb66-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-393"><a href="#cb66-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-394"><a href="#cb66-394" aria-hidden="true" tabindex="-1"></a>@fig-RCT_dep_causalgraph represents the causal graph when the</span>
<span id="cb66-395"><a href="#cb66-395" aria-hidden="true" tabindex="-1"></a>study is randomized with conditionally independent censoring.</span>
<span id="cb66-396"><a href="#cb66-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-397"><a href="#cb66-397" aria-hidden="true" tabindex="-1"></a>![Causal graph in RCT survival data with</span>
<span id="cb66-398"><a href="#cb66-398" aria-hidden="true" tabindex="-1"></a>dependent censoring.](causal_survival_rct_dep.pdf){#fig-RCT_dep_causalgraph fig-align="center" width="40%"}</span>
<span id="cb66-399"><a href="#cb66-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-400"><a href="#cb66-400" aria-hidden="true" tabindex="-1"></a>Under dependent censoring, the</span>
<span id="cb66-401"><a href="#cb66-401" aria-hidden="true" tabindex="-1"></a>Kaplan-Meier estimator as defined in @def-km can fail to estimate survival, in particular because @eq-kmindep does not hold anymore. Alternatives include plug-in G-formula estimators (@sec-Gformula) and unbiased transformations (@sec-unbiasedtransfo).  </span>
<span id="cb66-402"><a href="#cb66-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-403"><a href="#cb66-403" aria-hidden="true" tabindex="-1"></a><span class="fu">### The G-formula and the Cox Model {#sec-Gformula} </span></span>
<span id="cb66-404"><a href="#cb66-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-405"><a href="#cb66-405" aria-hidden="true" tabindex="-1"></a>Because the censoring is now independent from the potential outcome conditionally to the covariates, it would seem natural to model the response of the survival time conditionally to these covariates too: </span>
<span id="cb66-406"><a href="#cb66-406" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-407"><a href="#cb66-407" aria-hidden="true" tabindex="-1"></a>\mu(x,a) := \mathbb{E}<span class="co">[</span><span class="ot">T \wedge \tau |X = x, A = a</span><span class="co">]</span>.</span>
<span id="cb66-408"><a href="#cb66-408" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-409"><a href="#cb66-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-410"><a href="#cb66-410" aria-hidden="true" tabindex="-1"></a>Building on @eq-RMSTkm, one can express the RMST as a function of $\mu$: </span>
<span id="cb66-411"><a href="#cb66-411" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-412"><a href="#cb66-412" aria-hidden="true" tabindex="-1"></a> \theta_{\mathrm{RMST}} = \mathbb{E}\left<span class="co">[</span><span class="ot">\mathbb{E}[T \wedge \tau |X, A = 1]\right</span><span class="co">]</span> - \mathbb{E}\left<span class="co">[</span><span class="ot"> T \wedge \tau|X, A= 0</span><span class="co">]</span>\right] = \bbE<span class="co">[</span><span class="ot">\mu(X,1)-\mu(X,0)</span><span class="co">]</span>.</span>
<span id="cb66-413"><a href="#cb66-413" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-414"><a href="#cb66-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-415"><a href="#cb66-415" aria-hidden="true" tabindex="-1"></a>An estimator $\wh \mu$ of $\mu$ would then straightforwardly yield an estimator of the difference in RMST through the so-called _G-formula_ plug-in estimator:</span>
<span id="cb66-416"><a href="#cb66-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-417"><a href="#cb66-417" aria-hidden="true" tabindex="-1"></a>$$ \widehat{\theta}_{\mathrm{G-formula}} = \frac{1}{n} \sum_{i=1}^n \wh \mu\left(X_i, 1\right)-\wh \mu\left(X_i, 0\right). $${#eq-gformula}</span>
<span id="cb66-418"><a href="#cb66-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-419"><a href="#cb66-419" aria-hidden="true" tabindex="-1"></a>We would like to stress that a G-formula approach works also in a observational context as the one introduced in @sec-obscondcens. However, because the estimation strategies presented in the next sections relies on estimating nuisance parameters, and that this latter task is often done in the same way as we estimate the conditional response $\mu$, we decided to not delay the introduction of the G-formula any further, and we present below a few estimation methods for $\mu$. These methods are sub-divised in two categories: _$T$-learners_, where $\mu(\cdot,1)$ is estimated separately from $\mu(\cdot,0)$, and _$S$-learners, where $\wh\mu$ is obtained by fitting a single model based on covariates $(X,A)$. </span>
<span id="cb66-420"><a href="#cb66-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-421"><a href="#cb66-421" aria-hidden="true" tabindex="-1"></a>**Cox's Model**. There are many ways to model $\mu$ in a survival context, the most notorious of which being the Cox proportional hazards model <span class="co">[</span><span class="ot">@Cox_1972</span><span class="co">]</span>. It relies on a semi-parametric modelling the conditional hazard functions $\lambda^{(a)}(t|X)$ as </span>
<span id="cb66-422"><a href="#cb66-422" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-423"><a href="#cb66-423" aria-hidden="true" tabindex="-1"></a>\lambda^{(a)}(t|X) = \lambda_0^{(a)}(t) \exp(X^\top\beta^{(a)}),</span>
<span id="cb66-424"><a href="#cb66-424" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-425"><a href="#cb66-425" aria-hidden="true" tabindex="-1"></a>where $\lambda^{(a)}_0$ is a baseline hazard function and $\beta^{(a)}$ has the same dimension as the vector of covariate $X$. The conditional survival function then take the simple form (in the continuous case)</span>
<span id="cb66-426"><a href="#cb66-426" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-427"><a href="#cb66-427" aria-hidden="true" tabindex="-1"></a>S^{(a)}(t|X) = S^{(a)}_0(t)^{\exp(X^\top\beta^{(a)})},</span>
<span id="cb66-428"><a href="#cb66-428" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-429"><a href="#cb66-429" aria-hidden="true" tabindex="-1"></a>where $S^{(a)}_0(t)$ is the survival function associated with $\lambda_0^{(a)}$. The vector $\beta^{(a)}$ is classically estimated by maximizing the so-called _partial likelihood_ function as introduced in the original paper of @Cox_1972:</span>
<span id="cb66-430"><a href="#cb66-430" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-431"><a href="#cb66-431" aria-hidden="true" tabindex="-1"></a>\mathcal{L}(\beta) := \prod_{\Delta_i = 1} \frac{\exp(X_i^\top \beta)}{\displaystyle\sum_{\wt T_j \geq \wt T_i} \exp(X_j^\top \beta)},</span>
<span id="cb66-432"><a href="#cb66-432" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-433"><a href="#cb66-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-434"><a href="#cb66-434" aria-hidden="true" tabindex="-1"></a>while the cumulative baseline hazard function can be estimated through the Breslow's estimator  <span class="co">[</span><span class="ot">@Breslow_approx1974</span><span class="co">]</span>:</span>
<span id="cb66-435"><a href="#cb66-435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-436"><a href="#cb66-436" aria-hidden="true" tabindex="-1"></a>\wh \Lambda_0^{(a)}(t) = \sum_{\Delta_i = 1, \wt T_i \leq t} \frac{1}{\displaystyle\sum_{\wt T_j \geq \wt T_i} \exp(X_j^\top \wh \beta^{(a)})} </span>
<span id="cb66-437"><a href="#cb66-437" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-438"><a href="#cb66-438" aria-hidden="true" tabindex="-1"></a>where $\wh \beta^{(a)}$ is a partial likelihood maximizer. One can show that $(\wh\beta^{(a)},\wh \Lambda_0^{(a)})$ is the MLE of the true likelihood, when $\wh \Lambda_0^{(a)}$ is optimized over all step fonctions of the form</span>
<span id="cb66-439"><a href="#cb66-439" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-440"><a href="#cb66-440" aria-hidden="true" tabindex="-1"></a>\Lambda_0(t) := \sum_{\Delta_i=1} h_i, \quad h_i \in \mathbb{R}^+.</span>
<span id="cb66-441"><a href="#cb66-441" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-442"><a href="#cb66-442" aria-hidden="true" tabindex="-1"></a>This fact was already hinted in the original paper by Cox and made rigorous in many subsequent papers, see for instance @fan2010high. Furthermore, if the true distribution follows a Cox model, then both $\wh\beta^{(a)}$ and $\wh \Lambda_0^{(a)}$ are strongly consistent and asymptotically normal estimator of the true parameters $\beta^{(a)}$ and $\Lambda^{(a)}$, see @kalbfleisch2002statistical, Sec 5.7.</span>
<span id="cb66-443"><a href="#cb66-443" aria-hidden="true" tabindex="-1"></a>When using a $T$-learner approach, one simply finds $(\wh\beta^{(a)},\wh \Lambda_0^{(a)})$ for $a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$ by considering the control group and the treated group separately. When using a $S$-learner approach, the treatment status $A$ becomes a covariate a the model becomes</span>
<span id="cb66-444"><a href="#cb66-444" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-445"><a href="#cb66-445" aria-hidden="true" tabindex="-1"></a>\lambda(t|X,A) = \lambda_0(t) \exp(X^\top\beta+\alpha A).</span>
<span id="cb66-446"><a href="#cb66-446" aria-hidden="true" tabindex="-1"></a>$$ {#eq-coxslearner}</span>
<span id="cb66-447"><a href="#cb66-447" aria-hidden="true" tabindex="-1"></a>for some $\alpha \in \mathbb{R}$. One main advantage of Cox's model is that it makes it very easy to interpret the effect of  a covariate on the survival time. If indeed $\alpha &gt; 0$, then the treatment has a negative effect of the survival times. Likewise, if $\beta_i &gt;0$, then the $i$-th coordinate of $X$ has a negative effect as well. We finally mention that the hazard ratio takes a particularly simple form under the later model since</span>
<span id="cb66-448"><a href="#cb66-448" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-449"><a href="#cb66-449" aria-hidden="true" tabindex="-1"></a>\theta_{\mathrm{HR}} = e^{\alpha}.</span>
<span id="cb66-450"><a href="#cb66-450" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-451"><a href="#cb66-451" aria-hidden="true" tabindex="-1"></a>In particular, it does not depends on the time horizon $\tau$, and is thus sometimes refered to as _proportional hazard_. @fig-gf illustrates the estimation of the difference in Restricted Mean Survival Time using G-formula with Cox models. </span>
<span id="cb66-452"><a href="#cb66-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-453"><a href="#cb66-453" aria-hidden="true" tabindex="-1"></a>![Illustration of the G-formula for estimating</span>
<span id="cb66-454"><a href="#cb66-454" aria-hidden="true" tabindex="-1"></a>$\theta_{\mathrm{RMST}}$ in an RCT when only one covariate $X_1$ influences the  outcome.](G_formula_RCT.pdf){#fig-gf width="110%"}</span>
<span id="cb66-455"><a href="#cb66-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-456"><a href="#cb66-456" aria-hidden="true" tabindex="-1"></a>**Weibull Model**. A popular parametric model for survival is the Weibull Model, which amounts to assume that</span>
<span id="cb66-457"><a href="#cb66-457" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-458"><a href="#cb66-458" aria-hidden="true" tabindex="-1"></a>\lambda^{(a)}(t|X) = \lambda_0^{(a)}(t) \exp(X^\top\beta)</span>
<span id="cb66-459"><a href="#cb66-459" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-460"><a href="#cb66-460" aria-hidden="true" tabindex="-1"></a>where $\lambda_0^{(a)}(t)$ is the instant hazard function of a Weibull distribution, that is to say a function proportional to $t^{\gamma}$ for some shape parameter $\gamma &gt;0$. We refer to @zhang2016parametric for a study of this model. </span>
<span id="cb66-461"><a href="#cb66-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-462"><a href="#cb66-462" aria-hidden="true" tabindex="-1"></a>**Survival Forests**. On the non-parametric front, we mention the existence of survival forests <span class="co">[</span><span class="ot">@ishwaran2008random</span><span class="co">]</span>.</span>
<span id="cb66-463"><a href="#cb66-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-464"><a href="#cb66-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-465"><a href="#cb66-465" aria-hidden="true" tabindex="-1"></a><span class="fu">### Censoring unbiased transformations {#sec-unbiasedtransfo}</span></span>
<span id="cb66-466"><a href="#cb66-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-467"><a href="#cb66-467" aria-hidden="true" tabindex="-1"></a>Censoring unbiased transformations involve applying a transformation to $T$. Specifically, we compute a new time $T^*$ of the form</span>
<span id="cb66-468"><a href="#cb66-468" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-469"><a href="#cb66-469" aria-hidden="true" tabindex="-1"></a>T^* := T^*(\wt T,X,A,\Delta) = \begin{cases}</span>
<span id="cb66-470"><a href="#cb66-470" aria-hidden="true" tabindex="-1"></a>\phi_0(\wt T \wedge \tau,X,A) \quad &amp;\text{if} \quad \Delta^\tau = 0, <span class="sc">\\</span></span>
<span id="cb66-471"><a href="#cb66-471" aria-hidden="true" tabindex="-1"></a>\phi_1(\wt T \wedge \tau,X,A) \quad &amp;\text{if} \quad \Delta^\tau = 1.</span>
<span id="cb66-472"><a href="#cb66-472" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb66-473"><a href="#cb66-473" aria-hidden="true" tabindex="-1"></a>$$ {#eq-defcut}</span>
<span id="cb66-474"><a href="#cb66-474" aria-hidden="true" tabindex="-1"></a>for two wisely chosen transformations $\phi_0$ and $\phi_1$, and where </span>
<span id="cb66-475"><a href="#cb66-475" aria-hidden="true" tabindex="-1"></a>$$\Delta^{\tau}:=\mathbb{I}<span class="sc">\{</span>T \wedge \tau \leq C<span class="sc">\}</span> = \Delta+(1-\Delta)\mathbb{I}(\wt T \geq \tau)</span>
<span id="cb66-476"><a href="#cb66-476" aria-hidden="true" tabindex="-1"></a>$$ {#eq-defdeltatau}</span>
<span id="cb66-477"><a href="#cb66-477" aria-hidden="true" tabindex="-1"></a>is the indicator of the event where the individual is either uncensored or censored after time $\tau$. The idea behind the introduction of $\Delta^\tau$ is that because we are only interested in computed the expectation of the survival time thresholded by $\tau$, any censored observation coming after time $\tau$ can in fact be considered as uncensored ($\Delta^\tau = 1$). </span>
<span id="cb66-478"><a href="#cb66-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-479"><a href="#cb66-479" aria-hidden="true" tabindex="-1"></a>A censoring unbiased transformation $T^*$ shall satisfy: for $a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$, it holds</span>
<span id="cb66-480"><a href="#cb66-480" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-481"><a href="#cb66-481" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">T^*|A=a,X</span><span class="co">]</span> = \bbE<span class="co">[</span><span class="ot">T(a) \wedge \tau |X</span><span class="co">]</span> \quad\text{almost surely.}</span>
<span id="cb66-482"><a href="#cb66-482" aria-hidden="true" tabindex="-1"></a>$${#eq-cut}</span>
<span id="cb66-483"><a href="#cb66-483" aria-hidden="true" tabindex="-1"></a>A notable advantage of this</span>
<span id="cb66-484"><a href="#cb66-484" aria-hidden="true" tabindex="-1"></a>approach is that it enables the use of the full transformed dataset $(X_i,A_i,T^*_i)$ as if no censoring occured. Because it holds</span>
<span id="cb66-485"><a href="#cb66-485" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-486"><a href="#cb66-486" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">\bbE[T^*|A=a,X]</span><span class="co">]</span> = \bbE\left<span class="co">[</span><span class="ot">\frac{\mathbb{I}\{A=a\}}{\bbP(A=a)} T^*\right</span><span class="co">]</span>,</span>
<span id="cb66-487"><a href="#cb66-487" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cutcond}</span>
<span id="cb66-488"><a href="#cb66-488" aria-hidden="true" tabindex="-1"></a>there is a very natural way to derive an estimator of the difference in RMST from any censoring unbiased transformation $T^*$ as:</span>
<span id="cb66-489"><a href="#cb66-489" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-490"><a href="#cb66-490" aria-hidden="true" tabindex="-1"></a>\wh\theta = \frac1n\sum_{i=1}^n \left(\frac{A_i}{\pi}-\frac{1-A_i}{1-\pi} \right) T^*_i</span>
<span id="cb66-491"><a href="#cb66-491" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cutest}</span>
<span id="cb66-492"><a href="#cb66-492" aria-hidden="true" tabindex="-1"></a>where $\pi = \bbP(A=1) \in (0,1)$ by Assumption <span class="co">[</span><span class="ot">-@eq-postrial</span><span class="co">]</span> and where $T^*_i = T^*(\wt T_i,X_i,A_i,\Delta_i)$. We easily get the following result.</span>
<span id="cb66-493"><a href="#cb66-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-494"><a href="#cb66-494" aria-hidden="true" tabindex="-1"></a>::: {#prp-cutest}</span>
<span id="cb66-495"><a href="#cb66-495" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-rta</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-postrial</span><span class="co">]</span>, the estimator $\wh\theta$ derived as in @eq-cutest from a square integrable censoring unbiased transformations satisfying @eq-cut is an unbiased, strongly consistent, and asymptotically normal estimator of the difference in RMST.</span>
<span id="cb66-496"><a href="#cb66-496" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-497"><a href="#cb66-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-498"><a href="#cb66-498" aria-hidden="true" tabindex="-1"></a>Square integrability will be ensured any time the transformnation is bounded, which will always be the case of the ones considered in this work. It is natural in a RCT setting to assume that probability of being treated $\pi$ is known. If not, it is usual to replace $\pi$ by its empirical counterpart $\wh \pi = n_1/n$ where $n_a = \sum_{i} \mathbb{1}<span class="sc">\{</span>A=a<span class="sc">\}</span>$. The resulting estimator takes the form</span>
<span id="cb66-499"><a href="#cb66-499" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-500"><a href="#cb66-500" aria-hidden="true" tabindex="-1"></a>\wh\theta = \frac1{n_1}\sum_{A_i = 1}  T^*_i - \frac1{n_0}\sum_{A_i = 0}  T^*_i.</span>
<span id="cb66-501"><a href="#cb66-501" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cutestnopi}</span>
<span id="cb66-502"><a href="#cb66-502" aria-hidden="true" tabindex="-1"></a>Note however that this estimator is slighlty biased due to the estimation of $\pi$ (see for instance @colnet2022reweighting, Lemma 2), but it is still strongly consistent and asymptotically normal, and its biased is exponentially small in $n$.</span>
<span id="cb66-503"><a href="#cb66-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-504"><a href="#cb66-504" aria-hidden="true" tabindex="-1"></a>::: {#prp-cutestnopi}</span>
<span id="cb66-505"><a href="#cb66-505" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-rta</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-postrial</span><span class="co">]</span>, the estimator $\wh\theta$ derived as in @eq-cutestnopi from a square integrable censoring unbiased transformations satisfying @eq-cut is a strongly consistent, and asymptotically normal estimator of the difference in RMST.</span>
<span id="cb66-506"><a href="#cb66-506" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-507"><a href="#cb66-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-508"><a href="#cb66-508" aria-hidden="true" tabindex="-1"></a>The two most popular transformations are Inverse-Probability-of-Censoring Weighting (@IPCtransKoul81) and Buckley-James (@Buckley_james_79), both illustrated in @fig-trans and detailed below. In the former, only non-censored observations are considered and they are weighted while in the latter, censored observations are imputed with an estimated survival time.</span>
<span id="cb66-509"><a href="#cb66-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-510"><a href="#cb66-510" aria-hidden="true" tabindex="-1"></a>![Illustration of Inverse-Probability-of-Censoring and Buckley-James</span>
<span id="cb66-511"><a href="#cb66-511" aria-hidden="true" tabindex="-1"></a>transformations.](schema_transformation.pdf){#fig-trans}</span>
<span id="cb66-512"><a href="#cb66-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-513"><a href="#cb66-513" aria-hidden="true" tabindex="-1"></a>**The Inverse-Probability-of-Censoring Weighted transformation** </span>
<span id="cb66-514"><a href="#cb66-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-515"><a href="#cb66-515" aria-hidden="true" tabindex="-1"></a>The Inverse-Probability-of-Censoring Weighted (IPCW) transformation, introduced by (@IPCtransKoul81) in the context of censored linear regression, involves discarding censored observations and applying weights to uncensored data. More precisely, we let</span>
<span id="cb66-516"><a href="#cb66-516" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-517"><a href="#cb66-517" aria-hidden="true" tabindex="-1"></a>T^*_{\mathrm{IPCW}}=\frac{\Delta^\tau}{G(\widetilde{T}\wedge \tau|X,A)} \widetilde{T} \wedge \tau,</span>
<span id="cb66-518"><a href="#cb66-518" aria-hidden="true" tabindex="-1"></a>$$ {#eq-defipcw}</span>
<span id="cb66-519"><a href="#cb66-519" aria-hidden="true" tabindex="-1"></a>where we recall that $G(t|X,A) :=\mathbb{P}(C \geq t|X,A)$ is the left limit of the conditional survival function of the censoring. </span>
<span id="cb66-520"><a href="#cb66-520" aria-hidden="true" tabindex="-1"></a>This estimator assigns higher weights to uncensored subjects within a covariate group that is highly prone to censoring, thereby correcting for conditionally independent censoring and reducing selection bias <span class="co">[</span><span class="ot">@Howe2016SelectionBD</span><span class="co">]</span>.</span>
<span id="cb66-521"><a href="#cb66-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-522"><a href="#cb66-522" aria-hidden="true" tabindex="-1"></a>::: {#prp-ipcw}</span>
<span id="cb66-523"><a href="#cb66-523" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-rta;-@eq-postrial,-@eq-postrial;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, the IPCW transform <span class="co">[</span><span class="ot">-@eq-defipcw</span><span class="co">]</span> is a censoring unbiased transformation in the sense of @eq-cut.</span>
<span id="cb66-524"><a href="#cb66-524" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-525"><a href="#cb66-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-526"><a href="#cb66-526" aria-hidden="true" tabindex="-1"></a>The proof of @prp-ipcw is in @sec-proof22. The IPCW depends on the unknown conditional survival function of the censoring $G(\cdot|X,A)$, which thus needs to be estimated. Estimating conditional censoring or the conditional survival function can be approached similarly, as both involve estimating a time—whether for survival or censoring. Consequently, we can use semi-parametric methods, such as the Cox model, or non-parametric approaches like survival forests, and we refer to @sec-Gformula for a development on these approaches. Once an estimator $\wh G(\cdot|A,X)$ of the later is provided, one can construct an estimator of the difference in RMST based on @eq-cutest or @eq-cutestnopi</span>
<span id="cb66-527"><a href="#cb66-527" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-528"><a href="#cb66-528" aria-hidden="true" tabindex="-1"></a>\wh \theta_{\mathrm{IPCW}} = \frac1n \sum_{i=1}^n \left(\frac{A_i}{\pi}-\frac{1-A_i}{1-\pi}\right) T^*_{\mathrm{IPCW},i}, </span>
<span id="cb66-529"><a href="#cb66-529" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ipcwdef}</span>
<span id="cb66-530"><a href="#cb66-530" aria-hidden="true" tabindex="-1"></a>or </span>
<span id="cb66-531"><a href="#cb66-531" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-532"><a href="#cb66-532" aria-hidden="true" tabindex="-1"></a>\wh\theta_{\mathrm{IPCW}} = \frac1{n_1}\sum_{A_i = 1}  T^*_{\mathrm{IPCW},i} - \frac1{n_0}\sum_{A_i = 0}  T^*_{\mathrm{IPCW},i}. </span>
<span id="cb66-533"><a href="#cb66-533" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ipcwdefnopi}</span>
<span id="cb66-534"><a href="#cb66-534" aria-hidden="true" tabindex="-1"></a>where we recall that $n_a := <span class="sc">\#\{</span>i \in <span class="co">[</span><span class="ot">n</span><span class="co">]</span>~|~A_i=a<span class="sc">\}</span>$. By @prp-cutest, @prp-cutestnopi and @prp-ipcw, we easily deduce that $\wh \theta_{\mathrm{IPCW}}$ is asymptotically consistent as soon as $\wh G$ is.</span>
<span id="cb66-535"><a href="#cb66-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-536"><a href="#cb66-536" aria-hidden="true" tabindex="-1"></a>::: {#cor-ipcwcons}</span>
<span id="cb66-537"><a href="#cb66-537" aria-hidden="true" tabindex="-1"></a>Under Assumptions<span class="co">[</span><span class="ot">-@eq-sutva;-@eq-rta;-@eq-postrial;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, if $\wh G$ is uniformly weakly (resp. strongly) consistent then so is $\wh \theta_{\mathrm{IPCW}}$, either as in defined in @eq-ipcwdef or in @eq-ipcwdefnopi.</span>
<span id="cb66-538"><a href="#cb66-538" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-539"><a href="#cb66-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-540"><a href="#cb66-540" aria-hidden="true" tabindex="-1"></a>This result simply comes from the fact that $\wh \theta_{\mathrm{IPCW}}$ depends continuously on $\wh G$ and that $G$ is lower-bounded (Assumption <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>). Surprisingly, we found limited use of this estimator in the literature, beside its first introduction in @IPCtransKoul81. This could potentially be explained by the fact that, empirically, we observed that this estimator is highly variable. Consequently, we do not explore its properties further and will not include it in the numerical experiments. A related and more popular estimator is the IPCW-Kaplan-Meier, defined as follows. </span>
<span id="cb66-541"><a href="#cb66-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-542"><a href="#cb66-542" aria-hidden="true" tabindex="-1"></a>::: {#def-ipcwkm} </span>
<span id="cb66-543"><a href="#cb66-543" aria-hidden="true" tabindex="-1"></a>(IPCW-Kaplan-Meier)</span>
<span id="cb66-544"><a href="#cb66-544" aria-hidden="true" tabindex="-1"></a>We let again $\wh G(\cdot|X,A)$ be an estimator of the (left limit of) the conditional censoring survival function and we introduce</span>
<span id="cb66-545"><a href="#cb66-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-546"><a href="#cb66-546" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-547"><a href="#cb66-547" aria-hidden="true" tabindex="-1"></a>D_k^{\mathrm{IPCW}}(a) &amp;:= \sum_{i=1}^n \frac{\Delta_i^\tau}{\wh G(\wt T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\wt T_i = t_k, A_i=a) <span class="sc">\\</span></span>
<span id="cb66-548"><a href="#cb66-548" aria-hidden="true" tabindex="-1"></a>\mand N^{\mathrm{IPCW}}_k(a) &amp;:= \sum_{i=1}^n \frac{\Delta_i^\tau}{\wh G(\wt T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\wt T_i \geq t_k, A_i=a),</span>
<span id="cb66-549"><a href="#cb66-549" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-550"><a href="#cb66-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-551"><a href="#cb66-551" aria-hidden="true" tabindex="-1"></a>be the weight-corrected numbers of deaths and of individual at risk at time $t_k$. The IPCW version of the KM estimator is then defined as: </span>
<span id="cb66-552"><a href="#cb66-552" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-553"><a href="#cb66-553" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-554"><a href="#cb66-554" aria-hidden="true" tabindex="-1"></a>\wh{S}_{\mathrm{IPCW}}(t | A=a) &amp;= \prod_{t_k \leq t}\left(1-\frac{D_k^{\mathrm{IPCW}}(a)}{N_k^{\mathrm{IPCW}}(a)}\right). </span>
<span id="cb66-555"><a href="#cb66-555" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-556"><a href="#cb66-556" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-557"><a href="#cb66-557" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-558"><a href="#cb66-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-559"><a href="#cb66-559" aria-hidden="true" tabindex="-1"></a>Note that the quantity $\pi$ is not present in the definition of $D_k^{\mathrm{IPCW}}(a)$ and $N_k^{\mathrm{IPCW}}(a)$ because it would simply disappear in the ratio $D_k^{\mathrm{IPCW}}(a)/N_k^{\mathrm{IPCW}}(a)$. The subsequent RMST estimator then take the form</span>
<span id="cb66-560"><a href="#cb66-560" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-561"><a href="#cb66-561" aria-hidden="true" tabindex="-1"></a>\wh{\theta}_{\mathrm{IPCW-KM}} = \int_{0}^{\tau}\wh{S}_{\mathrm{IPCW}}(t|A=1)-\wh{S}_{\mathrm{IPCW}}(t|A=0)dt.</span>
<span id="cb66-562"><a href="#cb66-562" aria-hidden="true" tabindex="-1"></a>$$ {#eq-thetaIPCWKM}</span>
<span id="cb66-563"><a href="#cb66-563" aria-hidden="true" tabindex="-1"></a>Like before for the classical KM estimator, this new reweighted KM estimator enjoys good statistical properties.</span>
<span id="cb66-564"><a href="#cb66-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-565"><a href="#cb66-565" aria-hidden="true" tabindex="-1"></a>::: {#prp-ipcwkm}</span>
<span id="cb66-566"><a href="#cb66-566" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-rta;-@eq-postrial;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, and for all $t \in <span class="co">[</span><span class="ot">0,\tau</span><span class="co">]</span>$, the oracle estimator $S^*_{\mathrm{IPCW}}(t|A=a)$ defined as in @def-ipcwkm with $\wh G = G$ is a stronlgy consistent and asymptotically normal estimator of $S^{(a)}(t)$ .</span>
<span id="cb66-567"><a href="#cb66-567" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-568"><a href="#cb66-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-569"><a href="#cb66-569" aria-hidden="true" tabindex="-1"></a>The proof of @prp-ipcwkm can be found in @sec-proof22. Because the evaluation of $N_k^{\textrm{IPCW}}(a)$ now depends on information gathered after time $t_k$ (through the computation of the weights), the previous proofs on the absence of bias and on the derivation of the asymptotic variance unfortunately do not carry over in this case. Whether its bias is exponentially small and whether the asymptotic variance can be derived in a closed form are questions left open. We are also not aware of any estimation schemes for the asymptotic variance in this context. In the case where we do not have access to the oracle survival function $G$, we can again still achieve consistency if the estimator $\wh G(\cdot|A,X)$ that we provide is consistent.</span>
<span id="cb66-570"><a href="#cb66-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-571"><a href="#cb66-571" aria-hidden="true" tabindex="-1"></a>::: {#cor-ipcwkmcons}</span>
<span id="cb66-572"><a href="#cb66-572" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-rta,-@eq-postrial;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, if $\wh G$ is uniformly weakly (resp. strongly) consistent then so is $\wh S_{\mathrm{IPCW}}(t|A=a)$.</span>
<span id="cb66-573"><a href="#cb66-573" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-574"><a href="#cb66-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-575"><a href="#cb66-575" aria-hidden="true" tabindex="-1"></a>This corollary ensures that the corresponding RMST estimator defined in @eq-thetaIPCWKM will be consistent as well.</span>
<span id="cb66-576"><a href="#cb66-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-577"><a href="#cb66-577" aria-hidden="true" tabindex="-1"></a>**The Buckley-James transformation**</span>
<span id="cb66-578"><a href="#cb66-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-579"><a href="#cb66-579" aria-hidden="true" tabindex="-1"></a>One weakness of the IPCW transformation is that it discards all censored data. The Buckley-James (BJ) transformation, introduced by (@Buckley_james_79), takes a different path by leaving all uncensored values untouched, while replacing the censored ones by an extrapolated value. Formally, it is defined as follows:</span>
<span id="cb66-580"><a href="#cb66-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-581"><a href="#cb66-581" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-582"><a href="#cb66-582" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-583"><a href="#cb66-583" aria-hidden="true" tabindex="-1"></a>T^*_{\mathrm{BJ}} &amp;= \Delta^\tau (\widetilde{T}\wedge\tau) + (1-\Delta^\tau) Q_S(\widetilde T \wedge \tau|X,A),</span>
<span id="cb66-584"><a href="#cb66-584" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-585"><a href="#cb66-585" aria-hidden="true" tabindex="-1"></a>$$ {#eq-defbj}</span>
<span id="cb66-586"><a href="#cb66-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-587"><a href="#cb66-587" aria-hidden="true" tabindex="-1"></a>where, for $t \leq \tau$,</span>
<span id="cb66-588"><a href="#cb66-588" aria-hidden="true" tabindex="-1"></a>$$Q_S(t|X,A) :=\mathbb{E}<span class="co">[</span><span class="ot">T \wedge \tau | X,A,T \wedge \tau &gt; t</span><span class="co">]</span>= \frac{1}{S(t|X,A)}\int_{t}^{\tau} S(u|X,A) \diff u$$ where $S(t|X,A=a) := \bbP(T(a) &gt; t|X)$ is the conditional survival function. We refer again to @fig-trans for a diagram of this transformation.</span>
<span id="cb66-589"><a href="#cb66-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-590"><a href="#cb66-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-591"><a href="#cb66-591" aria-hidden="true" tabindex="-1"></a>::: {#prp-bj}</span>
<span id="cb66-592"><a href="#cb66-592" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-rta,-@eq-postrial;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, the BJ transform <span class="co">[</span><span class="ot">-@eq-defbj</span><span class="co">]</span> is a censoring unbiased transformation in the sense of @eq-cut.</span>
<span id="cb66-593"><a href="#cb66-593" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-594"><a href="#cb66-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-595"><a href="#cb66-595" aria-hidden="true" tabindex="-1"></a>The proof of @prp-bj can be found in @sec-proof22. Again, the BJ transformation depends on a nuisance parameter (here $Q_S(\cdot|X,A)$) that needs to be estimated. We again refer to @sec-Gformula for a brief overview of possible estimation strategies for $Q_S$. </span>
<span id="cb66-596"><a href="#cb66-596" aria-hidden="true" tabindex="-1"></a>Once provided with an estimator $\wh Q_S(\cdot|A,X)$, a very natural estimator of the RMST based on the BJ transformation and on @eq-cutest or @eq-cutestnopi would be</span>
<span id="cb66-597"><a href="#cb66-597" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-598"><a href="#cb66-598" aria-hidden="true" tabindex="-1"></a>\wh \theta_{\mathrm{BJ}} = \frac1n \sum_{i=1}^n \left(\frac{A_i}{\pi}-\frac{1-A_i}{1-\pi}\right) T^*_{\mathrm{BJ},i}, </span>
<span id="cb66-599"><a href="#cb66-599" aria-hidden="true" tabindex="-1"></a>$${#eq-BJ}</span>
<span id="cb66-600"><a href="#cb66-600" aria-hidden="true" tabindex="-1"></a>or </span>
<span id="cb66-601"><a href="#cb66-601" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-602"><a href="#cb66-602" aria-hidden="true" tabindex="-1"></a>\wh \theta_{\mathrm{BJ}} = \frac1{n_1} \sum_{A_i=1}  T^*_{\mathrm{BJ},i}-\frac1{n_0} \sum_{A_0=1}  T^*_{\mathrm{BJ},i}. </span>
<span id="cb66-603"><a href="#cb66-603" aria-hidden="true" tabindex="-1"></a>$${#eq-BJnopi}</span>
<span id="cb66-604"><a href="#cb66-604" aria-hidden="true" tabindex="-1"></a>Like for the IPCW transformation, the BJ transformation yields a consistent estimate of the RMST as soon as the model is well-specified.</span>
<span id="cb66-605"><a href="#cb66-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-606"><a href="#cb66-606" aria-hidden="true" tabindex="-1"></a>::: {#cor-bjcons}</span>
<span id="cb66-607"><a href="#cb66-607" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-rta,-@eq-postrial;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>,  if $\wh Q_S$ is uniformly weakly (resp. strongly) consistent then so is $\wh \theta_{\mathrm{BJ}}$ defined as in @eq-BJ or @eq-BJnopi.</span>
<span id="cb66-608"><a href="#cb66-608" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-609"><a href="#cb66-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-610"><a href="#cb66-610" aria-hidden="true" tabindex="-1"></a>The proof is again a mere application of Propositions <span class="co">[</span><span class="ot">-@prp-cutest;-@prp-cutestnopi</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@prp-bj</span><span class="co">]</span>, and relies on the continuity of $S \mapsto Q_S$. The BJ transformation is considered as the best censoring transformation of the original response in the following sense.</span>
<span id="cb66-611"><a href="#cb66-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-612"><a href="#cb66-612" aria-hidden="true" tabindex="-1"></a>::: {#thm-bj}</span>
<span id="cb66-613"><a href="#cb66-613" aria-hidden="true" tabindex="-1"></a>For any transformation $T^*$ of the form <span class="co">[</span><span class="ot">-@eq-defcut</span><span class="co">]</span>, it holds</span>
<span id="cb66-614"><a href="#cb66-614" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-615"><a href="#cb66-615" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">(T^*_{\mathrm{BJ}}-T \wedge \tau)^2</span><span class="co">]</span> \leq \bbE<span class="co">[</span><span class="ot">(T^*-T \wedge \tau)^2</span><span class="co">]</span>.</span>
<span id="cb66-616"><a href="#cb66-616" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-617"><a href="#cb66-617" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-618"><a href="#cb66-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-619"><a href="#cb66-619" aria-hidden="true" tabindex="-1"></a>This result is stated in @LocalLinear_Fan94 but without a proof. We detail it in @sec-proof22 for completeness.</span>
<span id="cb66-620"><a href="#cb66-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-621"><a href="#cb66-621" aria-hidden="true" tabindex="-1"></a><span class="fu">### Augmented corrections {#sec-tdr}</span></span>
<span id="cb66-622"><a href="#cb66-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-623"><a href="#cb66-623" aria-hidden="true" tabindex="-1"></a>The main disadvantage of the two previous transformations is that they heavily rely on the specification of good estimator $\wh G$ (for IPCW) or $\wh S$ (for BJ). In order to circumvent this limitation, @DoublyR_transformation proposed the following transformations, whose expression is based on theory of semi-parametric estimation developed in @vanderLaan2003,    </span>
<span id="cb66-624"><a href="#cb66-624" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-625"><a href="#cb66-625" aria-hidden="true" tabindex="-1"></a>T^*_\mathrm{DR} = \frac{\Delta^\tau \wt T\wedge \tau}{G(\wt T \wedge \tau|X,A)} + \frac{(1-\Delta^\tau)Q_S(\wt T \wedge \tau |X,A)}{G(\wt T \wedge \tau |X,A)}- \int_0^{\wt T \wedge \tau} \frac{Q_S(t|X,A)}{G(t|X,A)^2} \diff \bbP_C(t|X,A),</span>
<span id="cb66-626"><a href="#cb66-626" aria-hidden="true" tabindex="-1"></a>$$ {#eq-TDR}</span>
<span id="cb66-627"><a href="#cb66-627" aria-hidden="true" tabindex="-1"></a>where $\diff \bbP_C(t|X,A)$ is the distribution of $C$ conditional on the covariates $X$ and $A$. We stress that this distribution is entirely determined by the $G(\cdot|X,A)$, so that this transformation only depends on the knowledge of both conditional survival functions $G$ and $S$, will be thus sometimes denoted $T^*_\mathrm{DR}(G,S)$ to underline this dependency. This transformation is not only a censoring unbiased transform in the sense of @eq-cut, but is also doubly robust in the following sense.</span>
<span id="cb66-628"><a href="#cb66-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-629"><a href="#cb66-629" aria-hidden="true" tabindex="-1"></a>:::{#prp-tdr}</span>
<span id="cb66-630"><a href="#cb66-630" aria-hidden="true" tabindex="-1"></a>We let $F,R$ be two conditional survival functions. Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-rta;-@eq-postrial;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, if $F$ also satisfies Assumption <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, and if $F(\cdot|X,A)$ is absolutely continuous wrt $G(\cdot|X,A)$, then the transformation $T^*_\mathrm{DR} = T^*_\mathrm{DR}(F,R)$ is a censoring unbiased transformation in the sense of @eq-cut whenever $F = G$ or $R=S$.</span>
<span id="cb66-631"><a href="#cb66-631" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-632"><a href="#cb66-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-633"><a href="#cb66-633" aria-hidden="true" tabindex="-1"></a>The statement and proof of this results is found in @DoublyR_transformation in the case where $C$ and $T$ are continuous. A careful examination of the proofs show that the proof translates straight away to our discrete setting.</span>
<span id="cb66-634"><a href="#cb66-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-635"><a href="#cb66-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-636"><a href="#cb66-636" aria-hidden="true" tabindex="-1"></a><span class="fu"># Causal survival analysis in observational studies {#sec-theoryOBS}</span></span>
<span id="cb66-637"><a href="#cb66-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-638"><a href="#cb66-638" aria-hidden="true" tabindex="-1"></a>Unlike RCT, observational data --- such as from registries, electronic health records, or national healthcare systems --- are collected without controlled randomized treatment allocation. In such cases, treated and control groups are likely unbalanced due to the non-randomized design, which results in the treatment effect being confounded by variables influencing both the survival outcome $T$ and the treatment allocation $A$. To enable identifiability of the causal</span>
<span id="cb66-639"><a href="#cb66-639" aria-hidden="true" tabindex="-1"></a>effect, additional standard assumptions are needed.</span>
<span id="cb66-640"><a href="#cb66-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-641"><a href="#cb66-641" aria-hidden="true" tabindex="-1"></a>::: {.assumption}</span>
<span id="cb66-642"><a href="#cb66-642" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Conditional exchangeability / Unconfoundedness) It holds</span>
<span id="cb66-643"><a href="#cb66-643" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-644"><a href="#cb66-644" aria-hidden="true" tabindex="-1"></a> A \perp\mkern-9.5mu\perp T(0),T(1) | X</span>
<span id="cb66-645"><a href="#cb66-645" aria-hidden="true" tabindex="-1"></a>$$ {#eq-unconf} </span>
<span id="cb66-646"><a href="#cb66-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-647"><a href="#cb66-647" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-648"><a href="#cb66-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-649"><a href="#cb66-649" aria-hidden="true" tabindex="-1"></a>Under @eq-unconf, the treatment assignment is randomly</span>
<span id="cb66-650"><a href="#cb66-650" aria-hidden="true" tabindex="-1"></a>assigned conditionally on the covariates $X$. This assumption ensures that there are no</span>
<span id="cb66-651"><a href="#cb66-651" aria-hidden="true" tabindex="-1"></a>unmeasured confounder as the latter would make it impossible to</span>
<span id="cb66-652"><a href="#cb66-652" aria-hidden="true" tabindex="-1"></a>distinguish correlation from causality.</span>
<span id="cb66-653"><a href="#cb66-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-654"><a href="#cb66-654" aria-hidden="true" tabindex="-1"></a>::: assumption</span>
<span id="cb66-655"><a href="#cb66-655" aria-hidden="true" tabindex="-1"></a>**Assumption.** (Positivity / Overlap for treatment) Letting $e(X) := \bbP(A=1|X)$ be the _propensity score_, there holds</span>
<span id="cb66-656"><a href="#cb66-656" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb66-657"><a href="#cb66-657" aria-hidden="true" tabindex="-1"></a>0 &lt; e(X) &lt;1 \quad \text{almost surely.}</span>
<span id="cb66-658"><a href="#cb66-658" aria-hidden="true" tabindex="-1"></a>$$ {#eq-positivitytreat}</span>
<span id="cb66-659"><a href="#cb66-659" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-660"><a href="#cb66-660" aria-hidden="true" tabindex="-1"></a>The @eq-positivitytreat assumption requires adequate overlap in</span>
<span id="cb66-661"><a href="#cb66-661" aria-hidden="true" tabindex="-1"></a>covariate distributions between treatment groups, meaning every</span>
<span id="cb66-662"><a href="#cb66-662" aria-hidden="true" tabindex="-1"></a>observation must have a non-zero probability of being treated. Because Assumption <span class="co">[</span><span class="ot">-@eq-rta</span><span class="co">]</span> does not hold anymore, neither does the previous idenfiability @eq-RMSTkm. In this new context, we can write</span>
<span id="cb66-663"><a href="#cb66-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-664"><a href="#cb66-664" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-665"><a href="#cb66-665" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-666"><a href="#cb66-666" aria-hidden="true" tabindex="-1"></a>    \theta_{\mathrm{RMST}} &amp;=  \mathbb{E}<span class="co">[</span><span class="ot">T(1) \wedge \tau - T(0) \wedge \tau</span><span class="co">]</span><span class="sc">\\</span></span>
<span id="cb66-667"><a href="#cb66-667" aria-hidden="true" tabindex="-1"></a>    &amp;= \mathbb{E}\left<span class="co">[</span><span class="ot">\bbE[T(1) \wedge \tau|X] - \bbE[T(0) \wedge \tau|X] \right</span><span class="co">]</span>  &amp;&amp;  <span class="sc">\\</span></span>
<span id="cb66-668"><a href="#cb66-668" aria-hidden="true" tabindex="-1"></a>    &amp;=\mathbb{E}\left<span class="co">[</span><span class="ot">\bbE[T(1) \wedge \tau|X, A=1] - \bbE[T(0) \wedge \tau|X, A=0]\right</span><span class="co">]</span>   &amp;&amp; \tiny\text{(unconfoundness)} <span class="sc">\\</span></span>
<span id="cb66-669"><a href="#cb66-669" aria-hidden="true" tabindex="-1"></a>       &amp;= \mathbb{E}\left<span class="co">[</span><span class="ot">\bbE[T \wedge \tau|X, A=1] - \bbE[T \wedge \tau|X, A=0]\right</span><span class="co">]</span>.  &amp;&amp; \tiny\text{(SUTVA)}</span>
<span id="cb66-670"><a href="#cb66-670" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-671"><a href="#cb66-671" aria-hidden="true" tabindex="-1"></a>$$ {#eq-identcond}</span>
<span id="cb66-672"><a href="#cb66-672" aria-hidden="true" tabindex="-1"></a>In another direction, one could wish to identify the treatment effect through the survival curve as in @eq-rmstsurv:</span>
<span id="cb66-673"><a href="#cb66-673" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-674"><a href="#cb66-674" aria-hidden="true" tabindex="-1"></a>S^{(a)}(t) = \bbP(T(a) &gt; t) = \bbE\left<span class="co">[</span><span class="ot">\bbP(T &gt; t | X, A=a)\right</span><span class="co">]</span>.</span>
<span id="cb66-675"><a href="#cb66-675" aria-hidden="true" tabindex="-1"></a>$$ {#eq-kmcond}</span>
<span id="cb66-676"><a href="#cb66-676" aria-hidden="true" tabindex="-1"></a>Again, both identities still depend on the unknown quantity $T$ and suggest two different estimation strategies. These strategies differ according to the censoring assumptions and are detailed below. </span>
<span id="cb66-677"><a href="#cb66-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-678"><a href="#cb66-678" aria-hidden="true" tabindex="-1"></a><span class="fu">## Independent censoring {#sec-obs_indcen}</span></span>
<span id="cb66-679"><a href="#cb66-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-680"><a href="#cb66-680" aria-hidden="true" tabindex="-1"></a>@fig-causalgraph_obs_ind illustrates a causal graph in observational survival data with independent censoring (Assumption <span class="co">[</span><span class="ot">-@eq-independantcensoring</span><span class="co">]</span>).</span>
<span id="cb66-681"><a href="#cb66-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-682"><a href="#cb66-682" aria-hidden="true" tabindex="-1"></a>![Causal graph in observational survival data</span>
<span id="cb66-683"><a href="#cb66-683" aria-hidden="true" tabindex="-1"></a>with independent censoring.](causal_survival_obs_indep.pdf){#fig-causalgraph_obs_ind</span>
<span id="cb66-684"><a href="#cb66-684" aria-hidden="true" tabindex="-1"></a>alt="Illustration of a causal graph in observational survival data with independent censoring."</span>
<span id="cb66-685"><a href="#cb66-685" aria-hidden="true" tabindex="-1"></a>fig-align="center" width="40%"}</span>
<span id="cb66-686"><a href="#cb66-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-687"><a href="#cb66-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-688"><a href="#cb66-688" aria-hidden="true" tabindex="-1"></a>Under Assumption <span class="co">[</span><span class="ot">-@eq-independantcensoring</span><span class="co">]</span>, we saw in @sec-theoryRCT_indc that the Kaplan-Meier estimator could conveniently handle censoring. Building on @eq-kmcond, we can write</span>
<span id="cb66-689"><a href="#cb66-689" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-690"><a href="#cb66-690" aria-hidden="true" tabindex="-1"></a>S^{(1)}(t) = \bbE\left<span class="co">[</span><span class="ot">\frac{\bbE[\mathbb{I}\{A=1,T &gt; t\}|X]}{\bbE[\mathbb{I}\{A=1\}|X]} \right</span><span class="co">]</span>=\bbE\left<span class="co">[</span><span class="ot">\frac{A\mathbb{I}\{T &gt; t\}}{e(X)} \right</span><span class="co">]</span>,</span>
<span id="cb66-691"><a href="#cb66-691" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-692"><a href="#cb66-692" aria-hidden="true" tabindex="-1"></a>which suggests to adapt the classical KM estimator by reweighting it by the propensity score. The use of propensity score in causal</span>
<span id="cb66-693"><a href="#cb66-693" aria-hidden="true" tabindex="-1"></a>inference has been initially introduced by @Propensity_causality and further developed in @hirano2003efficient. It was extended to</span>
<span id="cb66-694"><a href="#cb66-694" aria-hidden="true" tabindex="-1"></a>survival analysis by @IPTW through the adjusted Kaplan-Meier estimator as defined below. </span>
<span id="cb66-695"><a href="#cb66-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-696"><a href="#cb66-696" aria-hidden="true" tabindex="-1"></a>::: {#def-iptwkm}</span>
<span id="cb66-697"><a href="#cb66-697" aria-hidden="true" tabindex="-1"></a>(IPTW Kaplan-Meier estimator)</span>
<span id="cb66-698"><a href="#cb66-698" aria-hidden="true" tabindex="-1"></a>We let $\wh e(\cdot)$ be an estimator of the propensity score $e(\cdot)$. We introduce</span>
<span id="cb66-699"><a href="#cb66-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-700"><a href="#cb66-700" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-701"><a href="#cb66-701" aria-hidden="true" tabindex="-1"></a>D_k^{\mathrm{IPTW}}(a) &amp;:= \sum_{i=1}^n \left(\frac{a}{\wh e(X_i)}+\frac{1-a}{1- \wh e(X_i)}\right)\mathbb{I}(\wt T_i = t_k, \Delta_i = 1, A_i=a) <span class="sc">\\</span></span>
<span id="cb66-702"><a href="#cb66-702" aria-hidden="true" tabindex="-1"></a>\mand N^{\mathrm{IPTW}}_k(a) &amp;:= \sum_{i=1}^n \left(\frac{a}{\wh e(X_i)}+\frac{1-a}{1- \wh e(X_i)}\right) \mathbb{I}(\wt T_i \geq t_k, A_i=a),</span>
<span id="cb66-703"><a href="#cb66-703" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-704"><a href="#cb66-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-705"><a href="#cb66-705" aria-hidden="true" tabindex="-1"></a>be the numbers of deaths and of individual at risk at time $t_k$, reweighted by the propensity score. The Inverse-Probability-of-Treatment Weighting (IPTW) version of the KM estimator is then defined as: </span>
<span id="cb66-706"><a href="#cb66-706" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-707"><a href="#cb66-707" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-708"><a href="#cb66-708" aria-hidden="true" tabindex="-1"></a>\wh{S}_{\mathrm{IPTW}}(t | A=a) &amp;= \prod_{t_k \leq t}\left(1-\frac{D_k^{\mathrm{IPTW}}(a)}{N_k^{\mathrm{IPTW}}(a)}\right). </span>
<span id="cb66-709"><a href="#cb66-709" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-710"><a href="#cb66-710" aria-hidden="true" tabindex="-1"></a>$${#eq-IPTWKM}</span>
<span id="cb66-711"><a href="#cb66-711" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-712"><a href="#cb66-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-713"><a href="#cb66-713" aria-hidden="true" tabindex="-1"></a>We let $S^*_{\mathrm{IPTW}}(t | A=a)$ be the oracle KM-estimator defined as above with $\wh e(\cdot) = e(\cdot)$. Although the reweighting slightly changes the analysis, the good properties of the classical KM carry on to this setting. </span>
<span id="cb66-714"><a href="#cb66-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-715"><a href="#cb66-715" aria-hidden="true" tabindex="-1"></a>::: {#prp-iptwkm}</span>
<span id="cb66-716"><a href="#cb66-716" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-independantcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-poscen</span><span class="co">]</span> The oracle IPTW Kaplan-Meier estimator $S^*_{\mathrm{IPTW}}(t | A=a)$ is a strongly consistent and asymptotically normal estimator of $S^{(a)}(t)$.</span>
<span id="cb66-717"><a href="#cb66-717" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-718"><a href="#cb66-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-719"><a href="#cb66-719" aria-hidden="true" tabindex="-1"></a>The proof of this result simply relies again on the law of large number and the $\delta$-method and can be found in @sec-proof31. Because now $S^*_{\mathrm{IPTW}}$ is a continuous function of $e(\cdot)$, and because $e$ and $1-e$ are lower-bounded as per Assumptions <span class="co">[</span><span class="ot">-@eq-positivitytreat</span><span class="co">]</span>, we easily derive the following corollary. </span>
<span id="cb66-720"><a href="#cb66-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-721"><a href="#cb66-721" aria-hidden="true" tabindex="-1"></a>::: {#cor-iptwkm}</span>
<span id="cb66-722"><a href="#cb66-722" aria-hidden="true" tabindex="-1"></a>Under the same assumptions as @prp-iptwkm, if $\wh e(\cdot)$ satisfies $\|\wh e-e\|_{\infty} \to 0$ almost surely (resp. in probability), then the IPTW Kaplan-Meier estimator $\hat S_{\mathrm{IPTW}}(t | A=a)$ is a strongly (resp. weakly) consistent estimator of $S^{(a)}(t)$.</span>
<span id="cb66-723"><a href="#cb66-723" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-724"><a href="#cb66-724" aria-hidden="true" tabindex="-1"></a>The resulting RMST estimator simply takes the form:</span>
<span id="cb66-725"><a href="#cb66-725" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-726"><a href="#cb66-726" aria-hidden="true" tabindex="-1"></a>\wh{\theta}_{\mathrm{IPTW-KM}} = \int_{0}^{\tau}\wh{S}_{\mathrm{IPTW}}(t|A=1)-\wh{S}_{\mathrm{IPTW}}(t|A=0)dt.</span>
<span id="cb66-727"><a href="#cb66-727" aria-hidden="true" tabindex="-1"></a>$$ {#eq-RMST_IPTWKM}</span>
<span id="cb66-728"><a href="#cb66-728" aria-hidden="true" tabindex="-1"></a>which will be consistent under the same Assumptions as the previous Corollary. Note that, we are not aware of any formal results concerning the bias and the asymptotic variance of the oracle estimator $S^*_{\mathrm{IPTW}}(t | A=a)$, and we refer to @IPTW for heuristics concerning these questions. </span>
<span id="cb66-729"><a href="#cb66-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-730"><a href="#cb66-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-731"><a href="#cb66-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-732"><a href="#cb66-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-733"><a href="#cb66-733" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conditional independent censoring {#sec-obscondcens}</span></span>
<span id="cb66-734"><a href="#cb66-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-735"><a href="#cb66-735" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-unconf</span><span class="co">]</span> (uncounfoundedness) and <span class="co">[</span><span class="ot">-@eq-condindepcensoring</span><span class="co">]</span></span>
<span id="cb66-736"><a href="#cb66-736" aria-hidden="true" tabindex="-1"></a>(conditional independent censoring), the causal effect is affected both</span>
<span id="cb66-737"><a href="#cb66-737" aria-hidden="true" tabindex="-1"></a>by confounding variables and by conditional</span>
<span id="cb66-738"><a href="#cb66-738" aria-hidden="true" tabindex="-1"></a>censoring. The associated causal graph is depicted in  @fig-causalgraph_obs_dep. In this setting, one can still use the $G$-formula exactly as in @sec-Gformula. </span>
<span id="cb66-739"><a href="#cb66-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-740"><a href="#cb66-740" aria-hidden="true" tabindex="-1"></a>A natural alternative approach is to weight the IPCW and BJ transformations from @sec-unbiasedtransfo by the propensity score to disentangle both confounding effects and censoring  at the same time.</span>
<span id="cb66-741"><a href="#cb66-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-742"><a href="#cb66-742" aria-hidden="true" tabindex="-1"></a>![Causal graph in observational survival data</span>
<span id="cb66-743"><a href="#cb66-743" aria-hidden="true" tabindex="-1"></a>with dependent censoring.](causal_survival_obs_dep.pdf){#fig-causalgraph_obs_dep</span>
<span id="cb66-744"><a href="#cb66-744" aria-hidden="true" tabindex="-1"></a>alt="Illustration of a simple causal graph in observational survival data with independent censoring.](causal_survival_obs_dep.pdf)"</span>
<span id="cb66-745"><a href="#cb66-745" aria-hidden="true" tabindex="-1"></a>fig-align="center" width="40%"}</span>
<span id="cb66-746"><a href="#cb66-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-747"><a href="#cb66-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-748"><a href="#cb66-748" aria-hidden="true" tabindex="-1"></a>We mention that the G-formula approach developed in @sec-Gformula does work in that context. In particular, @RMST prove consistency and asymptotic normality results for Cox estimators in a observational study, and they give an explicit formulation of the asymptotic variance as a function of the parameters of the Cox model. In the non-parametric world, @Foster_2011 and @Soren_2019 empirically study this estimator using survival forests, with the former employing it as a T-learner (referred to as _Virtual Twins_) and the latter as an S-learner.</span>
<span id="cb66-749"><a href="#cb66-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-750"><a href="#cb66-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-751"><a href="#cb66-751" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPTW-IPCW transformations</span></span>
<span id="cb66-752"><a href="#cb66-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-753"><a href="#cb66-753" aria-hidden="true" tabindex="-1"></a>One can check that the IPCW transformation as introduced in @eq-defipcw is also a censoring unbiased transformation in that context.</span>
<span id="cb66-754"><a href="#cb66-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-755"><a href="#cb66-755" aria-hidden="true" tabindex="-1"></a>::: {#prp-iptwipcw}</span>
<span id="cb66-756"><a href="#cb66-756" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, the IPTW-IPCW transform <span class="co">[</span><span class="ot">-@eq-defipcw</span><span class="co">]</span> is a censoring unbiased transformation in the sense of @eq-cut.</span>
<span id="cb66-757"><a href="#cb66-757" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-758"><a href="#cb66-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-759"><a href="#cb66-759" aria-hidden="true" tabindex="-1"></a>The proof of @prp-iptwipcw can be found in @sec-proof32. Deriving an estimator of the difference in RMST is however slightly different in that context. In particular, @eq-cutcond rewrites</span>
<span id="cb66-760"><a href="#cb66-760" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-761"><a href="#cb66-761" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">\bbE[T^*|X,A=1]</span><span class="co">]</span> = \bbE\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} T^*\right</span><span class="co">]</span>,</span>
<span id="cb66-762"><a href="#cb66-762" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-763"><a href="#cb66-763" aria-hidden="true" tabindex="-1"></a>Which in turn suggests to define</span>
<span id="cb66-764"><a href="#cb66-764" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-765"><a href="#cb66-765" aria-hidden="true" tabindex="-1"></a>\wh \theta_{\mathrm{IPTW-IPCW}} = \frac1n\sum_{i=1}^n  \left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right) T^*_{\mathrm{IPCW},i}.</span>
<span id="cb66-766"><a href="#cb66-766" aria-hidden="true" tabindex="-1"></a>$$ {#eq-iptwipcw}</span>
<span id="cb66-767"><a href="#cb66-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-768"><a href="#cb66-768" aria-hidden="true" tabindex="-1"></a>This transformation now depends on two nuisance parameters, namely the conditional survival function of the censoring (through $T^*_{\mathrm{IPCW}}$) and the propensity score. Once estimators of these quantities are provided, one could look at the corresponding quantity computed with these estimators.</span>
<span id="cb66-769"><a href="#cb66-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-770"><a href="#cb66-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-771"><a href="#cb66-771" aria-hidden="true" tabindex="-1"></a>::: {#prp-consiptwipcw}</span>
<span id="cb66-772"><a href="#cb66-772" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, and if $\wh G(\cdot|X,A)$ and $\wh e (\cdot)$ are uniformly weakly (resp. strongly) consistent estimators, then estimator <span class="co">[</span><span class="ot">-@eq-iptwipcw</span><span class="co">]</span> defined with $\wh e$ and $\wh G$ is a weakly (resp. strongly) consistent estimator of the difference in RMST.</span>
<span id="cb66-773"><a href="#cb66-773" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-774"><a href="#cb66-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-775"><a href="#cb66-775" aria-hidden="true" tabindex="-1"></a>The proof of @prp-consiptwipcw can be found in @sec-proof32. We can also use the same strategy as for the IPCW transformation and incorporate the new weights into a Kaplan-Meier estimator.</span>
<span id="cb66-776"><a href="#cb66-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-777"><a href="#cb66-777" aria-hidden="true" tabindex="-1"></a>::: {#def-iptwipcwkm} </span>
<span id="cb66-778"><a href="#cb66-778" aria-hidden="true" tabindex="-1"></a>(IPTW-IPCW-Kaplan-Meier)</span>
<span id="cb66-779"><a href="#cb66-779" aria-hidden="true" tabindex="-1"></a>We let again $\wh G(\cdot|X,A)$ and $\wh e(\cdot)$ be estimators of the conditional censoring survival function and of the propensity score. We introduce</span>
<span id="cb66-780"><a href="#cb66-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-781"><a href="#cb66-781" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-782"><a href="#cb66-782" aria-hidden="true" tabindex="-1"></a>D_k^{\mathrm{IPTW-IPCW}}(a) &amp;:= \sum_{i=1}^n \left(\frac{A_i}{\wh e(X_i)}+\frac{1-A_i}{1-\wh e(X_i)} \right)\frac{\Delta_i^\tau}{\wh G(\wt T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\wt T_i = t_k, A_i=a) <span class="sc">\\</span></span>
<span id="cb66-783"><a href="#cb66-783" aria-hidden="true" tabindex="-1"></a>\mand N^{\mathrm{IPTW-IPCW}}_k(a) &amp;:= \sum_{i=1}^n \left(\frac{A_i}{\wh e(X_i)}+\frac{1-A_i}{1-\wh e(X_i)} \right)\frac{\Delta_i^\tau}{\wh G(\wt T_i \wedge\tau | X_i,A=a)} \mathbb{I}(\wt T_i \geq t_k, A_i=a),</span>
<span id="cb66-784"><a href="#cb66-784" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-785"><a href="#cb66-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-786"><a href="#cb66-786" aria-hidden="true" tabindex="-1"></a>be the weight-corrected numbers of deaths and of individual at risk at time $t_k$. The IPTW-IPCW version of the KM estimator is then defined as: </span>
<span id="cb66-787"><a href="#cb66-787" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-788"><a href="#cb66-788" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-789"><a href="#cb66-789" aria-hidden="true" tabindex="-1"></a>\wh{S}_{\mathrm{IPTW-IPCW}}(t | A=a) &amp;= \prod_{t_k \leq t}\left(1-\frac{D_k^{\mathrm{IPTW-IPCW}}(a)}{N_k^{\mathrm{IPTW-IPCW}}(a)}\right). </span>
<span id="cb66-790"><a href="#cb66-790" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-791"><a href="#cb66-791" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-792"><a href="#cb66-792" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-793"><a href="#cb66-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-794"><a href="#cb66-794" aria-hidden="true" tabindex="-1"></a>The difference in RMST estimated with IPTW-IPCW-Kaplan-Meier survival curves is then simply  as</span>
<span id="cb66-795"><a href="#cb66-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-796"><a href="#cb66-796" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-797"><a href="#cb66-797" aria-hidden="true" tabindex="-1"></a>\wh{\theta}_{\mathrm{IPTW-IPCW-KM}} = \int_{0}^{\tau}\wh{S}_{\mathrm{IPTW-IPCW}}(t|A=1)-\wh{S}_{\mathrm{IPTW-IPCW}}(t|A=0)dt.</span>
<span id="cb66-798"><a href="#cb66-798" aria-hidden="true" tabindex="-1"></a>$$ {#eq-RMST_IPTW_IPCWKM}</span>
<span id="cb66-799"><a href="#cb66-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-800"><a href="#cb66-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-801"><a href="#cb66-801" aria-hidden="true" tabindex="-1"></a>::: {#prp-iptwipcwkm}</span>
<span id="cb66-802"><a href="#cb66-802" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, and for all $t \in <span class="co">[</span><span class="ot">0,\tau</span><span class="co">]</span>$, if the oracle estimator $S^*_{\mathrm{IPTW-IPCW}}(t | A=a)$ defined as in @def-iptwipcwkm with $\wh G(\cdot|A,X) = G(\cdot|A,X)$ and $\wh e = e$ is a strongly consistent and asymptotically normal estimator of $S^{(a)}(t)$ .</span>
<span id="cb66-803"><a href="#cb66-803" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-804"><a href="#cb66-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-805"><a href="#cb66-805" aria-hidden="true" tabindex="-1"></a>The proof of @prp-iptwipcwkm can be found in @sec-proof32. Under consistency of the estimators of the nuisance parameters, the previous proposition implies that this reweighted Kaplan-Meier is a consistent estimator of the survival curve, which in turn implies consistency of $\wh{\theta}_{\mathrm{IPTW-IPCW-KM}}$.</span>
<span id="cb66-806"><a href="#cb66-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-807"><a href="#cb66-807" aria-hidden="true" tabindex="-1"></a>::: {#cor-consiptwipcwkm}</span>
<span id="cb66-808"><a href="#cb66-808" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, and for all $t \in <span class="co">[</span><span class="ot">0,\tau</span><span class="co">]</span>$, if the nuisance estimators $\wh G(\cdot|A,X)$ and $\wh e$ are weakly (resp. strongly) uniformly consistent, then $\wh{S}_{\mathrm{IPTW-IPCW}}(t | A=a)$ is a weakly (resp. strongly) consistent estimator of $S^{(a)}(t)$.</span>
<span id="cb66-809"><a href="#cb66-809" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-810"><a href="#cb66-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-811"><a href="#cb66-811" aria-hidden="true" tabindex="-1"></a>We are not aware of general formula for the asymptotic variances in this context. We mention nonetheless that @Schaubel2011 have been able to derive asymptotic laws in this framework in the particular case of Cox-models.</span>
<span id="cb66-812"><a href="#cb66-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-813"><a href="#cb66-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-814"><a href="#cb66-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-815"><a href="#cb66-815" aria-hidden="true" tabindex="-1"></a><span class="fu">### IPTW-BJ transformations</span></span>
<span id="cb66-816"><a href="#cb66-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-817"><a href="#cb66-817" aria-hidden="true" tabindex="-1"></a>Like IPCW tranformation, BJ transformation is again a censoring unbiased transformation in an observational context.</span>
<span id="cb66-818"><a href="#cb66-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-819"><a href="#cb66-819" aria-hidden="true" tabindex="-1"></a>::: {#prp-iptwbj}</span>
<span id="cb66-820"><a href="#cb66-820" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, the IPTW-BJ transform <span class="co">[</span><span class="ot">-@eq-defbj</span><span class="co">]</span> is a censoring unbiased transformation in the sense of @eq-cut.</span>
<span id="cb66-821"><a href="#cb66-821" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-822"><a href="#cb66-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-823"><a href="#cb66-823" aria-hidden="true" tabindex="-1"></a>The proof of @prp-iptwbj can be found in @sec-proof32. The corresponding estimator of the difference in RMST is</span>
<span id="cb66-824"><a href="#cb66-824" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-825"><a href="#cb66-825" aria-hidden="true" tabindex="-1"></a>\hat \theta_{\mathrm{IPTW-BJ}} = \frac1n\sum_{i=1}^n  \left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right) T^*_{\mathrm{BJ},i}.</span>
<span id="cb66-826"><a href="#cb66-826" aria-hidden="true" tabindex="-1"></a>$$ {#eq-iptwbj}</span>
<span id="cb66-827"><a href="#cb66-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-828"><a href="#cb66-828" aria-hidden="true" tabindex="-1"></a>This transformation depends on the conditional survival function $S$ (through $T^*_{\mathrm{BJ}}$) and the propensity score. Consistency of the nuisance parameter estimators implies again consistency of the RMST estimator.</span>
<span id="cb66-829"><a href="#cb66-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-830"><a href="#cb66-830" aria-hidden="true" tabindex="-1"></a>::: {#prp-consiptwbj}</span>
<span id="cb66-831"><a href="#cb66-831" aria-hidden="true" tabindex="-1"></a>Under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, and if $\wh S(\cdot|X,A)$ and $\wh e (\cdot)$ are uniformly weakly (resp. strongly) consistent estimators, then $\wh \theta_{\mathrm{IPTW-BJ}}$ defined with $\wh S$ and $\wh e$ is a weakly (resp. strongly) consistent estimator of the RMST.</span>
<span id="cb66-832"><a href="#cb66-832" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-833"><a href="#cb66-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-834"><a href="#cb66-834" aria-hidden="true" tabindex="-1"></a>The proof of @prp-consiptwbj can be found in @sec-proof32.</span>
<span id="cb66-835"><a href="#cb66-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-836"><a href="#cb66-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-837"><a href="#cb66-837" aria-hidden="true" tabindex="-1"></a><span class="fu">### Double augmented corrections {#sec-AIPTW_AIPCW}</span></span>
<span id="cb66-838"><a href="#cb66-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-839"><a href="#cb66-839" aria-hidden="true" tabindex="-1"></a>Building on the classical doubly-robust AIPTW estimator from causal inference <span class="co">[</span><span class="ot">@robins1994estimation</span><span class="co">]</span>, we could incorporate the doubly-robust transformations of @sec-tdr to obtain a _quadruply robust_ tranformation</span>
<span id="cb66-840"><a href="#cb66-840" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-841"><a href="#cb66-841" aria-hidden="true" tabindex="-1"></a>\Delta^*_{\mathrm{QR}} = \Delta^*_{\mathrm{QR}}(G,S,\mu,e)  := \left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)}\right)(T^*_{\mathrm{DR}}(G,S)-\mu(X,A))+\mu(X,1)-\mu(X,0),</span>
<span id="cb66-842"><a href="#cb66-842" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-843"><a href="#cb66-843" aria-hidden="true" tabindex="-1"></a>where we recall that $T^*_{\mathrm{DR}}$ is defined in @sec-tdr. This transformations depends on four nuisance parameters: $G$ and $S$ through $T^*_{\mathrm{DR}}$, and now the propensity score $e$ and the conditional response $\mu$. This transformation doesn't really fall into the scope of censoring unbiased transform, but it is easy to show that $\Delta^*_{\mathrm{QR}}$ is quadruply robust in the following sense.</span>
<span id="cb66-844"><a href="#cb66-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-845"><a href="#cb66-845" aria-hidden="true" tabindex="-1"></a>::: {#prp-tqr} </span>
<span id="cb66-846"><a href="#cb66-846" aria-hidden="true" tabindex="-1"></a>Let $F,R$ be two conditional survival function, $p$ be a propensity score, and $\nu$ be a conditional response. Then, under the same assumption on $F,R$ as in @prp-tdr, and under Assumptions <span class="co">[</span><span class="ot">-@eq-sutva;-@eq-unconf;-@eq-positivitytreat;-@eq-condindepcensoring</span><span class="co">]</span> and <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span>, the transformations $\Delta^*_{\mathrm{QR}} = \Delta^*_{\mathrm{QR}}(F,R,p,\nu)$ satisfies, fo $a \in {0,1}$,</span>
<span id="cb66-847"><a href="#cb66-847" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-848"><a href="#cb66-848" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot"> \Delta^*_\mathrm{QR} |X</span><span class="co">]</span> = \bbE<span class="co">[</span><span class="ot">T(1)\wedge \tau-T(0)\wedge \tau |X</span><span class="co">]</span>\quad\text{if}\quad  </span>
<span id="cb66-849"><a href="#cb66-849" aria-hidden="true" tabindex="-1"></a>\begin{cases} F = G \quad &amp;\text{or}\quad R=S \quad \text{and} <span class="sc">\\</span></span>
<span id="cb66-850"><a href="#cb66-850" aria-hidden="true" tabindex="-1"></a>p=e \quad &amp;\text{or}\quad \nu=\mu.</span>
<span id="cb66-851"><a href="#cb66-851" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb66-852"><a href="#cb66-852" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-853"><a href="#cb66-853" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-854"><a href="#cb66-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-855"><a href="#cb66-855" aria-hidden="true" tabindex="-1"></a>This result is similar to @Ozenne20_AIPTW_AIPCW, Thm 1, and its proof can be found in @sec-proof32. Based on estimators $(\wh G, \wh S, \wh \mu, \wh e)$ of $(G,S,\mu,e)$, one can then propose the following estimator of the RMST, coined the AIPTW-AIPCW estimator in @Ozenne20_AIPTW_AIPCW:</span>
<span id="cb66-856"><a href="#cb66-856" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-857"><a href="#cb66-857" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-858"><a href="#cb66-858" aria-hidden="true" tabindex="-1"></a>\wh \theta_{\mathrm{AIPTW-AIPCW}} &amp;:= \frac1n \sum_{i=1}^n \Delta_{\mathrm{QR},i}^*(\wh G, \wh S, \wh \mu, \wh e)</span>
<span id="cb66-859"><a href="#cb66-859" aria-hidden="true" tabindex="-1"></a><span class="sc">\\</span></span>
<span id="cb66-860"><a href="#cb66-860" aria-hidden="true" tabindex="-1"></a>&amp;=\frac1n \sum_{i=1}^n \left(\frac{A_i}{\wh e(X_i)}-\frac{1-A_i}{1-\wh e(X_i)}\right)(T^*_{\mathrm{DR}}(\wh G,\wh S)_i-\wh \mu(X_i,A_i)) + \wh \mu(X_i,1)-\wh\mu(X_i,0).</span>
<span id="cb66-861"><a href="#cb66-861" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-862"><a href="#cb66-862" aria-hidden="true" tabindex="-1"></a>$${#eq-AIPTW_AIPCW}</span>
<span id="cb66-863"><a href="#cb66-863" aria-hidden="true" tabindex="-1"></a>This estimator enjoys good asymptotic properties under parametric models, as detailed in @Ozenne20_AIPTW_AIPCW.</span>
<span id="cb66-864"><a href="#cb66-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-865"><a href="#cb66-865" aria-hidden="true" tabindex="-1"></a><span class="fu"># Implementation</span></span>
<span id="cb66-866"><a href="#cb66-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-867"><a href="#cb66-867" aria-hidden="true" tabindex="-1"></a>In this section, we first summarize the various estimators and their properties. We then provide custom implementations for all estimators, even those already available in existing packages. These manual implementations serve two purposes: first, to make the methods accessible to the community when no existing implementation is available; and second, to facilitate a deeper understanding of the methods by detailing each step, even when a package solution exists.  Finally, we present the packages available for directly computing $\theta_{\mathrm{RMST}}$. </span>
<span id="cb66-868"><a href="#cb66-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-869"><a href="#cb66-869" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of the estimators {#sec-summary}</span></span>
<span id="cb66-870"><a href="#cb66-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-871"><a href="#cb66-871" aria-hidden="true" tabindex="-1"></a>@tbl-nuisance provides an overview of the estimators introduced in this paper, along with the corresponding nuisance parameters needed for their estimation and an overview of their statistical properties in particular regarding their sensitivity to misspecification of the nuisance parameters.</span>
<span id="cb66-872"><a href="#cb66-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-873"><a href="#cb66-873" aria-hidden="true" tabindex="-1"></a>| Estimator | RCT | Obs | Ind Cens | Dep Cens | Outcome model | Censoring model | Treatment model | Robustness |</span>
<span id="cb66-874"><a href="#cb66-874" aria-hidden="true" tabindex="-1"></a>|--------|--|--|--|--|----|----|----|----|</span>
<span id="cb66-875"><a href="#cb66-875" aria-hidden="true" tabindex="-1"></a>| _Unadjusted KM_ | $\color{green}X$ | | $\color{green}X$ | |   |  |  |  |</span>
<span id="cb66-876"><a href="#cb66-876" aria-hidden="true" tabindex="-1"></a>| IPCW-KM | $\color{green}X$ | | $\color{green}X$ | $\color{green}X$ |  | $G$ |  |  |</span>
<span id="cb66-877"><a href="#cb66-877" aria-hidden="true" tabindex="-1"></a>| BJ | $\color{green}X$ | | $\color{green}X$ | $\color{green}X$ | $S$  |  |  |  |</span>
<span id="cb66-878"><a href="#cb66-878" aria-hidden="true" tabindex="-1"></a>| _IPTW-KM_ | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ |  |   |  | $e$  |  |</span>
<span id="cb66-879"><a href="#cb66-879" aria-hidden="true" tabindex="-1"></a>| IPCW-IPTW-KM | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ |   | $G$ | $e$  |  |</span>
<span id="cb66-880"><a href="#cb66-880" aria-hidden="true" tabindex="-1"></a>| IPTW-BJ | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ | $S$  | | $e$  |  |</span>
<span id="cb66-881"><a href="#cb66-881" aria-hidden="true" tabindex="-1"></a>| _G-formula_ | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ | $\mu$  | |  |  |</span>
<span id="cb66-882"><a href="#cb66-882" aria-hidden="true" tabindex="-1"></a>| AIPTW-AIPCW | $\color{green}X$ | $\color{green}X$ | $\color{green}X$ |${\color{green}X}$ | $S,\mu$  | $G$ | $e$  |  $\color{green}X$ (Prp <span class="co">[</span><span class="ot">-@prp-tqr</span><span class="co">]</span>) |</span>
<span id="cb66-883"><a href="#cb66-883" aria-hidden="true" tabindex="-1"></a>: Estimators of the difference in RMST and nuisance parameters needed to compute each estimator. Empty boxes indicate that the nuisance parameter is not needed in the estimator thus misspecification has no impact. Estimators in italic are those that are already implemented in available packages. {#tbl-nuisance}</span>
<span id="cb66-884"><a href="#cb66-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-885"><a href="#cb66-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-886"><a href="#cb66-886" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation of the estimators</span></span>
<span id="cb66-887"><a href="#cb66-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-888"><a href="#cb66-888" aria-hidden="true" tabindex="-1"></a>Across different implementations, we use the following shared functions provided in the $\texttt{utilitary.R}$ file.</span>
<span id="cb66-889"><a href="#cb66-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-890"><a href="#cb66-890" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{estimate<span class="sc">\_</span>propensity<span class="sc">\_</span>score}$: function to estimate propensity scores  $e(X)$ using either parametric (i.e. logistic regression with the argument $\texttt{type<span class="sc">\_</span>of<span class="sc">\_</span>model = "glm"}$) or non-parametric methods (i.e. probability forest with the argument $\texttt{type<span class="sc">\_</span>of<span class="sc">\_</span>model ="probability forest"}$ based on the $\texttt{probability<span class="sc">\_</span>forest}$ function from the <span class="co">[</span><span class="ot">grf  </span><span class="co">](https:%20//cran.r-project.org/web/packages/grf/index.html)</span> <span class="co">[</span><span class="ot">@Tibshirani_Athey_Sverdrup_Wager_2017</span><span class="co">]</span> package). This latter can include cross-fitting ($\texttt{n.folds<span class="sc">\&gt;</span>1}$). </span>
<span id="cb66-891"><a href="#cb66-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-892"><a href="#cb66-892" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{estimate<span class="sc">\_</span>survival<span class="sc">\_</span>function}$: function to estimate the conditional survival model, which supports either Cox models (argument $\texttt{type<span class="sc">\_</span>of<span class="sc">\_</span>model = "cox"}$) or survival forests  (argument $\texttt{type<span class="sc">\_</span>of<span class="sc">\_</span>model = "survival forest"}$)  which uses the function $\texttt{survival<span class="sc">\_</span>forest}$ from the <span class="co">[</span><span class="ot">grf    </span><span class="co">](https:%20//cran.r-project.org/web/packages/grf/index.html)</span> <span class="co">[</span><span class="ot">@Tibshirani_Athey_Sverdrup_Wager_2017</span><span class="co">]</span> package. This latter can include cross-fitting ($\texttt{n.folds<span class="sc">\&gt;</span>1}$). The estimation can be done with a single learner (argument $\texttt{learner = "S-learner"}$) or two learners (argument $\texttt{learner = "T-learner"}$). </span>
<span id="cb66-893"><a href="#cb66-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-894"><a href="#cb66-894" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{estimate<span class="sc">\_</span>hazard<span class="sc">\_</span>function}$: function to estimate the instantaneous hazard function by deriving the cumulative hazard function at each time point. This cumulative hazard function is estimated from the negative logarithm of the survival function. </span>
<span id="cb66-895"><a href="#cb66-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-896"><a href="#cb66-896" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{Q<span class="sc">\_</span>t<span class="sc">\_</span>hat}$: function to estimate the remaining survival function at all time points and for all individuals which uses the former $\texttt{estimate<span class="sc">\_</span>survival<span class="sc">\_</span>function}$. </span>
<span id="cb66-897"><a href="#cb66-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-898"><a href="#cb66-898" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{Q<span class="sc">\_</span>Y}$: function to select the value of the remaining survival function from $\texttt{Q<span class="sc">\_</span>t<span class="sc">\_</span>hat}$ at the specific time-to-event.</span>
<span id="cb66-899"><a href="#cb66-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-900"><a href="#cb66-900" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{integral<span class="sc">\_</span>rectangles}$: function to estimate the integral of a decreasing step function using the rectangle method.</span>
<span id="cb66-901"><a href="#cb66-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-902"><a href="#cb66-902" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{expected<span class="sc">\_</span>survival}$: function to estimate the integral with $x,y$ coordinate (estimated survival function) using the trapezoidal method.</span>
<span id="cb66-903"><a href="#cb66-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-904"><a href="#cb66-904" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\texttt{integrate}$: function to estimate the integral at specific time points $\texttt{Y.grid}$ of a given $\texttt{integrand}$ function which takes initially its values on $\texttt{times}$ using the trapezoidal method. </span>
<span id="cb66-905"><a href="#cb66-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-906"><a href="#cb66-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-907"><a href="#cb66-907" aria-hidden="true" tabindex="-1"></a>**Unadjusted Kaplan-Meier** </span>
<span id="cb66-908"><a href="#cb66-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-909"><a href="#cb66-909" aria-hidden="true" tabindex="-1"></a>Although Kaplan-Meier is implemented in the $\texttt{survival}$ package <span class="co">[</span><span class="ot">@Therneau_2001</span><span class="co">]</span>, we provide a custom implementation, $\texttt{Kaplan<span class="sc">\_</span>meier<span class="sc">\_</span>handmade}$, for completeness. The difference in Restricted Mean Survival Time, estimated using Kaplan-Meier as in @eq-thetaunadjKM can then be calculated with the $\texttt{RMST<span class="sc">\_</span>1}$ function. </span>
<span id="cb66-910"><a href="#cb66-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-911"><a href="#cb66-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-912"><a href="#cb66-912" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-913"><a href="#cb66-913" aria-hidden="true" tabindex="-1"></a><span class="in">source("utilitary.R")</span></span>
<span id="cb66-914"><a href="#cb66-914" aria-hidden="true" tabindex="-1"></a><span class="in"># Kaplan-Meier estimator handmade implementation</span></span>
<span id="cb66-915"><a href="#cb66-915" aria-hidden="true" tabindex="-1"></a><span class="in"># The database 'data' must be in the same form as that shown in </span></span>
<span id="cb66-916"><a href="#cb66-916" aria-hidden="true" tabindex="-1"></a><span class="in"># notation (Table 1) and with the same variable names (status, T_obs) </span></span>
<span id="cb66-917"><a href="#cb66-917" aria-hidden="true" tabindex="-1"></a><span class="in">Kaplan_meier_handmade &lt;- function(data, </span></span>
<span id="cb66-918"><a href="#cb66-918" aria-hidden="true" tabindex="-1"></a><span class="in">                                  status = data$status, </span></span>
<span id="cb66-919"><a href="#cb66-919" aria-hidden="true" tabindex="-1"></a><span class="in">                                  T_obs = data$T_obs) {</span></span>
<span id="cb66-920"><a href="#cb66-920" aria-hidden="true" tabindex="-1"></a><span class="in">  # Sort unique observed times</span></span>
<span id="cb66-921"><a href="#cb66-921" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(T_obs))</span></span>
<span id="cb66-922"><a href="#cb66-922" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-923"><a href="#cb66-923" aria-hidden="true" tabindex="-1"></a><span class="in">  # Initialize vectors for number of events, number at risk, and survival </span></span>
<span id="cb66-924"><a href="#cb66-924" aria-hidden="true" tabindex="-1"></a><span class="in">  # probability</span></span>
<span id="cb66-925"><a href="#cb66-925" aria-hidden="true" tabindex="-1"></a><span class="in">  d &lt;- rep(NA, length(Y.grid))  # Number of events at time Y.grid[i]</span></span>
<span id="cb66-926"><a href="#cb66-926" aria-hidden="true" tabindex="-1"></a><span class="in">  n &lt;- rep(NA, length(Y.grid))  # Number at risk just before time Y.grid[i]</span></span>
<span id="cb66-927"><a href="#cb66-927" aria-hidden="true" tabindex="-1"></a><span class="in">  S &lt;- rep(NA, length(Y.grid))  # Survival probability at time Y.grid[i]</span></span>
<span id="cb66-928"><a href="#cb66-928" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-929"><a href="#cb66-929" aria-hidden="true" tabindex="-1"></a><span class="in">  # Loop over each unique observed time</span></span>
<span id="cb66-930"><a href="#cb66-930" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 1:length(Y.grid)) {</span></span>
<span id="cb66-931"><a href="#cb66-931" aria-hidden="true" tabindex="-1"></a><span class="in">    d[i] &lt;- sum(T_obs == Y.grid[i] &amp; status == 1, na.rm = TRUE)  # Count events</span></span>
<span id="cb66-932"><a href="#cb66-932" aria-hidden="true" tabindex="-1"></a><span class="in">    n[i] &lt;- sum(T_obs &gt;= Y.grid[i])  # Count at risk</span></span>
<span id="cb66-933"><a href="#cb66-933" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-934"><a href="#cb66-934" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calculate survival probability</span></span>
<span id="cb66-935"><a href="#cb66-935" aria-hidden="true" tabindex="-1"></a><span class="in">    S[i] &lt;- cumprod(1 - d / n)[i]</span></span>
<span id="cb66-936"><a href="#cb66-936" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-937"><a href="#cb66-937" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-938"><a href="#cb66-938" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create a dataframe with the results</span></span>
<span id="cb66-939"><a href="#cb66-939" aria-hidden="true" tabindex="-1"></a><span class="in">  df &lt;- data.frame(d = d, n = n, S = S, T = Y.grid)</span></span>
<span id="cb66-940"><a href="#cb66-940" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-941"><a href="#cb66-941" aria-hidden="true" tabindex="-1"></a><span class="in">  return(df)</span></span>
<span id="cb66-942"><a href="#cb66-942" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-943"><a href="#cb66-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-944"><a href="#cb66-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-945"><a href="#cb66-945" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to calculate RMST (Restricted Mean Survival Time):</span></span>
<span id="cb66-946"><a href="#cb66-946" aria-hidden="true" tabindex="-1"></a><span class="in"># Two possibilities for computing RMST: </span></span>
<span id="cb66-947"><a href="#cb66-947" aria-hidden="true" tabindex="-1"></a><span class="in"># - in using directly S_A1 and S_A0 (survival function of treated and control)</span></span>
<span id="cb66-948"><a href="#cb66-948" aria-hidden="true" tabindex="-1"></a><span class="in"># - in using the dataframe and the function computes the survival functions</span></span>
<span id="cb66-949"><a href="#cb66-949" aria-hidden="true" tabindex="-1"></a><span class="in">RMST_1 &lt;- function(data = NULL, A1 = 1, A0 = 0, tau, S_A1 = NULL, S_A0 = NULL) {</span></span>
<span id="cb66-950"><a href="#cb66-950" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(S_A1) &amp; is.null(S_A0)) {</span></span>
<span id="cb66-951"><a href="#cb66-951" aria-hidden="true" tabindex="-1"></a><span class="in">    # Subset data for treatment groups</span></span>
<span id="cb66-952"><a href="#cb66-952" aria-hidden="true" tabindex="-1"></a><span class="in">    data1 &lt;- data[data$A == A1,]</span></span>
<span id="cb66-953"><a href="#cb66-953" aria-hidden="true" tabindex="-1"></a><span class="in">    data0 &lt;- data[data$A == A0,]</span></span>
<span id="cb66-954"><a href="#cb66-954" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-955"><a href="#cb66-955" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calculate Kaplan-Meier survival estimates</span></span>
<span id="cb66-956"><a href="#cb66-956" aria-hidden="true" tabindex="-1"></a><span class="in">    S_A1 &lt;- Kaplan_meier_handmade(data1, status = data1$status, </span></span>
<span id="cb66-957"><a href="#cb66-957" aria-hidden="true" tabindex="-1"></a><span class="in">                                  T_obs = data1$T_obs)</span></span>
<span id="cb66-958"><a href="#cb66-958" aria-hidden="true" tabindex="-1"></a><span class="in">    S_A0 &lt;- Kaplan_meier_handmade(data0, status = data0$status, </span></span>
<span id="cb66-959"><a href="#cb66-959" aria-hidden="true" tabindex="-1"></a><span class="in">                                  T_obs = data0$T_obs)</span></span>
<span id="cb66-960"><a href="#cb66-960" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-961"><a href="#cb66-961" aria-hidden="true" tabindex="-1"></a><span class="in">    # Restrict observations to those less than or equal to tau</span></span>
<span id="cb66-962"><a href="#cb66-962" aria-hidden="true" tabindex="-1"></a><span class="in">    Y.grid1 &lt;- data1$T_obs[data1$T_obs &lt;= tau]</span></span>
<span id="cb66-963"><a href="#cb66-963" aria-hidden="true" tabindex="-1"></a><span class="in">    Y.grid0 &lt;- data0$T_obs[data0$T_obs &lt;= tau]</span></span>
<span id="cb66-964"><a href="#cb66-964" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb66-965"><a href="#cb66-965" aria-hidden="true" tabindex="-1"></a><span class="in">    # Restrict observations to those less than or equal to tau</span></span>
<span id="cb66-966"><a href="#cb66-966" aria-hidden="true" tabindex="-1"></a><span class="in">    Y.grid1 &lt;- S_A1$T[S_A1$T &lt;= tau]</span></span>
<span id="cb66-967"><a href="#cb66-967" aria-hidden="true" tabindex="-1"></a><span class="in">    Y.grid0 &lt;- S_A0$T[S_A0$T &lt;= tau]</span></span>
<span id="cb66-968"><a href="#cb66-968" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-969"><a href="#cb66-969" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-970"><a href="#cb66-970" aria-hidden="true" tabindex="-1"></a><span class="in">  # Filter survival estimates to restricted observations</span></span>
<span id="cb66-971"><a href="#cb66-971" aria-hidden="true" tabindex="-1"></a><span class="in">  S_A1 &lt;- S_A1 %&gt;%</span></span>
<span id="cb66-972"><a href="#cb66-972" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::filter(T %in% Y.grid1)</span></span>
<span id="cb66-973"><a href="#cb66-973" aria-hidden="true" tabindex="-1"></a><span class="in">  S_A0 &lt;- S_A0 %&gt;%</span></span>
<span id="cb66-974"><a href="#cb66-974" aria-hidden="true" tabindex="-1"></a><span class="in">    dplyr::filter(T %in% Y.grid0)</span></span>
<span id="cb66-975"><a href="#cb66-975" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-976"><a href="#cb66-976" aria-hidden="true" tabindex="-1"></a><span class="in">  # Check if there is any event at tau for S_A1</span></span>
<span id="cb66-977"><a href="#cb66-977" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!any(S_A1$T == tau)) {</span></span>
<span id="cb66-978"><a href="#cb66-978" aria-hidden="true" tabindex="-1"></a><span class="in">    new_row &lt;- tibble(T = tau, S = S_A1$S[nrow(S_A1)])</span></span>
<span id="cb66-979"><a href="#cb66-979" aria-hidden="true" tabindex="-1"></a><span class="in">    S_A1 &lt;- dplyr::bind_rows(S_A1, new_row)</span></span>
<span id="cb66-980"><a href="#cb66-980" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-981"><a href="#cb66-981" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-982"><a href="#cb66-982" aria-hidden="true" tabindex="-1"></a><span class="in">  # Check if there is any event at tau for S_A0</span></span>
<span id="cb66-983"><a href="#cb66-983" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!any(S_A0$T == tau)) {</span></span>
<span id="cb66-984"><a href="#cb66-984" aria-hidden="true" tabindex="-1"></a><span class="in">    new_row &lt;- tibble(T = tau, S = S_A0$S[nrow(S_A0)])</span></span>
<span id="cb66-985"><a href="#cb66-985" aria-hidden="true" tabindex="-1"></a><span class="in">    S_A0 &lt;- dplyr::bind_rows(S_A0, new_row)</span></span>
<span id="cb66-986"><a href="#cb66-986" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-987"><a href="#cb66-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-988"><a href="#cb66-988" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate integrals from 0 to tau of survival probabilities</span></span>
<span id="cb66-989"><a href="#cb66-989" aria-hidden="true" tabindex="-1"></a><span class="in">  intA1 &lt;- integral_rectangles(S_A1$T, S_A1$S)</span></span>
<span id="cb66-990"><a href="#cb66-990" aria-hidden="true" tabindex="-1"></a><span class="in">  intA0 &lt;- integral_rectangles(S_A0$T, S_A0$S)</span></span>
<span id="cb66-991"><a href="#cb66-991" aria-hidden="true" tabindex="-1"></a><span class="in">  RMST1 &lt;- intA1 - intA0</span></span>
<span id="cb66-992"><a href="#cb66-992" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-993"><a href="#cb66-993" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list(RMST=RMST1, intA1=intA1,intA0=intA0))</span></span>
<span id="cb66-994"><a href="#cb66-994" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-995"><a href="#cb66-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-996"><a href="#cb66-996" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-997"><a href="#cb66-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-998"><a href="#cb66-998" aria-hidden="true" tabindex="-1"></a>As an alternative, one can also use the $\texttt{survfit}$ function in the survival package <span class="co">[</span><span class="ot">@Therneau_2001</span><span class="co">]</span> for Kaplan-Meier and specify the $\texttt{rmean}$ argument equal to $\tau$ in the corresponding summary function:</span>
<span id="cb66-999"><a href="#cb66-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1000"><a href="#cb66-1000" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1001"><a href="#cb66-1001" aria-hidden="true" tabindex="-1"></a><span class="in"># Alternative code to estimate Kaplan-Meier estimator with survival package</span></span>
<span id="cb66-1002"><a href="#cb66-1002" aria-hidden="true" tabindex="-1"></a><span class="in"># instead of handmade KM</span></span>
<span id="cb66-1003"><a href="#cb66-1003" aria-hidden="true" tabindex="-1"></a><span class="in">RMST_alternative &lt;- function(data, A1 = 1, A0 = 0, tau){</span></span>
<span id="cb66-1004"><a href="#cb66-1004" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate Kaplan-Meier estimator with survfit function on data subset</span></span>
<span id="cb66-1005"><a href="#cb66-1005" aria-hidden="true" tabindex="-1"></a><span class="in">   # Groupe A = 0</span></span>
<span id="cb66-1006"><a href="#cb66-1006" aria-hidden="true" tabindex="-1"></a><span class="in">  fit0 &lt;- survfit(Surv(T_obs, status) ~ 1, data = data[data$A == A0,]) </span></span>
<span id="cb66-1007"><a href="#cb66-1007" aria-hidden="true" tabindex="-1"></a><span class="in">  # Groupe A = 1</span></span>
<span id="cb66-1008"><a href="#cb66-1008" aria-hidden="true" tabindex="-1"></a><span class="in">  fit1 &lt;- survfit(Surv(T_obs, status) ~ 1, data = data[data$A == A1,])  </span></span>
<span id="cb66-1009"><a href="#cb66-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1010"><a href="#cb66-1010" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate the RMST with rmean</span></span>
<span id="cb66-1011"><a href="#cb66-1011" aria-hidden="true" tabindex="-1"></a><span class="in">  summary_fit0 &lt;- summary(fit0, rmean = tau)  # RMST for A = 0</span></span>
<span id="cb66-1012"><a href="#cb66-1012" aria-hidden="true" tabindex="-1"></a><span class="in">  summary_fit1 &lt;- summary(fit1, rmean = tau)  # RMST for A = 1</span></span>
<span id="cb66-1013"><a href="#cb66-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1014"><a href="#cb66-1014" aria-hidden="true" tabindex="-1"></a><span class="in">  # Extract the RMST from the summary objects</span></span>
<span id="cb66-1015"><a href="#cb66-1015" aria-hidden="true" tabindex="-1"></a><span class="in">  rmst0 &lt;- summary_fit0$table["rmean"][[1]]</span></span>
<span id="cb66-1016"><a href="#cb66-1016" aria-hidden="true" tabindex="-1"></a><span class="in">  rmst1 &lt;- summary_fit1$table["rmean"][[1]]</span></span>
<span id="cb66-1017"><a href="#cb66-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1018"><a href="#cb66-1018" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute the difference of RMST between the two groups</span></span>
<span id="cb66-1019"><a href="#cb66-1019" aria-hidden="true" tabindex="-1"></a><span class="in">  difference_rmst &lt;- rmst1 - rmst0</span></span>
<span id="cb66-1020"><a href="#cb66-1020" aria-hidden="true" tabindex="-1"></a><span class="in">return(difference_rmst)</span></span>
<span id="cb66-1021"><a href="#cb66-1021" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1022"><a href="#cb66-1022" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1023"><a href="#cb66-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1024"><a href="#cb66-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1025"><a href="#cb66-1025" aria-hidden="true" tabindex="-1"></a>**IPCW Kaplan-Meier**</span>
<span id="cb66-1026"><a href="#cb66-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1027"><a href="#cb66-1027" aria-hidden="true" tabindex="-1"></a>We first provide an  $\texttt{adjusted.KM}$ function which is then used in the $\texttt{IPCW<span class="sc">\_</span>Kaplan<span class="sc">\_</span>meier}$ function to estimate the difference in RMST $\hat{\theta}_{\mathrm{IPCW}}$ as in @eq-thetaIPCWKM. The survival censoring function $G(t|X)$ is computed with the $\texttt{estimate<span class="sc">\_</span>survival<span class="sc">\_</span>function}$ utility function from the $\texttt{utilitary.R}$ file.</span>
<span id="cb66-1028"><a href="#cb66-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1029"><a href="#cb66-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1030"><a href="#cb66-1030" aria-hidden="true" tabindex="-1"></a><span class="in"># Kaplan-Meier adjusted</span></span>
<span id="cb66-1031"><a href="#cb66-1031" aria-hidden="true" tabindex="-1"></a><span class="in"># Times of event </span></span>
<span id="cb66-1032"><a href="#cb66-1032" aria-hidden="true" tabindex="-1"></a><span class="in"># Failures:  1 if event, 0 if censored</span></span>
<span id="cb66-1033"><a href="#cb66-1033" aria-hidden="true" tabindex="-1"></a><span class="in"># Variable:  1 if treated, 0 if control</span></span>
<span id="cb66-1034"><a href="#cb66-1034" aria-hidden="true" tabindex="-1"></a><span class="in"># Weights:  Weight of the individual</span></span>
<span id="cb66-1035"><a href="#cb66-1035" aria-hidden="true" tabindex="-1"></a><span class="in">adjusted.KM &lt;- function(times, failures, variable, weights = NULL) {</span></span>
<span id="cb66-1036"><a href="#cb66-1036" aria-hidden="true" tabindex="-1"></a><span class="in">  # Sanity checks</span></span>
<span id="cb66-1037"><a href="#cb66-1037" aria-hidden="true" tabindex="-1"></a><span class="in">  if (sum(times &lt; 0) &gt; 0) {</span></span>
<span id="cb66-1038"><a href="#cb66-1038" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("Error: times must be positive")</span></span>
<span id="cb66-1039"><a href="#cb66-1039" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-1040"><a href="#cb66-1040" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!is.null(weights) &amp;&amp; sum(weights &lt; 0, na.rm = TRUE) &gt; 0) {</span></span>
<span id="cb66-1041"><a href="#cb66-1041" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("Error: weights must be superior to 0")</span></span>
<span id="cb66-1042"><a href="#cb66-1042" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-1043"><a href="#cb66-1043" aria-hidden="true" tabindex="-1"></a><span class="in">  if (sum(failures != 0 &amp; failures != 1) &gt; 0) {</span></span>
<span id="cb66-1044"><a href="#cb66-1044" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("Error: failures must be a vector of 0 or 1")</span></span>
<span id="cb66-1045"><a href="#cb66-1045" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-1046"><a href="#cb66-1046" aria-hidden="true" tabindex="-1"></a><span class="in">  # If 'weights' is NULL, initialize 'w' with ones of the same length as 'times', </span></span>
<span id="cb66-1047"><a href="#cb66-1047" aria-hidden="true" tabindex="-1"></a><span class="in">  # otherwise use 'weights'</span></span>
<span id="cb66-1048"><a href="#cb66-1048" aria-hidden="true" tabindex="-1"></a><span class="in">  w &lt;- if (is.null(weights)) rep(1, length(times)) else weights</span></span>
<span id="cb66-1049"><a href="#cb66-1049" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1050"><a href="#cb66-1050" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create a DataFrame 'data' with columns t (times), f (failures), </span></span>
<span id="cb66-1051"><a href="#cb66-1051" aria-hidden="true" tabindex="-1"></a><span class="in">  # v (stratification variable: often treatment variable), and w (weights)</span></span>
<span id="cb66-1052"><a href="#cb66-1052" aria-hidden="true" tabindex="-1"></a><span class="in">  data &lt;- data.frame(t = times, f = failures, v = variable, w = w)</span></span>
<span id="cb66-1053"><a href="#cb66-1053" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1054"><a href="#cb66-1054" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove rows from the DataFrame where the stratification variable is NA</span></span>
<span id="cb66-1055"><a href="#cb66-1055" aria-hidden="true" tabindex="-1"></a><span class="in">  data &lt;- data[!is.na(data$v),]</span></span>
<span id="cb66-1056"><a href="#cb66-1056" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1057"><a href="#cb66-1057" aria-hidden="true" tabindex="-1"></a><span class="in">  # Initialize an empty DataFrame to store the Kaplan-Meier results</span></span>
<span id="cb66-1058"><a href="#cb66-1058" aria-hidden="true" tabindex="-1"></a><span class="in">  table_KM &lt;- data.frame(times = NULL, n.risk = NULL, n.event = NULL, </span></span>
<span id="cb66-1059"><a href="#cb66-1059" aria-hidden="true" tabindex="-1"></a><span class="in">                         survival = NULL, variable = NULL)</span></span>
<span id="cb66-1060"><a href="#cb66-1060" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1061"><a href="#cb66-1061" aria-hidden="true" tabindex="-1"></a><span class="in">  # Loop over each unique value of the stratification variable</span></span>
<span id="cb66-1062"><a href="#cb66-1062" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in unique(variable)) {</span></span>
<span id="cb66-1063"><a href="#cb66-1063" aria-hidden="true" tabindex="-1"></a><span class="in">    # Subset the data for the current stratification variable value</span></span>
<span id="cb66-1064"><a href="#cb66-1064" aria-hidden="true" tabindex="-1"></a><span class="in">    d &lt;- data[data$v == i,]</span></span>
<span id="cb66-1065"><a href="#cb66-1065" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-1066"><a href="#cb66-1066" aria-hidden="true" tabindex="-1"></a><span class="in">    # Create a sorted vector of unique event times, including time 0 and the </span></span>
<span id="cb66-1067"><a href="#cb66-1067" aria-hidden="true" tabindex="-1"></a><span class="in">    # maximum time</span></span>
<span id="cb66-1068"><a href="#cb66-1068" aria-hidden="true" tabindex="-1"></a><span class="in">    tj &lt;- c(0, sort(unique(d$t[d$f == 1])), max(d$t))</span></span>
<span id="cb66-1069"><a href="#cb66-1069" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-1070"><a href="#cb66-1070" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calculate the number of events at each time point</span></span>
<span id="cb66-1071"><a href="#cb66-1071" aria-hidden="true" tabindex="-1"></a><span class="in">    dj &lt;- sapply(tj, function(x) {</span></span>
<span id="cb66-1072"><a href="#cb66-1072" aria-hidden="true" tabindex="-1"></a><span class="in">      sum(d$w[d$t == x &amp; d$f == 1])</span></span>
<span id="cb66-1073"><a href="#cb66-1073" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb66-1074"><a href="#cb66-1074" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-1075"><a href="#cb66-1075" aria-hidden="true" tabindex="-1"></a><span class="in">    # Calculate the number of individuals at risk at each time point</span></span>
<span id="cb66-1076"><a href="#cb66-1076" aria-hidden="true" tabindex="-1"></a><span class="in">    nj &lt;- sapply(tj, function(x) {</span></span>
<span id="cb66-1077"><a href="#cb66-1077" aria-hidden="true" tabindex="-1"></a><span class="in">      sum(d$w[d$t &gt;= x])</span></span>
<span id="cb66-1078"><a href="#cb66-1078" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb66-1079"><a href="#cb66-1079" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-1080"><a href="#cb66-1080" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute the cumulative product for the survival probabilities</span></span>
<span id="cb66-1081"><a href="#cb66-1081" aria-hidden="true" tabindex="-1"></a><span class="in">    st &lt;- cumprod((nj - dj) / nj)</span></span>
<span id="cb66-1082"><a href="#cb66-1082" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-1083"><a href="#cb66-1083" aria-hidden="true" tabindex="-1"></a><span class="in">    # Append the results to the Kaplan-Meier table</span></span>
<span id="cb66-1084"><a href="#cb66-1084" aria-hidden="true" tabindex="-1"></a><span class="in">    table_KM &lt;- rbind(table_KM, data.frame(T = tj, n = nj, d = dj, </span></span>
<span id="cb66-1085"><a href="#cb66-1085" aria-hidden="true" tabindex="-1"></a><span class="in">                                           S = st, variable = i))</span></span>
<span id="cb66-1086"><a href="#cb66-1086" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-1087"><a href="#cb66-1087" aria-hidden="true" tabindex="-1"></a><span class="in">  return(table_KM)</span></span>
<span id="cb66-1088"><a href="#cb66-1088" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1089"><a href="#cb66-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1090"><a href="#cb66-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1091"><a href="#cb66-1091" aria-hidden="true" tabindex="-1"></a><span class="in"># IPCW Kaplan-Meier estimator with restricted tau</span></span>
<span id="cb66-1092"><a href="#cb66-1092" aria-hidden="true" tabindex="-1"></a><span class="in">IPCW_Kaplan_meier &lt;- function(data, tau, </span></span>
<span id="cb66-1093"><a href="#cb66-1093" aria-hidden="true" tabindex="-1"></a><span class="in">                              X.names.censoring, </span></span>
<span id="cb66-1094"><a href="#cb66-1094" aria-hidden="true" tabindex="-1"></a><span class="in">                              nuisance_censoring = "cox", </span></span>
<span id="cb66-1095"><a href="#cb66-1095" aria-hidden="true" tabindex="-1"></a><span class="in">                              n.folds = NULL) {</span></span>
<span id="cb66-1096"><a href="#cb66-1096" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1097"><a href="#cb66-1097" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute of truncated T_obs, status and censored status</span></span>
<span id="cb66-1098"><a href="#cb66-1098" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- ifelse(data$T_obs &gt;= tau, tau, data$T_obs)</span></span>
<span id="cb66-1099"><a href="#cb66-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  data$censor.status_tau &lt;- 1 - as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1100"><a href="#cb66-1100" aria-hidden="true" tabindex="-1"></a><span class="in">                                             (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1101"><a href="#cb66-1101" aria-hidden="true" tabindex="-1"></a><span class="in">  data$status_tau &lt;- as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1102"><a href="#cb66-1102" aria-hidden="true" tabindex="-1"></a><span class="in">                                  (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1103"><a href="#cb66-1103" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1104"><a href="#cb66-1104" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1105"><a href="#cb66-1105" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate probability of remaining uncensored based on nuisance model </span></span>
<span id="cb66-1106"><a href="#cb66-1106" aria-hidden="true" tabindex="-1"></a><span class="in">  S_C_hat &lt;- estimate_survival_function(data = data, X.names = X.names.censoring,</span></span>
<span id="cb66-1107"><a href="#cb66-1107" aria-hidden="true" tabindex="-1"></a><span class="in">                                        Y.grid = Y.grid, T_obs = "T_obs_tau",</span></span>
<span id="cb66-1108"><a href="#cb66-1108" aria-hidden="true" tabindex="-1"></a><span class="in">                                        status = "censor.status_tau",</span></span>
<span id="cb66-1109"><a href="#cb66-1109" aria-hidden="true" tabindex="-1"></a><span class="in">                                        type_of_model = nuisance_censoring,</span></span>
<span id="cb66-1110"><a href="#cb66-1110" aria-hidden="true" tabindex="-1"></a><span class="in">                                        n.folds = n.folds)</span></span>
<span id="cb66-1111"><a href="#cb66-1111" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1112"><a href="#cb66-1112" aria-hidden="true" tabindex="-1"></a><span class="in">  # Select the probability of censoring for each observed T_obs_tau from the </span></span>
<span id="cb66-1113"><a href="#cb66-1113" aria-hidden="true" tabindex="-1"></a><span class="in">  # curve</span></span>
<span id="cb66-1114"><a href="#cb66-1114" aria-hidden="true" tabindex="-1"></a><span class="in">  data$S_C &lt;- S_C_hat$S_hat[cbind(1:nrow(data), match(data$T_obs_tau, Y.grid))]</span></span>
<span id="cb66-1115"><a href="#cb66-1115" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1116"><a href="#cb66-1116" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute IPC weights</span></span>
<span id="cb66-1117"><a href="#cb66-1117" aria-hidden="true" tabindex="-1"></a><span class="in">  data$weights &lt;- data$status_tau / data$S_C</span></span>
<span id="cb66-1118"><a href="#cb66-1118" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1119"><a href="#cb66-1119" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute the adjusted IPCW Kaplan-Meier</span></span>
<span id="cb66-1120"><a href="#cb66-1120" aria-hidden="true" tabindex="-1"></a><span class="in">  S &lt;- adjusted.KM(times = data$T_obs, failures = data$status, </span></span>
<span id="cb66-1121"><a href="#cb66-1121" aria-hidden="true" tabindex="-1"></a><span class="in">                   variable = data$A, weights = data$weights)</span></span>
<span id="cb66-1122"><a href="#cb66-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1123"><a href="#cb66-1123" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute differenceof RMST between the two groups</span></span>
<span id="cb66-1124"><a href="#cb66-1124" aria-hidden="true" tabindex="-1"></a><span class="in">  RMST &lt;- RMST_1(S_A1 = S[S$variable == 1,], S_A0 = S[S$variable == 0,], tau = tau)</span></span>
<span id="cb66-1125"><a href="#cb66-1125" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1126"><a href="#cb66-1126" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list(RMST = RMST$RMST,</span></span>
<span id="cb66-1127"><a href="#cb66-1127" aria-hidden="true" tabindex="-1"></a><span class="in">              intA1 = RMST$intA1,</span></span>
<span id="cb66-1128"><a href="#cb66-1128" aria-hidden="true" tabindex="-1"></a><span class="in">              intA0 = RMST$intA0,</span></span>
<span id="cb66-1129"><a href="#cb66-1129" aria-hidden="true" tabindex="-1"></a><span class="in">              weights = data$weights))</span></span>
<span id="cb66-1130"><a href="#cb66-1130" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1131"><a href="#cb66-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1132"><a href="#cb66-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1133"><a href="#cb66-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1134"><a href="#cb66-1134" aria-hidden="true" tabindex="-1"></a>One could also use the $\texttt{survfit}$ function in the survival package <span class="co">[</span><span class="ot">@Therneau_2001</span><span class="co">]</span> in adding IPCW weights for treated and control group and specify the $\texttt{rmean}$ argument equal to $\tau$ in the corresponding summary function:</span>
<span id="cb66-1135"><a href="#cb66-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1136"><a href="#cb66-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1137"><a href="#cb66-1137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1138"><a href="#cb66-1138" aria-hidden="true" tabindex="-1"></a><span class="in"># Alternative code to estimate IPCW Kaplan-Meier, IPTW Kaplan-Meier or </span></span>
<span id="cb66-1139"><a href="#cb66-1139" aria-hidden="true" tabindex="-1"></a><span class="in"># IPTW-IPCW Kaplan-Meier estimator with survival package instead of using </span></span>
<span id="cb66-1140"><a href="#cb66-1140" aria-hidden="true" tabindex="-1"></a><span class="in"># handmade adjusted.KM function (the weights need to be calculated before).</span></span>
<span id="cb66-1141"><a href="#cb66-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1142"><a href="#cb66-1142" aria-hidden="true" tabindex="-1"></a><span class="in"># Weights0 corresponds to weights of the control and weights1 of treated</span></span>
<span id="cb66-1143"><a href="#cb66-1143" aria-hidden="true" tabindex="-1"></a><span class="in">Adjusted_Kaplan_meier_alternative &lt;- function(data, A1 = 1, A0 = 0, tau, </span></span>
<span id="cb66-1144"><a href="#cb66-1144" aria-hidden="true" tabindex="-1"></a><span class="in">                                          weights0, weights1){</span></span>
<span id="cb66-1145"><a href="#cb66-1145" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate Kaplan-Meier estimator with survfit function on data subset </span></span>
<span id="cb66-1146"><a href="#cb66-1146" aria-hidden="true" tabindex="-1"></a><span class="in">  # Groupe A = 0</span></span>
<span id="cb66-1147"><a href="#cb66-1147" aria-hidden="true" tabindex="-1"></a><span class="in">  fit0 &lt;- survfit(Surv(T_obs, status) ~ 1, data = data[data$A == A0,], weights = weights0)  </span></span>
<span id="cb66-1148"><a href="#cb66-1148" aria-hidden="true" tabindex="-1"></a><span class="in">  # Groupe A = 1</span></span>
<span id="cb66-1149"><a href="#cb66-1149" aria-hidden="true" tabindex="-1"></a><span class="in">  fit1 &lt;- survfit(Surv(T_obs, status) ~ 1, data = data[data$A == A1,], weights = weights1)  </span></span>
<span id="cb66-1150"><a href="#cb66-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1151"><a href="#cb66-1151" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate the RMST with rmean</span></span>
<span id="cb66-1152"><a href="#cb66-1152" aria-hidden="true" tabindex="-1"></a><span class="in">  summary_fit0 &lt;- summary(fit0, rmean = tau)  # RMST for A = 0</span></span>
<span id="cb66-1153"><a href="#cb66-1153" aria-hidden="true" tabindex="-1"></a><span class="in">  summary_fit1 &lt;- summary(fit1, rmean = tau)  # RMST for A = 1</span></span>
<span id="cb66-1154"><a href="#cb66-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1155"><a href="#cb66-1155" aria-hidden="true" tabindex="-1"></a><span class="in">  # Extract the RMST from the summary objects</span></span>
<span id="cb66-1156"><a href="#cb66-1156" aria-hidden="true" tabindex="-1"></a><span class="in">  rmst0 &lt;- summary_fit0$table["rmean"][[1]]</span></span>
<span id="cb66-1157"><a href="#cb66-1157" aria-hidden="true" tabindex="-1"></a><span class="in">  rmst1 &lt;- summary_fit1$table["rmean"][[1]]</span></span>
<span id="cb66-1158"><a href="#cb66-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1159"><a href="#cb66-1159" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute the difference in RMST between the two groups</span></span>
<span id="cb66-1160"><a href="#cb66-1160" aria-hidden="true" tabindex="-1"></a><span class="in">  difference_rmst &lt;- rmst1 - rmst0</span></span>
<span id="cb66-1161"><a href="#cb66-1161" aria-hidden="true" tabindex="-1"></a><span class="in">return(difference_rmst)</span></span>
<span id="cb66-1162"><a href="#cb66-1162" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1163"><a href="#cb66-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1164"><a href="#cb66-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1165"><a href="#cb66-1165" aria-hidden="true" tabindex="-1"></a>This alternative approach for IPCW Kaplan-Meier would also be valid for IPTW and IPTW-IPCW Kaplan-Meier.</span>
<span id="cb66-1166"><a href="#cb66-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1167"><a href="#cb66-1167" aria-hidden="true" tabindex="-1"></a>**Buckley-James based estimator **</span>
<span id="cb66-1168"><a href="#cb66-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1169"><a href="#cb66-1169" aria-hidden="true" tabindex="-1"></a>The function $\texttt{BJ}$ estimates $\theta_{\mathrm{RMST}}$ by implementing the Buckley-James estimator as in @eq-BJ. It uses two functions available in the $\texttt{utilitary.R}$ file, namely $\texttt{Q<span class="sc">\_</span>t<span class="sc">\_</span>hat}$ and $\texttt{Q<span class="sc">\_</span>Y}$.</span>
<span id="cb66-1170"><a href="#cb66-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1171"><a href="#cb66-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1172"><a href="#cb66-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1173"><a href="#cb66-1173" aria-hidden="true" tabindex="-1"></a><span class="in"># Compute the Restricted Mean Survival Time (RMST) difference</span></span>
<span id="cb66-1174"><a href="#cb66-1174" aria-hidden="true" tabindex="-1"></a><span class="in">BJ &lt;- function(data, tau, X.names.outcome = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-1175"><a href="#cb66-1175" aria-hidden="true" tabindex="-1"></a><span class="in">               nuisance = "cox", n.folds = NULL) {</span></span>
<span id="cb66-1176"><a href="#cb66-1176" aria-hidden="true" tabindex="-1"></a><span class="in">  # Truncate observed times at tau</span></span>
<span id="cb66-1177"><a href="#cb66-1177" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- ifelse(data$T_obs &gt;= tau, tau, data$T_obs)</span></span>
<span id="cb66-1178"><a href="#cb66-1178" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1179"><a href="#cb66-1179" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1180"><a href="#cb66-1180" aria-hidden="true" tabindex="-1"></a><span class="in">  # Censoring status at tau</span></span>
<span id="cb66-1181"><a href="#cb66-1181" aria-hidden="true" tabindex="-1"></a><span class="in">  data$status_tau &lt;- as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1182"><a href="#cb66-1182" aria-hidden="true" tabindex="-1"></a><span class="in">                                (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1183"><a href="#cb66-1183" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1184"><a href="#cb66-1184" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute Q_t for all time points</span></span>
<span id="cb66-1185"><a href="#cb66-1185" aria-hidden="true" tabindex="-1"></a><span class="in">  Q_t &lt;- Q_t_hat(data, tau, X.names.outcome, nuisance, n.folds)</span></span>
<span id="cb66-1186"><a href="#cb66-1186" aria-hidden="true" tabindex="-1"></a><span class="in">  data$Q_y &lt;- Q_Y(data, tau, Q_t)</span></span>
<span id="cb66-1187"><a href="#cb66-1187" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1188"><a href="#cb66-1188" aria-hidden="true" tabindex="-1"></a><span class="in">  # Split data by treatment group</span></span>
<span id="cb66-1189"><a href="#cb66-1189" aria-hidden="true" tabindex="-1"></a><span class="in">  data_treated &lt;- data %&gt;% dplyr::filter(A == 1)</span></span>
<span id="cb66-1190"><a href="#cb66-1190" aria-hidden="true" tabindex="-1"></a><span class="in">  data_not_treated &lt;- data %&gt;% dplyr::filter(A == 0)</span></span>
<span id="cb66-1191"><a href="#cb66-1191" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1192"><a href="#cb66-1192" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate Restricted Survival Time (RST) for each group</span></span>
<span id="cb66-1193"><a href="#cb66-1193" aria-hidden="true" tabindex="-1"></a><span class="in">  data_treated$RST &lt;- data_treated$status_tau * data_treated$T_obs_tau + </span></span>
<span id="cb66-1194"><a href="#cb66-1194" aria-hidden="true" tabindex="-1"></a><span class="in">                      (1 - data_treated$status_tau) * data_treated$Q_y</span></span>
<span id="cb66-1195"><a href="#cb66-1195" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1196"><a href="#cb66-1196" aria-hidden="true" tabindex="-1"></a><span class="in">  data_not_treated$RST &lt;- data_not_treated$status_tau * data_not_treated$T_obs_tau + </span></span>
<span id="cb66-1197"><a href="#cb66-1197" aria-hidden="true" tabindex="-1"></a><span class="in">                          (1 - data_not_treated$status_tau) * data_not_treated$Q_y</span></span>
<span id="cb66-1198"><a href="#cb66-1198" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1199"><a href="#cb66-1199" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate RMST difference between treated and not treated</span></span>
<span id="cb66-1200"><a href="#cb66-1200" aria-hidden="true" tabindex="-1"></a><span class="in">  RMST &lt;- mean(data_treated$RST) - mean(data_not_treated$RST)</span></span>
<span id="cb66-1201"><a href="#cb66-1201" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1202"><a href="#cb66-1202" aria-hidden="true" tabindex="-1"></a><span class="in">  # Return RMST and other relevant metrics</span></span>
<span id="cb66-1203"><a href="#cb66-1203" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list(</span></span>
<span id="cb66-1204"><a href="#cb66-1204" aria-hidden="true" tabindex="-1"></a><span class="in">    RMST = RMST, </span></span>
<span id="cb66-1205"><a href="#cb66-1205" aria-hidden="true" tabindex="-1"></a><span class="in">    ATE_treated = mean(data_treated$RST), </span></span>
<span id="cb66-1206"><a href="#cb66-1206" aria-hidden="true" tabindex="-1"></a><span class="in">    ATE_not_treated = mean(data_not_treated$RST)</span></span>
<span id="cb66-1207"><a href="#cb66-1207" aria-hidden="true" tabindex="-1"></a><span class="in">  ))</span></span>
<span id="cb66-1208"><a href="#cb66-1208" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1209"><a href="#cb66-1209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1210"><a href="#cb66-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1211"><a href="#cb66-1211" aria-hidden="true" tabindex="-1"></a>**IPTW Kaplan-Meier**</span>
<span id="cb66-1212"><a href="#cb66-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1213"><a href="#cb66-1213" aria-hidden="true" tabindex="-1"></a>The function $\texttt{IPTW<span class="sc">\_</span>Kaplan<span class="sc">\_</span>meier}$ implements the IPTW-KM estimator in @eq-RMST_IPTWKM. It uses the $\texttt{estimate<span class="sc">\_</span>propensity<span class="sc">\_</span>score}$ function from the $\texttt{utilitary.R}$. </span>
<span id="cb66-1214"><a href="#cb66-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1215"><a href="#cb66-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1216"><a href="#cb66-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1217"><a href="#cb66-1217" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to calculate IPTW Kaplan-Meier</span></span>
<span id="cb66-1218"><a href="#cb66-1218" aria-hidden="true" tabindex="-1"></a><span class="in">IPTW_Kaplan_meier &lt;- function(data, tau, X.names.propensity, </span></span>
<span id="cb66-1219"><a href="#cb66-1219" aria-hidden="true" tabindex="-1"></a><span class="in">                              nuisance_propensity = "glm", n.folds = NULL) {</span></span>
<span id="cb66-1220"><a href="#cb66-1220" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate propensity scores</span></span>
<span id="cb66-1221"><a href="#cb66-1221" aria-hidden="true" tabindex="-1"></a><span class="in">  data$e_hat &lt;- estimate_propensity_score(</span></span>
<span id="cb66-1222"><a href="#cb66-1222" aria-hidden="true" tabindex="-1"></a><span class="in">    data,</span></span>
<span id="cb66-1223"><a href="#cb66-1223" aria-hidden="true" tabindex="-1"></a><span class="in">    treatment_covariates = X.names.propensity,</span></span>
<span id="cb66-1224"><a href="#cb66-1224" aria-hidden="true" tabindex="-1"></a><span class="in">    type_of_model = nuisance_propensity,</span></span>
<span id="cb66-1225"><a href="#cb66-1225" aria-hidden="true" tabindex="-1"></a><span class="in">    n.folds = n.folds)</span></span>
<span id="cb66-1226"><a href="#cb66-1226" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1227"><a href="#cb66-1227" aria-hidden="true" tabindex="-1"></a><span class="in">  # Truncate observed times at tau</span></span>
<span id="cb66-1228"><a href="#cb66-1228" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- pmin(data$T_obs, tau)</span></span>
<span id="cb66-1229"><a href="#cb66-1229" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1230"><a href="#cb66-1230" aria-hidden="true" tabindex="-1"></a><span class="in">  # Define censoring status at tau</span></span>
<span id="cb66-1231"><a href="#cb66-1231" aria-hidden="true" tabindex="-1"></a><span class="in">  data$status_tau &lt;- as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1232"><a href="#cb66-1232" aria-hidden="true" tabindex="-1"></a><span class="in">                                (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1233"><a href="#cb66-1233" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1234"><a href="#cb66-1234" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate weights</span></span>
<span id="cb66-1235"><a href="#cb66-1235" aria-hidden="true" tabindex="-1"></a><span class="in">  data$weights &lt;- (data$A) * (1 / data$e_hat) + (1 - data$A) / (1 - data$e_hat)</span></span>
<span id="cb66-1236"><a href="#cb66-1236" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1237"><a href="#cb66-1237" aria-hidden="true" tabindex="-1"></a><span class="in">  # Adjusted Kaplan-Meier estimator</span></span>
<span id="cb66-1238"><a href="#cb66-1238" aria-hidden="true" tabindex="-1"></a><span class="in">  S &lt;- adjusted.KM(</span></span>
<span id="cb66-1239"><a href="#cb66-1239" aria-hidden="true" tabindex="-1"></a><span class="in">    times = data$T_obs, </span></span>
<span id="cb66-1240"><a href="#cb66-1240" aria-hidden="true" tabindex="-1"></a><span class="in">    failures = data$status,</span></span>
<span id="cb66-1241"><a href="#cb66-1241" aria-hidden="true" tabindex="-1"></a><span class="in">    variable = data$A, </span></span>
<span id="cb66-1242"><a href="#cb66-1242" aria-hidden="true" tabindex="-1"></a><span class="in">    weights = data$weights)</span></span>
<span id="cb66-1243"><a href="#cb66-1243" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1244"><a href="#cb66-1244" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate RMST from the adjusted survival curves</span></span>
<span id="cb66-1245"><a href="#cb66-1245" aria-hidden="true" tabindex="-1"></a><span class="in">  RMST &lt;- RMST_1(S_A1 = S[S$variable == 1,], </span></span>
<span id="cb66-1246"><a href="#cb66-1246" aria-hidden="true" tabindex="-1"></a><span class="in">                 S_A0 = S[S$variable == 0,], </span></span>
<span id="cb66-1247"><a href="#cb66-1247" aria-hidden="true" tabindex="-1"></a><span class="in">                 tau = tau)</span></span>
<span id="cb66-1248"><a href="#cb66-1248" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1249"><a href="#cb66-1249" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list("intA0" = RMST$intA0, "intA1" = RMST$intA1, "RMST" = RMST$RMST))</span></span>
<span id="cb66-1250"><a href="#cb66-1250" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1251"><a href="#cb66-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1252"><a href="#cb66-1252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1253"><a href="#cb66-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1254"><a href="#cb66-1254" aria-hidden="true" tabindex="-1"></a>**G-formula**</span>
<span id="cb66-1255"><a href="#cb66-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1256"><a href="#cb66-1256" aria-hidden="true" tabindex="-1"></a>We implement two versions of the G-formula: $\texttt{g<span class="sc">\_</span>formula<span class="sc">\_</span>T<span class="sc">\_</span>learner}$ and $\texttt{g<span class="sc">\_</span>formula<span class="sc">\_</span>S<span class="sc">\_</span>learner}$. In $\texttt{g<span class="sc">\_</span>formula<span class="sc">\_</span>T<span class="sc">\_</span>learner}$, separate models estimate survival curves for treated and control groups, whereas $\texttt{g<span class="sc">\_</span>formula<span class="sc">\_</span>S<span class="sc">\_</span>learner}$ uses a single model incorporating both covariates and treatment status to estimate survival time. The latter approach is also available in the RISCA package but is limited to Cox models.</span>
<span id="cb66-1257"><a href="#cb66-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1258"><a href="#cb66-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1259"><a href="#cb66-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1260"><a href="#cb66-1260" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to estimate the g-formula Two-learner.</span></span>
<span id="cb66-1261"><a href="#cb66-1261" aria-hidden="true" tabindex="-1"></a><span class="in">g_formula_T_learner &lt;- function(data, </span></span>
<span id="cb66-1262"><a href="#cb66-1262" aria-hidden="true" tabindex="-1"></a><span class="in">                                X.names.outcome, </span></span>
<span id="cb66-1263"><a href="#cb66-1263" aria-hidden="true" tabindex="-1"></a><span class="in">                                tau, </span></span>
<span id="cb66-1264"><a href="#cb66-1264" aria-hidden="true" tabindex="-1"></a><span class="in">                                nuisance_survival = "cox", </span></span>
<span id="cb66-1265"><a href="#cb66-1265" aria-hidden="true" tabindex="-1"></a><span class="in">                                n.folds = NULL) {</span></span>
<span id="cb66-1266"><a href="#cb66-1266" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute min(T_obs,tau)</span></span>
<span id="cb66-1267"><a href="#cb66-1267" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- ifelse(data$T_obs &gt;= tau, tau, data$T_obs)</span></span>
<span id="cb66-1268"><a href="#cb66-1268" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1269"><a href="#cb66-1269" aria-hidden="true" tabindex="-1"></a><span class="in">  # Y.grid is the grid of time points where we want to estimate the </span></span>
<span id="cb66-1270"><a href="#cb66-1270" aria-hidden="true" tabindex="-1"></a><span class="in">  # survival function.</span></span>
<span id="cb66-1271"><a href="#cb66-1271" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1272"><a href="#cb66-1272" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1273"><a href="#cb66-1273" aria-hidden="true" tabindex="-1"></a><span class="in">  S_hat &lt;- estimate_survival_function(data, X.names.outcome, </span></span>
<span id="cb66-1274"><a href="#cb66-1274" aria-hidden="true" tabindex="-1"></a><span class="in">                                      Y.grid, </span></span>
<span id="cb66-1275"><a href="#cb66-1275" aria-hidden="true" tabindex="-1"></a><span class="in">                                      type_of_model = nuisance_survival,</span></span>
<span id="cb66-1276"><a href="#cb66-1276" aria-hidden="true" tabindex="-1"></a><span class="in">                                      T_obs = "T_obs", </span></span>
<span id="cb66-1277"><a href="#cb66-1277" aria-hidden="true" tabindex="-1"></a><span class="in">                                      status = "status", </span></span>
<span id="cb66-1278"><a href="#cb66-1278" aria-hidden="true" tabindex="-1"></a><span class="in">                                      n.folds = n.folds)</span></span>
<span id="cb66-1279"><a href="#cb66-1279" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1280"><a href="#cb66-1280" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute the area under each survival curve up to max(Y.grid) = tau.</span></span>
<span id="cb66-1281"><a href="#cb66-1281" aria-hidden="true" tabindex="-1"></a><span class="in">  E_hat1 &lt;- expected_survival(S_hat$S_hat1, Y.grid)</span></span>
<span id="cb66-1282"><a href="#cb66-1282" aria-hidden="true" tabindex="-1"></a><span class="in">  E_hat0 &lt;- expected_survival(S_hat$S_hat0, Y.grid)</span></span>
<span id="cb66-1283"><a href="#cb66-1283" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1284"><a href="#cb66-1284" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate the mean difference.</span></span>
<span id="cb66-1285"><a href="#cb66-1285" aria-hidden="true" tabindex="-1"></a><span class="in">  theta_g_formula &lt;- mean(E_hat1 - E_hat0)</span></span>
<span id="cb66-1286"><a href="#cb66-1286" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1287"><a href="#cb66-1287" aria-hidden="true" tabindex="-1"></a><span class="in">  return(theta_g_formula)</span></span>
<span id="cb66-1288"><a href="#cb66-1288" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1289"><a href="#cb66-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1290"><a href="#cb66-1290" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to estimate the g-formula Single-learner.</span></span>
<span id="cb66-1291"><a href="#cb66-1291" aria-hidden="true" tabindex="-1"></a><span class="in">g_formula_S_learner &lt;- function(data, </span></span>
<span id="cb66-1292"><a href="#cb66-1292" aria-hidden="true" tabindex="-1"></a><span class="in">                                X.names.outcome, </span></span>
<span id="cb66-1293"><a href="#cb66-1293" aria-hidden="true" tabindex="-1"></a><span class="in">                                tau, </span></span>
<span id="cb66-1294"><a href="#cb66-1294" aria-hidden="true" tabindex="-1"></a><span class="in">                                nuisance_survival = "cox", </span></span>
<span id="cb66-1295"><a href="#cb66-1295" aria-hidden="true" tabindex="-1"></a><span class="in">                                n.folds = NULL) {</span></span>
<span id="cb66-1296"><a href="#cb66-1296" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute min(T_obs,tau)</span></span>
<span id="cb66-1297"><a href="#cb66-1297" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- ifelse(data$T_obs &gt;= tau, tau, data$T_obs)</span></span>
<span id="cb66-1298"><a href="#cb66-1298" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1299"><a href="#cb66-1299" aria-hidden="true" tabindex="-1"></a><span class="in">  # Y.grid is the grid of time points where we want to estimate the </span></span>
<span id="cb66-1300"><a href="#cb66-1300" aria-hidden="true" tabindex="-1"></a><span class="in">  # survival function.</span></span>
<span id="cb66-1301"><a href="#cb66-1301" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1302"><a href="#cb66-1302" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1303"><a href="#cb66-1303" aria-hidden="true" tabindex="-1"></a><span class="in">  S_hat &lt;- estimate_survival_function(data, X.names.outcome, </span></span>
<span id="cb66-1304"><a href="#cb66-1304" aria-hidden="true" tabindex="-1"></a><span class="in">                                      Y.grid, </span></span>
<span id="cb66-1305"><a href="#cb66-1305" aria-hidden="true" tabindex="-1"></a><span class="in">                                      type_of_model = nuisance_survival,</span></span>
<span id="cb66-1306"><a href="#cb66-1306" aria-hidden="true" tabindex="-1"></a><span class="in">                                      learner = "S-learner",</span></span>
<span id="cb66-1307"><a href="#cb66-1307" aria-hidden="true" tabindex="-1"></a><span class="in">                                      T_obs = "T_obs", </span></span>
<span id="cb66-1308"><a href="#cb66-1308" aria-hidden="true" tabindex="-1"></a><span class="in">                                      status = "status", </span></span>
<span id="cb66-1309"><a href="#cb66-1309" aria-hidden="true" tabindex="-1"></a><span class="in">                                      n.folds = n.folds)</span></span>
<span id="cb66-1310"><a href="#cb66-1310" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1311"><a href="#cb66-1311" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute the area under each survival curve until max(Y.grid) = tau.</span></span>
<span id="cb66-1312"><a href="#cb66-1312" aria-hidden="true" tabindex="-1"></a><span class="in">  E_hat1 &lt;- expected_survival(S_hat$S_hat1, Y.grid)</span></span>
<span id="cb66-1313"><a href="#cb66-1313" aria-hidden="true" tabindex="-1"></a><span class="in">  E_hat0 &lt;- expected_survival(S_hat$S_hat0, Y.grid)</span></span>
<span id="cb66-1314"><a href="#cb66-1314" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1315"><a href="#cb66-1315" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate the mean difference.</span></span>
<span id="cb66-1316"><a href="#cb66-1316" aria-hidden="true" tabindex="-1"></a><span class="in">  theta_g_formula &lt;- mean(E_hat1 - E_hat0)</span></span>
<span id="cb66-1317"><a href="#cb66-1317" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1318"><a href="#cb66-1318" aria-hidden="true" tabindex="-1"></a><span class="in">  return(theta_g_formula)</span></span>
<span id="cb66-1319"><a href="#cb66-1319" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1320"><a href="#cb66-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1321"><a href="#cb66-1321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1322"><a href="#cb66-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1323"><a href="#cb66-1323" aria-hidden="true" tabindex="-1"></a>**IPTW-IPCW Kaplan-Meier**</span>
<span id="cb66-1324"><a href="#cb66-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1325"><a href="#cb66-1325" aria-hidden="true" tabindex="-1"></a>The $\texttt{IPTW<span class="sc">\_</span>IPCW<span class="sc">\_</span>Kaplan<span class="sc">\_</span>meier}$ function implements the IPTW-IPCW Kaplan Meier estimator from @eq-RMST_IPTW_IPCWKM. It uses the  utilitary functions from the $\texttt{utilitary.R}$ file $\texttt{estimate<span class="sc">\_</span>propensity<span class="sc">\_</span>score}$ and $\texttt{estimate<span class="sc">\_</span>survival<span class="sc">\_</span>function}$ to estimate the nuisance parameters, and the function $\texttt{adjusted.KM}$ which computes an adjusted Kaplan Meier estimator using the appropriate weight.</span>
<span id="cb66-1326"><a href="#cb66-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1327"><a href="#cb66-1327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1328"><a href="#cb66-1328" aria-hidden="true" tabindex="-1"></a><span class="in">IPTW_IPCW_Kaplan_meier &lt;- function(data, </span></span>
<span id="cb66-1329"><a href="#cb66-1329" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.propensity, </span></span>
<span id="cb66-1330"><a href="#cb66-1330" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.censoring, </span></span>
<span id="cb66-1331"><a href="#cb66-1331" aria-hidden="true" tabindex="-1"></a><span class="in">                                   tau,</span></span>
<span id="cb66-1332"><a href="#cb66-1332" aria-hidden="true" tabindex="-1"></a><span class="in">                                   nuisance_propensity = "glm",</span></span>
<span id="cb66-1333"><a href="#cb66-1333" aria-hidden="true" tabindex="-1"></a><span class="in">                                   nuisance_censoring = "cox",</span></span>
<span id="cb66-1334"><a href="#cb66-1334" aria-hidden="true" tabindex="-1"></a><span class="in">                                   n.folds = NULL) {</span></span>
<span id="cb66-1335"><a href="#cb66-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  # Censoring time to tau if observed time exceeds tau</span></span>
<span id="cb66-1336"><a href="#cb66-1336" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- ifelse(data$T_obs &gt;= tau, tau, data$T_obs)</span></span>
<span id="cb66-1337"><a href="#cb66-1337" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1338"><a href="#cb66-1338" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create censoring status for tau</span></span>
<span id="cb66-1339"><a href="#cb66-1339" aria-hidden="true" tabindex="-1"></a><span class="in">  data$censor.status_tau &lt;- 1 - as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1340"><a href="#cb66-1340" aria-hidden="true" tabindex="-1"></a><span class="in">                                           (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1341"><a href="#cb66-1341" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1342"><a href="#cb66-1342" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create status at tau</span></span>
<span id="cb66-1343"><a href="#cb66-1343" aria-hidden="true" tabindex="-1"></a><span class="in">  data$status_tau &lt;- as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1344"><a href="#cb66-1344" aria-hidden="true" tabindex="-1"></a><span class="in">                                (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1345"><a href="#cb66-1345" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1346"><a href="#cb66-1346" aria-hidden="true" tabindex="-1"></a><span class="in">  # Grid of unique observed times truncated at tau</span></span>
<span id="cb66-1347"><a href="#cb66-1347" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1348"><a href="#cb66-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1349"><a href="#cb66-1349" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate propensity scores</span></span>
<span id="cb66-1350"><a href="#cb66-1350" aria-hidden="true" tabindex="-1"></a><span class="in">  data$e_hat &lt;- estimate_propensity_score(data,</span></span>
<span id="cb66-1351"><a href="#cb66-1351" aria-hidden="true" tabindex="-1"></a><span class="in">                                          treatment_covariates = X.names.propensity,</span></span>
<span id="cb66-1352"><a href="#cb66-1352" aria-hidden="true" tabindex="-1"></a><span class="in">                                          type_of_model = nuisance_propensity,</span></span>
<span id="cb66-1353"><a href="#cb66-1353" aria-hidden="true" tabindex="-1"></a><span class="in">                                          n.folds = n.folds)</span></span>
<span id="cb66-1354"><a href="#cb66-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1355"><a href="#cb66-1355" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate survival function for censoring</span></span>
<span id="cb66-1356"><a href="#cb66-1356" aria-hidden="true" tabindex="-1"></a><span class="in">  S_C_hat &lt;- estimate_survival_function(data, X.names = X.names.censoring,</span></span>
<span id="cb66-1357"><a href="#cb66-1357" aria-hidden="true" tabindex="-1"></a><span class="in">                                        Y.grid = Y.grid, T_obs = "T_obs_tau",</span></span>
<span id="cb66-1358"><a href="#cb66-1358" aria-hidden="true" tabindex="-1"></a><span class="in">                                        status = "censor.status_tau",</span></span>
<span id="cb66-1359"><a href="#cb66-1359" aria-hidden="true" tabindex="-1"></a><span class="in">                                        type_of_model = nuisance_censoring,</span></span>
<span id="cb66-1360"><a href="#cb66-1360" aria-hidden="true" tabindex="-1"></a><span class="in">                                        n.folds = n.folds)</span></span>
<span id="cb66-1361"><a href="#cb66-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1362"><a href="#cb66-1362" aria-hidden="true" tabindex="-1"></a><span class="in">  # Get estimated survival probabilities for censoring</span></span>
<span id="cb66-1363"><a href="#cb66-1363" aria-hidden="true" tabindex="-1"></a><span class="in">  data$S_C &lt;- S_C_hat$S_hat[cbind(1:nrow(data), match(data$T_obs_tau, Y.grid))]</span></span>
<span id="cb66-1364"><a href="#cb66-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1365"><a href="#cb66-1365" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate weights</span></span>
<span id="cb66-1366"><a href="#cb66-1366" aria-hidden="true" tabindex="-1"></a><span class="in">  data$weights &lt;- data$status_tau / data$S_C * </span></span>
<span id="cb66-1367"><a href="#cb66-1367" aria-hidden="true" tabindex="-1"></a><span class="in">                  (data$A * (1 / data$e_hat) + </span></span>
<span id="cb66-1368"><a href="#cb66-1368" aria-hidden="true" tabindex="-1"></a><span class="in">                     (1 - data$A) * (1 / (1 - data$e_hat)))</span></span>
<span id="cb66-1369"><a href="#cb66-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1370"><a href="#cb66-1370" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute adjusted Kaplan-Meier estimator</span></span>
<span id="cb66-1371"><a href="#cb66-1371" aria-hidden="true" tabindex="-1"></a><span class="in">  S &lt;- adjusted.KM(times = data$T_obs, </span></span>
<span id="cb66-1372"><a href="#cb66-1372" aria-hidden="true" tabindex="-1"></a><span class="in">                   failures = data$status, </span></span>
<span id="cb66-1373"><a href="#cb66-1373" aria-hidden="true" tabindex="-1"></a><span class="in">                   variable = data$A, </span></span>
<span id="cb66-1374"><a href="#cb66-1374" aria-hidden="true" tabindex="-1"></a><span class="in">                   weights = data$weights)</span></span>
<span id="cb66-1375"><a href="#cb66-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1376"><a href="#cb66-1376" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute Restricted Mean Survival Time (RMST)</span></span>
<span id="cb66-1377"><a href="#cb66-1377" aria-hidden="true" tabindex="-1"></a><span class="in">  RMST &lt;- RMST_1(S_A1 = S[S$variable == 1, ], </span></span>
<span id="cb66-1378"><a href="#cb66-1378" aria-hidden="true" tabindex="-1"></a><span class="in">                 S_A0 = S[S$variable == 0, ],</span></span>
<span id="cb66-1379"><a href="#cb66-1379" aria-hidden="true" tabindex="-1"></a><span class="in">                 tau = tau)</span></span>
<span id="cb66-1380"><a href="#cb66-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1381"><a href="#cb66-1381" aria-hidden="true" tabindex="-1"></a><span class="in">  # Return RMST and ATE for treated and not treated groups</span></span>
<span id="cb66-1382"><a href="#cb66-1382" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list(RMST = RMST$RMST, ATE_treated = RMST$intA1, </span></span>
<span id="cb66-1383"><a href="#cb66-1383" aria-hidden="true" tabindex="-1"></a><span class="in">              ATE_not_treated = RMST$intA0))</span></span>
<span id="cb66-1384"><a href="#cb66-1384" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1385"><a href="#cb66-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1386"><a href="#cb66-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1387"><a href="#cb66-1387" aria-hidden="true" tabindex="-1"></a>**IPTW-BJ estimator**</span>
<span id="cb66-1388"><a href="#cb66-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1389"><a href="#cb66-1389" aria-hidden="true" tabindex="-1"></a>The $\texttt{IPTW<span class="sc">\_</span>BJ}$ implements the IPTW-BJ estimator in @eq-iptwbj. It uses the  utilitary functions, from the $\texttt{utilitary.R}$ file, $\texttt{estimate<span class="sc">\_</span>propensity<span class="sc">\_</span>score}$, $\texttt{Q<span class="sc">\_</span>t<span class="sc">\_</span>hat}$ and $\texttt{Q<span class="sc">\_</span>Y}$ to estimate the nuisance parameters. </span>
<span id="cb66-1390"><a href="#cb66-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1391"><a href="#cb66-1391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1392"><a href="#cb66-1392" aria-hidden="true" tabindex="-1"></a><span class="in">IPTW_BJ &lt;- function(data, </span></span>
<span id="cb66-1393"><a href="#cb66-1393" aria-hidden="true" tabindex="-1"></a><span class="in">                    X.names.propensity,</span></span>
<span id="cb66-1394"><a href="#cb66-1394" aria-hidden="true" tabindex="-1"></a><span class="in">                    X.names.outcome, </span></span>
<span id="cb66-1395"><a href="#cb66-1395" aria-hidden="true" tabindex="-1"></a><span class="in">                    tau,</span></span>
<span id="cb66-1396"><a href="#cb66-1396" aria-hidden="true" tabindex="-1"></a><span class="in">                    nuisance_propensity = "glm",</span></span>
<span id="cb66-1397"><a href="#cb66-1397" aria-hidden="true" tabindex="-1"></a><span class="in">                    nuisance = "cox",</span></span>
<span id="cb66-1398"><a href="#cb66-1398" aria-hidden="true" tabindex="-1"></a><span class="in">                    n.folds = NULL) {</span></span>
<span id="cb66-1399"><a href="#cb66-1399" aria-hidden="true" tabindex="-1"></a><span class="in">  # Minimum of T_obs and tau</span></span>
<span id="cb66-1400"><a href="#cb66-1400" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- ifelse(data$T_obs &gt;= tau, tau, data$T_obs)</span></span>
<span id="cb66-1401"><a href="#cb66-1401" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1402"><a href="#cb66-1402" aria-hidden="true" tabindex="-1"></a><span class="in">  # Grid of unique observed times truncated at tau</span></span>
<span id="cb66-1403"><a href="#cb66-1403" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1404"><a href="#cb66-1404" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1405"><a href="#cb66-1405" aria-hidden="true" tabindex="-1"></a><span class="in">  # Indicator for min(T, tau) &lt; C</span></span>
<span id="cb66-1406"><a href="#cb66-1406" aria-hidden="true" tabindex="-1"></a><span class="in">  data$status_tau &lt;- as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1407"><a href="#cb66-1407" aria-hidden="true" tabindex="-1"></a><span class="in">                                (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1408"><a href="#cb66-1408" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1409"><a href="#cb66-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1410"><a href="#cb66-1410" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate propensity scores</span></span>
<span id="cb66-1411"><a href="#cb66-1411" aria-hidden="true" tabindex="-1"></a><span class="in">  data$e_hat &lt;- estimate_propensity_score(data,</span></span>
<span id="cb66-1412"><a href="#cb66-1412" aria-hidden="true" tabindex="-1"></a><span class="in">                                          treatment_covariates = X.names.propensity,</span></span>
<span id="cb66-1413"><a href="#cb66-1413" aria-hidden="true" tabindex="-1"></a><span class="in">                                          type_of_model = nuisance_propensity,</span></span>
<span id="cb66-1414"><a href="#cb66-1414" aria-hidden="true" tabindex="-1"></a><span class="in">                                          n.folds = n.folds)</span></span>
<span id="cb66-1415"><a href="#cb66-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1416"><a href="#cb66-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1417"><a href="#cb66-1417" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimation of Q_s</span></span>
<span id="cb66-1418"><a href="#cb66-1418" aria-hidden="true" tabindex="-1"></a><span class="in">  Q_t &lt;- Q_t_hat(data, tau, X.names.outcome, nuisance, n.folds)</span></span>
<span id="cb66-1419"><a href="#cb66-1419" aria-hidden="true" tabindex="-1"></a><span class="in">  data$Q_y &lt;-  Q_Y(data,tau,Q_t)</span></span>
<span id="cb66-1420"><a href="#cb66-1420" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1421"><a href="#cb66-1421" aria-hidden="true" tabindex="-1"></a><span class="in">  # BJ transformation</span></span>
<span id="cb66-1422"><a href="#cb66-1422" aria-hidden="true" tabindex="-1"></a><span class="in">  data$Y &lt;-  data$status_tau * data$T_obs_tau + </span></span>
<span id="cb66-1423"><a href="#cb66-1423" aria-hidden="true" tabindex="-1"></a><span class="in">                             (1 - data$status_tau) * data$Q_y</span></span>
<span id="cb66-1424"><a href="#cb66-1424" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1425"><a href="#cb66-1425" aria-hidden="true" tabindex="-1"></a><span class="in">  # IPTW on BJ transformation </span></span>
<span id="cb66-1426"><a href="#cb66-1426" aria-hidden="true" tabindex="-1"></a><span class="in">  data$RST &lt;- data$Y * (data$A/data$e_hat-(1-data$A)/(1-data$e_hat))</span></span>
<span id="cb66-1427"><a href="#cb66-1427" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1428"><a href="#cb66-1428" aria-hidden="true" tabindex="-1"></a><span class="in">  RMST &lt;- mean(data$RST)</span></span>
<span id="cb66-1429"><a href="#cb66-1429" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1430"><a href="#cb66-1430" aria-hidden="true" tabindex="-1"></a><span class="in">  # Return RMST</span></span>
<span id="cb66-1431"><a href="#cb66-1431" aria-hidden="true" tabindex="-1"></a><span class="in">  return(RMST)</span></span>
<span id="cb66-1432"><a href="#cb66-1432" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1433"><a href="#cb66-1433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1434"><a href="#cb66-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1435"><a href="#cb66-1435" aria-hidden="true" tabindex="-1"></a>**AIPTW-AIPCW**</span>
<span id="cb66-1436"><a href="#cb66-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1437"><a href="#cb66-1437" aria-hidden="true" tabindex="-1"></a>The $\texttt{AIPTW<span class="sc">\_</span>AIPCW}$ function implements the AIPTW_AIPCW estimator in @eq-AIPTW_AIPCW using the utilitary function from the $\texttt{utilitary.R}$ file $\texttt{estimate<span class="sc">\_</span>propensity<span class="sc">\_</span>score}$, $\texttt{Q<span class="sc">\_</span>t<span class="sc">\_</span>hat}$, $\texttt{Q<span class="sc">\_</span>Y}$, and $\texttt{estimate<span class="sc">\_</span>survival<span class="sc">\_</span>function}$ to estimate the nuisance parameters. </span>
<span id="cb66-1438"><a href="#cb66-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1439"><a href="#cb66-1439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1440"><a href="#cb66-1440" aria-hidden="true" tabindex="-1"></a><span class="in"># DR censoring transformation</span></span>
<span id="cb66-1441"><a href="#cb66-1441" aria-hidden="true" tabindex="-1"></a><span class="in">AIPCW &lt;-function(data,</span></span>
<span id="cb66-1442"><a href="#cb66-1442" aria-hidden="true" tabindex="-1"></a><span class="in">                 tau,</span></span>
<span id="cb66-1443"><a href="#cb66-1443" aria-hidden="true" tabindex="-1"></a><span class="in">                 X.names.censoring = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-1444"><a href="#cb66-1444" aria-hidden="true" tabindex="-1"></a><span class="in">                 X.names.outcome = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-1445"><a href="#cb66-1445" aria-hidden="true" tabindex="-1"></a><span class="in">                 nuisance_Qt = "cox",</span></span>
<span id="cb66-1446"><a href="#cb66-1446" aria-hidden="true" tabindex="-1"></a><span class="in">                 nuisance_censoring = "cox", </span></span>
<span id="cb66-1447"><a href="#cb66-1447" aria-hidden="true" tabindex="-1"></a><span class="in">                 n.folds = NULL, </span></span>
<span id="cb66-1448"><a href="#cb66-1448" aria-hidden="true" tabindex="-1"></a><span class="in">                 h_C_hat = NULL,</span></span>
<span id="cb66-1449"><a href="#cb66-1449" aria-hidden="true" tabindex="-1"></a><span class="in">                 method_aipw = 1) {</span></span>
<span id="cb66-1450"><a href="#cb66-1450" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1451"><a href="#cb66-1451" aria-hidden="true" tabindex="-1"></a><span class="in">  # Truncate observed times at tau</span></span>
<span id="cb66-1452"><a href="#cb66-1452" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- pmin(data$T_obs, tau)</span></span>
<span id="cb66-1453"><a href="#cb66-1453" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1454"><a href="#cb66-1454" aria-hidden="true" tabindex="-1"></a><span class="in">  # Define status at tau</span></span>
<span id="cb66-1455"><a href="#cb66-1455" aria-hidden="true" tabindex="-1"></a><span class="in">  data$status_tau &lt;-  as.numeric((data$T_obs &gt; tau) | </span></span>
<span id="cb66-1456"><a href="#cb66-1456" aria-hidden="true" tabindex="-1"></a><span class="in">                                  (data$T_obs &lt;= tau &amp;  data$status == 1 ))  </span></span>
<span id="cb66-1457"><a href="#cb66-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1458"><a href="#cb66-1458" aria-hidden="true" tabindex="-1"></a><span class="in">  data$censor.status_tau &lt;- 1- as.numeric(</span></span>
<span id="cb66-1459"><a href="#cb66-1459" aria-hidden="true" tabindex="-1"></a><span class="in">    (data$T_obs &gt; tau) | (data$T_obs &lt;= tau &amp;  data$status == 1 ))</span></span>
<span id="cb66-1460"><a href="#cb66-1460" aria-hidden="true" tabindex="-1"></a><span class="in"> </span></span>
<span id="cb66-1461"><a href="#cb66-1461" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1462"><a href="#cb66-1462" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1463"><a href="#cb66-1463" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate survival function for censoring</span></span>
<span id="cb66-1464"><a href="#cb66-1464" aria-hidden="true" tabindex="-1"></a><span class="in">  S_C_hat &lt;- estimate_survival_function(data = data,X.names.censoring,</span></span>
<span id="cb66-1465"><a href="#cb66-1465" aria-hidden="true" tabindex="-1"></a><span class="in">                                        type_of_model = nuisance_censoring,</span></span>
<span id="cb66-1466"><a href="#cb66-1466" aria-hidden="true" tabindex="-1"></a><span class="in">                                        n.folds = n.folds,</span></span>
<span id="cb66-1467"><a href="#cb66-1467" aria-hidden="true" tabindex="-1"></a><span class="in">                                        Y.grid = Y.grid,</span></span>
<span id="cb66-1468"><a href="#cb66-1468" aria-hidden="true" tabindex="-1"></a><span class="in">                                        T_obs = "T_obs_tau",</span></span>
<span id="cb66-1469"><a href="#cb66-1469" aria-hidden="true" tabindex="-1"></a><span class="in">                                        status = "censor.status_tau")</span></span>
<span id="cb66-1470"><a href="#cb66-1470" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1471"><a href="#cb66-1471" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.index &lt;- findInterval(data$T_obs_tau, Y.grid)</span></span>
<span id="cb66-1472"><a href="#cb66-1472" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1473"><a href="#cb66-1473" aria-hidden="true" tabindex="-1"></a><span class="in">  data$S_C_hat_T_obs_tau &lt;- S_C_hat$S_hat[cbind(seq_along(Y.index), Y.index)]</span></span>
<span id="cb66-1474"><a href="#cb66-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1475"><a href="#cb66-1475" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1476"><a href="#cb66-1476" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(h_C_hat)) {</span></span>
<span id="cb66-1477"><a href="#cb66-1477" aria-hidden="true" tabindex="-1"></a><span class="in">      h_C_hat &lt;- estimate_hazard_function(S_C_hat$S_hat,Y.grid)</span></span>
<span id="cb66-1478"><a href="#cb66-1478" aria-hidden="true" tabindex="-1"></a><span class="in">  } </span></span>
<span id="cb66-1479"><a href="#cb66-1479" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1480"><a href="#cb66-1480" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute Q.t.hat</span></span>
<span id="cb66-1481"><a href="#cb66-1481" aria-hidden="true" tabindex="-1"></a><span class="in">  Q.t.hat &lt;- Q_t_hat(data = data,</span></span>
<span id="cb66-1482"><a href="#cb66-1482" aria-hidden="true" tabindex="-1"></a><span class="in">                     X.names = X.names.outcome,</span></span>
<span id="cb66-1483"><a href="#cb66-1483" aria-hidden="true" tabindex="-1"></a><span class="in">                     tau = tau,</span></span>
<span id="cb66-1484"><a href="#cb66-1484" aria-hidden="true" tabindex="-1"></a><span class="in">                     nuisance = nuisance_Qt,</span></span>
<span id="cb66-1485"><a href="#cb66-1485" aria-hidden="true" tabindex="-1"></a><span class="in">                     n.folds = n.folds)</span></span>
<span id="cb66-1486"><a href="#cb66-1486" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1487"><a href="#cb66-1487" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute Q.Y.hat</span></span>
<span id="cb66-1488"><a href="#cb66-1488" aria-hidden="true" tabindex="-1"></a><span class="in">  data$Q.Y.hat &lt;- Q_Y(data = data, tau, Q.t.hat)</span></span>
<span id="cb66-1489"><a href="#cb66-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1490"><a href="#cb66-1490" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute first term</span></span>
<span id="cb66-1491"><a href="#cb66-1491" aria-hidden="true" tabindex="-1"></a><span class="in">  data$first_term &lt;- (data$T_obs_tau * data$status_tau) / </span></span>
<span id="cb66-1492"><a href="#cb66-1492" aria-hidden="true" tabindex="-1"></a><span class="in">    data$S_C_hat_T_obs_tau</span></span>
<span id="cb66-1493"><a href="#cb66-1493" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1494"><a href="#cb66-1494" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute second term</span></span>
<span id="cb66-1495"><a href="#cb66-1495" aria-hidden="true" tabindex="-1"></a><span class="in">  data$second_term &lt;- (data$Q.Y.hat * (1 - data$status_tau)) / </span></span>
<span id="cb66-1496"><a href="#cb66-1496" aria-hidden="true" tabindex="-1"></a><span class="in">    data$S_C_hat_T_obs_tau</span></span>
<span id="cb66-1497"><a href="#cb66-1497" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1498"><a href="#cb66-1498" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.diff &lt;- diff(c(0, Y.grid))</span></span>
<span id="cb66-1499"><a href="#cb66-1499" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1500"><a href="#cb66-1500" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute integrand for the third term</span></span>
<span id="cb66-1501"><a href="#cb66-1501" aria-hidden="true" tabindex="-1"></a><span class="in">  integrand &lt;- sweep( ( (h_C_hat) / S_C_hat$S_hat )* (Q.t.hat), 2, Y.diff, "*")</span></span>
<span id="cb66-1502"><a href="#cb66-1502" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1503"><a href="#cb66-1503" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute third term</span></span>
<span id="cb66-1504"><a href="#cb66-1504" aria-hidden="true" tabindex="-1"></a><span class="in">  data$third_term &lt;- integrate(integrand, Y.grid, data$T_obs_tau)</span></span>
<span id="cb66-1505"><a href="#cb66-1505" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1506"><a href="#cb66-1506" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute pseudo outcome</span></span>
<span id="cb66-1507"><a href="#cb66-1507" aria-hidden="true" tabindex="-1"></a><span class="in">  pseudo_outcome &lt;- data$first_term + data$second_term - data$third_term</span></span>
<span id="cb66-1508"><a href="#cb66-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1509"><a href="#cb66-1509" aria-hidden="true" tabindex="-1"></a><span class="in">  return(pseudo_outcome) </span></span>
<span id="cb66-1510"><a href="#cb66-1510" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1511"><a href="#cb66-1511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1512"><a href="#cb66-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1513"><a href="#cb66-1513" aria-hidden="true" tabindex="-1"></a><span class="in">AIPTW_AIPCW &lt;- function(data, </span></span>
<span id="cb66-1514"><a href="#cb66-1514" aria-hidden="true" tabindex="-1"></a><span class="in">                        tau, </span></span>
<span id="cb66-1515"><a href="#cb66-1515" aria-hidden="true" tabindex="-1"></a><span class="in">                        X.names.propensity = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-1516"><a href="#cb66-1516" aria-hidden="true" tabindex="-1"></a><span class="in">                        X.names.censoring = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-1517"><a href="#cb66-1517" aria-hidden="true" tabindex="-1"></a><span class="in">                        X.names.outcome = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-1518"><a href="#cb66-1518" aria-hidden="true" tabindex="-1"></a><span class="in">                        nuisance_propensity = "glm",</span></span>
<span id="cb66-1519"><a href="#cb66-1519" aria-hidden="true" tabindex="-1"></a><span class="in">                        nuisance_regression = "cox",</span></span>
<span id="cb66-1520"><a href="#cb66-1520" aria-hidden="true" tabindex="-1"></a><span class="in">                        nuisance_censoring = "cox",</span></span>
<span id="cb66-1521"><a href="#cb66-1521" aria-hidden="true" tabindex="-1"></a><span class="in">                        nuisance_Qt = "cox",</span></span>
<span id="cb66-1522"><a href="#cb66-1522" aria-hidden="true" tabindex="-1"></a><span class="in">                        n.folds = NULL) {</span></span>
<span id="cb66-1523"><a href="#cb66-1523" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1524"><a href="#cb66-1524" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate propensity scores</span></span>
<span id="cb66-1525"><a href="#cb66-1525" aria-hidden="true" tabindex="-1"></a><span class="in">  data$e_hat &lt;- estimate_propensity_score(</span></span>
<span id="cb66-1526"><a href="#cb66-1526" aria-hidden="true" tabindex="-1"></a><span class="in">    data = data, </span></span>
<span id="cb66-1527"><a href="#cb66-1527" aria-hidden="true" tabindex="-1"></a><span class="in">    treatment_covariates = X.names.propensity, </span></span>
<span id="cb66-1528"><a href="#cb66-1528" aria-hidden="true" tabindex="-1"></a><span class="in">    type_of_model = nuisance_propensity, </span></span>
<span id="cb66-1529"><a href="#cb66-1529" aria-hidden="true" tabindex="-1"></a><span class="in">    n.folds = n.folds</span></span>
<span id="cb66-1530"><a href="#cb66-1530" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb66-1531"><a href="#cb66-1531" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1532"><a href="#cb66-1532" aria-hidden="true" tabindex="-1"></a><span class="in">  # Prepare data for censoring model</span></span>
<span id="cb66-1533"><a href="#cb66-1533" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T_obs_tau &lt;- ifelse(data$T_obs &gt;= tau, tau, data$T_obs)</span></span>
<span id="cb66-1534"><a href="#cb66-1534" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1535"><a href="#cb66-1535" aria-hidden="true" tabindex="-1"></a><span class="in">  data$censor.status_tau &lt;- 1 - as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1536"><a href="#cb66-1536" aria-hidden="true" tabindex="-1"></a><span class="in">                                             (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1537"><a href="#cb66-1537" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1538"><a href="#cb66-1538" aria-hidden="true" tabindex="-1"></a><span class="in">  data$status_tau &lt;- as.numeric((data$T_obs &gt;= tau) | </span></span>
<span id="cb66-1539"><a href="#cb66-1539" aria-hidden="true" tabindex="-1"></a><span class="in">                                  (data$T_obs &lt; tau &amp; data$status == 1))</span></span>
<span id="cb66-1540"><a href="#cb66-1540" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1541"><a href="#cb66-1541" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create unique time grid</span></span>
<span id="cb66-1542"><a href="#cb66-1542" aria-hidden="true" tabindex="-1"></a><span class="in">  Y.grid &lt;- sort(unique(data$T_obs_tau))</span></span>
<span id="cb66-1543"><a href="#cb66-1543" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1544"><a href="#cb66-1544" aria-hidden="true" tabindex="-1"></a><span class="in">  S_hat &lt;- estimate_survival_function(data, X.names.outcome, </span></span>
<span id="cb66-1545"><a href="#cb66-1545" aria-hidden="true" tabindex="-1"></a><span class="in">                                      type_of_model = nuisance_regression, </span></span>
<span id="cb66-1546"><a href="#cb66-1546" aria-hidden="true" tabindex="-1"></a><span class="in">                                      Y.grid = Y.grid,</span></span>
<span id="cb66-1547"><a href="#cb66-1547" aria-hidden="true" tabindex="-1"></a><span class="in">                                      T_obs= "T_obs", </span></span>
<span id="cb66-1548"><a href="#cb66-1548" aria-hidden="true" tabindex="-1"></a><span class="in">                                      status = "status", </span></span>
<span id="cb66-1549"><a href="#cb66-1549" aria-hidden="true" tabindex="-1"></a><span class="in">                                      n.folds = n.folds)</span></span>
<span id="cb66-1550"><a href="#cb66-1550" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1551"><a href="#cb66-1551" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute area under the survival curve up to tau</span></span>
<span id="cb66-1552"><a href="#cb66-1552" aria-hidden="true" tabindex="-1"></a><span class="in">  data$E_hat1 &lt;- expected_survival(S_hat$S_hat1, Y.grid)</span></span>
<span id="cb66-1553"><a href="#cb66-1553" aria-hidden="true" tabindex="-1"></a><span class="in">  data$E_hat0 &lt;- expected_survival(S_hat$S_hat0, Y.grid)</span></span>
<span id="cb66-1554"><a href="#cb66-1554" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1555"><a href="#cb66-1555" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute IPW-weighted residuals</span></span>
<span id="cb66-1556"><a href="#cb66-1556" aria-hidden="true" tabindex="-1"></a><span class="in">  data$IPW_res &lt;- data$E_hat1 * (1 - data$A / data$e_hat) - </span></span>
<span id="cb66-1557"><a href="#cb66-1557" aria-hidden="true" tabindex="-1"></a><span class="in">    data$E_hat0 * (1 - (1 - data$A) / (1 - data$e_hat))</span></span>
<span id="cb66-1558"><a href="#cb66-1558" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1559"><a href="#cb66-1559" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute AIPCW weights</span></span>
<span id="cb66-1560"><a href="#cb66-1560" aria-hidden="true" tabindex="-1"></a><span class="in">  TDR &lt;- AIPCW(</span></span>
<span id="cb66-1561"><a href="#cb66-1561" aria-hidden="true" tabindex="-1"></a><span class="in">    data = data, </span></span>
<span id="cb66-1562"><a href="#cb66-1562" aria-hidden="true" tabindex="-1"></a><span class="in">    tau = tau,</span></span>
<span id="cb66-1563"><a href="#cb66-1563" aria-hidden="true" tabindex="-1"></a><span class="in">    X.names.censoring = X.names.censoring,</span></span>
<span id="cb66-1564"><a href="#cb66-1564" aria-hidden="true" tabindex="-1"></a><span class="in">    X.names.outcome = X.names.outcome,</span></span>
<span id="cb66-1565"><a href="#cb66-1565" aria-hidden="true" tabindex="-1"></a><span class="in">    nuisance_Qt = nuisance_Qt, </span></span>
<span id="cb66-1566"><a href="#cb66-1566" aria-hidden="true" tabindex="-1"></a><span class="in">    nuisance_censoring = nuisance_censoring, </span></span>
<span id="cb66-1567"><a href="#cb66-1567" aria-hidden="true" tabindex="-1"></a><span class="in">    n.folds = n.folds</span></span>
<span id="cb66-1568"><a href="#cb66-1568" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb66-1569"><a href="#cb66-1569" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1570"><a href="#cb66-1570" aria-hidden="true" tabindex="-1"></a><span class="in">  data$TDR &lt;- TDR</span></span>
<span id="cb66-1571"><a href="#cb66-1571" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1572"><a href="#cb66-1572" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute AIPCW-weighted residuals</span></span>
<span id="cb66-1573"><a href="#cb66-1573" aria-hidden="true" tabindex="-1"></a><span class="in">  data$AIPCW_w &lt;- data$TDR * (data$A / data$e_hat - </span></span>
<span id="cb66-1574"><a href="#cb66-1574" aria-hidden="true" tabindex="-1"></a><span class="in">                                (1 - data$A) / (1 - data$e_hat))</span></span>
<span id="cb66-1575"><a href="#cb66-1575" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1576"><a href="#cb66-1576" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute regression residuals</span></span>
<span id="cb66-1577"><a href="#cb66-1577" aria-hidden="true" tabindex="-1"></a><span class="in">  data$reg &lt;- data$E_hat1 - data$E_hat0</span></span>
<span id="cb66-1578"><a href="#cb66-1578" aria-hidden="true" tabindex="-1"></a><span class="in">  data$reg_res &lt;- data$A / data$e_hat * (data$TDR - data$E_hat1) - </span></span>
<span id="cb66-1579"><a href="#cb66-1579" aria-hidden="true" tabindex="-1"></a><span class="in">    (1 - data$A) / (1 - data$e_hat) * (data$TDR - data$E_hat0)</span></span>
<span id="cb66-1580"><a href="#cb66-1580" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1581"><a href="#cb66-1581" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute estimators</span></span>
<span id="cb66-1582"><a href="#cb66-1582" aria-hidden="true" tabindex="-1"></a><span class="in">  # na.rm = TRUE to remove NA for the mean calculation</span></span>
<span id="cb66-1583"><a href="#cb66-1583" aria-hidden="true" tabindex="-1"></a><span class="in">  AIPTW_AIPCW_IPW_res &lt;- mean(data$AIPCW_w + data$IPW_res, na.rm = TRUE)</span></span>
<span id="cb66-1584"><a href="#cb66-1584" aria-hidden="true" tabindex="-1"></a><span class="in">  AIPTW_AIPCW_reg_res &lt;- mean(data$reg + data$reg_res, na.rm = TRUE)</span></span>
<span id="cb66-1585"><a href="#cb66-1585" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1586"><a href="#cb66-1586" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list(AIPTW_AIPCW_reg_res = AIPTW_AIPCW_reg_res, </span></span>
<span id="cb66-1587"><a href="#cb66-1587" aria-hidden="true" tabindex="-1"></a><span class="in">              AIPTW_AIPCW_IPW_res = AIPTW_AIPCW_IPW_res))</span></span>
<span id="cb66-1588"><a href="#cb66-1588" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1589"><a href="#cb66-1589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1590"><a href="#cb66-1590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1591"><a href="#cb66-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1592"><a href="#cb66-1592" aria-hidden="true" tabindex="-1"></a><span class="fu">## Available packages {#sec-package}</span></span>
<span id="cb66-1593"><a href="#cb66-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1594"><a href="#cb66-1594" aria-hidden="true" tabindex="-1"></a>Currently, there are few sustained implementations available for estimating RMST in the presence of right censoring. Notable exceptions include the packages <span class="co">[</span><span class="ot">survRM2</span><span class="co">](https:%20//cran.r-project.org/web/packages/survRM2/index.html)</span></span>
<span id="cb66-1595"><a href="#cb66-1595" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@SurvRM2_2015</span><span class="co">]</span>, <span class="co">[</span><span class="ot">grf</span><span class="co">](https:%20//cran.r-project.org/web/packages/grf/index.html)</span> <span class="co">[</span><span class="ot">@Tibshirani_Athey_Sverdrup_Wager_2017</span><span class="co">]</span> and <span class="co">[</span><span class="ot">RISCA</span><span class="co">](https://cran.r-project.org/web/packages/RISCA/index.html)</span> <span class="co">[</span><span class="ot">@Foucher_Le_Borgne_Chatton_2019</span><span class="co">]</span>. Those packages are implemented in the $\texttt{utilitary.R}$ files. </span>
<span id="cb66-1596"><a href="#cb66-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1597"><a href="#cb66-1597" aria-hidden="true" tabindex="-1"></a>**SurvRM2**</span>
<span id="cb66-1598"><a href="#cb66-1598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1599"><a href="#cb66-1599" aria-hidden="true" tabindex="-1"></a>The difference in RMST with Unadjusted Kaplan-Meier $\hat \theta_{KM}$ (@eq-thetaunadjKM) can be obtained using the function $\texttt{rmst2}$ which takes as arguments the observed time-to-event, the status, the arm which corresponds to the treatment and $\tau$. </span>
<span id="cb66-1600"><a href="#cb66-1600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1601"><a href="#cb66-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1602"><a href="#cb66-1602" aria-hidden="true" tabindex="-1"></a>**RISCA**</span>
<span id="cb66-1603"><a href="#cb66-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1604"><a href="#cb66-1604" aria-hidden="true" tabindex="-1"></a>The RISCA package provides several methods for estimating $\theta_{\mathrm{RMST}}$. The difference in RMST with Unadjusted Kaplan-Meier $\hat \theta_{KM}$ (@eq-thetaunadjKM) can be derived using  the $\texttt{survfit}$ function from the the survival package <span class="co">[</span><span class="ot">@Therneau_2001</span><span class="co">]</span> which  estimates Kaplan-Meier survival curves for treated and control groups, and then the $\texttt{rmst}$ function calculates the RMST by integrating these curves, applying the rectangle method (type="s"), which is well-suited for step functions.</span>
<span id="cb66-1605"><a href="#cb66-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1606"><a href="#cb66-1606" aria-hidden="true" tabindex="-1"></a>The IPTW Kaplan-Meier (@eq-IPTWKM) can be applied using the $\texttt{ipw.survival}$ and $\texttt{rmst}$ functions. The ipw.survival function requires user-specified weights (i.e. propensity scores). To streamline this process, we define the $\texttt{RISCA<span class="sc">\_</span>iptw}$ function, which combines these steps and utilizes the $\texttt{estimate<span class="sc">\_</span>propensity<span class="sc">\_</span>score}$ from the $\texttt{utilitary.R}$ file.</span>
<span id="cb66-1607"><a href="#cb66-1607" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-1608"><a href="#cb66-1608" aria-hidden="true" tabindex="-1"></a>A single-learner version of the G-formula, as introduced in @sec-Gformula, can be implemented using the $\texttt{gc.survival}$ function. This function requires as input the conditional survival function which should be estimated beforehand with a Cox model via the $\texttt{coxph}$ function from the $\texttt{survival}$ package <span class="co">[</span><span class="ot">@Therneau_2001</span><span class="co">]</span>. Specifically, the single-learner approach applies a single Cox model incorporating both covariates and treatment, rather than separate models for each treatment arm. We provide a function $\texttt{RISCA<span class="sc">\_</span>gf}$ that consolidates these steps.</span>
<span id="cb66-1609"><a href="#cb66-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1610"><a href="#cb66-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1611"><a href="#cb66-1611" aria-hidden="true" tabindex="-1"></a>**grf**</span>
<span id="cb66-1612"><a href="#cb66-1612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1613"><a href="#cb66-1613" aria-hidden="true" tabindex="-1"></a>The $\texttt{grf}$ package <span class="co">[</span><span class="ot">@Tibshirani_Athey_Sverdrup_Wager_2017</span><span class="co">]</span> enables estimation of the difference between RMST using the Causal Survival Forest approach <span class="co">[</span><span class="ot">@HTE_causal_survival_forests</span><span class="co">]</span>, which extends the non-parametric causal forest framework to survival data.</span>
<span id="cb66-1614"><a href="#cb66-1614" aria-hidden="true" tabindex="-1"></a>The RMST can be estimated with the $\texttt{causal<span class="sc">\_</span>survival<span class="sc">\_</span>forest}$ function, requiring covariates $X$, observed event times, event status, treatment assignment, and the time horizon $\tau$ as inputs. The $\texttt{average<span class="sc">\_</span>treatment<span class="sc">\_</span>effect}$ function then evaluates the treatment effect based on predictions from the fitted forest.</span>
<span id="cb66-1615"><a href="#cb66-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1616"><a href="#cb66-1616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1617"><a href="#cb66-1617" aria-hidden="true" tabindex="-1"></a><span class="fu"># Simulations {#sec-simulation}</span></span>
<span id="cb66-1618"><a href="#cb66-1618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1619"><a href="#cb66-1619" aria-hidden="true" tabindex="-1"></a>We compare the behaviors and performances of the estimators through simulations conducted across various experiemental contexts. These contexts include scenarios based on RCTs and observational data, with both independent and dependent censoring. We also use semi-parametric and non-parametric models to generate censoring and survival times, as well as logistic and nonlinear models to simulate treatment assignment.</span>
<span id="cb66-1620"><a href="#cb66-1620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1621"><a href="#cb66-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1622"><a href="#cb66-1622" aria-hidden="true" tabindex="-1"></a><span class="fu">## RCT {#sec-simulation-RCT}</span></span>
<span id="cb66-1623"><a href="#cb66-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1624"><a href="#cb66-1624" aria-hidden="true" tabindex="-1"></a>**Data Generating Process**</span>
<span id="cb66-1625"><a href="#cb66-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1626"><a href="#cb66-1626" aria-hidden="true" tabindex="-1"></a>We generate RCTs with independent censoring (Scenario 1) and </span>
<span id="cb66-1627"><a href="#cb66-1627" aria-hidden="true" tabindex="-1"></a>conditionally independent censoring (Scenario 2).</span>
<span id="cb66-1628"><a href="#cb66-1628" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The survival time and the censoring time (when there is dependency --&gt;</span></span>
<span id="cb66-1629"><a href="#cb66-1629" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- between the censoring time and the covariates) is simulated using the --&gt;</span></span>
<span id="cb66-1630"><a href="#cb66-1630" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- cumulative hazard inversion method for exponential models [@Leemis_1990; @Bender_2005].  --&gt;</span></span>
<span id="cb66-1631"><a href="#cb66-1631" aria-hidden="true" tabindex="-1"></a>We sample $n$ iid datapoints $(X_{i},A_{i},C,T_{i}(0), T_{i}(1))_{i \in [n]}$ where $T_{i}(0), T_{i}(1)$ and $C$ follows Cox's models. More specifically, we set</span>
<span id="cb66-1632"><a href="#cb66-1632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1633"><a href="#cb66-1633" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$X \sim \mathcal{N}\left(\mu,\Sigma\right)$ where $\mu = (1,1,-1,1)$ and $\Sigma = \mathrm{Id}_4$.</span>
<span id="cb66-1634"><a href="#cb66-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1635"><a href="#cb66-1635" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The hazard function of $T(0)$ is </span>
<span id="cb66-1636"><a href="#cb66-1636" aria-hidden="true" tabindex="-1"></a>$$\lambda^{(0)}(t|X)= 0.01  \exp \left<span class="sc">\{</span> \beta_0^\top X\right<span class="sc">\}</span> \quad \text{where} \quad \beta_0 = (0.5,0.5,-0.5,0.5).</span>
<span id="cb66-1637"><a href="#cb66-1637" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-1638"><a href="#cb66-1638" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The survival times in the treatment group are given by $T(1) = T(0) + 10$.</span>
<span id="cb66-1639"><a href="#cb66-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1640"><a href="#cb66-1640" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The hazard function of the censoring time $C$ is simply taken as $\lambda_C(t|X)=0.03$ in Scenario 1, and in Scenario 2 as</span>
<span id="cb66-1641"><a href="#cb66-1641" aria-hidden="true" tabindex="-1"></a>        $$\lambda_C(t|X)=0.03 \cdot \exp \left<span class="sc">\{</span>\beta_C^\top X\right<span class="sc">\}</span> \quad \text{where} \quad \beta_C = (0.7,0.7,-0.25,-0.1).$$</span>
<span id="cb66-1642"><a href="#cb66-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1643"><a href="#cb66-1643" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The treatment allocation is independent of $X$: $e(X)=0.5$.</span>
<span id="cb66-1644"><a href="#cb66-1644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1645"><a href="#cb66-1645" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   the survival time is $T=A T(1)+(1-A) T(0)$. --&gt;</span></span>
<span id="cb66-1646"><a href="#cb66-1646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1647"><a href="#cb66-1647" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   The observed time is $\widetilde{T}=\min (T, C)$. --&gt;</span></span>
<span id="cb66-1648"><a href="#cb66-1648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1649"><a href="#cb66-1649" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   The status is $\Delta=1(T \leq C)$. --&gt;</span></span>
<span id="cb66-1650"><a href="#cb66-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1651"><a href="#cb66-1651" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The threshold time $\tau$ is set to 25.</span>
<span id="cb66-1652"><a href="#cb66-1652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1653"><a href="#cb66-1653" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The observed samples are $(X_{i},A_{i},\Delta_{i},\widetilde{T_{i}})$. --&gt;</span></span>
<span id="cb66-1654"><a href="#cb66-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1655"><a href="#cb66-1655" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1656"><a href="#cb66-1656" aria-hidden="true" tabindex="-1"></a><span class="in">############ RCT </span></span>
<span id="cb66-1657"><a href="#cb66-1657" aria-hidden="true" tabindex="-1"></a><span class="in"># RCT1:  Random treatment assignment + independent censoring</span></span>
<span id="cb66-1658"><a href="#cb66-1658" aria-hidden="true" tabindex="-1"></a><span class="in"># RCT2:  Random treatment assignment + dependent censoring (conditional on X </span></span>
<span id="cb66-1659"><a href="#cb66-1659" aria-hidden="true" tabindex="-1"></a><span class="in"># and A)</span></span>
<span id="cb66-1660"><a href="#cb66-1660" aria-hidden="true" tabindex="-1"></a><span class="in">simulate_data_RCT &lt;- function(n, mu = c(1, 1, -1, 1), </span></span>
<span id="cb66-1661"><a href="#cb66-1661" aria-hidden="true" tabindex="-1"></a><span class="in">                              sigma = diag(4), </span></span>
<span id="cb66-1662"><a href="#cb66-1662" aria-hidden="true" tabindex="-1"></a><span class="in">                              colnames_cov = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-1663"><a href="#cb66-1663" aria-hidden="true" tabindex="-1"></a><span class="in">                              tau, </span></span>
<span id="cb66-1664"><a href="#cb66-1664" aria-hidden="true" tabindex="-1"></a><span class="in">                              coefT0 = 0.01,</span></span>
<span id="cb66-1665"><a href="#cb66-1665" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsS = c(0.5, 0.5, -0.5, 0.5), </span></span>
<span id="cb66-1666"><a href="#cb66-1666" aria-hidden="true" tabindex="-1"></a><span class="in">                              coefC = 0.03,</span></span>
<span id="cb66-1667"><a href="#cb66-1667" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsC = c(0.7, 0.3, -0.25, -0.1), </span></span>
<span id="cb66-1668"><a href="#cb66-1668" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsC_A = c(-0.2), </span></span>
<span id="cb66-1669"><a href="#cb66-1669" aria-hidden="true" tabindex="-1"></a><span class="in">                              scenario = "RCT2",</span></span>
<span id="cb66-1670"><a href="#cb66-1670" aria-hidden="true" tabindex="-1"></a><span class="in">                              mis_specification="none") {</span></span>
<span id="cb66-1671"><a href="#cb66-1671" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1672"><a href="#cb66-1672" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate X from a multivariate normal distribution</span></span>
<span id="cb66-1673"><a href="#cb66-1673" aria-hidden="true" tabindex="-1"></a><span class="in">  X &lt;- MASS::mvrnorm(n, mu, sigma)</span></span>
<span id="cb66-1674"><a href="#cb66-1674" aria-hidden="true" tabindex="-1"></a><span class="in">  X &lt;- as.data.frame(X)</span></span>
<span id="cb66-1675"><a href="#cb66-1675" aria-hidden="true" tabindex="-1"></a><span class="in">  colnames(X) &lt;- colnames_cov</span></span>
<span id="cb66-1676"><a href="#cb66-1676" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1677"><a href="#cb66-1677" aria-hidden="true" tabindex="-1"></a><span class="in">  # Treatment variable selection: all X</span></span>
<span id="cb66-1678"><a href="#cb66-1678" aria-hidden="true" tabindex="-1"></a><span class="in">  X_treatment &lt;- as.matrix(X)</span></span>
<span id="cb66-1679"><a href="#cb66-1679" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1680"><a href="#cb66-1680" aria-hidden="true" tabindex="-1"></a><span class="in">  # Propensity score: constant for random assignment</span></span>
<span id="cb66-1681"><a href="#cb66-1681" aria-hidden="true" tabindex="-1"></a><span class="in">  e &lt;- rep(0.5, n)</span></span>
<span id="cb66-1682"><a href="#cb66-1682" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1683"><a href="#cb66-1683" aria-hidden="true" tabindex="-1"></a><span class="in">  # Random treatment assignment</span></span>
<span id="cb66-1684"><a href="#cb66-1684" aria-hidden="true" tabindex="-1"></a><span class="in">  A &lt;- sapply(e, FUN = function(p) rbinom(1, 1, p))</span></span>
<span id="cb66-1685"><a href="#cb66-1685" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1686"><a href="#cb66-1686" aria-hidden="true" tabindex="-1"></a><span class="in">  # Outcome variable selection: all X</span></span>
<span id="cb66-1687"><a href="#cb66-1687" aria-hidden="true" tabindex="-1"></a><span class="in">  X_outcome &lt;- as.matrix(X)</span></span>
<span id="cb66-1688"><a href="#cb66-1688" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1689"><a href="#cb66-1689" aria-hidden="true" tabindex="-1"></a><span class="in">  # Simulate the outcome using the cumulative hazard inversion method</span></span>
<span id="cb66-1690"><a href="#cb66-1690" aria-hidden="true" tabindex="-1"></a><span class="in">  epsilon &lt;- runif(n, min = 1e-8, max = 1)</span></span>
<span id="cb66-1691"><a href="#cb66-1691" aria-hidden="true" tabindex="-1"></a><span class="in">  T0 &lt;- -log(epsilon) / (coefT0 * exp(X_outcome %*% parsS))</span></span>
<span id="cb66-1692"><a href="#cb66-1692" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1693"><a href="#cb66-1693" aria-hidden="true" tabindex="-1"></a><span class="in">  if (scenario == "RCT1") {</span></span>
<span id="cb66-1694"><a href="#cb66-1694" aria-hidden="true" tabindex="-1"></a><span class="in">    # Simulate independent censoring time</span></span>
<span id="cb66-1695"><a href="#cb66-1695" aria-hidden="true" tabindex="-1"></a><span class="in">    epsilon &lt;- runif(n, min = 1e-8, max = 1)</span></span>
<span id="cb66-1696"><a href="#cb66-1696" aria-hidden="true" tabindex="-1"></a><span class="in">    C &lt;- -log(epsilon) / coefC</span></span>
<span id="cb66-1697"><a href="#cb66-1697" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-1698"><a href="#cb66-1698" aria-hidden="true" tabindex="-1"></a><span class="in">  else if (scenario == "RCT2") {</span></span>
<span id="cb66-1699"><a href="#cb66-1699" aria-hidden="true" tabindex="-1"></a><span class="in">    # Simulate dependent censoring time</span></span>
<span id="cb66-1700"><a href="#cb66-1700" aria-hidden="true" tabindex="-1"></a><span class="in">    X_censoring &lt;- as.matrix(cbind(X,A))</span></span>
<span id="cb66-1701"><a href="#cb66-1701" aria-hidden="true" tabindex="-1"></a><span class="in">    parsC &lt;- c(parsC,parsC_A)</span></span>
<span id="cb66-1702"><a href="#cb66-1702" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-1703"><a href="#cb66-1703" aria-hidden="true" tabindex="-1"></a><span class="in">    epsilon &lt;- runif(n, min = 1e-8, max = 1)</span></span>
<span id="cb66-1704"><a href="#cb66-1704" aria-hidden="true" tabindex="-1"></a><span class="in">    C &lt;- -log(epsilon) / (coefC * exp(rowSums(X_censoring %*% diag(parsC))))</span></span>
<span id="cb66-1705"><a href="#cb66-1705" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-1706"><a href="#cb66-1706" aria-hidden="true" tabindex="-1"></a><span class="in">  # T(1) = T(0) + 10</span></span>
<span id="cb66-1707"><a href="#cb66-1707" aria-hidden="true" tabindex="-1"></a><span class="in">  T1 &lt;- T0 + 10</span></span>
<span id="cb66-1708"><a href="#cb66-1708" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1709"><a href="#cb66-1709" aria-hidden="true" tabindex="-1"></a><span class="in">  # True survival time</span></span>
<span id="cb66-1710"><a href="#cb66-1710" aria-hidden="true" tabindex="-1"></a><span class="in">  T_true &lt;- A * T1 + (1 - A) * T0</span></span>
<span id="cb66-1711"><a href="#cb66-1711" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1712"><a href="#cb66-1712" aria-hidden="true" tabindex="-1"></a><span class="in">  # Observed time</span></span>
<span id="cb66-1713"><a href="#cb66-1713" aria-hidden="true" tabindex="-1"></a><span class="in">  T_obs &lt;- pmin(T_true, C)</span></span>
<span id="cb66-1714"><a href="#cb66-1714" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1715"><a href="#cb66-1715" aria-hidden="true" tabindex="-1"></a><span class="in">  # Status indicator</span></span>
<span id="cb66-1716"><a href="#cb66-1716" aria-hidden="true" tabindex="-1"></a><span class="in">  status &lt;- as.numeric(T_true &lt;= C)</span></span>
<span id="cb66-1717"><a href="#cb66-1717" aria-hidden="true" tabindex="-1"></a><span class="in">  censor.status &lt;- as.numeric(T_true &gt; C)</span></span>
<span id="cb66-1718"><a href="#cb66-1718" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1719"><a href="#cb66-1719" aria-hidden="true" tabindex="-1"></a><span class="in">  # Restricted survival time</span></span>
<span id="cb66-1720"><a href="#cb66-1720" aria-hidden="true" tabindex="-1"></a><span class="in">  T_obs_tau &lt;- pmin(T_obs, tau)</span></span>
<span id="cb66-1721"><a href="#cb66-1721" aria-hidden="true" tabindex="-1"></a><span class="in">  status_tau &lt;- as.numeric((T_obs &gt; tau) | (T_obs &lt;= tau &amp; status == 1))</span></span>
<span id="cb66-1722"><a href="#cb66-1722" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1723"><a href="#cb66-1723" aria-hidden="true" tabindex="-1"></a><span class="in">  # Combine all data into a single data frame</span></span>
<span id="cb66-1724"><a href="#cb66-1724" aria-hidden="true" tabindex="-1"></a><span class="in">  data_target_population &lt;- data.frame(X, tau, A, T0, T1, C, T_obs, T_obs_tau, </span></span>
<span id="cb66-1725"><a href="#cb66-1725" aria-hidden="true" tabindex="-1"></a><span class="in">                                       status, censor.status, status_tau, e)</span></span>
<span id="cb66-1726"><a href="#cb66-1726" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1727"><a href="#cb66-1727" aria-hidden="true" tabindex="-1"></a><span class="in">  return(data_target_population)</span></span>
<span id="cb66-1728"><a href="#cb66-1728" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1729"><a href="#cb66-1729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1730"><a href="#cb66-1730" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1731"><a href="#cb66-1731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1732"><a href="#cb66-1732" aria-hidden="true" tabindex="-1"></a>The descriptive statistics of the two datasets are displayed in Annex (@sec-stat_RCT).</span>
<span id="cb66-1733"><a href="#cb66-1733" aria-hidden="true" tabindex="-1"></a>The graph of the difference in RMST as a function of $\tau$ for the two scenarii are displayed below; $\theta_{\mathrm{RMST}}$ is the same in both</span>
<span id="cb66-1734"><a href="#cb66-1734" aria-hidden="true" tabindex="-1"></a>setting. </span>
<span id="cb66-1735"><a href="#cb66-1735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1736"><a href="#cb66-1736" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1737"><a href="#cb66-1737" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to calculate ground truth for RCT and Observational data</span></span>
<span id="cb66-1738"><a href="#cb66-1738" aria-hidden="true" tabindex="-1"></a><span class="in">ground_truth &lt;- function(tau, </span></span>
<span id="cb66-1739"><a href="#cb66-1739" aria-hidden="true" tabindex="-1"></a><span class="in">                         data) {</span></span>
<span id="cb66-1740"><a href="#cb66-1740" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute RMST with the true T1</span></span>
<span id="cb66-1741"><a href="#cb66-1741" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T1_tau &lt;- ifelse(data$T1 &gt;= tau, tau, data$T1)</span></span>
<span id="cb66-1742"><a href="#cb66-1742" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1743"><a href="#cb66-1743" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute RMST with the true T0</span></span>
<span id="cb66-1744"><a href="#cb66-1744" aria-hidden="true" tabindex="-1"></a><span class="in">  data$T0_tau &lt;- ifelse(data$T0 &gt;= tau, tau, data$T0)</span></span>
<span id="cb66-1745"><a href="#cb66-1745" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1746"><a href="#cb66-1746" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute the difference in RMST if everyone had the treatment </span></span>
<span id="cb66-1747"><a href="#cb66-1747" aria-hidden="true" tabindex="-1"></a><span class="in">  # and if everyone had the control</span></span>
<span id="cb66-1748"><a href="#cb66-1748" aria-hidden="true" tabindex="-1"></a><span class="in">  truth &lt;- mean(data$T1_tau) - mean(data$T0_tau)</span></span>
<span id="cb66-1749"><a href="#cb66-1749" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-1750"><a href="#cb66-1750" aria-hidden="true" tabindex="-1"></a><span class="in">  return(truth)</span></span>
<span id="cb66-1751"><a href="#cb66-1751" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1752"><a href="#cb66-1752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1753"><a href="#cb66-1753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1754"><a href="#cb66-1754" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-1755"><a href="#cb66-1755" aria-hidden="true" tabindex="-1"></a><span class="in"># Set initial tau value</span></span>
<span id="cb66-1756"><a href="#cb66-1756" aria-hidden="true" tabindex="-1"></a><span class="in">tau &lt;- 25</span></span>
<span id="cb66-1757"><a href="#cb66-1757" aria-hidden="true" tabindex="-1"></a><span class="in"># Define vector of tau values</span></span>
<span id="cb66-1758"><a href="#cb66-1758" aria-hidden="true" tabindex="-1"></a><span class="in">vec_tau &lt;- seq(1, 150, by = 1)</span></span>
<span id="cb66-1759"><a href="#cb66-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1760"><a href="#cb66-1760" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to plot the ground truth RMST for different scenarios</span></span>
<span id="cb66-1761"><a href="#cb66-1761" aria-hidden="true" tabindex="-1"></a><span class="in">plot_ground_truth &lt;- function(data, vec_tau, tau, ylim, title_text) {</span></span>
<span id="cb66-1762"><a href="#cb66-1762" aria-hidden="true" tabindex="-1"></a><span class="in">  truth &lt;- sapply(vec_tau, function(x) ground_truth(tau = x, data))</span></span>
<span id="cb66-1763"><a href="#cb66-1763" aria-hidden="true" tabindex="-1"></a><span class="in">  matplot(</span></span>
<span id="cb66-1764"><a href="#cb66-1764" aria-hidden="true" tabindex="-1"></a><span class="in">    vec_tau, truth, type = "l", lty = 1, col = 1,</span></span>
<span id="cb66-1765"><a href="#cb66-1765" aria-hidden="true" tabindex="-1"></a><span class="in">    ylab = "RMST", xlab = "tau", ylim = ylim</span></span>
<span id="cb66-1766"><a href="#cb66-1766" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb66-1767"><a href="#cb66-1767" aria-hidden="true" tabindex="-1"></a><span class="in">  abline(v = tau, col = "red", lty = 2)</span></span>
<span id="cb66-1768"><a href="#cb66-1768" aria-hidden="true" tabindex="-1"></a><span class="in">  abline(h = truth[vec_tau == tau], col = "red", lty = 2)</span></span>
<span id="cb66-1769"><a href="#cb66-1769" aria-hidden="true" tabindex="-1"></a><span class="in">  title(title_text, cex.main = 0.9)  # Adjusting title text size</span></span>
<span id="cb66-1770"><a href="#cb66-1770" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-1771"><a href="#cb66-1771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1772"><a href="#cb66-1772" aria-hidden="true" tabindex="-1"></a><span class="in"># Simulation for scenario RCT1</span></span>
<span id="cb66-1773"><a href="#cb66-1773" aria-hidden="true" tabindex="-1"></a><span class="in">data_RCT1 &lt;- simulate_data_RCT(</span></span>
<span id="cb66-1774"><a href="#cb66-1774" aria-hidden="true" tabindex="-1"></a><span class="in">  n = 100000, tau = tau, scenario = "RCT1")</span></span>
<span id="cb66-1775"><a href="#cb66-1775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1776"><a href="#cb66-1776" aria-hidden="true" tabindex="-1"></a><span class="in">plot_ground_truth(data_RCT1, </span></span>
<span id="cb66-1777"><a href="#cb66-1777" aria-hidden="true" tabindex="-1"></a><span class="in">                  vec_tau, </span></span>
<span id="cb66-1778"><a href="#cb66-1778" aria-hidden="true" tabindex="-1"></a><span class="in">                  tau, </span></span>
<span id="cb66-1779"><a href="#cb66-1779" aria-hidden="true" tabindex="-1"></a><span class="in">                  c(0, 10), </span></span>
<span id="cb66-1780"><a href="#cb66-1780" aria-hidden="true" tabindex="-1"></a><span class="in">                  "True difference in RMST for RCT scenario 1")</span></span>
<span id="cb66-1781"><a href="#cb66-1781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1782"><a href="#cb66-1782" aria-hidden="true" tabindex="-1"></a><span class="in">truth_tau1 &lt;- ground_truth(data_RCT1, tau = 25)</span></span>
<span id="cb66-1783"><a href="#cb66-1783" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste0("The ground truth for RCT scenario 1 and 2 at time 25 is ", round(truth_tau1, 1)))</span></span>
<span id="cb66-1784"><a href="#cb66-1784" aria-hidden="true" tabindex="-1"></a><span class="in">truth_tau2 &lt;- truth_tau1</span></span>
<span id="cb66-1785"><a href="#cb66-1785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1786"><a href="#cb66-1786" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-1787"><a href="#cb66-1787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1788"><a href="#cb66-1788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1789"><a href="#cb66-1789" aria-hidden="true" tabindex="-1"></a>**Estimation of the RMST**</span>
<span id="cb66-1790"><a href="#cb66-1790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1791"><a href="#cb66-1791" aria-hidden="true" tabindex="-1"></a>For each Scenario, we estimate the difference in RMST using the methods summarized in @sec-summary. The methods used to estimate the nuisance components are indicated in brackets: either logistic regression or random forests for propensity scores and either cox models or survival random forests for survival and censoring models.  A naive estimator where censored observations are simply removed and the survival time is averaged for treated and controls is also provided for a naive baseline.</span>
<span id="cb66-1792"><a href="#cb66-1792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1793"><a href="#cb66-1793" aria-hidden="true" tabindex="-1"></a>@fig-rct1 shows the distribution of the difference in RMST for 100 simulations in Scenario 1 and different sample sizes: 500, 1000, 2000, 4000. The  true value of $\theta_{\mathrm{RMST}}$ is indicated by red dotted line.</span>
<span id="cb66-1794"><a href="#cb66-1794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-1797"><a href="#cb66-1797" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-1798"><a href="#cb66-1798" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to launch the previous implemented functions in a </span></span>
<span id="cb66-1799"><a href="#cb66-1799" aria-hidden="true" tabindex="-1"></a><span class="co"># specified scenario, sample size.</span></span>
<span id="cb66-1800"><a href="#cb66-1800" aria-hidden="true" tabindex="-1"></a>all_estimates <span class="ot">&lt;-</span> <span class="cf">function</span>(data, sample.size, tau, </span>
<span id="cb66-1801"><a href="#cb66-1801" aria-hidden="true" tabindex="-1"></a>                           X.names.propensity,</span>
<span id="cb66-1802"><a href="#cb66-1802" aria-hidden="true" tabindex="-1"></a>                           X.names.censoring,</span>
<span id="cb66-1803"><a href="#cb66-1803" aria-hidden="true" tabindex="-1"></a>                           X.names.outcome,</span>
<span id="cb66-1804"><a href="#cb66-1804" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>, </span>
<span id="cb66-1805"><a href="#cb66-1805" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb66-1806"><a href="#cb66-1806" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb66-1807"><a href="#cb66-1807" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds =</span> <span class="cn">NULL</span>,</span>
<span id="cb66-1808"><a href="#cb66-1808" aria-hidden="true" tabindex="-1"></a>                           <span class="at">estimator =</span> <span class="st">"all"</span>) {</span>
<span id="cb66-1809"><a href="#cb66-1809" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1810"><a href="#cb66-1810" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of available estimators</span></span>
<span id="cb66-1811"><a href="#cb66-1811" aria-hidden="true" tabindex="-1"></a>  available_estimators <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb66-1812"><a href="#cb66-1812" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Naive"</span>, <span class="st">"KM"</span>, <span class="st">"IPTW KM"</span>, <span class="st">"IPCW KM"</span>, <span class="st">"BJ"</span>, </span>
<span id="cb66-1813"><a href="#cb66-1813" aria-hidden="true" tabindex="-1"></a>    <span class="st">"IPTW-IPCW KM"</span>, <span class="st">"IPTW-BJ"</span>, <span class="st">"G_formula (T-learners)"</span>, </span>
<span id="cb66-1814"><a href="#cb66-1814" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G_formula (S-learner)"</span>, <span class="st">"AIPTW-AIPCW"</span>, <span class="st">"SurvRM2 - KM"</span>, </span>
<span id="cb66-1815"><a href="#cb66-1815" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grf - Causal Survival Forest"</span>, <span class="st">"RISCA - IPTW KM"</span>, </span>
<span id="cb66-1816"><a href="#cb66-1816" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RISCA - G_formula (S-learner)"</span></span>
<span id="cb66-1817"><a href="#cb66-1817" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-1818"><a href="#cb66-1818" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1819"><a href="#cb66-1819" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If estimator is "all", we select all the estimators in </span></span>
<span id="cb66-1820"><a href="#cb66-1820" aria-hidden="true" tabindex="-1"></a>  <span class="co"># available_estimators</span></span>
<span id="cb66-1821"><a href="#cb66-1821" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"all"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1822"><a href="#cb66-1822" aria-hidden="true" tabindex="-1"></a>    estimator <span class="ot">&lt;-</span> available_estimators</span>
<span id="cb66-1823"><a href="#cb66-1823" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1824"><a href="#cb66-1824" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1825"><a href="#cb66-1825" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter the selected estimators</span></span>
<span id="cb66-1826"><a href="#cb66-1826" aria-hidden="true" tabindex="-1"></a>  estimator <span class="ot">&lt;-</span> <span class="fu">intersect</span>(estimator, available_estimators)</span>
<span id="cb66-1827"><a href="#cb66-1827" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1828"><a href="#cb66-1828" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the results in a data frame</span></span>
<span id="cb66-1829"><a href="#cb66-1829" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb66-1830"><a href="#cb66-1830" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample.size"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb66-1831"><a href="#cb66-1831" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimate"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb66-1832"><a href="#cb66-1832" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimator"</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb66-1833"><a href="#cb66-1833" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">character</span>()</span>
<span id="cb66-1834"><a href="#cb66-1834" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-1835"><a href="#cb66-1835" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1836"><a href="#cb66-1836" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to extract variable names from I() for squared terms and interaction terms</span></span>
<span id="cb66-1837"><a href="#cb66-1837" aria-hidden="true" tabindex="-1"></a>  extract_vars <span class="ot">&lt;-</span> <span class="cf">function</span>(names) {</span>
<span id="cb66-1838"><a href="#cb66-1838" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract names from squared terms</span></span>
<span id="cb66-1839"><a href="#cb66-1839" aria-hidden="true" tabindex="-1"></a>    extracted_squared <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"I</span><span class="sc">\\</span><span class="st">((.*)</span><span class="sc">\\</span><span class="st">^2</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, names)  <span class="co"># Replace "I(X^2)" with "X"</span></span>
<span id="cb66-1840"><a href="#cb66-1840" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract names from interaction terms (e.g., "X1:X2" becomes "X1" and "X2")</span></span>
<span id="cb66-1841"><a href="#cb66-1841" aria-hidden="true" tabindex="-1"></a>    result_vector <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(extracted_squared, <span class="st">":"</span>)))</span>
<span id="cb66-1842"><a href="#cb66-1842" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">unique</span>(result_vector))</span>
<span id="cb66-1843"><a href="#cb66-1843" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1844"><a href="#cb66-1844" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all vectors</span></span>
<span id="cb66-1845"><a href="#cb66-1845" aria-hidden="true" tabindex="-1"></a>  all_names <span class="ot">&lt;-</span> <span class="fu">c</span>(X.names.propensity, X.names.outcome, X.names.censoring)</span>
<span id="cb66-1846"><a href="#cb66-1846" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply the extraction function</span></span>
<span id="cb66-1847"><a href="#cb66-1847" aria-hidden="true" tabindex="-1"></a>  X.names <span class="ot">&lt;-</span> <span class="fu">extract_vars</span>(all_names)</span>
<span id="cb66-1848"><a href="#cb66-1848" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1849"><a href="#cb66-1849" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each estimator is computed if selected</span></span>
<span id="cb66-1850"><a href="#cb66-1850" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Naive estimator</span></span>
<span id="cb66-1851"><a href="#cb66-1851" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"Naive"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1852"><a href="#cb66-1852" aria-hidden="true" tabindex="-1"></a>    ATE_naive <span class="ot">&lt;-</span> <span class="fu">Naive</span>(data, tau)</span>
<span id="cb66-1853"><a href="#cb66-1853" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1854"><a href="#cb66-1854" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_naive, </span>
<span id="cb66-1855"><a href="#cb66-1855" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"Naive"</span>, <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb66-1856"><a href="#cb66-1856" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb66-1857"><a href="#cb66-1857" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1858"><a href="#cb66-1858" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with undajusted KM</span></span>
<span id="cb66-1859"><a href="#cb66-1859" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1860"><a href="#cb66-1860" aria-hidden="true" tabindex="-1"></a>    ATE_km_rct <span class="ot">&lt;-</span> <span class="fu">RMST_1</span>(data, <span class="at">tau =</span> tau)</span>
<span id="cb66-1861"><a href="#cb66-1861" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1862"><a href="#cb66-1862" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_km_rct<span class="sc">$</span>RMST, </span>
<span id="cb66-1863"><a href="#cb66-1863" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"KM"</span>, <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb66-1864"><a href="#cb66-1864" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb66-1865"><a href="#cb66-1865" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1866"><a href="#cb66-1866" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPTW KM</span></span>
<span id="cb66-1867"><a href="#cb66-1867" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPTW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1868"><a href="#cb66-1868" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb66-1869"><a href="#cb66-1869" aria-hidden="true" tabindex="-1"></a>      ATE_km_adj <span class="ot">&lt;-</span> <span class="fu">IPTW_Kaplan_meier</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb66-1870"><a href="#cb66-1870" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-1871"><a href="#cb66-1871" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb66-1872"><a href="#cb66-1872" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-1873"><a href="#cb66-1873" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1874"><a href="#cb66-1874" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb66-1875"><a href="#cb66-1875" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW KM ("</span>, propensity_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-1876"><a href="#cb66-1876" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1877"><a href="#cb66-1877" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_km_adj<span class="sc">$</span>RMST, </span>
<span id="cb66-1878"><a href="#cb66-1878" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, <span class="st">"nuisance"</span> <span class="ot">=</span> propensity_method</span>
<span id="cb66-1879"><a href="#cb66-1879" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb66-1880"><a href="#cb66-1880" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-1881"><a href="#cb66-1881" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1882"><a href="#cb66-1882" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1883"><a href="#cb66-1883" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPCW KM</span></span>
<span id="cb66-1884"><a href="#cb66-1884" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPCW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1885"><a href="#cb66-1885" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (censoring_method <span class="cf">in</span> nuisance_censoring) {</span>
<span id="cb66-1886"><a href="#cb66-1886" aria-hidden="true" tabindex="-1"></a>      ATE_IPCW <span class="ot">&lt;-</span> <span class="fu">IPCW_Kaplan_meier</span>(data, <span class="at">X.names.censoring =</span> X.names.censoring, </span>
<span id="cb66-1887"><a href="#cb66-1887" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">tau =</span> tau, </span>
<span id="cb66-1888"><a href="#cb66-1888" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">nuisance_censoring =</span> censoring_method, </span>
<span id="cb66-1889"><a href="#cb66-1889" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-1890"><a href="#cb66-1890" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (censoring_method <span class="sc">==</span> <span class="st">"survival forest"</span>){censoring_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1891"><a href="#cb66-1891" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{censoring_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-1892"><a href="#cb66-1892" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPCW KM ("</span>, censoring_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-1893"><a href="#cb66-1893" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1894"><a href="#cb66-1894" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_IPCW<span class="sc">$</span>RMST, </span>
<span id="cb66-1895"><a href="#cb66-1895" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name , <span class="st">"nuisance"</span> <span class="ot">=</span> censoring_method</span>
<span id="cb66-1896"><a href="#cb66-1896" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb66-1897"><a href="#cb66-1897" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-1898"><a href="#cb66-1898" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1899"><a href="#cb66-1899" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with BJ pseudo observations</span></span>
<span id="cb66-1900"><a href="#cb66-1900" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"BJ"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1901"><a href="#cb66-1901" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb66-1902"><a href="#cb66-1902" aria-hidden="true" tabindex="-1"></a>      ATE_bj <span class="ot">&lt;-</span> <span class="fu">BJ</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb66-1903"><a href="#cb66-1903" aria-hidden="true" tabindex="-1"></a>                   <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb66-1904"><a href="#cb66-1904" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nuisance =</span> survival_method, </span>
<span id="cb66-1905"><a href="#cb66-1905" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-1906"><a href="#cb66-1906" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1907"><a href="#cb66-1907" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-1908"><a href="#cb66-1908" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"BJ ("</span>, survival_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-1909"><a href="#cb66-1909" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1910"><a href="#cb66-1910" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_bj<span class="sc">$</span>RMST, </span>
<span id="cb66-1911"><a href="#cb66-1911" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, <span class="st">"nuisance"</span> <span class="ot">=</span> survival_method</span>
<span id="cb66-1912"><a href="#cb66-1912" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb66-1913"><a href="#cb66-1913" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-1914"><a href="#cb66-1914" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1915"><a href="#cb66-1915" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1916"><a href="#cb66-1916" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with g-formula two-learners</span></span>
<span id="cb66-1917"><a href="#cb66-1917" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"G_formula (T-learners)"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1918"><a href="#cb66-1918" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb66-1919"><a href="#cb66-1919" aria-hidden="true" tabindex="-1"></a>      ATE_g_formula_t <span class="ot">&lt;-</span> <span class="fu">g_formula_T_learner</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb66-1920"><a href="#cb66-1920" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.outcome =</span> X.names.outcome, </span>
<span id="cb66-1921"><a href="#cb66-1921" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_survival =</span> survival_method, </span>
<span id="cb66-1922"><a href="#cb66-1922" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-1923"><a href="#cb66-1923" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1924"><a href="#cb66-1924" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-1925"><a href="#cb66-1925" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"G-formula ("</span>, survival_name, <span class="st">"/ T-learners)"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-1926"><a href="#cb66-1926" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1927"><a href="#cb66-1927" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_g_formula_t, </span>
<span id="cb66-1928"><a href="#cb66-1928" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb66-1929"><a href="#cb66-1929" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nuisance"</span> <span class="ot">=</span> survival_method</span>
<span id="cb66-1930"><a href="#cb66-1930" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb66-1931"><a href="#cb66-1931" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-1932"><a href="#cb66-1932" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1933"><a href="#cb66-1933" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1934"><a href="#cb66-1934" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with g-formula single learner</span></span>
<span id="cb66-1935"><a href="#cb66-1935" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"G_formula (S-learner)"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1936"><a href="#cb66-1936" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb66-1937"><a href="#cb66-1937" aria-hidden="true" tabindex="-1"></a>      ATE_g_formula_s <span class="ot">&lt;-</span> <span class="fu">g_formula_S_learner</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb66-1938"><a href="#cb66-1938" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.outcome =</span> X.names.outcome, </span>
<span id="cb66-1939"><a href="#cb66-1939" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_survival =</span> survival_method, </span>
<span id="cb66-1940"><a href="#cb66-1940" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-1941"><a href="#cb66-1941" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1942"><a href="#cb66-1942" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-1943"><a href="#cb66-1943" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"G-formula ("</span>, survival_name, <span class="st">"/ S-learner)"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-1944"><a href="#cb66-1944" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1945"><a href="#cb66-1945" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_g_formula_s, </span>
<span id="cb66-1946"><a href="#cb66-1946" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb66-1947"><a href="#cb66-1947" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nuisance"</span> <span class="ot">=</span> survival_method</span>
<span id="cb66-1948"><a href="#cb66-1948" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb66-1949"><a href="#cb66-1949" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-1950"><a href="#cb66-1950" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1951"><a href="#cb66-1951" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1952"><a href="#cb66-1952" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1953"><a href="#cb66-1953" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPTW with pseudo observations (BJ transformation)</span></span>
<span id="cb66-1954"><a href="#cb66-1954" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPTW-BJ"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1955"><a href="#cb66-1955" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb66-1956"><a href="#cb66-1956" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb66-1957"><a href="#cb66-1957" aria-hidden="true" tabindex="-1"></a>        ATE_IPTW_bj <span class="ot">&lt;-</span> <span class="fu">IPTW_BJ</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb66-1958"><a href="#cb66-1958" aria-hidden="true" tabindex="-1"></a>                               <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-1959"><a href="#cb66-1959" aria-hidden="true" tabindex="-1"></a>                               <span class="at">X.names.outcome =</span> X.names.outcome, </span>
<span id="cb66-1960"><a href="#cb66-1960" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb66-1961"><a href="#cb66-1961" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nuisance =</span> survival_method, </span>
<span id="cb66-1962"><a href="#cb66-1962" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-1963"><a href="#cb66-1963" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1964"><a href="#cb66-1964" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-1965"><a href="#cb66-1965" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1966"><a href="#cb66-1966" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb66-1967"><a href="#cb66-1967" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_name  <span class="sc">==</span> survival_name){</span>
<span id="cb66-1968"><a href="#cb66-1968" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-BJ ("</span>, survival_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-1969"><a href="#cb66-1969" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb66-1970"><a href="#cb66-1970" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{</span>
<span id="cb66-1971"><a href="#cb66-1971" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-BJ ("</span>, survival_name,<span class="st">" &amp; "</span>, propensity_name , <span class="st">")"</span>, </span>
<span id="cb66-1972"><a href="#cb66-1972" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sep =</span> <span class="st">""</span>)}</span>
<span id="cb66-1973"><a href="#cb66-1973" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-1974"><a href="#cb66-1974" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-1975"><a href="#cb66-1975" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-1976"><a href="#cb66-1976" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_IPTW_bj, </span>
<span id="cb66-1977"><a href="#cb66-1977" aria-hidden="true" tabindex="-1"></a>          <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb66-1978"><a href="#cb66-1978" aria-hidden="true" tabindex="-1"></a>          <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">paste</span>(survival_method, propensity_method, <span class="at">sep =</span> <span class="st">", "</span>)</span>
<span id="cb66-1979"><a href="#cb66-1979" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb66-1980"><a href="#cb66-1980" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-1981"><a href="#cb66-1981" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-1982"><a href="#cb66-1982" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-1983"><a href="#cb66-1983" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-1984"><a href="#cb66-1984" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with IPTW-IPCW KM</span></span>
<span id="cb66-1985"><a href="#cb66-1985" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"IPTW-IPCW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-1986"><a href="#cb66-1986" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (censoring_method <span class="cf">in</span> nuisance_censoring) {</span>
<span id="cb66-1987"><a href="#cb66-1987" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb66-1988"><a href="#cb66-1988" aria-hidden="true" tabindex="-1"></a>        ATE_iptw_ipcw_km <span class="ot">&lt;-</span> <span class="fu">IPTW_IPCW_Kaplan_meier</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb66-1989"><a href="#cb66-1989" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-1990"><a href="#cb66-1990" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">X.names.censoring =</span> X.names.censoring, </span>
<span id="cb66-1991"><a href="#cb66-1991" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb66-1992"><a href="#cb66-1992" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">nuisance_censoring =</span> censoring_method, </span>
<span id="cb66-1993"><a href="#cb66-1993" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-1994"><a href="#cb66-1994" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (censoring_method <span class="sc">==</span> <span class="st">"survival forest"</span>){censoring_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1995"><a href="#cb66-1995" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{censoring_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-1996"><a href="#cb66-1996" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-1997"><a href="#cb66-1997" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb66-1998"><a href="#cb66-1998" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (propensity_name  <span class="sc">==</span> censoring_name){</span>
<span id="cb66-1999"><a href="#cb66-1999" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-IPCW KM ("</span>, censoring_name , <span class="st">")"</span>, </span>
<span id="cb66-2000"><a href="#cb66-2000" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-2001"><a href="#cb66-2001" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb66-2002"><a href="#cb66-2002" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{</span>
<span id="cb66-2003"><a href="#cb66-2003" aria-hidden="true" tabindex="-1"></a>          est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"IPTW-IPCW KM ("</span>, censoring_name,<span class="st">" &amp; "</span>, propensity_name , <span class="st">")"</span>, </span>
<span id="cb66-2004"><a href="#cb66-2004" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sep =</span> <span class="st">""</span>)}</span>
<span id="cb66-2005"><a href="#cb66-2005" aria-hidden="true" tabindex="-1"></a>        results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-2006"><a href="#cb66-2006" aria-hidden="true" tabindex="-1"></a>          <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_iptw_ipcw_km<span class="sc">$</span>RMST, </span>
<span id="cb66-2007"><a href="#cb66-2007" aria-hidden="true" tabindex="-1"></a>          <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb66-2008"><a href="#cb66-2008" aria-hidden="true" tabindex="-1"></a>          <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">paste</span>(censoring_method, propensity_method, <span class="at">sep =</span> <span class="st">", "</span>)</span>
<span id="cb66-2009"><a href="#cb66-2009" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb66-2010"><a href="#cb66-2010" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-2011"><a href="#cb66-2011" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-2012"><a href="#cb66-2012" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2013"><a href="#cb66-2013" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2014"><a href="#cb66-2014" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2015"><a href="#cb66-2015" aria-hidden="true" tabindex="-1"></a>  <span class="co"># RMST estimate with AIPTW with pseudo observations (AIPCW transformation)</span></span>
<span id="cb66-2016"><a href="#cb66-2016" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"AIPTW-AIPCW"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-2017"><a href="#cb66-2017" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (survival_method <span class="cf">in</span> nuisance_survival) {</span>
<span id="cb66-2018"><a href="#cb66-2018" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb66-2019"><a href="#cb66-2019" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (censoring_method <span class="cf">in</span> nuisance_censoring) {</span>
<span id="cb66-2020"><a href="#cb66-2020" aria-hidden="true" tabindex="-1"></a>          ATE_aiptw_aipcw <span class="ot">&lt;-</span> <span class="fu">AIPTW_AIPCW</span>(data, <span class="at">tau =</span> tau, </span>
<span id="cb66-2021"><a href="#cb66-2021" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-2022"><a href="#cb66-2022" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">X.names.censoring =</span> X.names.censoring, </span>
<span id="cb66-2023"><a href="#cb66-2023" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb66-2024"><a href="#cb66-2024" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">nuisance_propensity =</span> propensity_method, </span>
<span id="cb66-2025"><a href="#cb66-2025" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">nuisance_censoring =</span> censoring_method, </span>
<span id="cb66-2026"><a href="#cb66-2026" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">nuisance_Qt =</span> survival_method, </span>
<span id="cb66-2027"><a href="#cb66-2027" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">n.folds =</span> n.folds)</span>
<span id="cb66-2028"><a href="#cb66-2028" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (survival_method <span class="sc">==</span> <span class="st">"survival forest"</span>){survival_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-2029"><a href="#cb66-2029" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{survival_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-2030"><a href="#cb66-2030" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){</span>
<span id="cb66-2031"><a href="#cb66-2031" aria-hidden="true" tabindex="-1"></a>            propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-2032"><a href="#cb66-2032" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb66-2033"><a href="#cb66-2033" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (censoring_method <span class="sc">==</span> <span class="st">"survival forest"</span>){</span>
<span id="cb66-2034"><a href="#cb66-2034" aria-hidden="true" tabindex="-1"></a>            censoring_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-2035"><a href="#cb66-2035" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{censoring_name <span class="ot">=</span> <span class="st">"Cox"</span>}</span>
<span id="cb66-2036"><a href="#cb66-2036" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (censoring_name <span class="sc">==</span> propensity_name <span class="sc">&amp;</span> censoring_name <span class="sc">==</span> survival_name){</span>
<span id="cb66-2037"><a href="#cb66-2037" aria-hidden="true" tabindex="-1"></a>            est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"AIPTW-AIPCW ("</span>, survival_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-2038"><a href="#cb66-2038" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb66-2039"><a href="#cb66-2039" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{</span>
<span id="cb66-2040"><a href="#cb66-2040" aria-hidden="true" tabindex="-1"></a>            est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"AIPTW-AIPCW ("</span>, survival_name,<span class="st">" &amp; "</span>, </span>
<span id="cb66-2041"><a href="#cb66-2041" aria-hidden="true" tabindex="-1"></a>                              censoring_name ,<span class="st">" &amp; "</span>, propensity_name , <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)}</span>
<span id="cb66-2042"><a href="#cb66-2042" aria-hidden="true" tabindex="-1"></a>          results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-2043"><a href="#cb66-2043" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, </span>
<span id="cb66-2044"><a href="#cb66-2044" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimate"</span> <span class="ot">=</span> ATE_aiptw_aipcw<span class="sc">$</span>AIPTW_AIPCW_IPW_res, </span>
<span id="cb66-2045"><a href="#cb66-2045" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb66-2046"><a href="#cb66-2046" aria-hidden="true" tabindex="-1"></a>            <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">paste</span>(survival_method, </span>
<span id="cb66-2047"><a href="#cb66-2047" aria-hidden="true" tabindex="-1"></a>                               censoring_method, </span>
<span id="cb66-2048"><a href="#cb66-2048" aria-hidden="true" tabindex="-1"></a>                               propensity_method , <span class="at">sep =</span> <span class="st">", "</span>)</span>
<span id="cb66-2049"><a href="#cb66-2049" aria-hidden="true" tabindex="-1"></a>          ))</span>
<span id="cb66-2050"><a href="#cb66-2050" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb66-2051"><a href="#cb66-2051" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-2052"><a href="#cb66-2052" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-2053"><a href="#cb66-2053" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2054"><a href="#cb66-2054" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2055"><a href="#cb66-2055" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unadjusted estimate using package from SurvRM2</span></span>
<span id="cb66-2056"><a href="#cb66-2056" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"SurvRM2 - KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-2057"><a href="#cb66-2057" aria-hidden="true" tabindex="-1"></a>    ATE_pack <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb66-2058"><a href="#cb66-2058" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theta_rmst_survrm2</span>(data, <span class="at">tau =</span> tau)</span>
<span id="cb66-2059"><a href="#cb66-2059" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb66-2060"><a href="#cb66-2060" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error in ATE_pack: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb66-2061"><a href="#cb66-2061" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb66-2062"><a href="#cb66-2062" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb66-2063"><a href="#cb66-2063" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-2064"><a href="#cb66-2064" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_pack, </span>
<span id="cb66-2065"><a href="#cb66-2065" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"SurvRM2 - KM"</span>, <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb66-2066"><a href="#cb66-2066" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb66-2067"><a href="#cb66-2067" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2068"><a href="#cb66-2068" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate using survival random forest from grf</span></span>
<span id="cb66-2069"><a href="#cb66-2069" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CSF can have a misspecification only on all nuisance parameters</span></span>
<span id="cb66-2070"><a href="#cb66-2070" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"grf - Causal Survival Forest"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-2071"><a href="#cb66-2071" aria-hidden="true" tabindex="-1"></a>    ATE_RF <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb66-2072"><a href="#cb66-2072" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If there is no misspecification, X.names has to be defined as the </span></span>
<span id="cb66-2073"><a href="#cb66-2073" aria-hidden="true" tabindex="-1"></a>      <span class="co"># union of all the covariates which influence nuisance models</span></span>
<span id="cb66-2074"><a href="#cb66-2074" aria-hidden="true" tabindex="-1"></a>      <span class="fu">CSRF</span>(data, X.names, <span class="at">tau =</span> tau)</span>
<span id="cb66-2075"><a href="#cb66-2075" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb66-2076"><a href="#cb66-2076" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error in ATE_RF: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb66-2077"><a href="#cb66-2077" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb66-2078"><a href="#cb66-2078" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb66-2079"><a href="#cb66-2079" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-2080"><a href="#cb66-2080" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_RF, </span>
<span id="cb66-2081"><a href="#cb66-2081" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"grf - Causal Survival Forest"</span>, </span>
<span id="cb66-2082"><a href="#cb66-2082" aria-hidden="true" tabindex="-1"></a>      <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb66-2083"><a href="#cb66-2083" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb66-2084"><a href="#cb66-2084" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2085"><a href="#cb66-2085" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2086"><a href="#cb66-2086" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"RISCA - IPTW KM"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-2087"><a href="#cb66-2087" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (propensity_method <span class="cf">in</span> nuisance_propensity) {</span>
<span id="cb66-2088"><a href="#cb66-2088" aria-hidden="true" tabindex="-1"></a>      <span class="co"># IPTW estimate from RISCA</span></span>
<span id="cb66-2089"><a href="#cb66-2089" aria-hidden="true" tabindex="-1"></a>      ATE_RISCA_iptw <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb66-2090"><a href="#cb66-2090" aria-hidden="true" tabindex="-1"></a>        <span class="fu">RISCA_iptw</span>(data, X.names.propensity, propensity_method, <span class="at">tau =</span> tau, </span>
<span id="cb66-2091"><a href="#cb66-2091" aria-hidden="true" tabindex="-1"></a>                   <span class="at">n.folds=</span>n.folds)</span>
<span id="cb66-2092"><a href="#cb66-2092" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb66-2093"><a href="#cb66-2093" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Error in ATE_RISCA_iptw: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb66-2094"><a href="#cb66-2094" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb66-2095"><a href="#cb66-2095" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb66-2096"><a href="#cb66-2096" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (propensity_method <span class="sc">==</span> <span class="st">"probability forest"</span>){propensity_name <span class="ot">=</span> <span class="st">"Forest"</span>}</span>
<span id="cb66-2097"><a href="#cb66-2097" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{propensity_name <span class="ot">=</span> <span class="st">"Log. Reg."</span>}</span>
<span id="cb66-2098"><a href="#cb66-2098" aria-hidden="true" tabindex="-1"></a>      est_name <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"RISCA - IPTW KM ("</span>, propensity_name, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb66-2099"><a href="#cb66-2099" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-2100"><a href="#cb66-2100" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_RISCA_iptw, </span>
<span id="cb66-2101"><a href="#cb66-2101" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span> <span class="ot">=</span> est_name, </span>
<span id="cb66-2102"><a href="#cb66-2102" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nuisance"</span> <span class="ot">=</span> propensity_method</span>
<span id="cb66-2103"><a href="#cb66-2103" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb66-2104"><a href="#cb66-2104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-2105"><a href="#cb66-2105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2106"><a href="#cb66-2106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Only support Cox object</span></span>
<span id="cb66-2107"><a href="#cb66-2107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"RISCA - G_formula (S-learner)"</span> <span class="sc">%in%</span> estimator) {</span>
<span id="cb66-2108"><a href="#cb66-2108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># G-formula estimate from RISCA</span></span>
<span id="cb66-2109"><a href="#cb66-2109" aria-hidden="true" tabindex="-1"></a>    ATE_RISCA_gf <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb66-2110"><a href="#cb66-2110" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RISCA_gf</span>(data, X.names.outcome, <span class="at">tau =</span> tau)</span>
<span id="cb66-2111"><a href="#cb66-2111" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb66-2112"><a href="#cb66-2112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error in ATE_RISCA_gf: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb66-2113"><a href="#cb66-2113" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>) </span>
<span id="cb66-2114"><a href="#cb66-2114" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb66-2115"><a href="#cb66-2115" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(</span>
<span id="cb66-2116"><a href="#cb66-2116" aria-hidden="true" tabindex="-1"></a>      <span class="st">"sample.size"</span> <span class="ot">=</span> sample.size, <span class="st">"estimate"</span> <span class="ot">=</span> ATE_RISCA_gf, </span>
<span id="cb66-2117"><a href="#cb66-2117" aria-hidden="true" tabindex="-1"></a>      <span class="st">"estimator"</span> <span class="ot">=</span> <span class="st">"RISCA - G_formula (S-learner)"</span>, </span>
<span id="cb66-2118"><a href="#cb66-2118" aria-hidden="true" tabindex="-1"></a>      <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="st">"Cox"</span></span>
<span id="cb66-2119"><a href="#cb66-2119" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb66-2120"><a href="#cb66-2120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2121"><a href="#cb66-2121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb66-2122"><a href="#cb66-2122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-2123"><a href="#cb66-2123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2124"><a href="#cb66-2124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2125"><a href="#cb66-2125" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute estimators for multiple simulations and sample sizes</span></span>
<span id="cb66-2126"><a href="#cb66-2126" aria-hidden="true" tabindex="-1"></a>compute_estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(n_sim, tau, <span class="at">scenario =</span> <span class="st">"RCT1"</span>, </span>
<span id="cb66-2127"><a href="#cb66-2127" aria-hidden="true" tabindex="-1"></a>                              X.names.propensity, </span>
<span id="cb66-2128"><a href="#cb66-2128" aria-hidden="true" tabindex="-1"></a>                              X.names.outcome,</span>
<span id="cb66-2129"><a href="#cb66-2129" aria-hidden="true" tabindex="-1"></a>                              X.names.censoring,</span>
<span id="cb66-2130"><a href="#cb66-2130" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>, </span>
<span id="cb66-2131"><a href="#cb66-2131" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb66-2132"><a href="#cb66-2132" aria-hidden="true" tabindex="-1"></a>                              <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb66-2133"><a href="#cb66-2133" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.folds_propensity =</span> <span class="cn">NULL</span>,</span>
<span id="cb66-2134"><a href="#cb66-2134" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.folds_censoring =</span> <span class="cn">NULL</span>, </span>
<span id="cb66-2135"><a href="#cb66-2135" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.folds_survival =</span> <span class="cn">NULL</span>, <span class="at">coefC =</span> <span class="cn">NULL</span>, </span>
<span id="cb66-2136"><a href="#cb66-2136" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC =</span> <span class="cn">NULL</span>,</span>
<span id="cb66-2137"><a href="#cb66-2137" aria-hidden="true" tabindex="-1"></a>                              <span class="at">parsC_A =</span> <span class="cn">NULL</span>,</span>
<span id="cb66-2138"><a href="#cb66-2138" aria-hidden="true" tabindex="-1"></a>                              <span class="at">estimator =</span> <span class="st">"all"</span>,</span>
<span id="cb66-2139"><a href="#cb66-2139" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sample_sizes =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">4000</span>, <span class="dv">8000</span>)) {</span>
<span id="cb66-2140"><a href="#cb66-2140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2141"><a href="#cb66-2141" aria-hidden="true" tabindex="-1"></a>  pb_n <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">length</span>(sample_sizes), </span>
<span id="cb66-2142"><a href="#cb66-2142" aria-hidden="true" tabindex="-1"></a>                         <span class="at">style =</span> <span class="dv">3</span>, <span class="at">initial =</span> <span class="dv">0</span>, <span class="at">char =</span> <span class="st">"#"</span>)</span>
<span id="cb66-2143"><a href="#cb66-2143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">on.exit</span>(<span class="fu">close</span>(pb_n))</span>
<span id="cb66-2144"><a href="#cb66-2144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2145"><a href="#cb66-2145" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb66-2146"><a href="#cb66-2146" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample.size"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb66-2147"><a href="#cb66-2147" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimate"</span> <span class="ot">=</span> <span class="fu">numeric</span>(),</span>
<span id="cb66-2148"><a href="#cb66-2148" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimator"</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb66-2149"><a href="#cb66-2149" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nuisance"</span> <span class="ot">=</span> <span class="fu">character</span>()</span>
<span id="cb66-2150"><a href="#cb66-2150" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-2151"><a href="#cb66-2151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2152"><a href="#cb66-2152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through each sample size</span></span>
<span id="cb66-2153"><a href="#cb66-2153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (idx_n <span class="cf">in</span> <span class="fu">seq_along</span>(sample_sizes)) {</span>
<span id="cb66-2154"><a href="#cb66-2154" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> sample_sizes[idx_n]</span>
<span id="cb66-2155"><a href="#cb66-2155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-2156"><a href="#cb66-2156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Progress bar for simulations</span></span>
<span id="cb66-2157"><a href="#cb66-2157" aria-hidden="true" tabindex="-1"></a>    pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> n_sim, <span class="at">style =</span> <span class="dv">3</span>, <span class="at">initial =</span> <span class="dv">0</span>, <span class="at">char =</span> <span class="st">"#"</span>)</span>
<span id="cb66-2158"><a href="#cb66-2158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">on.exit</span>(<span class="fu">close</span>(pb))</span>
<span id="cb66-2159"><a href="#cb66-2159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-2160"><a href="#cb66-2160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each simulation</span></span>
<span id="cb66-2161"><a href="#cb66-2161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sim) {</span>
<span id="cb66-2162"><a href="#cb66-2162" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb66-2163"><a href="#cb66-2163" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2164"><a href="#cb66-2164" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Simulate data based on the scenario</span></span>
<span id="cb66-2165"><a href="#cb66-2165" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"RCT1"</span>) {</span>
<span id="cb66-2166"><a href="#cb66-2166" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_RCT</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2167"><a href="#cb66-2167" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"RCT1"</span>)</span>
<span id="cb66-2168"><a href="#cb66-2168" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"RCT2"</span>) {</span>
<span id="cb66-2169"><a href="#cb66-2169" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_RCT</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2170"><a href="#cb66-2170" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"RCT2"</span>, </span>
<span id="cb66-2171"><a href="#cb66-2171" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">coefC =</span> coefC, </span>
<span id="cb66-2172"><a href="#cb66-2172" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parsC =</span> parsC,</span>
<span id="cb66-2173"><a href="#cb66-2173" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parsC_A =</span> parsC_A)</span>
<span id="cb66-2174"><a href="#cb66-2174" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Obs1"</span>) {</span>
<span id="cb66-2175"><a href="#cb66-2175" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2176"><a href="#cb66-2176" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"Obs1"</span>)</span>
<span id="cb66-2177"><a href="#cb66-2177" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Obs2"</span>) {</span>
<span id="cb66-2178"><a href="#cb66-2178" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2179"><a href="#cb66-2179" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">scenario =</span> <span class="st">"Obs2"</span>, </span>
<span id="cb66-2180"><a href="#cb66-2180" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">coefC =</span> coefC, </span>
<span id="cb66-2181"><a href="#cb66-2181" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parsC =</span> parsC)</span>
<span id="cb66-2182"><a href="#cb66-2182" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Complex"</span>) {</span>
<span id="cb66-2183"><a href="#cb66-2183" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_complex</span>(n, </span>
<span id="cb66-2184"><a href="#cb66-2184" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">tau =</span> tau,</span>
<span id="cb66-2185"><a href="#cb66-2185" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">parsC =</span> parsC)</span>
<span id="cb66-2186"><a href="#cb66-2186" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"Mis"</span>) {</span>
<span id="cb66-2187"><a href="#cb66-2187" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">simulate_data_mis</span>(n, <span class="at">tau =</span> tau)</span>
<span id="cb66-2188"><a href="#cb66-2188" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb66-2189"><a href="#cb66-2189" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2190"><a href="#cb66-2190" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2191"><a href="#cb66-2191" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute all estimates for the simulated data</span></span>
<span id="cb66-2192"><a href="#cb66-2192" aria-hidden="true" tabindex="-1"></a>      all <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2193"><a href="#cb66-2193" aria-hidden="true" tabindex="-1"></a>                           X.names.propensity, </span>
<span id="cb66-2194"><a href="#cb66-2194" aria-hidden="true" tabindex="-1"></a>                           X.names.outcome,</span>
<span id="cb66-2195"><a href="#cb66-2195" aria-hidden="true" tabindex="-1"></a>                           X.names.censoring,</span>
<span id="cb66-2196"><a href="#cb66-2196" aria-hidden="true" tabindex="-1"></a>                           nuisance_propensity, </span>
<span id="cb66-2197"><a href="#cb66-2197" aria-hidden="true" tabindex="-1"></a>                           nuisance_censoring,</span>
<span id="cb66-2198"><a href="#cb66-2198" aria-hidden="true" tabindex="-1"></a>                           nuisance_survival, </span>
<span id="cb66-2199"><a href="#cb66-2199" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2200"><a href="#cb66-2200" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2201"><a href="#cb66-2201" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2202"><a href="#cb66-2202" aria-hidden="true" tabindex="-1"></a>                           estimator)</span>
<span id="cb66-2203"><a href="#cb66-2203" aria-hidden="true" tabindex="-1"></a>      results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(all, results)</span>
<span id="cb66-2204"><a href="#cb66-2204" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-2205"><a href="#cb66-2205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-2206"><a href="#cb66-2206" aria-hidden="true" tabindex="-1"></a>    <span class="fu">close</span>(pb)</span>
<span id="cb66-2207"><a href="#cb66-2207" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setTxtProgressBar</span>(pb_n, idx_n)</span>
<span id="cb66-2208"><a href="#cb66-2208" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2209"><a href="#cb66-2209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2210"><a href="#cb66-2210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb66-2211"><a href="#cb66-2211" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-2212"><a href="#cb66-2212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2213"><a href="#cb66-2213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2214"><a href="#cb66-2214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2215"><a href="#cb66-2215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2216"><a href="#cb66-2216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2217"><a href="#cb66-2217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb66-2218"><a href="#cb66-2218" aria-hidden="true" tabindex="-1"></a><span class="in"># Number of simulations and tau value</span></span>
<span id="cb66-2219"><a href="#cb66-2219" aria-hidden="true" tabindex="-1"></a><span class="in">n_sim &lt;- 100</span></span>
<span id="cb66-2220"><a href="#cb66-2220" aria-hidden="true" tabindex="-1"></a><span class="in">tau &lt;- 25</span></span>
<span id="cb66-2221"><a href="#cb66-2221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2222"><a href="#cb66-2222" aria-hidden="true" tabindex="-1"></a><span class="in"># RCT1 simulation</span></span>
<span id="cb66-2223"><a href="#cb66-2223" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_rct1 &lt;- compute_estimator(</span></span>
<span id="cb66-2224"><a href="#cb66-2224" aria-hidden="true" tabindex="-1"></a><span class="in">      n_sim, tau = tau, scenario = "RCT1", </span></span>
<span id="cb66-2225"><a href="#cb66-2225" aria-hidden="true" tabindex="-1"></a><span class="in">      X.names.propensity = c("X1", "X2", "X3", "X4"), </span></span>
<span id="cb66-2226"><a href="#cb66-2226" aria-hidden="true" tabindex="-1"></a><span class="in">      X.names.outcome = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2227"><a href="#cb66-2227" aria-hidden="true" tabindex="-1"></a><span class="in">      X.names.censoring = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2228"><a href="#cb66-2228" aria-hidden="true" tabindex="-1"></a><span class="in">      nuisance_propensity = c("glm", "probability forest"), </span></span>
<span id="cb66-2229"><a href="#cb66-2229" aria-hidden="true" tabindex="-1"></a><span class="in">      nuisance_censoring = c("cox", "survival forest"), </span></span>
<span id="cb66-2230"><a href="#cb66-2230" aria-hidden="true" tabindex="-1"></a><span class="in">      nuisance_survival = c("cox", "survival forest"), </span></span>
<span id="cb66-2231"><a href="#cb66-2231" aria-hidden="true" tabindex="-1"></a><span class="in">      n.folds_propensity = 5,</span></span>
<span id="cb66-2232"><a href="#cb66-2232" aria-hidden="true" tabindex="-1"></a><span class="in">      n.folds_censoring = 5,</span></span>
<span id="cb66-2233"><a href="#cb66-2233" aria-hidden="true" tabindex="-1"></a><span class="in">      n.folds_survival = 5,</span></span>
<span id="cb66-2234"><a href="#cb66-2234" aria-hidden="true" tabindex="-1"></a><span class="in">      coefC = 0.03</span></span>
<span id="cb66-2235"><a href="#cb66-2235" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2236"><a href="#cb66-2236" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_rct1, file = "simulation_rct1.RData")</span></span>
<span id="cb66-2237"><a href="#cb66-2237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2238"><a href="#cb66-2238" aria-hidden="true" tabindex="-1"></a><span class="in"># RCT2 simulation with specific coefficients and parameters</span></span>
<span id="cb66-2239"><a href="#cb66-2239" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_rct2 &lt;- compute_estimator(</span></span>
<span id="cb66-2240"><a href="#cb66-2240" aria-hidden="true" tabindex="-1"></a><span class="in">  n_sim, tau = tau, scenario = "RCT2", </span></span>
<span id="cb66-2241"><a href="#cb66-2241" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.propensity = c("X1", "X2", "X3", "X4"), </span></span>
<span id="cb66-2242"><a href="#cb66-2242" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.outcome = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2243"><a href="#cb66-2243" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.censoring = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2244"><a href="#cb66-2244" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_propensity = c("glm", "probability forest"), </span></span>
<span id="cb66-2245"><a href="#cb66-2245" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_censoring = c("cox", "survival forest"), </span></span>
<span id="cb66-2246"><a href="#cb66-2246" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_survival = c("cox", "survival forest"), </span></span>
<span id="cb66-2247"><a href="#cb66-2247" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_propensity = 5,</span></span>
<span id="cb66-2248"><a href="#cb66-2248" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_censoring = 5,</span></span>
<span id="cb66-2249"><a href="#cb66-2249" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_survival = 5,</span></span>
<span id="cb66-2250"><a href="#cb66-2250" aria-hidden="true" tabindex="-1"></a><span class="in">  coefC = 0.03, </span></span>
<span id="cb66-2251"><a href="#cb66-2251" aria-hidden="true" tabindex="-1"></a><span class="in">  parsC = c(0.7, 0.3, -0.25, -0.1), </span></span>
<span id="cb66-2252"><a href="#cb66-2252" aria-hidden="true" tabindex="-1"></a><span class="in">  parsC_A = 0</span></span>
<span id="cb66-2253"><a href="#cb66-2253" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2254"><a href="#cb66-2254" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_rct2, file = "simulation_rct2.RData")</span></span>
<span id="cb66-2255"><a href="#cb66-2255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2256"><a href="#cb66-2256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2257"><a href="#cb66-2257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2260"><a href="#cb66-2260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-2261"><a href="#cb66-2261" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_rct1.RData"</span>)</span>
<span id="cb66-2262"><a href="#cb66-2262" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_rct2.RData"</span>)</span>
<span id="cb66-2263"><a href="#cb66-2263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2264"><a href="#cb66-2264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2265"><a href="#cb66-2265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2266"><a href="#cb66-2266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2267"><a href="#cb66-2267" aria-hidden="true" tabindex="-1"></a><span class="in"># Update the theme to center the plot title</span></span>
<span id="cb66-2268"><a href="#cb66-2268" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-2269"><a href="#cb66-2269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2270"><a href="#cb66-2270" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the desired order of the estimators</span></span>
<span id="cb66-2271"><a href="#cb66-2271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2272"><a href="#cb66-2272" aria-hidden="true" tabindex="-1"></a><span class="in">desired_order &lt;- c(</span></span>
<span id="cb66-2273"><a href="#cb66-2273" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naive",</span></span>
<span id="cb66-2274"><a href="#cb66-2274" aria-hidden="true" tabindex="-1"></a><span class="in">  "KM",</span></span>
<span id="cb66-2275"><a href="#cb66-2275" aria-hidden="true" tabindex="-1"></a><span class="in">  "SurvRM2 - KM",</span></span>
<span id="cb66-2276"><a href="#cb66-2276" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW KM (Log. Reg.)",</span></span>
<span id="cb66-2277"><a href="#cb66-2277" aria-hidden="true" tabindex="-1"></a><span class="in">  "RISCA - IPTW KM (Log. Reg.)",</span></span>
<span id="cb66-2278"><a href="#cb66-2278" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPCW KM (Cox)",</span></span>
<span id="cb66-2279"><a href="#cb66-2279" aria-hidden="true" tabindex="-1"></a><span class="in">  "BJ (Cox)",</span></span>
<span id="cb66-2280"><a href="#cb66-2280" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-BJ (Cox &amp; Log. Reg.)",</span></span>
<span id="cb66-2281"><a href="#cb66-2281" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-IPCW KM (Cox &amp; Log. Reg.)",</span></span>
<span id="cb66-2282"><a href="#cb66-2282" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Cox/ T-learners)",</span></span>
<span id="cb66-2283"><a href="#cb66-2283" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Cox/ S-learner)",</span></span>
<span id="cb66-2284"><a href="#cb66-2284" aria-hidden="true" tabindex="-1"></a><span class="in">  "RISCA - G_formula (S-learner)",</span></span>
<span id="cb66-2285"><a href="#cb66-2285" aria-hidden="true" tabindex="-1"></a><span class="in">  "AIPTW-AIPCW (Cox &amp; Cox &amp; Log. Reg.)",</span></span>
<span id="cb66-2286"><a href="#cb66-2286" aria-hidden="true" tabindex="-1"></a><span class="in">  "grf - Causal Survival Forest",</span></span>
<span id="cb66-2287"><a href="#cb66-2287" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW KM (Forest)",</span></span>
<span id="cb66-2288"><a href="#cb66-2288" aria-hidden="true" tabindex="-1"></a><span class="in">  "RISCA - IPTW KM (Forest)",</span></span>
<span id="cb66-2289"><a href="#cb66-2289" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPCW KM (Forest)",</span></span>
<span id="cb66-2290"><a href="#cb66-2290" aria-hidden="true" tabindex="-1"></a><span class="in">  "BJ (Forest)",</span></span>
<span id="cb66-2291"><a href="#cb66-2291" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-BJ (Forest)",</span></span>
<span id="cb66-2292"><a href="#cb66-2292" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-IPCW KM (Forest)",</span></span>
<span id="cb66-2293"><a href="#cb66-2293" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Forest/ T-learners)",</span></span>
<span id="cb66-2294"><a href="#cb66-2294" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Forest/ S-learner)",</span></span>
<span id="cb66-2295"><a href="#cb66-2295" aria-hidden="true" tabindex="-1"></a><span class="in">  "AIPTW-AIPCW (Forest)")</span></span>
<span id="cb66-2296"><a href="#cb66-2296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2297"><a href="#cb66-2297" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert sample size to a factor with levels sorted in decreasing order</span></span>
<span id="cb66-2298"><a href="#cb66-2298" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_rct1$sample.size &lt;- factor(</span></span>
<span id="cb66-2299"><a href="#cb66-2299" aria-hidden="true" tabindex="-1"></a><span class="in">  simulation_rct1$sample.size, </span></span>
<span id="cb66-2300"><a href="#cb66-2300" aria-hidden="true" tabindex="-1"></a><span class="in">  levels = sort(unique(simulation_rct1$sample.size), decreasing = FALSE)</span></span>
<span id="cb66-2301"><a href="#cb66-2301" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2302"><a href="#cb66-2302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2303"><a href="#cb66-2303" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert estimator column to a factor with the specified order</span></span>
<span id="cb66-2304"><a href="#cb66-2304" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_rct1$estimator &lt;- factor(simulation_rct1$estimator, </span></span>
<span id="cb66-2305"><a href="#cb66-2305" aria-hidden="true" tabindex="-1"></a><span class="in">                                    levels = desired_order)</span></span>
<span id="cb66-2306"><a href="#cb66-2306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2307"><a href="#cb66-2307" aria-hidden="true" tabindex="-1"></a><span class="in"># Create the plot for RCT + independent censoring</span></span>
<span id="cb66-2308"><a href="#cb66-2308" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_rct1 &lt;- simulation_rct1 %&gt;%</span></span>
<span id="cb66-2309"><a href="#cb66-2309" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(</span></span>
<span id="cb66-2310"><a href="#cb66-2310" aria-hidden="true" tabindex="-1"></a><span class="in">    x = estimator, y = estimate,  </span></span>
<span id="cb66-2311"><a href="#cb66-2311" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = factor(sample.size, levels = rev(levels(sample.size)))</span></span>
<span id="cb66-2312"><a href="#cb66-2312" aria-hidden="true" tabindex="-1"></a><span class="in">  )) +</span></span>
<span id="cb66-2313"><a href="#cb66-2313" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-2314"><a href="#cb66-2314" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-2315"><a href="#cb66-2315" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +  # Change x-axis label</span></span>
<span id="cb66-2316"><a href="#cb66-2316" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") +  # Change y-axis label</span></span>
<span id="cb66-2317"><a href="#cb66-2317" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom = "errorbar") +</span></span>
<span id="cb66-2318"><a href="#cb66-2318" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(</span></span>
<span id="cb66-2319"><a href="#cb66-2319" aria-hidden="true" tabindex="-1"></a><span class="in">    yintercept = truth_tau1, linetype = "dashed", color = "red", </span></span>
<span id="cb66-2320"><a href="#cb66-2320" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha = 0.8, size = 0.8</span></span>
<span id="cb66-2321"><a href="#cb66-2321" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb66-2322"><a href="#cb66-2322" aria-hidden="true" tabindex="-1"></a><span class="in">theme(</span></span>
<span id="cb66-2323"><a href="#cb66-2323" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-2324"><a href="#cb66-2324" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.box = "vertical", legend.text = element_text(size = 18),</span></span>
<span id="cb66-2325"><a href="#cb66-2325" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text.x = element_text(angle = 35, vjust = 1, hjust = 1),  </span></span>
<span id="cb66-2326"><a href="#cb66-2326" aria-hidden="true" tabindex="-1"></a><span class="in">    # Adjust text angle for better visibility</span></span>
<span id="cb66-2327"><a href="#cb66-2327" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text = element_text(size = 15, face = "bold"),</span></span>
<span id="cb66-2328"><a href="#cb66-2328" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.title.x = element_text(size = 16, face = "bold"),</span></span>
<span id="cb66-2329"><a href="#cb66-2329" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.margin = margin(t = 10, r = 10, b = 50, l = 10)  # Add margin</span></span>
<span id="cb66-2330"><a href="#cb66-2330" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +    </span></span>
<span id="cb66-2331"><a href="#cb66-2331" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0, 15))</span></span>
<span id="cb66-2332"><a href="#cb66-2332" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2333"><a href="#cb66-2333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2334"><a href="#cb66-2334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2335"><a href="#cb66-2335" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2336"><a href="#cb66-2336" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-rct1</span></span>
<span id="cb66-2337"><a href="#cb66-2337" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Results of the ATE for the simulation of a RCT with independent censoring."</span></span>
<span id="cb66-2338"><a href="#cb66-2338" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb66-2339"><a href="#cb66-2339" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_rct1 </span></span>
<span id="cb66-2340"><a href="#cb66-2340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2341"><a href="#cb66-2341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2342"><a href="#cb66-2342" aria-hidden="true" tabindex="-1"></a>In this setting, and in accordance with the theory, the simplest estimator (unadjusted KM) performs just as well as the others, and presents an extremely small bias (as derived in @Sec-theoryRCT_indc).</span>
<span id="cb66-2343"><a href="#cb66-2343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2344"><a href="#cb66-2344" aria-hidden="true" tabindex="-1"></a>The naive estimator is biased, as expected, and the bias in both the G-formula (RISCA) and the manual G-formula S-learner arises because the treatment effect is additive $T(1) = T(0) + 10$ and violates the assumption that $T$ would follow a Cox model in the variables $(X,A)$. However, $T|A=a$ is a Cox-model for $a \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$, which explain the remarkable performance of G-formula (Cox/T-learners) and some of the other models based on a Cox estimation of $S$. </span>
<span id="cb66-2345"><a href="#cb66-2345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2346"><a href="#cb66-2346" aria-hidden="true" tabindex="-1"></a>Other estimators (IPTW KM (Reg.Log), IPCW KM (Cox), IPTW-IPCW KM (Cox &amp; Log.Reg), IPTW-BJ (Cox &amp; Log.Reg), AIPTW-AIPCW (Cox &amp; Cox &amp; Log.Reg))  involve unnecessary nuisance parameter estimates, such as propensity scores or censoring models. Despite this, their performance remains relatively stable in terms of variability, and there are roughly no differences between using (semi-)parametric or non-parametric estimation methods for nuisance parameters except for IPCW KM and IPTW-IPCW KM where there is a slight bias when using forest-based methods. </span>
<span id="cb66-2347"><a href="#cb66-2347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2348"><a href="#cb66-2348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2349"><a href="#cb66-2349" aria-hidden="true" tabindex="-1"></a><span class="in"># Update the theme to center the plot title</span></span>
<span id="cb66-2350"><a href="#cb66-2350" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-2351"><a href="#cb66-2351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2352"><a href="#cb66-2352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2353"><a href="#cb66-2353" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert sample size to a factor with levels sorted in decreasing order</span></span>
<span id="cb66-2354"><a href="#cb66-2354" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_rct2$sample.size &lt;- factor(</span></span>
<span id="cb66-2355"><a href="#cb66-2355" aria-hidden="true" tabindex="-1"></a><span class="in">  simulation_rct2$sample.size, </span></span>
<span id="cb66-2356"><a href="#cb66-2356" aria-hidden="true" tabindex="-1"></a><span class="in">  levels = sort(unique(simulation_rct2$sample.size), decreasing = TRUE)</span></span>
<span id="cb66-2357"><a href="#cb66-2357" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2358"><a href="#cb66-2358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2359"><a href="#cb66-2359" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert estimator column to a factor with the specified order</span></span>
<span id="cb66-2360"><a href="#cb66-2360" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_rct2$estimator &lt;- factor(simulation_rct2$estimator, </span></span>
<span id="cb66-2361"><a href="#cb66-2361" aria-hidden="true" tabindex="-1"></a><span class="in">                                    levels = desired_order)</span></span>
<span id="cb66-2362"><a href="#cb66-2362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2363"><a href="#cb66-2363" aria-hidden="true" tabindex="-1"></a><span class="in"># Create the plot for RCT + dependent censoring</span></span>
<span id="cb66-2364"><a href="#cb66-2364" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_rct2 &lt;- simulation_rct2 %&gt;%</span></span>
<span id="cb66-2365"><a href="#cb66-2365" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(</span></span>
<span id="cb66-2366"><a href="#cb66-2366" aria-hidden="true" tabindex="-1"></a><span class="in">    x = estimator, y = estimate,  </span></span>
<span id="cb66-2367"><a href="#cb66-2367" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = factor(sample.size, levels = rev(levels(sample.size)))</span></span>
<span id="cb66-2368"><a href="#cb66-2368" aria-hidden="true" tabindex="-1"></a><span class="in">  )) +</span></span>
<span id="cb66-2369"><a href="#cb66-2369" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-2370"><a href="#cb66-2370" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-2371"><a href="#cb66-2371" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +  # Change x-axis label</span></span>
<span id="cb66-2372"><a href="#cb66-2372" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") +  # Change y-axis label</span></span>
<span id="cb66-2373"><a href="#cb66-2373" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom = "errorbar") +</span></span>
<span id="cb66-2374"><a href="#cb66-2374" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(</span></span>
<span id="cb66-2375"><a href="#cb66-2375" aria-hidden="true" tabindex="-1"></a><span class="in">    yintercept = truth_tau2, linetype = "dashed", color = "red", </span></span>
<span id="cb66-2376"><a href="#cb66-2376" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha = 0.8, size = 0.8</span></span>
<span id="cb66-2377"><a href="#cb66-2377" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb66-2378"><a href="#cb66-2378" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb66-2379"><a href="#cb66-2379" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-2380"><a href="#cb66-2380" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.box = "vertical", legend.text = element_text(size = 18),</span></span>
<span id="cb66-2381"><a href="#cb66-2381" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  </span></span>
<span id="cb66-2382"><a href="#cb66-2382" aria-hidden="true" tabindex="-1"></a><span class="in">    # Adjust text angle for better visibility</span></span>
<span id="cb66-2383"><a href="#cb66-2383" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text = element_text(size = 15, face = "bold"),</span></span>
<span id="cb66-2384"><a href="#cb66-2384" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.title.x = element_text(size = 16, face = "bold"),</span></span>
<span id="cb66-2385"><a href="#cb66-2385" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.margin = margin(t = 10, r = 10, b = 50, l = 10)  # Add margin</span></span>
<span id="cb66-2386"><a href="#cb66-2386" aria-hidden="true" tabindex="-1"></a><span class="in">  ) + </span></span>
<span id="cb66-2387"><a href="#cb66-2387" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0, 15))</span></span>
<span id="cb66-2388"><a href="#cb66-2388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2389"><a href="#cb66-2389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2390"><a href="#cb66-2390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2391"><a href="#cb66-2391" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-rct2</span></span>
<span id="cb66-2392"><a href="#cb66-2392" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Estimation results of the ATE for the simulation of a RCT with dependent censoring."</span></span>
<span id="cb66-2393"><a href="#cb66-2393" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb66-2394"><a href="#cb66-2394" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_rct2</span></span>
<span id="cb66-2395"><a href="#cb66-2395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2396"><a href="#cb66-2396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2397"><a href="#cb66-2397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2398"><a href="#cb66-2398" aria-hidden="true" tabindex="-1"></a>@fig-rct2 shows the results for the  RCT simulation with conditionally independent censoring (Scenario 2). </span>
<span id="cb66-2399"><a href="#cb66-2399" aria-hidden="true" tabindex="-1"></a>In this setting, the Naive estimator remains biased. Similarly, both the</span>
<span id="cb66-2400"><a href="#cb66-2400" aria-hidden="true" tabindex="-1"></a>unadjusted Kaplan-Meier (KM) and its SurvRM2 equivalent, as well as the</span>
<span id="cb66-2401"><a href="#cb66-2401" aria-hidden="true" tabindex="-1"></a>treatment-adjusted IPTW KM and its RISCA equivalent, are biased due to</span>
<span id="cb66-2402"><a href="#cb66-2402" aria-hidden="true" tabindex="-1"></a>their failure to account for dependent censoring. As in Scenario 1, G-formula (Cox/ S-learner) and its RISCA equivalent also remain biased. </span>
<span id="cb66-2403"><a href="#cb66-2403" aria-hidden="true" tabindex="-1"></a>The IPCW KM (Cox) is slightly biased up to 4,000 observations and quite variable due to extreme censoring probabilities. IPTW-IPCW KM (Cox &amp; Log.Reg.) is not biased but shows high variance. In contrast, the Buckley-James estimator BJ (Cox) is unbiased even with as few as 500 observations. The BJ</span>
<span id="cb66-2404"><a href="#cb66-2404" aria-hidden="true" tabindex="-1"></a>estimator also demonstrates smaller variance than IPCW methods. G-formula (Cox/ T-learners) and AIPCW-AIPTW (Cox <span class="sc">\&amp;</span> Cox <span class="sc">\&amp;</span> Log.Reg.) estimators seem to perform well, even in small samples. The forest versions of these estimators seem more biased, except Causal Survival Forest and the AIPTW-AIPCW (Forest).</span>
<span id="cb66-2405"><a href="#cb66-2405" aria-hidden="true" tabindex="-1"></a>Notably, all estimators exhibit higher variability compared to Scenario 1.</span>
<span id="cb66-2406"><a href="#cb66-2406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2407"><a href="#cb66-2407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2408"><a href="#cb66-2408" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observational data {#sec-simulation-Obs}</span></span>
<span id="cb66-2409"><a href="#cb66-2409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2410"><a href="#cb66-2410" aria-hidden="true" tabindex="-1"></a>**Data Generating Process**</span>
<span id="cb66-2411"><a href="#cb66-2411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2412"><a href="#cb66-2412" aria-hidden="true" tabindex="-1"></a>As for Scenarii 1 and 2, we carry out two simulations of an</span>
<span id="cb66-2413"><a href="#cb66-2413" aria-hidden="true" tabindex="-1"></a>observational study with both independent and conditional independent censoring. The only difference lies in the simulation of the propensity score, which is no longer constant.</span>
<span id="cb66-2414"><a href="#cb66-2414" aria-hidden="true" tabindex="-1"></a>For the simulation, an iid $n$-sample $(X_{i},A_{i},C,T_{i}(0), T_{i}(1))_{i \in <span class="co">[</span><span class="ot">n</span><span class="co">]</span>}$ is generated as in @sec-simulation-RCT, except for the treatment allocation process that is given by:</span>
<span id="cb66-2415"><a href="#cb66-2415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2416"><a href="#cb66-2416" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-2417"><a href="#cb66-2417" aria-hidden="true" tabindex="-1"></a>\operatorname{logit}(e(X))= \beta_A^\top X \quad \text{where} \quad \beta_A = (-1,-1,-2.5,-1),</span>
<span id="cb66-2418"><a href="#cb66-2418" aria-hidden="true" tabindex="-1"></a>$$    </span>
<span id="cb66-2419"><a href="#cb66-2419" aria-hidden="true" tabindex="-1"></a>where we recall that $\operatorname{logit}(p) = \log(p/(1-p))$.</span>
<span id="cb66-2420"><a href="#cb66-2420" aria-hidden="true" tabindex="-1"></a>The descriptive statistics for the two observational data with independent ($\texttt{Obs1}$) and conditionally independent censoring ($\texttt{Obs2}$)  are displayed in Appendix (@sec-stat_obs). Note that we did not modify the survival distribution, the target difference in RMST is thus the same.</span>
<span id="cb66-2421"><a href="#cb66-2421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2422"><a href="#cb66-2422" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2423"><a href="#cb66-2423" aria-hidden="true" tabindex="-1"></a><span class="in"># Obs1:  Treatment assignment dependent on X + independent censoring</span></span>
<span id="cb66-2424"><a href="#cb66-2424" aria-hidden="true" tabindex="-1"></a><span class="in"># Obs2:  Treatment assignment dependent on X + dependent censoring (conditional </span></span>
<span id="cb66-2425"><a href="#cb66-2425" aria-hidden="true" tabindex="-1"></a><span class="in"># on X)</span></span>
<span id="cb66-2426"><a href="#cb66-2426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2427"><a href="#cb66-2427" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to simulate observational data for two scenarios: Obs1 and Obs2</span></span>
<span id="cb66-2428"><a href="#cb66-2428" aria-hidden="true" tabindex="-1"></a><span class="in">simulate_data_obs &lt;- function(n, </span></span>
<span id="cb66-2429"><a href="#cb66-2429" aria-hidden="true" tabindex="-1"></a><span class="in">                              mu = c(1, 1, -1, 1), </span></span>
<span id="cb66-2430"><a href="#cb66-2430" aria-hidden="true" tabindex="-1"></a><span class="in">                              sigma = diag(4), </span></span>
<span id="cb66-2431"><a href="#cb66-2431" aria-hidden="true" tabindex="-1"></a><span class="in">                              colnames_cov = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2432"><a href="#cb66-2432" aria-hidden="true" tabindex="-1"></a><span class="in">                              tau,</span></span>
<span id="cb66-2433"><a href="#cb66-2433" aria-hidden="true" tabindex="-1"></a><span class="in">                              coefT0 = 0.01, </span></span>
<span id="cb66-2434"><a href="#cb66-2434" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsS = c(0.5, 0.5, -0.5, 0.5),</span></span>
<span id="cb66-2435"><a href="#cb66-2435" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsA = c(-1, -1, -2.5, -1), </span></span>
<span id="cb66-2436"><a href="#cb66-2436" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsC_A = c(0), </span></span>
<span id="cb66-2437"><a href="#cb66-2437" aria-hidden="true" tabindex="-1"></a><span class="in">                              coefC = 0.03,</span></span>
<span id="cb66-2438"><a href="#cb66-2438" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsC = c(0.7, 0.3, -0.25, -0.1), </span></span>
<span id="cb66-2439"><a href="#cb66-2439" aria-hidden="true" tabindex="-1"></a><span class="in">                              scenario = "Obs2") {</span></span>
<span id="cb66-2440"><a href="#cb66-2440" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2441"><a href="#cb66-2441" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate covariates X from a multivariate normal distribution</span></span>
<span id="cb66-2442"><a href="#cb66-2442" aria-hidden="true" tabindex="-1"></a><span class="in">  X &lt;- mvrnorm(n, mu, sigma)</span></span>
<span id="cb66-2443"><a href="#cb66-2443" aria-hidden="true" tabindex="-1"></a><span class="in">  X &lt;- as.data.frame(X)</span></span>
<span id="cb66-2444"><a href="#cb66-2444" aria-hidden="true" tabindex="-1"></a><span class="in">  colnames(X) &lt;- colnames_cov</span></span>
<span id="cb66-2445"><a href="#cb66-2445" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2446"><a href="#cb66-2446" aria-hidden="true" tabindex="-1"></a><span class="in">  # Propensity score model based on X</span></span>
<span id="cb66-2447"><a href="#cb66-2447" aria-hidden="true" tabindex="-1"></a><span class="in">  e &lt;- rowSums(as.matrix(X) %*% diag(parsA))</span></span>
<span id="cb66-2448"><a href="#cb66-2448" aria-hidden="true" tabindex="-1"></a><span class="in">  e &lt;- plogis(e)  # Transform to probability scale</span></span>
<span id="cb66-2449"><a href="#cb66-2449" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2450"><a href="#cb66-2450" aria-hidden="true" tabindex="-1"></a><span class="in">  # Treatment assignment based on the propensity score</span></span>
<span id="cb66-2451"><a href="#cb66-2451" aria-hidden="true" tabindex="-1"></a><span class="in">  A &lt;- sapply(e, FUN = function(p) rbinom(n = 1, size = 1, prob = p))</span></span>
<span id="cb66-2452"><a href="#cb66-2452" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2453"><a href="#cb66-2453" aria-hidden="true" tabindex="-1"></a><span class="in">  # Outcome model based on X</span></span>
<span id="cb66-2454"><a href="#cb66-2454" aria-hidden="true" tabindex="-1"></a><span class="in">  X_outcome &lt;- as.matrix(X)</span></span>
<span id="cb66-2455"><a href="#cb66-2455" aria-hidden="true" tabindex="-1"></a><span class="in">  epsilon &lt;- runif(n, min = 0.00000001, max = 1)</span></span>
<span id="cb66-2456"><a href="#cb66-2456" aria-hidden="true" tabindex="-1"></a><span class="in">  T0 &lt;- -log(epsilon) / (coefT0 * exp(X_outcome %*% parsS))</span></span>
<span id="cb66-2457"><a href="#cb66-2457" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2458"><a href="#cb66-2458" aria-hidden="true" tabindex="-1"></a><span class="in">  # Define treatment effect (shift in survival time due to treatment)</span></span>
<span id="cb66-2459"><a href="#cb66-2459" aria-hidden="true" tabindex="-1"></a><span class="in">  T1 &lt;- T0 + 10</span></span>
<span id="cb66-2460"><a href="#cb66-2460" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2461"><a href="#cb66-2461" aria-hidden="true" tabindex="-1"></a><span class="in">  if (scenario == "Obs1") {</span></span>
<span id="cb66-2462"><a href="#cb66-2462" aria-hidden="true" tabindex="-1"></a><span class="in">    # Scenario 1: Independent censoring</span></span>
<span id="cb66-2463"><a href="#cb66-2463" aria-hidden="true" tabindex="-1"></a><span class="in">    C &lt;- -log(runif(n, min = 0.00000001, max = 1)) / coefC</span></span>
<span id="cb66-2464"><a href="#cb66-2464" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-2465"><a href="#cb66-2465" aria-hidden="true" tabindex="-1"></a><span class="in">  } else if (scenario == "Obs2") {</span></span>
<span id="cb66-2466"><a href="#cb66-2466" aria-hidden="true" tabindex="-1"></a><span class="in">    # Scenario 2: Dependent censoring based on X</span></span>
<span id="cb66-2467"><a href="#cb66-2467" aria-hidden="true" tabindex="-1"></a><span class="in">    X_censoring &lt;- as.matrix(cbind(X,A))</span></span>
<span id="cb66-2468"><a href="#cb66-2468" aria-hidden="true" tabindex="-1"></a><span class="in">    parsC &lt;- c(parsC,parsC_A)</span></span>
<span id="cb66-2469"><a href="#cb66-2469" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-2470"><a href="#cb66-2470" aria-hidden="true" tabindex="-1"></a><span class="in">    C &lt;- -log(runif(n, min = 0.00000001, max = 1)) / </span></span>
<span id="cb66-2471"><a href="#cb66-2471" aria-hidden="true" tabindex="-1"></a><span class="in">      (coefC * exp(rowSums(X_censoring %*% diag(parsC))))</span></span>
<span id="cb66-2472"><a href="#cb66-2472" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb66-2473"><a href="#cb66-2473" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb66-2474"><a href="#cb66-2474" aria-hidden="true" tabindex="-1"></a><span class="in">    stop("Invalid scenario. Choose 'Obs1' or 'Obs2'.")</span></span>
<span id="cb66-2475"><a href="#cb66-2475" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-2476"><a href="#cb66-2476" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2477"><a href="#cb66-2477" aria-hidden="true" tabindex="-1"></a><span class="in">  # Determine the true survival time based on treatment</span></span>
<span id="cb66-2478"><a href="#cb66-2478" aria-hidden="true" tabindex="-1"></a><span class="in">  T_true &lt;- A * T1 + (1 - A) * T0</span></span>
<span id="cb66-2479"><a href="#cb66-2479" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2480"><a href="#cb66-2480" aria-hidden="true" tabindex="-1"></a><span class="in">  # Observed time is the minimum of the true survival time and censoring time</span></span>
<span id="cb66-2481"><a href="#cb66-2481" aria-hidden="true" tabindex="-1"></a><span class="in">  T_obs &lt;- pmin(T_true, C)</span></span>
<span id="cb66-2482"><a href="#cb66-2482" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2483"><a href="#cb66-2483" aria-hidden="true" tabindex="-1"></a><span class="in">  # Status indicator: 1 if the event (death) occurred, 0 if censored</span></span>
<span id="cb66-2484"><a href="#cb66-2484" aria-hidden="true" tabindex="-1"></a><span class="in">  status &lt;- as.numeric(T_true &lt;= C)</span></span>
<span id="cb66-2485"><a href="#cb66-2485" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2486"><a href="#cb66-2486" aria-hidden="true" tabindex="-1"></a><span class="in">  # Restricted survival time (censored at tau)</span></span>
<span id="cb66-2487"><a href="#cb66-2487" aria-hidden="true" tabindex="-1"></a><span class="in">  T_obs_tau &lt;- pmin(T_obs, tau)</span></span>
<span id="cb66-2488"><a href="#cb66-2488" aria-hidden="true" tabindex="-1"></a><span class="in">  status_tau &lt;- as.numeric((T_obs &gt; tau) | (T_obs &lt;= tau &amp; status == 1))</span></span>
<span id="cb66-2489"><a href="#cb66-2489" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2490"><a href="#cb66-2490" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compile the simulated data into a data frame</span></span>
<span id="cb66-2491"><a href="#cb66-2491" aria-hidden="true" tabindex="-1"></a><span class="in">  DATA_target_population &lt;- data.frame(X, tau, A, T0, T1, C, T_obs, T_obs_tau, </span></span>
<span id="cb66-2492"><a href="#cb66-2492" aria-hidden="true" tabindex="-1"></a><span class="in">                                       status, status_tau, e)</span></span>
<span id="cb66-2493"><a href="#cb66-2493" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2494"><a href="#cb66-2494" aria-hidden="true" tabindex="-1"></a><span class="in">  return(DATA_target_population)</span></span>
<span id="cb66-2495"><a href="#cb66-2495" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-2496"><a href="#cb66-2496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2497"><a href="#cb66-2497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2498"><a href="#cb66-2498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2501"><a href="#cb66-2501" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-2502"><a href="#cb66-2502" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation for scenario Obs1</span></span>
<span id="cb66-2503"><a href="#cb66-2503" aria-hidden="true" tabindex="-1"></a>data_Obs1 <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(<span class="at">n =</span> <span class="dv">100000</span>, <span class="at">tau =</span> <span class="dv">25</span>, <span class="at">scenario =</span> <span class="st">"Obs1"</span>)</span>
<span id="cb66-2504"><a href="#cb66-2504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2505"><a href="#cb66-2505" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_ground_truth(data_Obs1, </span></span>
<span id="cb66-2506"><a href="#cb66-2506" aria-hidden="true" tabindex="-1"></a><span class="co">#                  vec_tau, </span></span>
<span id="cb66-2507"><a href="#cb66-2507" aria-hidden="true" tabindex="-1"></a><span class="co">#                  tau, </span></span>
<span id="cb66-2508"><a href="#cb66-2508" aria-hidden="true" tabindex="-1"></a><span class="co">#                  c(0, 10),</span></span>
<span id="cb66-2509"><a href="#cb66-2509" aria-hidden="true" tabindex="-1"></a><span class="co">#                  "True difference in RMST for Obs #scenario 1")</span></span>
<span id="cb66-2510"><a href="#cb66-2510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2511"><a href="#cb66-2511" aria-hidden="true" tabindex="-1"></a>truth_tau3 <span class="ot">&lt;-</span>  <span class="fu">ground_truth</span>(data_Obs1, <span class="at">tau =</span> <span class="dv">25</span>)</span>
<span id="cb66-2512"><a href="#cb66-2512" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The ground truth for Obs scenario 1 at time 25 is "</span>, <span class="fu">round</span>(truth_tau3, <span class="dv">1</span>)))</span>
<span id="cb66-2513"><a href="#cb66-2513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2514"><a href="#cb66-2514" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation for scenario Obs2 with specific coefficients and parameters</span></span>
<span id="cb66-2515"><a href="#cb66-2515" aria-hidden="true" tabindex="-1"></a>data_Obs2 <span class="ot">&lt;-</span> <span class="fu">simulate_data_obs</span>(</span>
<span id="cb66-2516"><a href="#cb66-2516" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">100000</span>, <span class="at">tau =</span> tau, <span class="at">scenario =</span> <span class="st">"Obs2"</span>, </span>
<span id="cb66-2517"><a href="#cb66-2517" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefC =</span> <span class="fl">0.03</span>, <span class="at">parsC =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="sc">-</span><span class="fl">0.1</span>))</span>
<span id="cb66-2518"><a href="#cb66-2518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2519"><a href="#cb66-2519" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_ground_truth(data_Obs2, </span></span>
<span id="cb66-2520"><a href="#cb66-2520" aria-hidden="true" tabindex="-1"></a><span class="co">#                  vec_tau, </span></span>
<span id="cb66-2521"><a href="#cb66-2521" aria-hidden="true" tabindex="-1"></a><span class="co">#                  tau, </span></span>
<span id="cb66-2522"><a href="#cb66-2522" aria-hidden="true" tabindex="-1"></a><span class="co">#                  c(0, 10),</span></span>
<span id="cb66-2523"><a href="#cb66-2523" aria-hidden="true" tabindex="-1"></a><span class="co">#                  "True difference in RMST for Obs #scenario 2")</span></span>
<span id="cb66-2524"><a href="#cb66-2524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2525"><a href="#cb66-2525" aria-hidden="true" tabindex="-1"></a>truth_tau4 <span class="ot">&lt;-</span> <span class="fu">ground_truth</span>(data_Obs2, <span class="at">tau =</span> <span class="dv">25</span>)</span>
<span id="cb66-2526"><a href="#cb66-2526" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The ground truth for Obs scenario 2 at #time 25 is "</span>, <span class="fu">round</span>(truth_tau4, <span class="dv">1</span>)))</span>
<span id="cb66-2527"><a href="#cb66-2527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2528"><a href="#cb66-2528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2529"><a href="#cb66-2529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2530"><a href="#cb66-2530" aria-hidden="true" tabindex="-1"></a>**Estimation of the RMST**</span>
<span id="cb66-2531"><a href="#cb66-2531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2532"><a href="#cb66-2532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2533"><a href="#cb66-2533" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb66-2534"><a href="#cb66-2534" aria-hidden="true" tabindex="-1"></a><span class="in"># Obs1 simulation</span></span>
<span id="cb66-2535"><a href="#cb66-2535" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_obs1 &lt;- compute_estimator(</span></span>
<span id="cb66-2536"><a href="#cb66-2536" aria-hidden="true" tabindex="-1"></a><span class="in">  n_sim, tau = tau, scenario = "Obs1", </span></span>
<span id="cb66-2537"><a href="#cb66-2537" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.propensity = c("X1", "X2", "X3", "X4"), </span></span>
<span id="cb66-2538"><a href="#cb66-2538" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.outcome = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2539"><a href="#cb66-2539" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.censoring = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2540"><a href="#cb66-2540" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_propensity = c("glm", "probability forest"), </span></span>
<span id="cb66-2541"><a href="#cb66-2541" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_censoring = c("cox", "survival forest"), </span></span>
<span id="cb66-2542"><a href="#cb66-2542" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_survival = c("cox", "survival forest"), </span></span>
<span id="cb66-2543"><a href="#cb66-2543" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_propensity = 5,</span></span>
<span id="cb66-2544"><a href="#cb66-2544" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_censoring = 5,</span></span>
<span id="cb66-2545"><a href="#cb66-2545" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_survival = 5,</span></span>
<span id="cb66-2546"><a href="#cb66-2546" aria-hidden="true" tabindex="-1"></a><span class="in">  coefC = 0.03</span></span>
<span id="cb66-2547"><a href="#cb66-2547" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2548"><a href="#cb66-2548" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_obs1, file = "simulation_obs1.RData")</span></span>
<span id="cb66-2549"><a href="#cb66-2549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2550"><a href="#cb66-2550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2551"><a href="#cb66-2551" aria-hidden="true" tabindex="-1"></a><span class="in"># Obs2 simulation with specific coefficients and parameters</span></span>
<span id="cb66-2552"><a href="#cb66-2552" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_obs2 &lt;- compute_estimator(</span></span>
<span id="cb66-2553"><a href="#cb66-2553" aria-hidden="true" tabindex="-1"></a><span class="in">  n_sim, tau = tau, scenario = "Obs2", </span></span>
<span id="cb66-2554"><a href="#cb66-2554" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.propensity = c("X1", "X2", "X3", "X4"), </span></span>
<span id="cb66-2555"><a href="#cb66-2555" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.outcome = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2556"><a href="#cb66-2556" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.censoring = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2557"><a href="#cb66-2557" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_propensity = c("glm", "probability forest"), </span></span>
<span id="cb66-2558"><a href="#cb66-2558" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_censoring = c("cox", "survival forest"), </span></span>
<span id="cb66-2559"><a href="#cb66-2559" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_survival = c("cox", "survival forest"), </span></span>
<span id="cb66-2560"><a href="#cb66-2560" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_propensity = 5,</span></span>
<span id="cb66-2561"><a href="#cb66-2561" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_censoring = 5,</span></span>
<span id="cb66-2562"><a href="#cb66-2562" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_survival = 5,</span></span>
<span id="cb66-2563"><a href="#cb66-2563" aria-hidden="true" tabindex="-1"></a><span class="in">  coefC = 0.03, </span></span>
<span id="cb66-2564"><a href="#cb66-2564" aria-hidden="true" tabindex="-1"></a><span class="in">  parsC = c(0.7, 0.3, -0.25, -0.1)</span></span>
<span id="cb66-2565"><a href="#cb66-2565" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2566"><a href="#cb66-2566" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_obs2, file = "simulation_obs2.RData")</span></span>
<span id="cb66-2567"><a href="#cb66-2567" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2568"><a href="#cb66-2568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2569"><a href="#cb66-2569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2572"><a href="#cb66-2572" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-2573"><a href="#cb66-2573" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_obs1.RData"</span>)</span>
<span id="cb66-2574"><a href="#cb66-2574" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_obs2.RData"</span>)</span>
<span id="cb66-2575"><a href="#cb66-2575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2576"><a href="#cb66-2576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2577"><a href="#cb66-2577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2578"><a href="#cb66-2578" aria-hidden="true" tabindex="-1"></a>@fig-obs1 below shows the distribution of the estimators of $\theta_{\mathrm{RMST}}$</span>
<span id="cb66-2579"><a href="#cb66-2579" aria-hidden="true" tabindex="-1"></a>for the observational study with independent censoring.</span>
<span id="cb66-2580"><a href="#cb66-2580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2581"><a href="#cb66-2581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2582"><a href="#cb66-2582" aria-hidden="true" tabindex="-1"></a><span class="in"># Update the theme to center the plot title</span></span>
<span id="cb66-2583"><a href="#cb66-2583" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-2584"><a href="#cb66-2584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2585"><a href="#cb66-2585" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert sample size to a factor with levels sorted in decreasing order</span></span>
<span id="cb66-2586"><a href="#cb66-2586" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_obs1$sample.size &lt;- factor(</span></span>
<span id="cb66-2587"><a href="#cb66-2587" aria-hidden="true" tabindex="-1"></a><span class="in">  simulation_obs1$sample.size, </span></span>
<span id="cb66-2588"><a href="#cb66-2588" aria-hidden="true" tabindex="-1"></a><span class="in">  levels = sort(unique(simulation_obs1$sample.size), decreasing = TRUE)</span></span>
<span id="cb66-2589"><a href="#cb66-2589" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2590"><a href="#cb66-2590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2591"><a href="#cb66-2591" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert estimator column to a factor with the specified order</span></span>
<span id="cb66-2592"><a href="#cb66-2592" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_obs1$estimator &lt;- factor(simulation_obs1$estimator, </span></span>
<span id="cb66-2593"><a href="#cb66-2593" aria-hidden="true" tabindex="-1"></a><span class="in">                                    levels = desired_order)</span></span>
<span id="cb66-2594"><a href="#cb66-2594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2595"><a href="#cb66-2595" aria-hidden="true" tabindex="-1"></a><span class="in"># Create the plot for Observational + independent censoring</span></span>
<span id="cb66-2596"><a href="#cb66-2596" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_obs1 &lt;- simulation_obs1 %&gt;%</span></span>
<span id="cb66-2597"><a href="#cb66-2597" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(</span></span>
<span id="cb66-2598"><a href="#cb66-2598" aria-hidden="true" tabindex="-1"></a><span class="in">    x = estimator, y = estimate,  </span></span>
<span id="cb66-2599"><a href="#cb66-2599" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = factor(sample.size, levels = rev(levels(sample.size)))</span></span>
<span id="cb66-2600"><a href="#cb66-2600" aria-hidden="true" tabindex="-1"></a><span class="in">  )) +</span></span>
<span id="cb66-2601"><a href="#cb66-2601" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-2602"><a href="#cb66-2602" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-2603"><a href="#cb66-2603" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +  # Change x-axis label</span></span>
<span id="cb66-2604"><a href="#cb66-2604" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") +  # Change y-axis label</span></span>
<span id="cb66-2605"><a href="#cb66-2605" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom = "errorbar") +</span></span>
<span id="cb66-2606"><a href="#cb66-2606" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(</span></span>
<span id="cb66-2607"><a href="#cb66-2607" aria-hidden="true" tabindex="-1"></a><span class="in">    yintercept = truth_tau3, linetype = "dashed", color = "red", </span></span>
<span id="cb66-2608"><a href="#cb66-2608" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha = 0.8, size = 0.8</span></span>
<span id="cb66-2609"><a href="#cb66-2609" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb66-2610"><a href="#cb66-2610" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb66-2611"><a href="#cb66-2611" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-2612"><a href="#cb66-2612" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.box = "vertical", legend.text = element_text(size = 18),</span></span>
<span id="cb66-2613"><a href="#cb66-2613" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  </span></span>
<span id="cb66-2614"><a href="#cb66-2614" aria-hidden="true" tabindex="-1"></a><span class="in">    # Adjust text angle for better visibility</span></span>
<span id="cb66-2615"><a href="#cb66-2615" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text = element_text(size = 15, face = "bold"),</span></span>
<span id="cb66-2616"><a href="#cb66-2616" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.title.x = element_text(size = 16, face = "bold"),</span></span>
<span id="cb66-2617"><a href="#cb66-2617" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.margin = margin(t = 10, r = 10, b = 50, l = 10)  # Add margin</span></span>
<span id="cb66-2618"><a href="#cb66-2618" aria-hidden="true" tabindex="-1"></a><span class="in">  ) + </span></span>
<span id="cb66-2619"><a href="#cb66-2619" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0, 15))</span></span>
<span id="cb66-2620"><a href="#cb66-2620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2621"><a href="#cb66-2621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2622"><a href="#cb66-2622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2623"><a href="#cb66-2623" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2624"><a href="#cb66-2624" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-obs1</span></span>
<span id="cb66-2625"><a href="#cb66-2625" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Estimation results of the ATE for the simulation of an observational study with independent censoring."</span></span>
<span id="cb66-2626"><a href="#cb66-2626" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb66-2627"><a href="#cb66-2627" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_obs1</span></span>
<span id="cb66-2628"><a href="#cb66-2628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2629"><a href="#cb66-2629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2630"><a href="#cb66-2630" aria-hidden="true" tabindex="-1"></a>In the simulation of an observational study with independent censoring,</span>
<span id="cb66-2631"><a href="#cb66-2631" aria-hidden="true" tabindex="-1"></a>confounding bias is introduced, setting it apart from RCT simulations.</span>
<span id="cb66-2632"><a href="#cb66-2632" aria-hidden="true" tabindex="-1"></a>As expected, estimators that fail to adjust for this bias, such as</span>
<span id="cb66-2633"><a href="#cb66-2633" aria-hidden="true" tabindex="-1"></a>unadjusted Kaplan-Meier (KM), IPCW KM (Cox), and their equivalents, are</span>
<span id="cb66-2634"><a href="#cb66-2634" aria-hidden="true" tabindex="-1"></a>biased. However, estimators like IPTW KM (Log.Reg.), IPTW-IPCW</span>
<span id="cb66-2635"><a href="#cb66-2635" aria-hidden="true" tabindex="-1"></a>KM (Cox <span class="sc">\&amp;</span> Log. Reg.) are unbiased, even if the latter estimate unnecessary nuisance components. Results with IPTW BJ (Cox &amp; Log.Reg) are extremely variable. </span>
<span id="cb66-2636"><a href="#cb66-2636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2637"><a href="#cb66-2637" aria-hidden="true" tabindex="-1"></a>The top-performing estimators in this</span>
<span id="cb66-2638"><a href="#cb66-2638" aria-hidden="true" tabindex="-1"></a>scenario are  G-formula (Cox/ T-learners) and AIPCW-AIPTW (Cox &amp; Cox &amp; Log.Reg.), which are unbiased even with 500 observations. The former has the lowest variance. All estimators that use forests to estimate nuisance parameters are biased across sample sizes from 500 to 8000. Although Causal Survival Forest and AIPW-AIPCW (Forest) are expected to eventually converge, they remain extremely demanding in terms of sample size. This setting thus highlights that one should either have an a priori knowledge on the specification of the models or large sample size.</span>
<span id="cb66-2639"><a href="#cb66-2639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2640"><a href="#cb66-2640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2641"><a href="#cb66-2641" aria-hidden="true" tabindex="-1"></a>@fig-obs2 below shows the distribution of the $\theta_{\mathrm{RMST}}$</span>
<span id="cb66-2642"><a href="#cb66-2642" aria-hidden="true" tabindex="-1"></a>estimates for the observational study with conditionally independent</span>
<span id="cb66-2643"><a href="#cb66-2643" aria-hidden="true" tabindex="-1"></a>censoring. The red dashed line represents the true $\theta_{\mathrm{RMST}}$ for</span>
<span id="cb66-2644"><a href="#cb66-2644" aria-hidden="true" tabindex="-1"></a>$\tau=25$.</span>
<span id="cb66-2645"><a href="#cb66-2645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2646"><a href="#cb66-2646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2647"><a href="#cb66-2647" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2648"><a href="#cb66-2648" aria-hidden="true" tabindex="-1"></a><span class="in"># Update the theme to center the plot title</span></span>
<span id="cb66-2649"><a href="#cb66-2649" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-2650"><a href="#cb66-2650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2651"><a href="#cb66-2651" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert sample size to a factor with levels sorted in decreasing order</span></span>
<span id="cb66-2652"><a href="#cb66-2652" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_obs2$sample.size &lt;- factor(</span></span>
<span id="cb66-2653"><a href="#cb66-2653" aria-hidden="true" tabindex="-1"></a><span class="in">  simulation_obs2$sample.size, </span></span>
<span id="cb66-2654"><a href="#cb66-2654" aria-hidden="true" tabindex="-1"></a><span class="in">  levels = sort(unique(simulation_obs2$sample.size), decreasing = TRUE)</span></span>
<span id="cb66-2655"><a href="#cb66-2655" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-2656"><a href="#cb66-2656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2657"><a href="#cb66-2657" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert estimator column to a factor with the specified order</span></span>
<span id="cb66-2658"><a href="#cb66-2658" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_obs2$estimator &lt;- factor(simulation_obs2$estimator, </span></span>
<span id="cb66-2659"><a href="#cb66-2659" aria-hidden="true" tabindex="-1"></a><span class="in">                                    levels = desired_order)</span></span>
<span id="cb66-2660"><a href="#cb66-2660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2661"><a href="#cb66-2661" aria-hidden="true" tabindex="-1"></a><span class="in"># Create the plot for Observational + dependent censoring</span></span>
<span id="cb66-2662"><a href="#cb66-2662" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_obs2 &lt;- simulation_obs2 %&gt;%</span></span>
<span id="cb66-2663"><a href="#cb66-2663" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(</span></span>
<span id="cb66-2664"><a href="#cb66-2664" aria-hidden="true" tabindex="-1"></a><span class="in">    x = estimator, y = estimate,  </span></span>
<span id="cb66-2665"><a href="#cb66-2665" aria-hidden="true" tabindex="-1"></a><span class="in">    fill = factor(sample.size, levels = rev(levels(sample.size)))</span></span>
<span id="cb66-2666"><a href="#cb66-2666" aria-hidden="true" tabindex="-1"></a><span class="in">  )) +</span></span>
<span id="cb66-2667"><a href="#cb66-2667" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-2668"><a href="#cb66-2668" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-2669"><a href="#cb66-2669" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +  # Change x-axis label</span></span>
<span id="cb66-2670"><a href="#cb66-2670" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") +  # Change y-axis label</span></span>
<span id="cb66-2671"><a href="#cb66-2671" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom = "errorbar") +</span></span>
<span id="cb66-2672"><a href="#cb66-2672" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(</span></span>
<span id="cb66-2673"><a href="#cb66-2673" aria-hidden="true" tabindex="-1"></a><span class="in">    yintercept = truth_tau4, linetype = "dashed", color = "red", </span></span>
<span id="cb66-2674"><a href="#cb66-2674" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha = 0.8, size = 0.8</span></span>
<span id="cb66-2675"><a href="#cb66-2675" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb66-2676"><a href="#cb66-2676" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(</span></span>
<span id="cb66-2677"><a href="#cb66-2677" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-2678"><a href="#cb66-2678" aria-hidden="true" tabindex="-1"></a><span class="in">    legend.box = "vertical", legend.text = element_text(size = 18),</span></span>
<span id="cb66-2679"><a href="#cb66-2679" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  </span></span>
<span id="cb66-2680"><a href="#cb66-2680" aria-hidden="true" tabindex="-1"></a><span class="in">    # Adjust text angle for better visibility</span></span>
<span id="cb66-2681"><a href="#cb66-2681" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.text = element_text(size = 15, face = "bold"),</span></span>
<span id="cb66-2682"><a href="#cb66-2682" aria-hidden="true" tabindex="-1"></a><span class="in">    axis.title.x = element_text(size = 16, face = "bold"),</span></span>
<span id="cb66-2683"><a href="#cb66-2683" aria-hidden="true" tabindex="-1"></a><span class="in">    plot.margin = margin(t = 10, r = 10, b = 50, l = 10)  # Add margin</span></span>
<span id="cb66-2684"><a href="#cb66-2684" aria-hidden="true" tabindex="-1"></a><span class="in">  ) + </span></span>
<span id="cb66-2685"><a href="#cb66-2685" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim = c(0, 15))</span></span>
<span id="cb66-2686"><a href="#cb66-2686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2687"><a href="#cb66-2687" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2688"><a href="#cb66-2688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2689"><a href="#cb66-2689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2690"><a href="#cb66-2690" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-obs2</span></span>
<span id="cb66-2691"><a href="#cb66-2691" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Estimation results of the ATE for the simulation of an observational study with dependent censoring."</span></span>
<span id="cb66-2692"><a href="#cb66-2692" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb66-2693"><a href="#cb66-2693" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_obs2</span></span>
<span id="cb66-2694"><a href="#cb66-2694" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2695"><a href="#cb66-2695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2696"><a href="#cb66-2696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2697"><a href="#cb66-2697" aria-hidden="true" tabindex="-1"></a>In the simulation of an observational study with conditionally</span>
<span id="cb66-2698"><a href="#cb66-2698" aria-hidden="true" tabindex="-1"></a>independent censoring, estimators that do not account for both censoring</span>
<span id="cb66-2699"><a href="#cb66-2699" aria-hidden="true" tabindex="-1"></a>and confounding bias, such as KM, IPCW KM, IPTW KM, and their</span>
<span id="cb66-2700"><a href="#cb66-2700" aria-hidden="true" tabindex="-1"></a>package equivalents, are biased.</span>
<span id="cb66-2701"><a href="#cb66-2701" aria-hidden="true" tabindex="-1"></a>The top-performing estimators in this</span>
<span id="cb66-2702"><a href="#cb66-2702" aria-hidden="true" tabindex="-1"></a>scenario are  G-formula (Cox/ T-learners) and AIPCW-AIPTW (Cox &amp; Cox &amp; Log.Reg.), which are unbiased even with 500 observations. The former has the lowest variance as expected, see  @sec-Gformula. Surprisingly, the G-formula (Cox/S-learner) and its equivalent from the RISCA package perform quite competitively, showing only a slight bias despite the violation of the proportional hazards assumption.</span>
<span id="cb66-2703"><a href="#cb66-2703" aria-hidden="true" tabindex="-1"></a>All estimators that use forests to estimate nuisance parameters are biased across sample sizes from 500 to 8000. Although Causal Survival Forest and AIPTW-AIPCW (Forest) are expected to eventually converge, they remain extremely demanding in terms of sample size. </span>
<span id="cb66-2704"><a href="#cb66-2704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2705"><a href="#cb66-2705" aria-hidden="true" tabindex="-1"></a><span class="fu">## Mispecification of nuisance components</span></span>
<span id="cb66-2706"><a href="#cb66-2706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2707"><a href="#cb66-2707" aria-hidden="true" tabindex="-1"></a>**Data Generating Process**</span>
<span id="cb66-2708"><a href="#cb66-2708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2709"><a href="#cb66-2709" aria-hidden="true" tabindex="-1"></a>We generate an observational study with covariate interactions and conditionally independent censoring. The objective is to assess the impact of misspecifying nuisance components; specifically, we will use models that omit interactions to estimate these components. This approach enables us to evaluate the robustness properties of various estimators. In addition, in this setting forest based methods are expected to behave better. </span>
<span id="cb66-2710"><a href="#cb66-2710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2711"><a href="#cb66-2711" aria-hidden="true" tabindex="-1"></a>We generate $n$ samples $(X_{i},A_{i},C,T_{i}(0), T_{i}(1))$ as follows:</span>
<span id="cb66-2712"><a href="#cb66-2712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2713"><a href="#cb66-2713" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>$X \sim \mathcal{N}\left(\mu, \Sigma\right)$ and $\mu = (0.5,0.5,0.7,0.5)$, $\Sigma = \mathrm{Id}_4$.</span>
<span id="cb66-2714"><a href="#cb66-2714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2715"><a href="#cb66-2715" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The hazard function of $T(0)$ is given by</span>
<span id="cb66-2716"><a href="#cb66-2716" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb66-2717"><a href="#cb66-2717" aria-hidden="true" tabindex="-1"></a>    \begin{aligned}</span>
<span id="cb66-2718"><a href="#cb66-2718" aria-hidden="true" tabindex="-1"></a>    \lambda^{(0)}(t|X) = \exp<span class="sc">\{</span>\beta_0^\top Y<span class="sc">\}</span> \quad \text{where} \quad \beta_0 &amp;= (0.2,0.3,0.1,0.1,1,0,0,0,0,1), <span class="sc">\\</span></span>
<span id="cb66-2719"><a href="#cb66-2719" aria-hidden="true" tabindex="-1"></a>    \text{and} \quad Y &amp;= (X_1^2,X_2^2,X_3^2,X_4^2,X_1 X_2,X_1X_3,X_1X_4,X_2 X_3,X_2X_4, X_3 X_4).</span>
<span id="cb66-2720"><a href="#cb66-2720" aria-hidden="true" tabindex="-1"></a>    \end{aligned}</span>
<span id="cb66-2721"><a href="#cb66-2721" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb66-2722"><a href="#cb66-2722" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>The distribution of $T(1)$ is the one of $T(0)$ but shifted: $T(1) = T(0)+1$.</span>
<span id="cb66-2723"><a href="#cb66-2723" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The hazard function of $C$ is given by</span>
<span id="cb66-2724"><a href="#cb66-2724" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb66-2725"><a href="#cb66-2725" aria-hidden="true" tabindex="-1"></a>    \begin{aligned}</span>
<span id="cb66-2726"><a href="#cb66-2726" aria-hidden="true" tabindex="-1"></a>    \lambda_C(t|X) = \exp<span class="sc">\{</span>\beta_C^\top Y<span class="sc">\}</span> \quad \text{where} \quad \beta_C &amp;= (0.05,0.05,-0.1,0.1,0,1,0,-1,0,0).</span>
<span id="cb66-2727"><a href="#cb66-2727" aria-hidden="true" tabindex="-1"></a>    \end{aligned}</span>
<span id="cb66-2728"><a href="#cb66-2728" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb66-2729"><a href="#cb66-2729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2730"><a href="#cb66-2730" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The propensity score is</span>
<span id="cb66-2731"><a href="#cb66-2731" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb66-2732"><a href="#cb66-2732" aria-hidden="true" tabindex="-1"></a>    \begin{aligned}</span>
<span id="cb66-2733"><a href="#cb66-2733" aria-hidden="true" tabindex="-1"></a>    \mathrm{logit}(e(x)) = \beta_A^\top Y \quad \text{where} \quad \beta_A= (0.05,-0.1,0.5,-0.1,1,0,1,0,0,0).</span>
<span id="cb66-2734"><a href="#cb66-2734" aria-hidden="true" tabindex="-1"></a>    \end{aligned}</span>
<span id="cb66-2735"><a href="#cb66-2735" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb66-2736"><a href="#cb66-2736" aria-hidden="true" tabindex="-1"></a>When the model is well-specified, the full vector $(X,Y)$ is given as an input of the nuisance parameter models. When it is not, only $X$ and the first half of $Y$ corresponding to $(X_1^2,X_2^2,X_3^2,X_4^2)$ is given as an input.</span>
<span id="cb66-2737"><a href="#cb66-2737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2738"><a href="#cb66-2738" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-2739"><a href="#cb66-2739" aria-hidden="true" tabindex="-1"></a><span class="in"># DGP for misspecification </span></span>
<span id="cb66-2740"><a href="#cb66-2740" aria-hidden="true" tabindex="-1"></a><span class="in">simulate_data_mis &lt;- function(n, </span></span>
<span id="cb66-2741"><a href="#cb66-2741" aria-hidden="true" tabindex="-1"></a><span class="in">                              mu = c(0.5, 0.5, 0.7, 0.5),</span></span>
<span id="cb66-2742"><a href="#cb66-2742" aria-hidden="true" tabindex="-1"></a><span class="in">                              sigma =  matrix(c(1, 0, 0, 0, </span></span>
<span id="cb66-2743"><a href="#cb66-2743" aria-hidden="true" tabindex="-1"></a><span class="in">                                                0, 1, 0, 0, </span></span>
<span id="cb66-2744"><a href="#cb66-2744" aria-hidden="true" tabindex="-1"></a><span class="in">                                                0, 0, 1, 0,</span></span>
<span id="cb66-2745"><a href="#cb66-2745" aria-hidden="true" tabindex="-1"></a><span class="in">                                                0, 0, 0, 1), </span></span>
<span id="cb66-2746"><a href="#cb66-2746" aria-hidden="true" tabindex="-1"></a><span class="in">                                              nrow = 4, byrow = TRUE),</span></span>
<span id="cb66-2747"><a href="#cb66-2747" aria-hidden="true" tabindex="-1"></a><span class="in">                              colnames_cov = c("X1", "X2", "X3", "X4"),</span></span>
<span id="cb66-2748"><a href="#cb66-2748" aria-hidden="true" tabindex="-1"></a><span class="in">                              parsA =  c(0.05, -0.1, 0.5, -0.1),</span></span>
<span id="cb66-2749"><a href="#cb66-2749" aria-hidden="true" tabindex="-1"></a><span class="in">                              tau){</span></span>
<span id="cb66-2750"><a href="#cb66-2750" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2751"><a href="#cb66-2751" aria-hidden="true" tabindex="-1"></a><span class="in">  # Generate X from a multivariate normal distribution</span></span>
<span id="cb66-2752"><a href="#cb66-2752" aria-hidden="true" tabindex="-1"></a><span class="in">  X &lt;- MASS::mvrnorm(n, mu, sigma)</span></span>
<span id="cb66-2753"><a href="#cb66-2753" aria-hidden="true" tabindex="-1"></a><span class="in">  X &lt;- as.data.frame(X)</span></span>
<span id="cb66-2754"><a href="#cb66-2754" aria-hidden="true" tabindex="-1"></a><span class="in">  colnames(X) &lt;- colnames_cov</span></span>
<span id="cb66-2755"><a href="#cb66-2755" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2756"><a href="#cb66-2756" aria-hidden="true" tabindex="-1"></a><span class="in">  # Treatment variable selection: all X</span></span>
<span id="cb66-2757"><a href="#cb66-2757" aria-hidden="true" tabindex="-1"></a><span class="in">  X_treatment &lt;- as.matrix(X)</span></span>
<span id="cb66-2758"><a href="#cb66-2758" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2759"><a href="#cb66-2759" aria-hidden="true" tabindex="-1"></a><span class="in">  # Propensity score model based on X</span></span>
<span id="cb66-2760"><a href="#cb66-2760" aria-hidden="true" tabindex="-1"></a><span class="in">  e &lt;- parsA[1]*X_treatment[, "X1"]^2 + parsA[2]*X_treatment[, "X2"]^2 + </span></span>
<span id="cb66-2761"><a href="#cb66-2761" aria-hidden="true" tabindex="-1"></a><span class="in">    parsA[3]*X_treatment[, "X3"]^2 + parsA[4]*X_treatment[, "X4"]^2-</span></span>
<span id="cb66-2762"><a href="#cb66-2762" aria-hidden="true" tabindex="-1"></a><span class="in">    X_treatment[, "X1"]*X_treatment[, "X2"] +</span></span>
<span id="cb66-2763"><a href="#cb66-2763" aria-hidden="true" tabindex="-1"></a><span class="in">    X_treatment[, "X1"]*X_treatment[, "X4"]</span></span>
<span id="cb66-2764"><a href="#cb66-2764" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2765"><a href="#cb66-2765" aria-hidden="true" tabindex="-1"></a><span class="in">  # Logistic regression</span></span>
<span id="cb66-2766"><a href="#cb66-2766" aria-hidden="true" tabindex="-1"></a><span class="in">  e &lt;- plogis(e)</span></span>
<span id="cb66-2767"><a href="#cb66-2767" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2768"><a href="#cb66-2768" aria-hidden="true" tabindex="-1"></a><span class="in">  # Treatment assignment based on the propensity score</span></span>
<span id="cb66-2769"><a href="#cb66-2769" aria-hidden="true" tabindex="-1"></a><span class="in">  A &lt;- sapply(e, FUN = function(p) rbinom(n = 1, size = 1, prob = p))</span></span>
<span id="cb66-2770"><a href="#cb66-2770" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2771"><a href="#cb66-2771" aria-hidden="true" tabindex="-1"></a><span class="in">  # Outcome variable selection: all X</span></span>
<span id="cb66-2772"><a href="#cb66-2772" aria-hidden="true" tabindex="-1"></a><span class="in">  X_outcome &lt;- as.matrix(X)</span></span>
<span id="cb66-2773"><a href="#cb66-2773" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2774"><a href="#cb66-2774" aria-hidden="true" tabindex="-1"></a><span class="in">  lambda &lt;- exp(0.2*X[,1]^2 + 0.3*X[,2]^2 + 0.1*X[,3]^2 + 0.1*X[,4]^2 + </span></span>
<span id="cb66-2775"><a href="#cb66-2775" aria-hidden="true" tabindex="-1"></a><span class="in">    X[,1] * X[,2] + X[,3] * X[,4])</span></span>
<span id="cb66-2776"><a href="#cb66-2776" aria-hidden="true" tabindex="-1"></a><span class="in">  # Simulate the outcome using the cumulative hazard inversion method</span></span>
<span id="cb66-2777"><a href="#cb66-2777" aria-hidden="true" tabindex="-1"></a><span class="in">  epsilon &lt;- runif(n, min = 1e-8, max = 1)</span></span>
<span id="cb66-2778"><a href="#cb66-2778" aria-hidden="true" tabindex="-1"></a><span class="in">  T0 &lt;- -log(epsilon) / lambda</span></span>
<span id="cb66-2779"><a href="#cb66-2779" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2780"><a href="#cb66-2780" aria-hidden="true" tabindex="-1"></a><span class="in">  # Simulate independent censoring time</span></span>
<span id="cb66-2781"><a href="#cb66-2781" aria-hidden="true" tabindex="-1"></a><span class="in">  censoring_lambda &lt;- exp(0.05*X[,1]^2 + 0.05*X[,2]^2-0.1*X[,3]^2 + 0.1*X[,4]^2 + </span></span>
<span id="cb66-2782"><a href="#cb66-2782" aria-hidden="true" tabindex="-1"></a><span class="in">    X[,3] * X[,1] - X[,2]*X[,4])</span></span>
<span id="cb66-2783"><a href="#cb66-2783" aria-hidden="true" tabindex="-1"></a><span class="in">  epsilon &lt;- runif(n, min = 1e-8, max = 1)</span></span>
<span id="cb66-2784"><a href="#cb66-2784" aria-hidden="true" tabindex="-1"></a><span class="in">  C &lt;- -log(epsilon) / censoring_lambda</span></span>
<span id="cb66-2785"><a href="#cb66-2785" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2786"><a href="#cb66-2786" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2787"><a href="#cb66-2787" aria-hidden="true" tabindex="-1"></a><span class="in">  # T(1) = T(0) + 1</span></span>
<span id="cb66-2788"><a href="#cb66-2788" aria-hidden="true" tabindex="-1"></a><span class="in">  T1 &lt;- T0 + 1</span></span>
<span id="cb66-2789"><a href="#cb66-2789" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2790"><a href="#cb66-2790" aria-hidden="true" tabindex="-1"></a><span class="in">  # True survival time</span></span>
<span id="cb66-2791"><a href="#cb66-2791" aria-hidden="true" tabindex="-1"></a><span class="in">  T_true &lt;- A * T1 + (1 - A) * T0</span></span>
<span id="cb66-2792"><a href="#cb66-2792" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2793"><a href="#cb66-2793" aria-hidden="true" tabindex="-1"></a><span class="in">  # Observed time</span></span>
<span id="cb66-2794"><a href="#cb66-2794" aria-hidden="true" tabindex="-1"></a><span class="in">  T_obs &lt;- pmin(T_true, C)</span></span>
<span id="cb66-2795"><a href="#cb66-2795" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2796"><a href="#cb66-2796" aria-hidden="true" tabindex="-1"></a><span class="in">  # Status indicator</span></span>
<span id="cb66-2797"><a href="#cb66-2797" aria-hidden="true" tabindex="-1"></a><span class="in">  status &lt;- as.numeric(T_true &lt;= C)</span></span>
<span id="cb66-2798"><a href="#cb66-2798" aria-hidden="true" tabindex="-1"></a><span class="in">  censor.status &lt;- as.numeric(T_true &gt; C)</span></span>
<span id="cb66-2799"><a href="#cb66-2799" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2800"><a href="#cb66-2800" aria-hidden="true" tabindex="-1"></a><span class="in">  # Restricted survival time</span></span>
<span id="cb66-2801"><a href="#cb66-2801" aria-hidden="true" tabindex="-1"></a><span class="in">  T_obs_tau &lt;- pmin(T_obs, tau)</span></span>
<span id="cb66-2802"><a href="#cb66-2802" aria-hidden="true" tabindex="-1"></a><span class="in">  status_tau &lt;- as.numeric((T_obs &gt; tau) | (T_obs &lt;= tau &amp; status == 1))</span></span>
<span id="cb66-2803"><a href="#cb66-2803" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compile the simulated data into a data frame</span></span>
<span id="cb66-2804"><a href="#cb66-2804" aria-hidden="true" tabindex="-1"></a><span class="in">  DATA_target_population &lt;- data.frame(X, tau, A, T0, T1, C, T_obs, T_obs_tau, </span></span>
<span id="cb66-2805"><a href="#cb66-2805" aria-hidden="true" tabindex="-1"></a><span class="in">                                       status, status_tau, censor.status, e)</span></span>
<span id="cb66-2806"><a href="#cb66-2806" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-2807"><a href="#cb66-2807" aria-hidden="true" tabindex="-1"></a><span class="in">  return(DATA_target_population)</span></span>
<span id="cb66-2808"><a href="#cb66-2808" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-2809"><a href="#cb66-2809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2810"><a href="#cb66-2810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2811"><a href="#cb66-2811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2812"><a href="#cb66-2812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2815"><a href="#cb66-2815" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-2816"><a href="#cb66-2816" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to estimate RMST for each misspecification context</span></span>
<span id="cb66-2817"><a href="#cb66-2817" aria-hidden="true" tabindex="-1"></a>compute_estimator_mispec <span class="ot">&lt;-</span> <span class="cf">function</span>(n_sim, tau, </span>
<span id="cb66-2818"><a href="#cb66-2818" aria-hidden="true" tabindex="-1"></a>                                     X.names.propensity_mis, </span>
<span id="cb66-2819"><a href="#cb66-2819" aria-hidden="true" tabindex="-1"></a>                                     X.names.propensity, </span>
<span id="cb66-2820"><a href="#cb66-2820" aria-hidden="true" tabindex="-1"></a>                                     X.names.outcome,</span>
<span id="cb66-2821"><a href="#cb66-2821" aria-hidden="true" tabindex="-1"></a>                                     X.names.outcome_mis,</span>
<span id="cb66-2822"><a href="#cb66-2822" aria-hidden="true" tabindex="-1"></a>                                     X.names.censoring,</span>
<span id="cb66-2823"><a href="#cb66-2823" aria-hidden="true" tabindex="-1"></a>                                     X.names.censoring_mis,</span>
<span id="cb66-2824"><a href="#cb66-2824" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">nuisance_propensity =</span> <span class="st">"glm"</span>, </span>
<span id="cb66-2825"><a href="#cb66-2825" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">nuisance_censoring =</span> <span class="st">"cox"</span>, </span>
<span id="cb66-2826"><a href="#cb66-2826" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">nuisance_survival =</span> <span class="st">"cox"</span>, </span>
<span id="cb66-2827"><a href="#cb66-2827" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">n.folds_propensity =</span> <span class="cn">NULL</span>,</span>
<span id="cb66-2828"><a href="#cb66-2828" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">n.folds_censoring =</span> <span class="cn">NULL</span>, </span>
<span id="cb66-2829"><a href="#cb66-2829" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">n.folds_survival =</span> <span class="cn">NULL</span>,</span>
<span id="cb66-2830"><a href="#cb66-2830" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">estimator =</span> <span class="st">"all"</span>,</span>
<span id="cb66-2831"><a href="#cb66-2831" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">sample_sizes =</span> <span class="fu">c</span>(<span class="dv">8000</span>)) {</span>
<span id="cb66-2832"><a href="#cb66-2832" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2833"><a href="#cb66-2833" aria-hidden="true" tabindex="-1"></a>  pb_n <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">length</span>(sample_sizes) <span class="sc">*</span> n_sim, </span>
<span id="cb66-2834"><a href="#cb66-2834" aria-hidden="true" tabindex="-1"></a>                         <span class="at">style =</span> <span class="dv">3</span>, <span class="at">initial =</span> <span class="dv">0</span>, <span class="at">char =</span> <span class="st">"#"</span>)</span>
<span id="cb66-2835"><a href="#cb66-2835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">on.exit</span>(<span class="fu">close</span>(pb_n))</span>
<span id="cb66-2836"><a href="#cb66-2836" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2837"><a href="#cb66-2837" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize data frame for each misspecification</span></span>
<span id="cb66-2838"><a href="#cb66-2838" aria-hidden="true" tabindex="-1"></a>  simulation_mis <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2839"><a href="#cb66-2839" aria-hidden="true" tabindex="-1"></a>  simulation_mistreat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2840"><a href="#cb66-2840" aria-hidden="true" tabindex="-1"></a>  simulation_misout <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2841"><a href="#cb66-2841" aria-hidden="true" tabindex="-1"></a>  simulation_miscens <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2842"><a href="#cb66-2842" aria-hidden="true" tabindex="-1"></a>  simulation_mistreat_out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2843"><a href="#cb66-2843" aria-hidden="true" tabindex="-1"></a>  simulation_miscens_out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2844"><a href="#cb66-2844" aria-hidden="true" tabindex="-1"></a>  simulation_mistreat_cens <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2845"><a href="#cb66-2845" aria-hidden="true" tabindex="-1"></a>  simulation_misall <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb66-2846"><a href="#cb66-2846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2847"><a href="#cb66-2847" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to compute estimators for multiple simulations and sample sizes</span></span>
<span id="cb66-2848"><a href="#cb66-2848" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> sample_sizes) {</span>
<span id="cb66-2849"><a href="#cb66-2849" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sim) {</span>
<span id="cb66-2850"><a href="#cb66-2850" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setTxtProgressBar</span>(pb_n, (<span class="fu">which</span>(sample_sizes <span class="sc">==</span> n) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> n_sim <span class="sc">+</span> i)</span>
<span id="cb66-2851"><a href="#cb66-2851" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">&lt;-</span> <span class="fu">simulate_data_mis</span>(n, <span class="at">tau =</span> tau)</span>
<span id="cb66-2852"><a href="#cb66-2852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2853"><a href="#cb66-2853" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute all estimates for the simulated data</span></span>
<span id="cb66-2854"><a href="#cb66-2854" aria-hidden="true" tabindex="-1"></a>      res_all_mis <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2855"><a href="#cb66-2855" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-2856"><a href="#cb66-2856" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb66-2857"><a href="#cb66-2857" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb66-2858"><a href="#cb66-2858" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_propensity =</span> nuisance_propensity, </span>
<span id="cb66-2859"><a href="#cb66-2859" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2860"><a href="#cb66-2860" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">nuisance_survival =</span> nuisance_survival, </span>
<span id="cb66-2861"><a href="#cb66-2861" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2862"><a href="#cb66-2862" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2863"><a href="#cb66-2863" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2864"><a href="#cb66-2864" aria-hidden="true" tabindex="-1"></a>                                   estimator)</span>
<span id="cb66-2865"><a href="#cb66-2865" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2866"><a href="#cb66-2866" aria-hidden="true" tabindex="-1"></a>      res_all_mistreat <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2867"><a href="#cb66-2867" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb66-2868"><a href="#cb66-2868" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb66-2869"><a href="#cb66-2869" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb66-2870"><a href="#cb66-2870" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb66-2871"><a href="#cb66-2871" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2872"><a href="#cb66-2872" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">nuisance_survival =</span> nuisance_survival,  </span>
<span id="cb66-2873"><a href="#cb66-2873" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2874"><a href="#cb66-2874" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2875"><a href="#cb66-2875" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2876"><a href="#cb66-2876" aria-hidden="true" tabindex="-1"></a>                                        estimator)</span>
<span id="cb66-2877"><a href="#cb66-2877" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2878"><a href="#cb66-2878" aria-hidden="true" tabindex="-1"></a>      res_all_misout <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2879"><a href="#cb66-2879" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-2880"><a href="#cb66-2880" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb66-2881"><a href="#cb66-2881" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb66-2882"><a href="#cb66-2882" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb66-2883"><a href="#cb66-2883" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2884"><a href="#cb66-2884" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_survival =</span> nuisance_survival,  </span>
<span id="cb66-2885"><a href="#cb66-2885" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2886"><a href="#cb66-2886" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2887"><a href="#cb66-2887" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2888"><a href="#cb66-2888" aria-hidden="true" tabindex="-1"></a>                                      estimator)</span>
<span id="cb66-2889"><a href="#cb66-2889" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2890"><a href="#cb66-2890" aria-hidden="true" tabindex="-1"></a>      res_all_miscens <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2891"><a href="#cb66-2891" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-2892"><a href="#cb66-2892" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb66-2893"><a href="#cb66-2893" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb66-2894"><a href="#cb66-2894" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb66-2895"><a href="#cb66-2895" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2896"><a href="#cb66-2896" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">nuisance_survival =</span> nuisance_survival,  </span>
<span id="cb66-2897"><a href="#cb66-2897" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2898"><a href="#cb66-2898" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2899"><a href="#cb66-2899" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2900"><a href="#cb66-2900" aria-hidden="true" tabindex="-1"></a>                                       estimator)</span>
<span id="cb66-2901"><a href="#cb66-2901" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2902"><a href="#cb66-2902" aria-hidden="true" tabindex="-1"></a>      res_all_mistreat_out <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2903"><a href="#cb66-2903" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb66-2904"><a href="#cb66-2904" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb66-2905"><a href="#cb66-2905" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">X.names.censoring =</span> X.names.censoring,</span>
<span id="cb66-2906"><a href="#cb66-2906" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb66-2907"><a href="#cb66-2907" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2908"><a href="#cb66-2908" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb66-2909"><a href="#cb66-2909" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2910"><a href="#cb66-2910" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2911"><a href="#cb66-2911" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2912"><a href="#cb66-2912" aria-hidden="true" tabindex="-1"></a>                                            estimator)</span>
<span id="cb66-2913"><a href="#cb66-2913" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2914"><a href="#cb66-2914" aria-hidden="true" tabindex="-1"></a>      res_all_miscens_out <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2915"><a href="#cb66-2915" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">X.names.propensity =</span> X.names.propensity, </span>
<span id="cb66-2916"><a href="#cb66-2916" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb66-2917"><a href="#cb66-2917" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb66-2918"><a href="#cb66-2918" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb66-2919"><a href="#cb66-2919" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2920"><a href="#cb66-2920" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb66-2921"><a href="#cb66-2921" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2922"><a href="#cb66-2922" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2923"><a href="#cb66-2923" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2924"><a href="#cb66-2924" aria-hidden="true" tabindex="-1"></a>                                           estimator)</span>
<span id="cb66-2925"><a href="#cb66-2925" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2926"><a href="#cb66-2926" aria-hidden="true" tabindex="-1"></a>      res_all_mistreat_cens <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2927"><a href="#cb66-2927" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb66-2928"><a href="#cb66-2928" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.outcome =</span> X.names.outcome,</span>
<span id="cb66-2929"><a href="#cb66-2929" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb66-2930"><a href="#cb66-2930" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb66-2931"><a href="#cb66-2931" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2932"><a href="#cb66-2932" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb66-2933"><a href="#cb66-2933" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2934"><a href="#cb66-2934" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2935"><a href="#cb66-2935" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2936"><a href="#cb66-2936" aria-hidden="true" tabindex="-1"></a>                                             estimator)</span>
<span id="cb66-2937"><a href="#cb66-2937" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2938"><a href="#cb66-2938" aria-hidden="true" tabindex="-1"></a>      res_all_misall <span class="ot">&lt;-</span> <span class="fu">all_estimates</span>(data, n, <span class="at">tau =</span> tau, </span>
<span id="cb66-2939"><a href="#cb66-2939" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.propensity =</span> X.names.propensity_mis, </span>
<span id="cb66-2940"><a href="#cb66-2940" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.outcome =</span> X.names.outcome_mis,</span>
<span id="cb66-2941"><a href="#cb66-2941" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X.names.censoring =</span> X.names.censoring_mis,</span>
<span id="cb66-2942"><a href="#cb66-2942" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_propensity =</span> nuisance_propensity,</span>
<span id="cb66-2943"><a href="#cb66-2943" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_censoring =</span> nuisance_censoring,</span>
<span id="cb66-2944"><a href="#cb66-2944" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">nuisance_survival =</span> nuisance_survival,</span>
<span id="cb66-2945"><a href="#cb66-2945" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_propensity =</span> n.folds_propensity, </span>
<span id="cb66-2946"><a href="#cb66-2946" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_censoring =</span> n.folds_censoring, </span>
<span id="cb66-2947"><a href="#cb66-2947" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">n.folds_survival =</span> n.folds_survival,</span>
<span id="cb66-2948"><a href="#cb66-2948" aria-hidden="true" tabindex="-1"></a>                                      estimator)</span>
<span id="cb66-2949"><a href="#cb66-2949" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb66-2950"><a href="#cb66-2950" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Store the results</span></span>
<span id="cb66-2951"><a href="#cb66-2951" aria-hidden="true" tabindex="-1"></a>      simulation_mis <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mis, res_all_mis)</span>
<span id="cb66-2952"><a href="#cb66-2952" aria-hidden="true" tabindex="-1"></a>      simulation_mistreat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mistreat, res_all_mistreat)</span>
<span id="cb66-2953"><a href="#cb66-2953" aria-hidden="true" tabindex="-1"></a>      simulation_misout <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_misout, res_all_misout)</span>
<span id="cb66-2954"><a href="#cb66-2954" aria-hidden="true" tabindex="-1"></a>      simulation_miscens <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_miscens, res_all_miscens)</span>
<span id="cb66-2955"><a href="#cb66-2955" aria-hidden="true" tabindex="-1"></a>      simulation_mistreat_out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mistreat_out, res_all_mistreat_out)</span>
<span id="cb66-2956"><a href="#cb66-2956" aria-hidden="true" tabindex="-1"></a>      simulation_miscens_out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_miscens_out, res_all_miscens_out)</span>
<span id="cb66-2957"><a href="#cb66-2957" aria-hidden="true" tabindex="-1"></a>      simulation_mistreat_cens <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_mistreat_cens, res_all_mistreat_cens)</span>
<span id="cb66-2958"><a href="#cb66-2958" aria-hidden="true" tabindex="-1"></a>      simulation_misall <span class="ot">&lt;-</span> <span class="fu">rbind</span>(simulation_misall, res_all_misall)</span>
<span id="cb66-2959"><a href="#cb66-2959" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-2960"><a href="#cb66-2960" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-2961"><a href="#cb66-2961" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-2962"><a href="#cb66-2962" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fusion of dataframe</span></span>
<span id="cb66-2963"><a href="#cb66-2963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb66-2964"><a href="#cb66-2964" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mis =</span> simulation_mis,</span>
<span id="cb66-2965"><a href="#cb66-2965" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mistreat =</span> simulation_mistreat,</span>
<span id="cb66-2966"><a href="#cb66-2966" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_misout =</span> simulation_misout,</span>
<span id="cb66-2967"><a href="#cb66-2967" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_miscens =</span> simulation_miscens,</span>
<span id="cb66-2968"><a href="#cb66-2968" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mistreat_out =</span> simulation_mistreat_out,</span>
<span id="cb66-2969"><a href="#cb66-2969" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_miscens_out =</span> simulation_miscens_out,</span>
<span id="cb66-2970"><a href="#cb66-2970" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_mistreat_cens =</span> simulation_mistreat_cens,</span>
<span id="cb66-2971"><a href="#cb66-2971" aria-hidden="true" tabindex="-1"></a>    <span class="at">simulation_misall =</span> simulation_misall</span>
<span id="cb66-2972"><a href="#cb66-2972" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb66-2973"><a href="#cb66-2973" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-2974"><a href="#cb66-2974" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2975"><a href="#cb66-2975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2976"><a href="#cb66-2976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2977"><a href="#cb66-2977" aria-hidden="true" tabindex="-1"></a>The descriptive statistics are given in Appendix (@sec-stat_inter).</span>
<span id="cb66-2978"><a href="#cb66-2978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2981"><a href="#cb66-2981" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-2982"><a href="#cb66-2982" aria-hidden="true" tabindex="-1"></a><span class="co"># Mis scenario </span></span>
<span id="cb66-2983"><a href="#cb66-2983" aria-hidden="true" tabindex="-1"></a>tau_mis <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb66-2984"><a href="#cb66-2984" aria-hidden="true" tabindex="-1"></a>vec_tau_complex <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb66-2985"><a href="#cb66-2985" aria-hidden="true" tabindex="-1"></a>data_mis <span class="ot">&lt;-</span> <span class="fu">simulate_data_mis</span>(<span class="at">n =</span> <span class="dv">150000</span>, <span class="at">tau =</span> tau_mis)</span>
<span id="cb66-2986"><a href="#cb66-2986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2987"><a href="#cb66-2987" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_ground_truth(data_mis,</span></span>
<span id="cb66-2988"><a href="#cb66-2988" aria-hidden="true" tabindex="-1"></a><span class="co">#                  vec_tau_complex, </span></span>
<span id="cb66-2989"><a href="#cb66-2989" aria-hidden="true" tabindex="-1"></a><span class="co">#                  tau_mis, </span></span>
<span id="cb66-2990"><a href="#cb66-2990" aria-hidden="true" tabindex="-1"></a><span class="co">#                  c(0, 1), </span></span>
<span id="cb66-2991"><a href="#cb66-2991" aria-hidden="true" tabindex="-1"></a><span class="co">#                  "True difference in RMST for Mis scenario")</span></span>
<span id="cb66-2992"><a href="#cb66-2992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2993"><a href="#cb66-2993" aria-hidden="true" tabindex="-1"></a>truth_complex_mis <span class="ot">&lt;-</span> <span class="fu">ground_truth</span>(data_mis, <span class="at">tau =</span> tau_mis)</span>
<span id="cb66-2994"><a href="#cb66-2994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2995"><a href="#cb66-2995" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The ground truth for mis scenario at time 0.45 is "</span>, <span class="fu">round</span>(truth_complex_mis,<span class="dv">2</span>)))</span>
<span id="cb66-2996"><a href="#cb66-2996" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-2997"><a href="#cb66-2997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2998"><a href="#cb66-2998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2999"><a href="#cb66-2999" aria-hidden="true" tabindex="-1"></a>**Estimation of the RMST**</span>
<span id="cb66-3000"><a href="#cb66-3000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3001"><a href="#cb66-3001" aria-hidden="true" tabindex="-1"></a>First, we estimate $\theta_{\mathrm{RMST}}$ without any model misspecification to confirm the consistency of the estimators under correctly specified nuisance models. More specifically, it means that for parametric propensity score models, semi-parametric censoring and survival models, we use models including interactions and squared assuming knowledge on the data generating process.  </span>
<span id="cb66-3002"><a href="#cb66-3002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3003"><a href="#cb66-3003" aria-hidden="true" tabindex="-1"></a>Next, we introduce misspecification individually for the treatment model, censoring model, and outcome model (@fig-mis), i.e., we use models without interaction to estimate parametric and semi-parametric nuisance components while the data are generated with interactions.  </span>
<span id="cb66-3004"><a href="#cb66-3004" aria-hidden="true" tabindex="-1"></a>We further examine combined misspecifications for pairs of models: treatment and censoring, treatment and outcome, and outcome and censoring. Finally, we assess the impact of misspecifying all nuisance models simultaneously (@fig-mis2).</span>
<span id="cb66-3005"><a href="#cb66-3005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3006"><a href="#cb66-3006" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb66-3007"><a href="#cb66-3007" aria-hidden="true" tabindex="-1"></a><span class="in">n_sim &lt;- 100</span></span>
<span id="cb66-3008"><a href="#cb66-3008" aria-hidden="true" tabindex="-1"></a><span class="in">tau &lt;- 0.5</span></span>
<span id="cb66-3009"><a href="#cb66-3009" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis &lt;- compute_estimator(</span></span>
<span id="cb66-3010"><a href="#cb66-3010" aria-hidden="true" tabindex="-1"></a><span class="in">  n_sim, tau = tau, scenario = "Mis", </span></span>
<span id="cb66-3011"><a href="#cb66-3011" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.propensity = c("I(X1^2)", "I(X2^2)","I(X3^2)", "I(X4^2)", </span></span>
<span id="cb66-3012"><a href="#cb66-3012" aria-hidden="true" tabindex="-1"></a><span class="in">                         "X1*X2","X1*X4"),</span></span>
<span id="cb66-3013"><a href="#cb66-3013" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.outcome = c("I(X1^2)", "I(X2^2)","I(X3^2)", "I(X4^2)", </span></span>
<span id="cb66-3014"><a href="#cb66-3014" aria-hidden="true" tabindex="-1"></a><span class="in">                      "X1:X2", "X3:X4"),</span></span>
<span id="cb66-3015"><a href="#cb66-3015" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.censoring = c("I(X1^2)", "I(X2^2)","I(X3^2)", "I(X4^2)", </span></span>
<span id="cb66-3016"><a href="#cb66-3016" aria-hidden="true" tabindex="-1"></a><span class="in">                        "X1:X3", "X2:X4"),</span></span>
<span id="cb66-3017"><a href="#cb66-3017" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_propensity = c("glm"), </span></span>
<span id="cb66-3018"><a href="#cb66-3018" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_censoring = c("cox"), </span></span>
<span id="cb66-3019"><a href="#cb66-3019" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_survival = c("cox"), </span></span>
<span id="cb66-3020"><a href="#cb66-3020" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_propensity = NULL,</span></span>
<span id="cb66-3021"><a href="#cb66-3021" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_censoring = NULL,</span></span>
<span id="cb66-3022"><a href="#cb66-3022" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_survival = NULL,</span></span>
<span id="cb66-3023"><a href="#cb66-3023" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_sizes = c(500, 1000, 2000, 4000, 8000),</span></span>
<span id="cb66-3024"><a href="#cb66-3024" aria-hidden="true" tabindex="-1"></a><span class="in">  estimator = c("Naive", "KM", "IPTW KM", "IPCW KM", "BJ", </span></span>
<span id="cb66-3025"><a href="#cb66-3025" aria-hidden="true" tabindex="-1"></a><span class="in">                "IPTW-IPCW KM", "IPTW-BJ", "G_formula (T-learners)", </span></span>
<span id="cb66-3026"><a href="#cb66-3026" aria-hidden="true" tabindex="-1"></a><span class="in">                "G_formula (S-learner)", "AIPTW-AIPCW")</span></span>
<span id="cb66-3027"><a href="#cb66-3027" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-3028"><a href="#cb66-3028" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_mis, file="simulation_mis.RData") </span></span>
<span id="cb66-3029"><a href="#cb66-3029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3030"><a href="#cb66-3030" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis_c &lt;- compute_estimator(</span></span>
<span id="cb66-3031"><a href="#cb66-3031" aria-hidden="true" tabindex="-1"></a><span class="in">  n_sim, tau = tau, scenario = "Mis", </span></span>
<span id="cb66-3032"><a href="#cb66-3032" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.propensity = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-3033"><a href="#cb66-3033" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.outcome = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-3034"><a href="#cb66-3034" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.censoring = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-3035"><a href="#cb66-3035" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_propensity = c("probability forest"), </span></span>
<span id="cb66-3036"><a href="#cb66-3036" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_censoring = c("survival forest"), </span></span>
<span id="cb66-3037"><a href="#cb66-3037" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_survival = c("survival forest"), </span></span>
<span id="cb66-3038"><a href="#cb66-3038" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_propensity = 5,</span></span>
<span id="cb66-3039"><a href="#cb66-3039" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_censoring = 5,</span></span>
<span id="cb66-3040"><a href="#cb66-3040" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_survival = 5,</span></span>
<span id="cb66-3041"><a href="#cb66-3041" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_sizes = c(500, 1000, 2000, 4000, 8000),</span></span>
<span id="cb66-3042"><a href="#cb66-3042" aria-hidden="true" tabindex="-1"></a><span class="in">  estimator = c("IPTW KM", "IPCW KM", "BJ", </span></span>
<span id="cb66-3043"><a href="#cb66-3043" aria-hidden="true" tabindex="-1"></a><span class="in">                "IPTW-IPCW KM", "IPTW-BJ", "G_formula (T-learners)", </span></span>
<span id="cb66-3044"><a href="#cb66-3044" aria-hidden="true" tabindex="-1"></a><span class="in">                "G_formula (S-learner)", "AIPTW-AIPCW",</span></span>
<span id="cb66-3045"><a href="#cb66-3045" aria-hidden="true" tabindex="-1"></a><span class="in">                "grf - Causal Survival Forest")</span></span>
<span id="cb66-3046"><a href="#cb66-3046" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-3047"><a href="#cb66-3047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3048"><a href="#cb66-3048" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_mis_c, file="simulation_mis_c.RData") </span></span>
<span id="cb66-3049"><a href="#cb66-3049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3050"><a href="#cb66-3050" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis_c_16000 &lt;- compute_estimator(</span></span>
<span id="cb66-3051"><a href="#cb66-3051" aria-hidden="true" tabindex="-1"></a><span class="in">  n_sim, tau = tau, scenario = "Mis", </span></span>
<span id="cb66-3052"><a href="#cb66-3052" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.propensity = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-3053"><a href="#cb66-3053" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.outcome = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-3054"><a href="#cb66-3054" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.censoring = c("X1","X2","X3","X4"),</span></span>
<span id="cb66-3055"><a href="#cb66-3055" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_propensity = c("probability forest"), </span></span>
<span id="cb66-3056"><a href="#cb66-3056" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_censoring = c("survival forest"), </span></span>
<span id="cb66-3057"><a href="#cb66-3057" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_survival = c("survival forest"), </span></span>
<span id="cb66-3058"><a href="#cb66-3058" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_propensity = 5,</span></span>
<span id="cb66-3059"><a href="#cb66-3059" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_censoring = 5,</span></span>
<span id="cb66-3060"><a href="#cb66-3060" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds_survival = 5,</span></span>
<span id="cb66-3061"><a href="#cb66-3061" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_sizes = 16000,</span></span>
<span id="cb66-3062"><a href="#cb66-3062" aria-hidden="true" tabindex="-1"></a><span class="in">  estimator = c("IPTW KM", "G_formula (T-learners)")</span></span>
<span id="cb66-3063"><a href="#cb66-3063" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-3064"><a href="#cb66-3064" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_mis_c_16000, file="simulations/results magellan 4/simulation_mis_c_16000.RData")  </span></span>
<span id="cb66-3065"><a href="#cb66-3065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3066"><a href="#cb66-3066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3067"><a href="#cb66-3067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3070"><a href="#cb66-3070" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-3071"><a href="#cb66-3071" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mis.RData"</span>)</span>
<span id="cb66-3072"><a href="#cb66-3072" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mis_c.RData"</span>)</span>
<span id="cb66-3073"><a href="#cb66-3073" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 4/simulation_mis_c_16000.RData"</span>)</span>
<span id="cb66-3074"><a href="#cb66-3074" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3075"><a href="#cb66-3075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3076"><a href="#cb66-3076" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3077"><a href="#cb66-3077" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the desired order of the estimators</span></span>
<span id="cb66-3078"><a href="#cb66-3078" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis2 &lt;- rbind(simulation_mis,simulation_mis_c)</span></span>
<span id="cb66-3079"><a href="#cb66-3079" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis2 &lt;- rbind(simulation_mis2,simulation_mis_c_16000)</span></span>
<span id="cb66-3080"><a href="#cb66-3080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3081"><a href="#cb66-3081" aria-hidden="true" tabindex="-1"></a><span class="in">desired_order &lt;- c(</span></span>
<span id="cb66-3082"><a href="#cb66-3082" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naive",</span></span>
<span id="cb66-3083"><a href="#cb66-3083" aria-hidden="true" tabindex="-1"></a><span class="in">  "KM",</span></span>
<span id="cb66-3084"><a href="#cb66-3084" aria-hidden="true" tabindex="-1"></a><span class="in">  "SurvRM2 - KM",</span></span>
<span id="cb66-3085"><a href="#cb66-3085" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW KM (Log. Reg.)",</span></span>
<span id="cb66-3086"><a href="#cb66-3086" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPCW KM (Cox)",</span></span>
<span id="cb66-3087"><a href="#cb66-3087" aria-hidden="true" tabindex="-1"></a><span class="in">  "BJ (Cox)",</span></span>
<span id="cb66-3088"><a href="#cb66-3088" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-BJ (Cox &amp; Log. Reg.)",</span></span>
<span id="cb66-3089"><a href="#cb66-3089" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-IPCW KM (Cox &amp; Log. Reg.)",</span></span>
<span id="cb66-3090"><a href="#cb66-3090" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Cox/ T-learners)",</span></span>
<span id="cb66-3091"><a href="#cb66-3091" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Cox/ S-learner)",</span></span>
<span id="cb66-3092"><a href="#cb66-3092" aria-hidden="true" tabindex="-1"></a><span class="in">  "AIPTW-AIPCW (Cox &amp; Cox &amp; Log. Reg.)",</span></span>
<span id="cb66-3093"><a href="#cb66-3093" aria-hidden="true" tabindex="-1"></a><span class="in">  "grf - Causal Survival Forest",</span></span>
<span id="cb66-3094"><a href="#cb66-3094" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW KM (Forest)",</span></span>
<span id="cb66-3095"><a href="#cb66-3095" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPCW KM (Forest)",</span></span>
<span id="cb66-3096"><a href="#cb66-3096" aria-hidden="true" tabindex="-1"></a><span class="in">  "BJ (Forest)",</span></span>
<span id="cb66-3097"><a href="#cb66-3097" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-BJ (Forest)",</span></span>
<span id="cb66-3098"><a href="#cb66-3098" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPTW-IPCW KM (Forest)",</span></span>
<span id="cb66-3099"><a href="#cb66-3099" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Forest/ T-learners)",</span></span>
<span id="cb66-3100"><a href="#cb66-3100" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Forest/ S-learner)",</span></span>
<span id="cb66-3101"><a href="#cb66-3101" aria-hidden="true" tabindex="-1"></a><span class="in">  "AIPTW-AIPCW (Forest)")</span></span>
<span id="cb66-3102"><a href="#cb66-3102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3103"><a href="#cb66-3103" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3104"><a href="#cb66-3104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3105"><a href="#cb66-3105" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis2$sample.size &lt;- factor(simulation_mis2$sample.size, </span></span>
<span id="cb66-3106"><a href="#cb66-3106" aria-hidden="true" tabindex="-1"></a><span class="in">                                      levels = sort(unique(simulation_mis2$sample.size), </span></span>
<span id="cb66-3107"><a href="#cb66-3107" aria-hidden="true" tabindex="-1"></a><span class="in">                                                    decreasing = TRUE))</span></span>
<span id="cb66-3108"><a href="#cb66-3108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3109"><a href="#cb66-3109" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3110"><a href="#cb66-3110" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis2$estimator &lt;- factor(simulation_mis2$estimator, levels = desired_order)</span></span>
<span id="cb66-3111"><a href="#cb66-3111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3112"><a href="#cb66-3112" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis &lt;- simulation_mis2 %&gt;%</span></span>
<span id="cb66-3113"><a href="#cb66-3113" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, </span></span>
<span id="cb66-3114"><a href="#cb66-3114" aria-hidden="true" tabindex="-1"></a><span class="in">                                                         levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3115"><a href="#cb66-3115" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3116"><a href="#cb66-3116" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("No misspecification:  ")+</span></span>
<span id="cb66-3117"><a href="#cb66-3117" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3118"><a href="#cb66-3118" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +  # Changer le label de l'axe x</span></span>
<span id="cb66-3119"><a href="#cb66-3119" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") +  # Retirer le label de l'axe y</span></span>
<span id="cb66-3120"><a href="#cb66-3120" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3121"><a href="#cb66-3121" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3122"><a href="#cb66-3122" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Changer geom_hline en geom_vline</span></span>
<span id="cb66-3123"><a href="#cb66-3123" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3124"><a href="#cb66-3124" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3125"><a href="#cb66-3125" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3126"><a href="#cb66-3126" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3127"><a href="#cb66-3127" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3128"><a href="#cb66-3128" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3129"><a href="#cb66-3129" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3130"><a href="#cb66-3130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3131"><a href="#cb66-3131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3132"><a href="#cb66-3132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3133"><a href="#cb66-3133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=15, fig.height=10, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3134"><a href="#cb66-3134" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-mis3</span></span>
<span id="cb66-3135"><a href="#cb66-3135" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Estimation results of the ATE for the simulation of an observational study with dependent censoring and non linear relationships."</span></span>
<span id="cb66-3136"><a href="#cb66-3136" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb66-3137"><a href="#cb66-3137" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis</span></span>
<span id="cb66-3138"><a href="#cb66-3138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3139"><a href="#cb66-3139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3140"><a href="#cb66-3140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb66-3141"><a href="#cb66-3141" aria-hidden="true" tabindex="-1"></a><span class="in">n_sim &lt;- 100</span></span>
<span id="cb66-3142"><a href="#cb66-3142" aria-hidden="true" tabindex="-1"></a><span class="in">tau &lt;- 0.5</span></span>
<span id="cb66-3143"><a href="#cb66-3143" aria-hidden="true" tabindex="-1"></a><span class="in">mis &lt;- compute_estimator_mispec(n_sim, tau = tau, </span></span>
<span id="cb66-3144"><a href="#cb66-3144" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.propensity = c("I(X1^2)", "I(X2^2)",</span></span>
<span id="cb66-3145"><a href="#cb66-3145" aria-hidden="true" tabindex="-1"></a><span class="in">                                                          "I(X3^2)", "I(X4^2)", </span></span>
<span id="cb66-3146"><a href="#cb66-3146" aria-hidden="true" tabindex="-1"></a><span class="in">                                                          "X1*X2","X1*X4"),</span></span>
<span id="cb66-3147"><a href="#cb66-3147" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.outcome = c("I(X1^2)", "I(X2^2)",</span></span>
<span id="cb66-3148"><a href="#cb66-3148" aria-hidden="true" tabindex="-1"></a><span class="in">                                                       "I(X3^2)", "I(X4^2)", </span></span>
<span id="cb66-3149"><a href="#cb66-3149" aria-hidden="true" tabindex="-1"></a><span class="in">                                                       "X1:X2", "X3:X4"),</span></span>
<span id="cb66-3150"><a href="#cb66-3150" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.censoring = c("I(X1^2)", "I(X2^2)",</span></span>
<span id="cb66-3151"><a href="#cb66-3151" aria-hidden="true" tabindex="-1"></a><span class="in">                                                         "I(X3^2)", "I(X4^2)", </span></span>
<span id="cb66-3152"><a href="#cb66-3152" aria-hidden="true" tabindex="-1"></a><span class="in">                                                         "X1:X3", "X2:X4"),</span></span>
<span id="cb66-3153"><a href="#cb66-3153" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.propensity_mis = c("I(X1^2)","I(X2^2)",</span></span>
<span id="cb66-3154"><a href="#cb66-3154" aria-hidden="true" tabindex="-1"></a><span class="in">                                                              "I(X3^2)", "I(X4^2)"),</span></span>
<span id="cb66-3155"><a href="#cb66-3155" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.outcome_mis = c("I(X1^2)", "I(X2^2)",</span></span>
<span id="cb66-3156"><a href="#cb66-3156" aria-hidden="true" tabindex="-1"></a><span class="in">                                                           "I(X3^2)", "I(X4^2)"),</span></span>
<span id="cb66-3157"><a href="#cb66-3157" aria-hidden="true" tabindex="-1"></a><span class="in">                                   X.names.censoring_mis = c("I(X1^2)", "I(X2^2)",</span></span>
<span id="cb66-3158"><a href="#cb66-3158" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             "I(X3^2)", "I(X4^2)"),</span></span>
<span id="cb66-3159"><a href="#cb66-3159" aria-hidden="true" tabindex="-1"></a><span class="in">                                   nuisance_propensity = c("glm"), </span></span>
<span id="cb66-3160"><a href="#cb66-3160" aria-hidden="true" tabindex="-1"></a><span class="in">                                   nuisance_censoring = c("cox"), </span></span>
<span id="cb66-3161"><a href="#cb66-3161" aria-hidden="true" tabindex="-1"></a><span class="in">                                   nuisance_survival = c("cox"),</span></span>
<span id="cb66-3162"><a href="#cb66-3162" aria-hidden="true" tabindex="-1"></a><span class="in">                                   estimator = estimators,</span></span>
<span id="cb66-3163"><a href="#cb66-3163" aria-hidden="true" tabindex="-1"></a><span class="in">                                   sample_size = 8000)</span></span>
<span id="cb66-3164"><a href="#cb66-3164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3165"><a href="#cb66-3165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3166"><a href="#cb66-3166" aria-hidden="true" tabindex="-1"></a><span class="in"># Initialize a list to decompose the results</span></span>
<span id="cb66-3167"><a href="#cb66-3167" aria-hidden="true" tabindex="-1"></a><span class="in">merged_results &lt;- list()</span></span>
<span id="cb66-3168"><a href="#cb66-3168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3169"><a href="#cb66-3169" aria-hidden="true" tabindex="-1"></a><span class="in"># All the defined sceanario</span></span>
<span id="cb66-3170"><a href="#cb66-3170" aria-hidden="true" tabindex="-1"></a><span class="in">scenarios &lt;- c("simulation_mis", "simulation_mistreat", "simulation_misout",</span></span>
<span id="cb66-3171"><a href="#cb66-3171" aria-hidden="true" tabindex="-1"></a><span class="in">               "simulation_miscens", "simulation_mistreat_out", </span></span>
<span id="cb66-3172"><a href="#cb66-3172" aria-hidden="true" tabindex="-1"></a><span class="in">               "simulation_miscens_out", "simulation_mistreat_cens", </span></span>
<span id="cb66-3173"><a href="#cb66-3173" aria-hidden="true" tabindex="-1"></a><span class="in">               "simulation_misall")</span></span>
<span id="cb66-3174"><a href="#cb66-3174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3175"><a href="#cb66-3175" aria-hidden="true" tabindex="-1"></a><span class="in"># Loop through all scenarios</span></span>
<span id="cb66-3176"><a href="#cb66-3176" aria-hidden="true" tabindex="-1"></a><span class="in">for (s in scenarios) {</span></span>
<span id="cb66-3177"><a href="#cb66-3177" aria-hidden="true" tabindex="-1"></a><span class="in">  # Initialize an empty dataframe</span></span>
<span id="cb66-3178"><a href="#cb66-3178" aria-hidden="true" tabindex="-1"></a><span class="in">  scenario_results &lt;- data.frame()</span></span>
<span id="cb66-3179"><a href="#cb66-3179" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-3180"><a href="#cb66-3180" aria-hidden="true" tabindex="-1"></a><span class="in">  # Loop through all sample sizes</span></span>
<span id="cb66-3181"><a href="#cb66-3181" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in seq_along(sample_sizes)) {</span></span>
<span id="cb66-3182"><a href="#cb66-3182" aria-hidden="true" tabindex="-1"></a><span class="in">    # Append the results for the given scenario and sample size </span></span>
<span id="cb66-3183"><a href="#cb66-3183" aria-hidden="true" tabindex="-1"></a><span class="in">    scenario_results &lt;- rbind(scenario_results, results[[i]][[s]])</span></span>
<span id="cb66-3184"><a href="#cb66-3184" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb66-3185"><a href="#cb66-3185" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-3186"><a href="#cb66-3186" aria-hidden="true" tabindex="-1"></a><span class="in">  # Add the results for the given scenario to the results list </span></span>
<span id="cb66-3187"><a href="#cb66-3187" aria-hidden="true" tabindex="-1"></a><span class="in">  merged_results[[s]] &lt;- scenario_results</span></span>
<span id="cb66-3188"><a href="#cb66-3188" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb66-3189"><a href="#cb66-3189" aria-hidden="true" tabindex="-1"></a><span class="in">  # Save the final results for the given scenario in an .RData file</span></span>
<span id="cb66-3190"><a href="#cb66-3190" aria-hidden="true" tabindex="-1"></a><span class="in">  assign(paste0(s), scenario_results)</span></span>
<span id="cb66-3191"><a href="#cb66-3191" aria-hidden="true" tabindex="-1"></a><span class="in">  save(list = paste0(s), file = sprintf("%s.RData", s))</span></span>
<span id="cb66-3192"><a href="#cb66-3192" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb66-3193"><a href="#cb66-3193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3194"><a href="#cb66-3194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3195"><a href="#cb66-3195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3196"><a href="#cb66-3196" aria-hidden="true" tabindex="-1"></a><span class="in">load("simulations/results magellan 5/simulation_mis2.RData")</span></span>
<span id="cb66-3197"><a href="#cb66-3197" aria-hidden="true" tabindex="-1"></a><span class="in">load("simulations/results magellan 5/simulation_mistreat.RData")</span></span>
<span id="cb66-3198"><a href="#cb66-3198" aria-hidden="true" tabindex="-1"></a><span class="in">load("simulations/results magellan 5/simulation_miscens.RData")</span></span>
<span id="cb66-3199"><a href="#cb66-3199" aria-hidden="true" tabindex="-1"></a><span class="in">load("simulations/results magellan 5/simulation_misout.RData")</span></span>
<span id="cb66-3200"><a href="#cb66-3200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3201"><a href="#cb66-3201" aria-hidden="true" tabindex="-1"></a><span class="in"># Define the desired order of the estimators</span></span>
<span id="cb66-3202"><a href="#cb66-3202" aria-hidden="true" tabindex="-1"></a><span class="in">desired_order_mis &lt;- c(</span></span>
<span id="cb66-3203"><a href="#cb66-3203" aria-hidden="true" tabindex="-1"></a><span class="in">  "Naive", "KM",</span></span>
<span id="cb66-3204"><a href="#cb66-3204" aria-hidden="true" tabindex="-1"></a><span class="in">"IPTW KM (Log. Reg.)",</span></span>
<span id="cb66-3205"><a href="#cb66-3205" aria-hidden="true" tabindex="-1"></a><span class="in">  "IPCW KM (Cox)", "BJ (Cox)",  "IPTW-BJ (Cox &amp; Log. Reg.)", </span></span>
<span id="cb66-3206"><a href="#cb66-3206" aria-hidden="true" tabindex="-1"></a><span class="in">"IPTW-IPCW KM (Cox &amp; Log. Reg.)",</span></span>
<span id="cb66-3207"><a href="#cb66-3207" aria-hidden="true" tabindex="-1"></a><span class="in">  "G-formula (Cox/ T-learners)", "G-formula (Cox/ S-learner)",</span></span>
<span id="cb66-3208"><a href="#cb66-3208" aria-hidden="true" tabindex="-1"></a><span class="in">  "AIPTW-AIPCW (Cox &amp; Cox &amp; Log. Reg.)"</span></span>
<span id="cb66-3209"><a href="#cb66-3209" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-3210"><a href="#cb66-3210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3211"><a href="#cb66-3211" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis2 &lt;- simulation_mis2[simulation_mis2$estimator %in% desired_order_mis, ]</span></span>
<span id="cb66-3212"><a href="#cb66-3212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3213"><a href="#cb66-3213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3214"><a href="#cb66-3214" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3215"><a href="#cb66-3215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3216"><a href="#cb66-3216" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis2$sample.size &lt;- factor(simulation_mis2$sample.size, </span></span>
<span id="cb66-3217"><a href="#cb66-3217" aria-hidden="true" tabindex="-1"></a><span class="in">                                      levels = sort(unique(simulation_mis2$sample.size), </span></span>
<span id="cb66-3218"><a href="#cb66-3218" aria-hidden="true" tabindex="-1"></a><span class="in">                                                    decreasing = TRUE))</span></span>
<span id="cb66-3219"><a href="#cb66-3219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3220"><a href="#cb66-3220" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3221"><a href="#cb66-3221" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis2$estimator &lt;- factor(simulation_mis2$estimator, levels = desired_order)</span></span>
<span id="cb66-3222"><a href="#cb66-3222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3223"><a href="#cb66-3223" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis2 &lt;- simulation_mis2 %&gt;%</span></span>
<span id="cb66-3224"><a href="#cb66-3224" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, </span></span>
<span id="cb66-3225"><a href="#cb66-3225" aria-hidden="true" tabindex="-1"></a><span class="in">                                                         levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3226"><a href="#cb66-3226" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3227"><a href="#cb66-3227" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("No misspecification:  ")+</span></span>
<span id="cb66-3228"><a href="#cb66-3228" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3229"><a href="#cb66-3229" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +</span></span>
<span id="cb66-3230"><a href="#cb66-3230" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") + </span></span>
<span id="cb66-3231"><a href="#cb66-3231" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3232"><a href="#cb66-3232" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3233"><a href="#cb66-3233" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Change geom_hline to geom_vline</span></span>
<span id="cb66-3234"><a href="#cb66-3234" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3235"><a href="#cb66-3235" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3236"><a href="#cb66-3236" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3237"><a href="#cb66-3237" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3238"><a href="#cb66-3238" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3239"><a href="#cb66-3239" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3240"><a href="#cb66-3240" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3241"><a href="#cb66-3241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3242"><a href="#cb66-3242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3243"><a href="#cb66-3243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3244"><a href="#cb66-3244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3245"><a href="#cb66-3245" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3246"><a href="#cb66-3246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3247"><a href="#cb66-3247" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mistreat$sample.size &lt;- factor(simulation_mistreat$sample.size, levels = sort(unique(simulation_mistreat$sample.size), decreasing = TRUE))</span></span>
<span id="cb66-3248"><a href="#cb66-3248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3249"><a href="#cb66-3249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3250"><a href="#cb66-3250" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3251"><a href="#cb66-3251" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mistreat$estimator &lt;- factor(simulation_mistreat$estimator, levels = desired_order_mis)</span></span>
<span id="cb66-3252"><a href="#cb66-3252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3253"><a href="#cb66-3253" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis_mistreat &lt;- simulation_mistreat %&gt;%</span></span>
<span id="cb66-3254"><a href="#cb66-3254" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3255"><a href="#cb66-3255" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3256"><a href="#cb66-3256" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Misspecification of treatment model:  ")+</span></span>
<span id="cb66-3257"><a href="#cb66-3257" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3258"><a href="#cb66-3258" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +  </span></span>
<span id="cb66-3259"><a href="#cb66-3259" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") + </span></span>
<span id="cb66-3260"><a href="#cb66-3260" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3261"><a href="#cb66-3261" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3262"><a href="#cb66-3262" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Changer geom_hline en geom_vline</span></span>
<span id="cb66-3263"><a href="#cb66-3263" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3264"><a href="#cb66-3264" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3265"><a href="#cb66-3265" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3266"><a href="#cb66-3266" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3267"><a href="#cb66-3267" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3268"><a href="#cb66-3268" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3269"><a href="#cb66-3269" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3270"><a href="#cb66-3270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3271"><a href="#cb66-3271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3272"><a href="#cb66-3272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3273"><a href="#cb66-3273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3274"><a href="#cb66-3274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3275"><a href="#cb66-3275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3276"><a href="#cb66-3276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3277"><a href="#cb66-3277" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3278"><a href="#cb66-3278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3279"><a href="#cb66-3279" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_miscens$sample.size &lt;- factor(simulation_miscens$sample.size, levels = sort(unique(simulation_miscens$sample.size), decreasing = TRUE))</span></span>
<span id="cb66-3280"><a href="#cb66-3280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3281"><a href="#cb66-3281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3282"><a href="#cb66-3282" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3283"><a href="#cb66-3283" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_miscens$estimator &lt;- factor(simulation_miscens$estimator, levels = desired_order_mis)</span></span>
<span id="cb66-3284"><a href="#cb66-3284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3285"><a href="#cb66-3285" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis_miscens &lt;- simulation_miscens %&gt;%</span></span>
<span id="cb66-3286"><a href="#cb66-3286" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3287"><a href="#cb66-3287" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3288"><a href="#cb66-3288" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Misspecification of censoring model:  ")+</span></span>
<span id="cb66-3289"><a href="#cb66-3289" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3290"><a href="#cb66-3290" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +</span></span>
<span id="cb66-3291"><a href="#cb66-3291" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") +</span></span>
<span id="cb66-3292"><a href="#cb66-3292" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3293"><a href="#cb66-3293" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3294"><a href="#cb66-3294" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Change geom_hline to geom_vline</span></span>
<span id="cb66-3295"><a href="#cb66-3295" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3296"><a href="#cb66-3296" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3297"><a href="#cb66-3297" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3298"><a href="#cb66-3298" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3299"><a href="#cb66-3299" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3300"><a href="#cb66-3300" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3301"><a href="#cb66-3301" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3302"><a href="#cb66-3302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3303"><a href="#cb66-3303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3304"><a href="#cb66-3304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3305"><a href="#cb66-3305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3306"><a href="#cb66-3306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3307"><a href="#cb66-3307" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3308"><a href="#cb66-3308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3309"><a href="#cb66-3309" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_misout$sample.size &lt;- factor(simulation_misout$sample.size, levels = sort(unique(simulation_misout$sample.size), decreasing = TRUE))</span></span>
<span id="cb66-3310"><a href="#cb66-3310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3311"><a href="#cb66-3311" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3312"><a href="#cb66-3312" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_misout$estimator &lt;- factor(simulation_misout$estimator, levels = desired_order_mis)</span></span>
<span id="cb66-3313"><a href="#cb66-3313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3314"><a href="#cb66-3314" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis_misout &lt;- simulation_misout %&gt;%</span></span>
<span id="cb66-3315"><a href="#cb66-3315" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3316"><a href="#cb66-3316" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3317"><a href="#cb66-3317" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Misspecification of outcome model:  ")+</span></span>
<span id="cb66-3318"><a href="#cb66-3318" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3319"><a href="#cb66-3319" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") + </span></span>
<span id="cb66-3320"><a href="#cb66-3320" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") + </span></span>
<span id="cb66-3321"><a href="#cb66-3321" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3322"><a href="#cb66-3322" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3323"><a href="#cb66-3323" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Changer geom_hline to geom_vline</span></span>
<span id="cb66-3324"><a href="#cb66-3324" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3325"><a href="#cb66-3325" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3326"><a href="#cb66-3326" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3327"><a href="#cb66-3327" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3328"><a href="#cb66-3328" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3329"><a href="#cb66-3329" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3330"><a href="#cb66-3330" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3331"><a href="#cb66-3331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3332"><a href="#cb66-3332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3333"><a href="#cb66-3333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3334"><a href="#cb66-3334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3335"><a href="#cb66-3335" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=25, fig.height=25, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3336"><a href="#cb66-3336" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-mis</span></span>
<span id="cb66-3337"><a href="#cb66-3337" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Estimation results of the ATE for an observational study with dependent censoring in case of a single misspecification."</span></span>
<span id="cb66-3338"><a href="#cb66-3338" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb66-3339"><a href="#cb66-3339" aria-hidden="true" tabindex="-1"></a><span class="in">grid.arrange(simulation_graph_mis2, simulation_graph_mis_miscens, simulation_graph_mis_misout, simulation_graph_mis_mistreat, ncol = 2, nrow = 2)</span></span>
<span id="cb66-3340"><a href="#cb66-3340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3341"><a href="#cb66-3341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3342"><a href="#cb66-3342" aria-hidden="true" tabindex="-1"></a>When there is no misspecification in @fig-mis3, as expected, IPTW-BJ (Cox &amp; Log.Reg), G-formula (Cox/ T-learners) and AIPTW-AIPCW (Cox &amp; Cox &amp; Reg.Log) are unbiased. </span>
<span id="cb66-3343"><a href="#cb66-3343" aria-hidden="true" tabindex="-1"></a>IPTW-IPCW KM (Cox &amp; Log.Reg) exhibits a bias but seems to converge at larger sample size. </span>
<span id="cb66-3344"><a href="#cb66-3344" aria-hidden="true" tabindex="-1"></a>Regarding forest-based methods, IPTW-BJ (Forest), AIPTW-AIPCW (Forest) and Causal Survival Forest estimate accurately the difference in RMST. Surprisingly, G-formula (Forest/ T-learners), G-formula (Forest/ S-learner) and IPTW-IPCW KM (Forest) exhibit small bias but are expected to eventually converge at large sample size.</span>
<span id="cb66-3345"><a href="#cb66-3345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3346"><a href="#cb66-3346" aria-hidden="true" tabindex="-1"></a>@fig-mis shows that AIPTW-AIPCW (Cox &amp; Cox &amp; Reg.Log) is convergent when there is one nuisance misspecification. In contrary, the other estimators are biased when one of its nuisance parameter is misspecified.</span>
<span id="cb66-3347"><a href="#cb66-3347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3350"><a href="#cb66-3350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-3351"><a href="#cb66-3351" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mistreat_out.RData"</span>)</span>
<span id="cb66-3352"><a href="#cb66-3352" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_miscens_out.RData"</span>)</span>
<span id="cb66-3353"><a href="#cb66-3353" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_mistreat_cens.RData"</span>)</span>
<span id="cb66-3354"><a href="#cb66-3354" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"simulations/results magellan 5/simulation_misall.RData"</span>)</span>
<span id="cb66-3355"><a href="#cb66-3355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3356"><a href="#cb66-3356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3357"><a href="#cb66-3357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3358"><a href="#cb66-3358" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3359"><a href="#cb66-3359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3360"><a href="#cb66-3360" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mistreat_out$sample.size &lt;- factor(simulation_mistreat_out$sample.size, levels = sort(unique(simulation_mistreat_out$sample.size), decreasing = TRUE))</span></span>
<span id="cb66-3361"><a href="#cb66-3361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3362"><a href="#cb66-3362" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3363"><a href="#cb66-3363" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mistreat_out$estimator &lt;- factor(simulation_mistreat_out$estimator, levels = desired_order_mis)</span></span>
<span id="cb66-3364"><a href="#cb66-3364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3365"><a href="#cb66-3365" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis_mistreat_out &lt;- simulation_mistreat_out %&gt;%</span></span>
<span id="cb66-3366"><a href="#cb66-3366" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3367"><a href="#cb66-3367" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3368"><a href="#cb66-3368" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Misspecification of outcome and treatment model:  ")+</span></span>
<span id="cb66-3369"><a href="#cb66-3369" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3370"><a href="#cb66-3370" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") + </span></span>
<span id="cb66-3371"><a href="#cb66-3371" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") +</span></span>
<span id="cb66-3372"><a href="#cb66-3372" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3373"><a href="#cb66-3373" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3374"><a href="#cb66-3374" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Change geom_hline to geom_vline</span></span>
<span id="cb66-3375"><a href="#cb66-3375" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3376"><a href="#cb66-3376" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3377"><a href="#cb66-3377" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3378"><a href="#cb66-3378" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3379"><a href="#cb66-3379" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3380"><a href="#cb66-3380" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3381"><a href="#cb66-3381" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3382"><a href="#cb66-3382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3383"><a href="#cb66-3383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3384"><a href="#cb66-3384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3385"><a href="#cb66-3385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3386"><a href="#cb66-3386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3387"><a href="#cb66-3387" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3388"><a href="#cb66-3388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3389"><a href="#cb66-3389" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_miscens_out$sample.size &lt;- factor(simulation_miscens_out$sample.size, levels = sort(unique(simulation_miscens_out$sample.size), decreasing = TRUE))</span></span>
<span id="cb66-3390"><a href="#cb66-3390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3391"><a href="#cb66-3391" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3392"><a href="#cb66-3392" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_miscens_out$estimator &lt;- factor(simulation_miscens_out$estimator, levels = desired_order_mis)</span></span>
<span id="cb66-3393"><a href="#cb66-3393" aria-hidden="true" tabindex="-1"></a><span class="in">#simulation_mis$estimator[is.na(simulation_mis$estimator)] &lt;- "G_formula (S-learner)"</span></span>
<span id="cb66-3394"><a href="#cb66-3394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3395"><a href="#cb66-3395" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis_miscens_out &lt;- simulation_miscens_out %&gt;%</span></span>
<span id="cb66-3396"><a href="#cb66-3396" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3397"><a href="#cb66-3397" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3398"><a href="#cb66-3398" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Misspecification of censoring and outcome model:  ")+</span></span>
<span id="cb66-3399"><a href="#cb66-3399" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3400"><a href="#cb66-3400" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") +  </span></span>
<span id="cb66-3401"><a href="#cb66-3401" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") + </span></span>
<span id="cb66-3402"><a href="#cb66-3402" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3403"><a href="#cb66-3403" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3404"><a href="#cb66-3404" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Change geom_hline to geom_vline</span></span>
<span id="cb66-3405"><a href="#cb66-3405" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3406"><a href="#cb66-3406" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3407"><a href="#cb66-3407" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3408"><a href="#cb66-3408" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3409"><a href="#cb66-3409" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3410"><a href="#cb66-3410" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3411"><a href="#cb66-3411" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3412"><a href="#cb66-3412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3413"><a href="#cb66-3413" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3414"><a href="#cb66-3414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3415"><a href="#cb66-3415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb66-3416"><a href="#cb66-3416" aria-hidden="true" tabindex="-1"></a><span class="in">n_sim &lt;- 100</span></span>
<span id="cb66-3417"><a href="#cb66-3417" aria-hidden="true" tabindex="-1"></a><span class="in">tau &lt;- 0.5</span></span>
<span id="cb66-3418"><a href="#cb66-3418" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mis_mistreat_cens &lt;- compute_estimator(</span></span>
<span id="cb66-3419"><a href="#cb66-3419" aria-hidden="true" tabindex="-1"></a><span class="in">  n_sim, tau = tau, scenario = "Mis", </span></span>
<span id="cb66-3420"><a href="#cb66-3420" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.propensity = c("X2"), </span></span>
<span id="cb66-3421"><a href="#cb66-3421" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.outcome = c("I(X1^2)", "I(X2^2)", "X1:X2"),</span></span>
<span id="cb66-3422"><a href="#cb66-3422" aria-hidden="true" tabindex="-1"></a><span class="in">  X.names.censoring = c("X1","X2"),</span></span>
<span id="cb66-3423"><a href="#cb66-3423" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_propensity = "glm",</span></span>
<span id="cb66-3424"><a href="#cb66-3424" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_censoring = "cox",</span></span>
<span id="cb66-3425"><a href="#cb66-3425" aria-hidden="true" tabindex="-1"></a><span class="in">  nuisance_survival = "cox",</span></span>
<span id="cb66-3426"><a href="#cb66-3426" aria-hidden="true" tabindex="-1"></a><span class="in">  coefC = NULL, </span></span>
<span id="cb66-3427"><a href="#cb66-3427" aria-hidden="true" tabindex="-1"></a><span class="in">  parsC = NULL,</span></span>
<span id="cb66-3428"><a href="#cb66-3428" aria-hidden="true" tabindex="-1"></a><span class="in">  n.folds = NULL,</span></span>
<span id="cb66-3429"><a href="#cb66-3429" aria-hidden="true" tabindex="-1"></a><span class="in">  mis_specification = "none",</span></span>
<span id="cb66-3430"><a href="#cb66-3430" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_size = 4000</span></span>
<span id="cb66-3431"><a href="#cb66-3431" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb66-3432"><a href="#cb66-3432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3433"><a href="#cb66-3433" aria-hidden="true" tabindex="-1"></a><span class="in">save(simulation_mis_mistreat_cens,file="simulations/results magellan 2/simulation_mis_mistreat_cens.RData")</span></span>
<span id="cb66-3434"><a href="#cb66-3434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3435"><a href="#cb66-3435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3436"><a href="#cb66-3436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3437"><a href="#cb66-3437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3438"><a href="#cb66-3438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3439"><a href="#cb66-3439" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3440"><a href="#cb66-3440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3441"><a href="#cb66-3441" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mistreat_cens$sample.size &lt;- factor(simulation_mistreat_cens$sample.size, levels = sort(unique(simulation_mistreat_cens$sample.size), decreasing = TRUE))</span></span>
<span id="cb66-3442"><a href="#cb66-3442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3443"><a href="#cb66-3443" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3444"><a href="#cb66-3444" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_mistreat_cens$estimator &lt;- factor(simulation_mistreat_cens$estimator, levels = desired_order_mis)</span></span>
<span id="cb66-3445"><a href="#cb66-3445" aria-hidden="true" tabindex="-1"></a><span class="in">#simulation_mis$estimator[is.na(simulation_mis$estimator)] &lt;- "G_formula (S-learner)"</span></span>
<span id="cb66-3446"><a href="#cb66-3446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3447"><a href="#cb66-3447" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis_mistreat_cens &lt;- simulation_mistreat_cens %&gt;%</span></span>
<span id="cb66-3448"><a href="#cb66-3448" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3449"><a href="#cb66-3449" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3450"><a href="#cb66-3450" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Misspecification of censoring and treatment model:  ")+</span></span>
<span id="cb66-3451"><a href="#cb66-3451" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3452"><a href="#cb66-3452" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") + </span></span>
<span id="cb66-3453"><a href="#cb66-3453" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") + </span></span>
<span id="cb66-3454"><a href="#cb66-3454" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3455"><a href="#cb66-3455" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3456"><a href="#cb66-3456" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Change geom_hline to geom_vline</span></span>
<span id="cb66-3457"><a href="#cb66-3457" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3458"><a href="#cb66-3458" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3459"><a href="#cb66-3459" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3460"><a href="#cb66-3460" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3461"><a href="#cb66-3461" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3462"><a href="#cb66-3462" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3463"><a href="#cb66-3463" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3464"><a href="#cb66-3464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3465"><a href="#cb66-3465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3466"><a href="#cb66-3466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3467"><a href="#cb66-3467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3468"><a href="#cb66-3468" aria-hidden="true" tabindex="-1"></a><span class="in">theme_update(plot.title = element_text(hjust = 0.5))</span></span>
<span id="cb66-3469"><a href="#cb66-3469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3470"><a href="#cb66-3470" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_misall$sample.size &lt;- factor(simulation_misall$sample.size, levels = sort(unique(simulation_misall$sample.size), decreasing = TRUE))</span></span>
<span id="cb66-3471"><a href="#cb66-3471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3472"><a href="#cb66-3472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3473"><a href="#cb66-3473" aria-hidden="true" tabindex="-1"></a><span class="in"># Convert 'estimator' column to a factor with the specified order</span></span>
<span id="cb66-3474"><a href="#cb66-3474" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_misall$estimator &lt;- factor(simulation_misall$estimator, levels = desired_order_mis)</span></span>
<span id="cb66-3475"><a href="#cb66-3475" aria-hidden="true" tabindex="-1"></a><span class="in">#simulation_mis$estimator[is.na(simulation_mis$estimator)] &lt;- "G_formula (S-learner)"</span></span>
<span id="cb66-3476"><a href="#cb66-3476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3477"><a href="#cb66-3477" aria-hidden="true" tabindex="-1"></a><span class="in">simulation_graph_mis_all &lt;- simulation_misall %&gt;%</span></span>
<span id="cb66-3478"><a href="#cb66-3478" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = estimator, y = estimate,  fill = factor(sample.size, levels = rev(levels(sample.size))))) +</span></span>
<span id="cb66-3479"><a href="#cb66-3479" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette = "Accent") +</span></span>
<span id="cb66-3480"><a href="#cb66-3480" aria-hidden="true" tabindex="-1"></a><span class="in">  ggtitle("Misspecification of all models:  ")+</span></span>
<span id="cb66-3481"><a href="#cb66-3481" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_boxplot(alpha = 0.9, show.legend = TRUE, position = "dodge") +</span></span>
<span id="cb66-3482"><a href="#cb66-3482" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("") + </span></span>
<span id="cb66-3483"><a href="#cb66-3483" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("ATE") + </span></span>
<span id="cb66-3484"><a href="#cb66-3484" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_boxplot(geom="errorbar")+</span></span>
<span id="cb66-3485"><a href="#cb66-3485" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept = truth_complex_mis , linetype = "dashed", color = "red", alpha = 0.8,</span></span>
<span id="cb66-3486"><a href="#cb66-3486" aria-hidden="true" tabindex="-1"></a><span class="in">             size = 0.8) +  # Change geom_hline to geom_vline</span></span>
<span id="cb66-3487"><a href="#cb66-3487" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.title = element_blank(), legend.position = "bottom",</span></span>
<span id="cb66-3488"><a href="#cb66-3488" aria-hidden="true" tabindex="-1"></a><span class="in">          legend.box = "vertical", legend.text = element_text(size=18),</span></span>
<span id="cb66-3489"><a href="#cb66-3489" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),  # Adjust text angle for better visibility</span></span>
<span id="cb66-3490"><a href="#cb66-3490" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.text = element_text(size=20, face = "bold"),</span></span>
<span id="cb66-3491"><a href="#cb66-3491" aria-hidden="true" tabindex="-1"></a><span class="in">          plot.title = element_text(size=24, face = "bold"),</span></span>
<span id="cb66-3492"><a href="#cb66-3492" aria-hidden="true" tabindex="-1"></a><span class="in">          axis.title.x = element_text(size=20, face = "bold"))+</span></span>
<span id="cb66-3493"><a href="#cb66-3493" aria-hidden="true" tabindex="-1"></a><span class="in">            coord_cartesian(ylim = c(0.1,0.4))</span></span>
<span id="cb66-3494"><a href="#cb66-3494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3495"><a href="#cb66-3495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3496"><a href="#cb66-3496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3497"><a href="#cb66-3497" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.width=25, fig.height=25, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3498"><a href="#cb66-3498" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-mis2</span></span>
<span id="cb66-3499"><a href="#cb66-3499" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Estimation results of the ATE for an observational study with dependent censoring in case of a two or more misspecifications."</span></span>
<span id="cb66-3500"><a href="#cb66-3500" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb66-3501"><a href="#cb66-3501" aria-hidden="true" tabindex="-1"></a><span class="in">grid.arrange(simulation_graph_mis_mistreat_out, simulation_graph_mis_miscens_out, simulation_graph_mis_mistreat_cens, simulation_graph_mis_all, ncol = 2, nrow = 2)</span></span>
<span id="cb66-3502"><a href="#cb66-3502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3503"><a href="#cb66-3503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3504"><a href="#cb66-3504" aria-hidden="true" tabindex="-1"></a>@fig-mis2 shows that, as expected, when all nuisance models are misspecified, all estimators exhibit bias. </span>
<span id="cb66-3505"><a href="#cb66-3505" aria-hidden="true" tabindex="-1"></a>AIPTW-AIPCW (Cox &amp; Cox &amp; Reg.Log) seems to converge in case where either the outcome and censoring models, or the treatment and censoring models are misspecificed which deviates from initial expectations. </span>
<span id="cb66-3506"><a href="#cb66-3506" aria-hidden="true" tabindex="-1"></a>It was anticipated that AIPTW-AIPCW would converge solely when both the censoring and treatment models were misspecified.</span>
<span id="cb66-3507"><a href="#cb66-3507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3508"><a href="#cb66-3508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3509"><a href="#cb66-3509" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion {#sec-conclusion}</span></span>
<span id="cb66-3510"><a href="#cb66-3510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3511"><a href="#cb66-3511" aria-hidden="true" tabindex="-1"></a>Based on the simulations and theoretical results, it might be advisable to stay away from the IPCW and IPTW-IPCW estimators, as they often exhibit excessive variability. Instead, we recommend implementing BJ which seems like a more stable transformation as IPCW, as well as Causal Survival Forest, G-formula (T-learners), IPTW-BJ, and AIPTW-AIPCW in both their Cox, Logistic Regression and forest versions. By qualitatively combining the results from these more robust estimators, we can expect to gain a fairly accurate understanding of the treatment effect. </span>
<span id="cb66-3512"><a href="#cb66-3512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3513"><a href="#cb66-3513" aria-hidden="true" tabindex="-1"></a>It is important to note that our simulations utilize large sample sizes with relatively simple relationships, which may not fully capture the complexity of real-world scenarios. In practice, most survival analysis datasets tend to be smaller and more intricate, meaning the stability of certain estimators observed in our simulations may not generalize to real-world applications. Testing these methods on real-world datasets would provide a more comprehensive evaluation of their performance in practical settings.</span>
<span id="cb66-3514"><a href="#cb66-3514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3515"><a href="#cb66-3515" aria-hidden="true" tabindex="-1"></a>An interesting direction for future work would be to focus on variable selection. Indeed, there is no reason to assume that the variables related to censoring should be the same as those linked to survival or treatment allocation. We could explore differentiating these sets of variables and study the impact on the estimators' variance. Similarly to causal inference settings without survival data, we might expect, for instance, that adding precision variables—-those solely related to the outcome—-could reduce the variance of the estimators.</span>
<span id="cb66-3516"><a href="#cb66-3516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3517"><a href="#cb66-3517" aria-hidden="true" tabindex="-1"></a>Additionally, the estimators of the Restricted Mean Survival Time (RMST) provide a valuable alternative to the Hazard Ratio. The analysis and code provided with this article enables further exploration of the advantages of the estimators of RMST for causal analysis in survival studies. This could lead to a deeper understanding of how these estimators can offer more stable and interpretable estimates of treatment effects, particularly in complex real-world datasets.</span>
<span id="cb66-3518"><a href="#cb66-3518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3519"><a href="#cb66-3519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3520"><a href="#cb66-3520" aria-hidden="true" tabindex="-1"></a><span class="fu"># References {.unnumbered}</span></span>
<span id="cb66-3521"><a href="#cb66-3521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3522"><a href="#cb66-3522" aria-hidden="true" tabindex="-1"></a>::: {#refs}</span>
<span id="cb66-3523"><a href="#cb66-3523" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3524"><a href="#cb66-3524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3525"><a href="#cb66-3525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3526"><a href="#cb66-3526" aria-hidden="true" tabindex="-1"></a><span class="fu"># Appendix A: Proofs  {.appendix}</span></span>
<span id="cb66-3527"><a href="#cb66-3527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3528"><a href="#cb66-3528" aria-hidden="true" tabindex="-1"></a><span class="fu">## Proofs of @sec-theoryRCT_indc {#sec-proof21}</span></span>
<span id="cb66-3529"><a href="#cb66-3529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3530"><a href="#cb66-3530" aria-hidden="true" tabindex="-1"></a>::: {.proof} </span>
<span id="cb66-3531"><a href="#cb66-3531" aria-hidden="true" tabindex="-1"></a>_(@prp-km)._</span>
<span id="cb66-3532"><a href="#cb66-3532" aria-hidden="true" tabindex="-1"></a>Consistency is a trivial consequence of the law of large number and the identity <span class="co">[</span><span class="ot">-@eq-kmi</span><span class="co">]</span>. To show that $\wh S_{\mathrm{KM}}$ is unbiased, let us introduce $\cF_k$ be the filtration generated by the set of variables</span>
<span id="cb66-3533"><a href="#cb66-3533" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3534"><a href="#cb66-3534" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>A_i, \mathbb{I}<span class="sc">\{</span>\wt T_i = t_j<span class="sc">\}</span>, \mathbb{I}<span class="sc">\{</span>\wt T_i = t_j, \Delta_i=1<span class="sc">\}</span>~|~j \in <span class="co">[</span><span class="ot">k</span><span class="co">]</span>, i \in <span class="co">[</span><span class="ot">n</span><span class="co">]</span><span class="sc">\}</span>.</span>
<span id="cb66-3535"><a href="#cb66-3535" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3536"><a href="#cb66-3536" aria-hidden="true" tabindex="-1"></a>which corresponds to the known information up to time $t_k$, so that $D_k(a)$ is $\cF_k$-measurable but $N_k(a)$ is $\cF_{k-1}$-measurable. One can write that, for $k\geq 2$</span>
<span id="cb66-3537"><a href="#cb66-3537" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-3538"><a href="#cb66-3538" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">\mathbb{I}\{\wt T_i = t_k, \Delta_i = 1, A_i=a\}~|~\cF_{k-1}</span><span class="co">]</span> &amp;= \bbE<span class="co">[</span><span class="ot">\mathbb{I}\{\wt T_i = t_k, \Delta_i = 1, A_i=a\}~|~\mathbb{I}\{\wt T_i \geq t_k\},A_i</span><span class="co">]</span>  <span class="sc">\\</span></span>
<span id="cb66-3539"><a href="#cb66-3539" aria-hidden="true" tabindex="-1"></a>&amp;= \mathbb{I}<span class="sc">\{</span>A_i=a<span class="sc">\}</span> \bbE<span class="co">[</span><span class="ot">\mathbb{I}\{T_i = t_k, C_i \geq t_k\}~|~\mathbb{I}\{T_i \geq t_k, C_i \geq t_k\}, A_i</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3540"><a href="#cb66-3540" aria-hidden="true" tabindex="-1"></a>&amp;=  \mathbb{I}<span class="sc">\{</span>A_i=a<span class="sc">\}</span> \mathbb{I}<span class="sc">\{</span>C_i \geq t_k<span class="sc">\}</span> \bbE<span class="co">[</span><span class="ot">\mathbb{I}\{T_i = t_k\} ~|~ \mathbb{I}\{T_i \geq t_k\}, A_i</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3541"><a href="#cb66-3541" aria-hidden="true" tabindex="-1"></a>&amp;= \mathbb{I}<span class="sc">\{</span>\wt T_i \geq t_k, A_i=a<span class="sc">\}</span>\left(1- \frac{S^{(a)}(t_{k})}{S^{(a)}(t_{k-1})}\right),</span>
<span id="cb66-3542"><a href="#cb66-3542" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-3543"><a href="#cb66-3543" aria-hidden="true" tabindex="-1"></a>where we used that $T_i(a)$ is idependant from $A_i$ by Assumption <span class="co">[</span><span class="ot">-@eq-rta</span><span class="co">]</span>.</span>
<span id="cb66-3544"><a href="#cb66-3544" aria-hidden="true" tabindex="-1"></a>We then easily derive from this that</span>
<span id="cb66-3545"><a href="#cb66-3545" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3546"><a href="#cb66-3546" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\left(1-\frac{D_k(a)}{N_k(a)} \right) \mathbb{I}\{N_k(a) &gt;0\}\middle |\cF_{k-1}\right</span><span class="co">]</span> = \frac{S^{(a)}(t_k)}{S^{(a)}(t_{k-1})} \mathbb{I}<span class="sc">\{</span>N_k(a) &gt;0<span class="sc">\}</span>,</span>
<span id="cb66-3547"><a href="#cb66-3547" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3548"><a href="#cb66-3548" aria-hidden="true" tabindex="-1"></a>and then that</span>
<span id="cb66-3549"><a href="#cb66-3549" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3550"><a href="#cb66-3550" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\wh S_{\mathrm{KM}}(t_k|A=a)\middle |\cF_{k-1}\right</span><span class="co">]</span> =  \frac{S^{(a)}(t_k)}{S^{(a)}(t_{k-1})} \wh S_{\mathrm{KM}}(t_{k-1}|A=a) + O(\mathbb{I}<span class="sc">\{</span>N_k(a) =0<span class="sc">\}</span>),</span>
<span id="cb66-3551"><a href="#cb66-3551" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3552"><a href="#cb66-3552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3553"><a href="#cb66-3553" aria-hidden="true" tabindex="-1"></a>By induction, we easily find that</span>
<span id="cb66-3554"><a href="#cb66-3554" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3555"><a href="#cb66-3555" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">\wh S_{\mathrm{KM}}(t|A=a)</span><span class="co">]</span> = \prod_{t_j \leq t} \frac{S^{(a)}(t_j)}{S^{(a)}(t_{j-1})} + O\left(\sum_{t_j \leq t}\bbP(N_j(a) =0)\right)= S^{(a)}(t) + O(\bbP(N_k(a) =0))</span>
<span id="cb66-3556"><a href="#cb66-3556" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3557"><a href="#cb66-3557" aria-hidden="true" tabindex="-1"></a>where $t_k$ is the greatest time such that $t_k \leq t$.</span>
<span id="cb66-3558"><a href="#cb66-3558" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3559"><a href="#cb66-3559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3560"><a href="#cb66-3560" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3561"><a href="#cb66-3561" aria-hidden="true" tabindex="-1"></a>_(@prp-varkm)._</span>
<span id="cb66-3562"><a href="#cb66-3562" aria-hidden="true" tabindex="-1"></a>The asymptotic normality is a mere consequence of the joint asymptotic normality of $(N_k(a),D_k(a))_{t_k \leq t}$ with an application of the $\delta$-method. To access the asymptotic variance, notice that, using a similar reasonning as in the previous proof:</span>
<span id="cb66-3563"><a href="#cb66-3563" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-3564"><a href="#cb66-3564" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">(1-D_k(a)/N_k(a))^2|\cF_{k-1}</span><span class="co">]</span> &amp;= \bbE<span class="co">[</span><span class="ot">1-D_k(a)/N_k(a)|\cF_{k-1}(a)</span><span class="co">]</span>^2+\frac{1}{N_k(a)^2}\Var(D_k(a)|\cF_{k-1}) <span class="sc">\\</span></span>
<span id="cb66-3565"><a href="#cb66-3565" aria-hidden="true" tabindex="-1"></a>&amp;= s_k^2(a)+ \frac{s_k(a)(1-s_k(a))}{N_k(a)}\mathbb{I}<span class="sc">\{</span>N_k(a) &gt; 0<span class="sc">\}</span> + O(\mathbb{I}<span class="sc">\{</span>N_k(a) = 0<span class="sc">\}</span>). </span>
<span id="cb66-3566"><a href="#cb66-3566" aria-hidden="true" tabindex="-1"></a>\end{align*} </span>
<span id="cb66-3567"><a href="#cb66-3567" aria-hidden="true" tabindex="-1"></a>Now we know that $N_k(a) = n r_k(a) + \sqrt{n} O_{\bbP}(1)$, with the $O_{\bbP}(1)$ having uniformly bounded moments. </span>
<span id="cb66-3568"><a href="#cb66-3568" aria-hidden="true" tabindex="-1"></a>So that we deduce that</span>
<span id="cb66-3569"><a href="#cb66-3569" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3570"><a href="#cb66-3570" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3571"><a href="#cb66-3571" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">(1-D_k(a)/N_k(a))^2|\cF_{k-1}</span><span class="co">]</span> &amp;= s_k^2(a)+ \frac{s_k(a)(1-s_k(a))}{n r_k(a)} +  \frac{1}{n^{3/2}} O_{\bbP}(1), </span>
<span id="cb66-3572"><a href="#cb66-3572" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3573"><a href="#cb66-3573" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3574"><a href="#cb66-3574" aria-hidden="true" tabindex="-1"></a>where $O_{\bbP}(1)$ has again bounded moments. Using this identity, we find that</span>
<span id="cb66-3575"><a href="#cb66-3575" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3576"><a href="#cb66-3576" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3577"><a href="#cb66-3577" aria-hidden="true" tabindex="-1"></a>n \Var\wh S_{\mathrm{KM}} (t|A=a) &amp;= n \left(\bbE  S_{\mathrm{KM}} (t|A=a)^2 -  S^{(a)} (t)^2 \right) <span class="sc">\\</span></span>
<span id="cb66-3578"><a href="#cb66-3578" aria-hidden="true" tabindex="-1"></a>&amp;= n S^{(a)}(t)^2 \left(\bbE\left<span class="co">[</span><span class="ot">\prod_{t_k \leq t}  \left(1+\frac1n\frac{1-s_k(a)}{s_k(a) r_k(a)} +   \frac{1}{n^{3/2}} O_{\bbP}(1) \right)\right</span><span class="co">]</span>-1\right).</span>
<span id="cb66-3579"><a href="#cb66-3579" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3580"><a href="#cb66-3580" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3581"><a href="#cb66-3581" aria-hidden="true" tabindex="-1"></a>Expending the product and using that the $O_{\bbP}(1)$'s have bounded moments, we finally deduce that</span>
<span id="cb66-3582"><a href="#cb66-3582" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3583"><a href="#cb66-3583" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3584"><a href="#cb66-3584" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\prod_{t_k \leq t}  \left(1+\frac1n\frac{1-s_k(a)}{s_k(a) r_k(a)} +   \frac{1}{n^{3/2}} O_{\bbP}(1) \right)\right</span><span class="co">]</span>-1 =   \frac1n \sum_{t_k \leq t}\frac{1-s_k(a)}{s_k(a) r_k(a)} +   \frac{1}{n^{3/2}} O(1),</span>
<span id="cb66-3585"><a href="#cb66-3585" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3586"><a href="#cb66-3586" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3587"><a href="#cb66-3587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3588"><a href="#cb66-3588" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3589"><a href="#cb66-3589" aria-hidden="true" tabindex="-1"></a>n\Var\wh S_{\mathrm{KM}} (t|A=a) = V_{\mathrm{KM}}(t|A=a) + O(n^{-1/2}),  </span>
<span id="cb66-3590"><a href="#cb66-3590" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3591"><a href="#cb66-3591" aria-hidden="true" tabindex="-1"></a>which is what we wanted to show.</span>
<span id="cb66-3592"><a href="#cb66-3592" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3593"><a href="#cb66-3593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3594"><a href="#cb66-3594" aria-hidden="true" tabindex="-1"></a><span class="fu">## Proofs of @sec-condcens {#sec-proof22}</span></span>
<span id="cb66-3595"><a href="#cb66-3595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3596"><a href="#cb66-3596" aria-hidden="true" tabindex="-1"></a>::: {.proof} </span>
<span id="cb66-3597"><a href="#cb66-3597" aria-hidden="true" tabindex="-1"></a>_(@prp-ipcw)._</span>
<span id="cb66-3598"><a href="#cb66-3598" aria-hidden="true" tabindex="-1"></a>Assumption <span class="co">[</span><span class="ot">-@eq-positivitycensoring</span><span class="co">]</span> allows the tranformation to be well-defined. Furthermore, it holds</span>
<span id="cb66-3599"><a href="#cb66-3599" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-3600"><a href="#cb66-3600" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">T^*_{\mathrm{IPCW}}|A=a,X</span><span class="co">]</span> </span>
<span id="cb66-3601"><a href="#cb66-3601" aria-hidden="true" tabindex="-1"></a>&amp;= E\left<span class="co">[</span><span class="ot">\frac{ \Delta^\tau \times\widetilde T \wedge \tau}{G(\widetilde T \wedge \tau | A,X)} \middle | A = a,X\right</span><span class="co">]</span>  <span class="sc">\\</span></span>
<span id="cb66-3602"><a href="#cb66-3602" aria-hidden="true" tabindex="-1"></a>&amp;= E\left<span class="co">[</span><span class="ot">\frac{ \Delta^\tau \times T(a) \wedge \tau}{G(T(a) \wedge \tau | A,X)} \middle | A = a,X\right</span><span class="co">]</span><span class="sc">\\</span></span>
<span id="cb66-3603"><a href="#cb66-3603" aria-hidden="true" tabindex="-1"></a>&amp;= E\left<span class="co">[</span><span class="ot"> E\left[\frac{ \mathbb{I}\{T(a)\wedge \tau \leq C \} \times T(a) \wedge \tau}{G(T(a) \wedge \tau | A,X)}\middle| A, X,T(1) \right] \middle | A = a,X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3604"><a href="#cb66-3604" aria-hidden="true" tabindex="-1"></a>&amp;= E\left<span class="co">[</span><span class="ot">T(a) \wedge \tau|A=a, X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3605"><a href="#cb66-3605" aria-hidden="true" tabindex="-1"></a>&amp;= E\left<span class="co">[</span><span class="ot">T(a) \wedge \tau | X \right</span><span class="co">]</span>.</span>
<span id="cb66-3606"><a href="#cb66-3606" aria-hidden="true" tabindex="-1"></a>\end{align*} </span>
<span id="cb66-3607"><a href="#cb66-3607" aria-hidden="true" tabindex="-1"></a>We used in the second equality that on the event $<span class="sc">\{</span>\Delta^\tau=1, A=a<span class="sc">\}</span>$, it holds $\widetilde T \wedge \tau =  T \wedge \tau = T(a) \wedge \tau$. We used in the fourth equality that $G(T(a) \wedge \tau | A,X) = E<span class="co">[</span><span class="ot">\mathbb{I}\{T(a) \wedge \tau \leq C\}|X,T(a),A</span><span class="co">]</span>$ thanks to Assumption <span class="co">[</span><span class="ot">-@eq-condindepcensoring</span><span class="co">]</span>, and in the last one that $A$ is idependent from $X$ and $T(a)$ thanks to Assumption <span class="co">[</span><span class="ot">-@eq-rta</span><span class="co">]</span>.</span>
<span id="cb66-3608"><a href="#cb66-3608" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3609"><a href="#cb66-3609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3610"><a href="#cb66-3610" aria-hidden="true" tabindex="-1"></a>::: {.proof} </span>
<span id="cb66-3611"><a href="#cb66-3611" aria-hidden="true" tabindex="-1"></a>_(@prp-ipcwkm)._</span>
<span id="cb66-3612"><a href="#cb66-3612" aria-hidden="true" tabindex="-1"></a>Similarly to the computations done in the proof of @prp-ipcw, it is easy to show that </span>
<span id="cb66-3613"><a href="#cb66-3613" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3614"><a href="#cb66-3614" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\frac{\Delta_i^\tau}{G(\wt T \wedge\tau | X,A)} \mathbb{I}(\wt T_i = t_k, A=a)\right</span><span class="co">]</span> = \bbP(A=a) \bbP(T(a) = t_k),</span>
<span id="cb66-3615"><a href="#cb66-3615" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3616"><a href="#cb66-3616" aria-hidden="true" tabindex="-1"></a>and likewise that</span>
<span id="cb66-3617"><a href="#cb66-3617" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3618"><a href="#cb66-3618" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\frac{\Delta_i^\tau}{G(\wt T \wedge\tau | X,A)} \mathbb{I}(\wt T_i \geq t_k, A=a)\right</span><span class="co">]</span> = \bbP(A=a) \bbP(T(a) \geq t_k),</span>
<span id="cb66-3619"><a href="#cb66-3619" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3620"><a href="#cb66-3620" aria-hidden="true" tabindex="-1"></a>so that $\wh S_{\mathrm{IPCW}}(t)$ converges almost surely towards the product limit</span>
<span id="cb66-3621"><a href="#cb66-3621" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3622"><a href="#cb66-3622" aria-hidden="true" tabindex="-1"></a>\prod_{t_k \leq t} \left(1-\frac{\bbP(T(a) = t_k)}{\bbP(T(a) \geq t_k)}\right) = S^{(a)}(t),</span>
<span id="cb66-3623"><a href="#cb66-3623" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3624"><a href="#cb66-3624" aria-hidden="true" tabindex="-1"></a>yielding strong consistency. Asymptotic normality is straightforward.</span>
<span id="cb66-3625"><a href="#cb66-3625" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3626"><a href="#cb66-3626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3627"><a href="#cb66-3627" aria-hidden="true" tabindex="-1"></a>::: {.proof} </span>
<span id="cb66-3628"><a href="#cb66-3628" aria-hidden="true" tabindex="-1"></a>_(@prp-bj)._</span>
<span id="cb66-3629"><a href="#cb66-3629" aria-hidden="true" tabindex="-1"></a>There holds</span>
<span id="cb66-3630"><a href="#cb66-3630" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3631"><a href="#cb66-3631" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3632"><a href="#cb66-3632" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">T_{\mathrm{BJ}}^*|X,A=a</span><span class="co">]</span> &amp;= \bbE \left<span class="co">[</span><span class="ot">\Delta^\tau T(a) \wedge \tau + (1-\Delta^\tau)\frac{\bbE[T \wedge \tau \times \mathbb{I}\{T \wedge \tau &gt; C\}|C,A,X]}{\bbP(T &gt; C|C,A,X)} \middle | X,A=a \right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3633"><a href="#cb66-3633" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE <span class="co">[</span><span class="ot">\Delta^\tau T(a) \wedge \tau | X </span><span class="co">]</span> +  \underbrace{\bbE \left<span class="co">[</span><span class="ot"> \mathbb{I}\{T \wedge \tau &gt; C\} \frac{\bbE[T \wedge \tau \times \mathbb{I}\{T \wedge \tau &gt; C\}|C,A,X]}{\bbE[\mathbb{I}\{T \wedge \tau \geq C\}|C,A,X]}\middle | X,A=a \right</span><span class="co">]</span>}_{(\star)}.</span>
<span id="cb66-3634"><a href="#cb66-3634" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3635"><a href="#cb66-3635" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3636"><a href="#cb66-3636" aria-hidden="true" tabindex="-1"></a>Now we easily see that conditionning wrt $X$ in the second term yields</span>
<span id="cb66-3637"><a href="#cb66-3637" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-3638"><a href="#cb66-3638" aria-hidden="true" tabindex="-1"></a>(\star) &amp;= \bbE \left<span class="co">[</span><span class="ot"> \bbE[T \wedge \tau \times \mathbb{I}\{T \wedge \tau &gt; C\}|C,A,X] \middle | X,A=a \right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3639"><a href="#cb66-3639" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE <span class="co">[</span><span class="ot">(1-\Delta^\tau) T \wedge \tau | X,A=a </span><span class="co">]</span>  <span class="sc">\\</span></span>
<span id="cb66-3640"><a href="#cb66-3640" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE <span class="co">[</span><span class="ot">(1-\Delta^\tau)  T(a) \wedge \tau | X</span><span class="co">]</span>, </span>
<span id="cb66-3641"><a href="#cb66-3641" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-3642"><a href="#cb66-3642" aria-hidden="true" tabindex="-1"></a>ending the proof.</span>
<span id="cb66-3643"><a href="#cb66-3643" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3644"><a href="#cb66-3644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3645"><a href="#cb66-3645" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3646"><a href="#cb66-3646" aria-hidden="true" tabindex="-1"></a>_(@thm-bj)._</span>
<span id="cb66-3647"><a href="#cb66-3647" aria-hidden="true" tabindex="-1"></a>We let $T^* = \Delta^\tau \phi_1 + (1-\Delta^\tau)\phi_0$ be a transformation of the form @eq-defcut. There holds</span>
<span id="cb66-3648"><a href="#cb66-3648" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3649"><a href="#cb66-3649" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">(T^*-T \wedge \tau)^2</span><span class="co">]</span> = \bbE<span class="co">[</span><span class="ot">\Delta^\tau (\phi_1-T \wedge \tau)^2</span><span class="co">]</span> + \bbE<span class="co">[</span><span class="ot">(1-\Delta^\tau)(\phi_0-T \wedge \tau)^2</span><span class="co">]</span>.</span>
<span id="cb66-3650"><a href="#cb66-3650" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3651"><a href="#cb66-3651" aria-hidden="true" tabindex="-1"></a>The first term is non negative and is zero for the BJ transformation. Since $\phi_0$ is a function of $(\wt T, X, A)$ and that $\wt T = C$ on $<span class="sc">\{</span>\Delta^\tau = 0<span class="sc">\}</span>$, the second term can be rewritten in the following way. We let $R$ be a generic quantity that does not depend on $\phi_0$.</span>
<span id="cb66-3652"><a href="#cb66-3652" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb66-3653"><a href="#cb66-3653" aria-hidden="true" tabindex="-1"></a>\bbE&amp;<span class="co">[</span><span class="ot">(1-\Delta^\tau)(\phi_0-T)^2</span><span class="co">]</span> = \bbE\left<span class="co">[</span><span class="ot">\mathbb{I}\{T\wedge \tau &gt; C\} \phi_0^2 - 2 \mathbb{I}\{T\wedge \tau &gt; C\} \phi_0 T \wedge \tau\right</span><span class="co">]</span>  + R <span class="sc">\\</span></span>
<span id="cb66-3654"><a href="#cb66-3654" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot"> \bbP(T\wedge \tau &gt; C|C,A,X) \phi_0^2 - 2 \bbE[T\wedge \tau \mathbb{I}\{T\wedge \tau &gt; C\}|C,A,X] \phi_0 \right</span><span class="co">]</span> + R <span class="sc">\\</span></span>
<span id="cb66-3655"><a href="#cb66-3655" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot">\bbP(T\wedge \tau &gt; C|C,A,X) \left(\phi_0- \frac{\bbE[T\wedge \tau \mathbb{I}\{T\wedge \tau &gt; C\}|C,A,X]}{\bbP(T\wedge \tau &gt; C|C,A,X) }\right)^2\right</span><span class="co">]</span> + R.</span>
<span id="cb66-3656"><a href="#cb66-3656" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb66-3657"><a href="#cb66-3657" aria-hidden="true" tabindex="-1"></a>Now the first term in the right hand side is always non-negative, and is zero for the BJ tranformation.</span>
<span id="cb66-3658"><a href="#cb66-3658" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3659"><a href="#cb66-3659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3660"><a href="#cb66-3660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3661"><a href="#cb66-3661" aria-hidden="true" tabindex="-1"></a><span class="fu">## Proofs of @sec-obs_indcen {#sec-proof31}</span></span>
<span id="cb66-3662"><a href="#cb66-3662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3663"><a href="#cb66-3663" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3664"><a href="#cb66-3664" aria-hidden="true" tabindex="-1"></a>_(@prp-iptwkm)._ The fact that it is strongly consistent and asymptotically normal is again a simple application of the law of large number and of the $\delta$-method. We indeed find that, for $t_k \leq \tau$</span>
<span id="cb66-3665"><a href="#cb66-3665" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3666"><a href="#cb66-3666" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3667"><a href="#cb66-3667" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\frac{1}{e(X_i)} \mathbb{1}\{\wt T_i = t_k, \Delta_i = 1, A_i=1\}\right</span><span class="co">]</span> &amp;= \bbE\left<span class="co">[</span><span class="ot">\frac{A_i}{e(X_i)} \mathbb{1}\{T_i = t_k, C_i \geq t_k\}\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3668"><a href="#cb66-3668" aria-hidden="true" tabindex="-1"></a>&amp;=\bbE\left<span class="co">[</span><span class="ot"> \bbE \left[ \frac{A_i}{e(X_i)} \mathbb{1}\{T_i = t_k, C_i \geq t_k\} \middle |X_i \right]\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3669"><a href="#cb66-3669" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot"> \bbE \left[\frac{A_i}{e(X_i)}\middle | X_i\right] \bbP(T_i = t_k |X_i) \bbP( C_i \geq t_k)\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3670"><a href="#cb66-3670" aria-hidden="true" tabindex="-1"></a>&amp;= \bbP(T_i = t_k) \bbP( C_i \geq t_k),</span>
<span id="cb66-3671"><a href="#cb66-3671" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3672"><a href="#cb66-3672" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3673"><a href="#cb66-3673" aria-hidden="true" tabindex="-1"></a>where we used that $A$ is independent from $T$ conditionnaly on $X$, and that $C$ is independent from everything. Likewise, one would get that</span>
<span id="cb66-3674"><a href="#cb66-3674" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3675"><a href="#cb66-3675" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3676"><a href="#cb66-3676" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\frac{1}{e(X_i)} \mathbb{1}\{\wt T_i \geq t_k, A_i=1\}\right</span><span class="co">]</span> =</span>
<span id="cb66-3677"><a href="#cb66-3677" aria-hidden="true" tabindex="-1"></a>&amp;= \bbP(T_i \geq t_k) \bbP( C_i \geq t_k).</span>
<span id="cb66-3678"><a href="#cb66-3678" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3679"><a href="#cb66-3679" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3680"><a href="#cb66-3680" aria-hidden="true" tabindex="-1"></a>Similar computations hold for $A=0$, ending the proof.</span>
<span id="cb66-3681"><a href="#cb66-3681" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3682"><a href="#cb66-3682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3683"><a href="#cb66-3683" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ::: {.proof} --&gt;</span></span>
<span id="cb66-3684"><a href="#cb66-3684" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- _(@prp-variptwkm)._ --&gt;</span></span>
<span id="cb66-3685"><a href="#cb66-3685" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We let  --&gt;</span></span>
<span id="cb66-3686"><a href="#cb66-3686" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb66-3687"><a href="#cb66-3687" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- s_k(X) := \frac{S^{(1)}(t_k|X)}{S^{(1)}(t_{k-1}|X)}. --&gt;</span></span>
<span id="cb66-3688"><a href="#cb66-3688" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb66-3689"><a href="#cb66-3689" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Similar computation as in the proof of @prp-varkm show that --&gt;</span></span>
<span id="cb66-3690"><a href="#cb66-3690" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb66-3691"><a href="#cb66-3691" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \bbE\left[\left(1-\frac{D_k^{\mathrm{IPTW}}(1)}{N_k^{\mathrm{IPTW}}(1)}\right)^2\right | \cF_{k-1},\cX] = --&gt;</span></span>
<span id="cb66-3692"><a href="#cb66-3692" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb66-3693"><a href="#cb66-3693" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ::: --&gt;</span></span>
<span id="cb66-3694"><a href="#cb66-3694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3695"><a href="#cb66-3695" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ::: {.proof} --&gt;</span></span>
<span id="cb66-3696"><a href="#cb66-3696" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- _(@prp-tdr)._ --&gt;</span></span>
<span id="cb66-3697"><a href="#cb66-3697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3698"><a href="#cb66-3698" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ::: --&gt;</span></span>
<span id="cb66-3699"><a href="#cb66-3699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3700"><a href="#cb66-3700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3701"><a href="#cb66-3701" aria-hidden="true" tabindex="-1"></a><span class="fu">## Proofs of @sec-obscondcens {#sec-proof32}</span></span>
<span id="cb66-3702"><a href="#cb66-3702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3703"><a href="#cb66-3703" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3704"><a href="#cb66-3704" aria-hidden="true" tabindex="-1"></a>_(@prp-iptwipcw)._</span>
<span id="cb66-3705"><a href="#cb66-3705" aria-hidden="true" tabindex="-1"></a>On the event $<span class="sc">\{</span>\Delta^\tau=1, A=1<span class="sc">\}</span>$, there holds $\wt T \wedge \tau = T \wedge \tau = T(1) \wedge \tau$, whence we find that, </span>
<span id="cb66-3706"><a href="#cb66-3706" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3707"><a href="#cb66-3707" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3708"><a href="#cb66-3708" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot"> T^*_{\mathrm{IPCW}}|X,A=1</span><span class="co">]</span> &amp;= \bbE\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} \frac{\mathbb{I}\{T(1) \wedge \tau \leq C\}}{G(T(1) \wedge \tau|X,A)} T(1) \wedge \tau\middle|X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3709"><a href="#cb66-3709" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot"> \frac{A}{e(X)} \bbE\left[\frac{\mathbb{I}\{T(1) \wedge \tau \leq C\}}{G(T(1) \wedge \tau|X,A)} \middle| X,A, T(1) \right]T(1) \wedge \tau\middle|X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3710"><a href="#cb66-3710" aria-hidden="true" tabindex="-1"></a>&amp;=\bbE\left<span class="co">[</span><span class="ot"> \frac{A}{e(X)} T(1) \wedge \tau\middle|X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3711"><a href="#cb66-3711" aria-hidden="true" tabindex="-1"></a>&amp;=\bbE\left<span class="co">[</span><span class="ot">T(1) \wedge \tau\middle|X\right</span><span class="co">]</span>,</span>
<span id="cb66-3712"><a href="#cb66-3712" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3713"><a href="#cb66-3713" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3714"><a href="#cb66-3714" aria-hidden="true" tabindex="-1"></a>and the same holds on the event $A=0$.</span>
<span id="cb66-3715"><a href="#cb66-3715" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3716"><a href="#cb66-3716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3717"><a href="#cb66-3717" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3718"><a href="#cb66-3718" aria-hidden="true" tabindex="-1"></a>_(@prp-consiptwipcw)._</span>
<span id="cb66-3719"><a href="#cb66-3719" aria-hidden="true" tabindex="-1"></a>By consistency of $\wh G(\cdot|X,A)$ and $\wh e$ and by continuity, it suffices to look at the asymptotic behavior of the oracle estimator</span>
<span id="cb66-3720"><a href="#cb66-3720" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3721"><a href="#cb66-3721" aria-hidden="true" tabindex="-1"></a>\theta^*_{\mathrm{IPTW-IPCW}} = \frac1n\sum_{i=1}^n  \left(\frac{A_i}{ e(X_i)}-\frac{1-A_i}{1-e(X_i)} \right)\frac{\Delta_i^\tau}{G(\wt T_i \wedge \tau | A_i,X_i)} \wt T_i \wedge \tau.</span>
<span id="cb66-3722"><a href="#cb66-3722" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3723"><a href="#cb66-3723" aria-hidden="true" tabindex="-1"></a>The later is converging almost towards its mean, which, following similar computations as in the previous proof, write</span>
<span id="cb66-3724"><a href="#cb66-3724" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3725"><a href="#cb66-3725" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3726"><a href="#cb66-3726" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right)\frac{\Delta^\tau}{G(\wt T \wedge \tau | A,X)} \wt T \wedge \tau\right</span><span class="co">]</span>  </span>
<span id="cb66-3727"><a href="#cb66-3727" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot">\left(\frac{A}{e(X)}-\frac{1-A}{1-e(X)} \right) T \wedge \tau\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3728"><a href="#cb66-3728" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot">T(1) \wedge \tau\right</span><span class="co">]</span>-\bbE\left<span class="co">[</span><span class="ot">T(0) \wedge \tau\right</span><span class="co">]</span>.</span>
<span id="cb66-3729"><a href="#cb66-3729" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3730"><a href="#cb66-3730" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3731"><a href="#cb66-3731" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3732"><a href="#cb66-3732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3733"><a href="#cb66-3733" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3734"><a href="#cb66-3734" aria-hidden="true" tabindex="-1"></a>_(@prp-iptwipcwkm)._</span>
<span id="cb66-3735"><a href="#cb66-3735" aria-hidden="true" tabindex="-1"></a>Asymptotic normality comes from a mere application of the $\delta$-method, while strong consistency follows from the law of large number and the follozing computations. Like for the proof of @prp-ipcwkm, one find, by first conditionning wrt $X,A,T(a)$, that, for $t_k \leq \tau$,</span>
<span id="cb66-3736"><a href="#cb66-3736" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3737"><a href="#cb66-3737" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3738"><a href="#cb66-3738" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\left(\frac{A}{e(X)}+\frac{1-A}{1-e(X)} \right)\frac{\Delta^\tau}{G(\wt T \wedge \tau | A,X)} \mathbb{I}\{\wt T = t_k, A=a\}\right</span><span class="co">]</span> = \bbP(T(a)=t_k)</span>
<span id="cb66-3739"><a href="#cb66-3739" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3740"><a href="#cb66-3740" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3741"><a href="#cb66-3741" aria-hidden="true" tabindex="-1"></a>and likewise that</span>
<span id="cb66-3742"><a href="#cb66-3742" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3743"><a href="#cb66-3743" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3744"><a href="#cb66-3744" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\left(\frac{A}{e(X)}+\frac{1-A}{1-e(X)} \right)\frac{\Delta^\tau}{G(\wt T \wedge \tau | A,X)} \mathbb{I}\{\wt T \geq t_k, A=a\}\right</span><span class="co">]</span> = \bbP(T(a)\geq t_k)</span>
<span id="cb66-3745"><a href="#cb66-3745" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3746"><a href="#cb66-3746" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3747"><a href="#cb66-3747" aria-hidden="true" tabindex="-1"></a>so that indeed $S^*_{\mathrm{IPTW-IPCW}} (t|A=a)$ converges almost surely towards $S^{(a)}(t)$.</span>
<span id="cb66-3748"><a href="#cb66-3748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3749"><a href="#cb66-3749" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3750"><a href="#cb66-3750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3751"><a href="#cb66-3751" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3752"><a href="#cb66-3752" aria-hidden="true" tabindex="-1"></a>_(@prp-iptwbj)._</span>
<span id="cb66-3753"><a href="#cb66-3753" aria-hidden="true" tabindex="-1"></a>We write</span>
<span id="cb66-3754"><a href="#cb66-3754" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3755"><a href="#cb66-3755" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3756"><a href="#cb66-3756" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot"> T^*_{\mathrm{IPTW-BJ}}|X,A=1</span><span class="co">]</span> &amp;= \bbE\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} \Delta^\tau \times \wt T \wedge \tau\middle|X\right</span><span class="co">]</span> + \bbE\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} (1-\Delta^\tau) Q_S(\wt T \wedge \tau|A,X) \middle| X\right</span><span class="co">]</span>. </span>
<span id="cb66-3757"><a href="#cb66-3757" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3758"><a href="#cb66-3758" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3759"><a href="#cb66-3759" aria-hidden="true" tabindex="-1"></a>On the event $<span class="sc">\{</span>\Delta^\tau=1, A=1<span class="sc">\}</span>$, there holds $\wt T \wedge \tau = T \wedge \tau = T(1) \wedge \tau$, whence we find that the first term on the the right hand side is equal to</span>
<span id="cb66-3760"><a href="#cb66-3760" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3761"><a href="#cb66-3761" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3762"><a href="#cb66-3762" aria-hidden="true" tabindex="-1"></a>\bbE\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} \Delta^\tau \times \wt T \wedge \tau\middle|X\right</span><span class="co">]</span> &amp;= \bbE\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} \Delta^\tau \times T(1) \wedge \tau\middle|X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3763"><a href="#cb66-3763" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot">\Delta^\tau \times T(1) \wedge \tau\middle|X\right</span><span class="co">]</span>.</span>
<span id="cb66-3764"><a href="#cb66-3764" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3765"><a href="#cb66-3765" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3766"><a href="#cb66-3766" aria-hidden="true" tabindex="-1"></a>For the second term in the right hand side, notice that on the event $<span class="sc">\{</span>\Delta^\tau=0, A=1<span class="sc">\}</span>$, there holds $\wt T = C &lt; T(1) \wedge \tau$, so that</span>
<span id="cb66-3767"><a href="#cb66-3767" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3768"><a href="#cb66-3768" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3769"><a href="#cb66-3769" aria-hidden="true" tabindex="-1"></a>\bbE&amp;\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} \mathbb{I}\{C &lt; T(1) \wedge \tau\} \frac{\bbE[T(1) \wedge \tau \times \mathbb{I}\{C &lt; T(1) \wedge \tau\}|X,A,C]}{\bbP(C &lt; T(1) \wedge \tau | C,X,A)} \middle| X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3770"><a href="#cb66-3770" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot">\frac{A}{e(X)} \bbE[T(1) \wedge \tau \times \mathbb{I}\{C &lt; T(1) \wedge \tau\}|X,A,C] \middle| X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3771"><a href="#cb66-3771" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot">T(1) \wedge \tau \times \mathbb{I}\{C &lt; T(1) \wedge \tau\} \middle| X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3772"><a href="#cb66-3772" aria-hidden="true" tabindex="-1"></a>&amp;= \bbE\left<span class="co">[</span><span class="ot">(1-\Delta^\tau) T(1) \wedge \tau  \middle| X\right</span><span class="co">]</span>, </span>
<span id="cb66-3773"><a href="#cb66-3773" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3774"><a href="#cb66-3774" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3775"><a href="#cb66-3775" aria-hidden="true" tabindex="-1"></a>and the sane holds on the event $<span class="sc">\{</span>A=0<span class="sc">\}</span>$, which ends the proof.</span>
<span id="cb66-3776"><a href="#cb66-3776" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3777"><a href="#cb66-3777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3778"><a href="#cb66-3778" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3779"><a href="#cb66-3779" aria-hidden="true" tabindex="-1"></a>_(@prp-consiptwbj)._</span>
<span id="cb66-3780"><a href="#cb66-3780" aria-hidden="true" tabindex="-1"></a>By consistency of $\wh G(\cdot|X,A)$ and $\wh e$ and by continuity, it suffices to look at the asymptotic behavior of the oracle estimator</span>
<span id="cb66-3781"><a href="#cb66-3781" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3782"><a href="#cb66-3782" aria-hidden="true" tabindex="-1"></a>\theta^*_{\mathrm{IPTW-BJ}} = \frac1n\sum_{i=1}^n  \left(\frac{A_i}{ e(X_i)}-\frac{1-A_i}{1-e(X_i)} \right)\left(\Delta_i^\tau \times \wt T_i \wedge \tau + (1-\Delta_i^\tau) Q_S(\wt T_i \wedge \tau|A_i,X_i)\right).</span>
<span id="cb66-3783"><a href="#cb66-3783" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3784"><a href="#cb66-3784" aria-hidden="true" tabindex="-1"></a>The later is converging almost towards its mean, which, following similar computations as in the previous proof, is simply equal to the difference in RMST.</span>
<span id="cb66-3785"><a href="#cb66-3785" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3786"><a href="#cb66-3786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3787"><a href="#cb66-3787" aria-hidden="true" tabindex="-1"></a>::: {.proof}</span>
<span id="cb66-3788"><a href="#cb66-3788" aria-hidden="true" tabindex="-1"></a>_(@prp-tqr)._</span>
<span id="cb66-3789"><a href="#cb66-3789" aria-hidden="true" tabindex="-1"></a>We can write that</span>
<span id="cb66-3790"><a href="#cb66-3790" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3791"><a href="#cb66-3791" aria-hidden="true" tabindex="-1"></a>\Delta^*_{\mathrm{QR}} = \underbrace{\frac{A}{p(X)}(T^*_{\mathrm{DR}}(F,R)-\nu(X,1))+ \nu(X,1)}_{(\mathrm{A})} - \left(\underbrace{\frac{1-A}{1-p(X)}(T^*_{\mathrm{DR}}(F,R)-\nu(X,0))+ \nu(X,0)}_{(\mathrm{B})} \right). </span>
<span id="cb66-3792"><a href="#cb66-3792" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3793"><a href="#cb66-3793" aria-hidden="true" tabindex="-1"></a>Focusing on term $(\mathrm{A})$, we easily find that</span>
<span id="cb66-3794"><a href="#cb66-3794" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3795"><a href="#cb66-3795" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb66-3796"><a href="#cb66-3796" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">(\mathrm{A}) |X</span><span class="co">]</span> &amp;= \bbE\left<span class="co">[</span><span class="ot">\frac{A}{p(X)}(T^*_{\mathrm{DR}}(F,R)-\nu(X,1))+ \nu(X,1) \middle|X\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb66-3797"><a href="#cb66-3797" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{e(X)}{p(X)}(\mu(X,1)-\nu(X,1)) + \nu(X,1).</span>
<span id="cb66-3798"><a href="#cb66-3798" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb66-3799"><a href="#cb66-3799" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3800"><a href="#cb66-3800" aria-hidden="true" tabindex="-1"></a>Where we used that $T^*_{\mathrm{DR}}(F,R)$ is a censoring unbiased transform when $F=G$ or $R=S$. Now we see that if $p(X) = e(X)$, then </span>
<span id="cb66-3801"><a href="#cb66-3801" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3802"><a href="#cb66-3802" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">(\mathrm{A}) |X</span><span class="co">]</span> = \mu(X,1)-\nu(X,1) + \nu(X,1) = \mu(X,1),</span>
<span id="cb66-3803"><a href="#cb66-3803" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3804"><a href="#cb66-3804" aria-hidden="true" tabindex="-1"></a>and if $\nu(X,1) = \mu(X,1)$, then</span>
<span id="cb66-3805"><a href="#cb66-3805" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3806"><a href="#cb66-3806" aria-hidden="true" tabindex="-1"></a>\bbE<span class="co">[</span><span class="ot">(\mathrm{A}) |X</span><span class="co">]</span> = \frac{e(X)}{p(X)} \times 0 + \mu(X,1) = \mu(X,1).</span>
<span id="cb66-3807"><a href="#cb66-3807" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb66-3808"><a href="#cb66-3808" aria-hidden="true" tabindex="-1"></a>Likewise, we would show that $\bbE<span class="co">[</span><span class="ot">(\mathrm{B}) |X</span><span class="co">]</span> = \mu(X,0)$ under either alternative, ending the proof. </span>
<span id="cb66-3809"><a href="#cb66-3809" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-3810"><a href="#cb66-3810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3811"><a href="#cb66-3811" aria-hidden="true" tabindex="-1"></a><span class="fu"># Appendix B: Descriptive statistics {.appendix}</span></span>
<span id="cb66-3812"><a href="#cb66-3812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3813"><a href="#cb66-3813" aria-hidden="true" tabindex="-1"></a><span class="fu">## RCT {#sec-stat_RCT}</span></span>
<span id="cb66-3814"><a href="#cb66-3814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3815"><a href="#cb66-3815" aria-hidden="true" tabindex="-1"></a>The summary by group of treatment of the generated (observed and</span>
<span id="cb66-3816"><a href="#cb66-3816" aria-hidden="true" tabindex="-1"></a>unobserved) RCT with independent censoring is displayed below:</span>
<span id="cb66-3817"><a href="#cb66-3817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3818"><a href="#cb66-3818" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3819"><a href="#cb66-3819" aria-hidden="true" tabindex="-1"></a><span class="in"># data_rct1 simulate the data from RCT with independent censoring </span></span>
<span id="cb66-3820"><a href="#cb66-3820" aria-hidden="true" tabindex="-1"></a><span class="in">data_rct1 &lt;- simulate_data_RCT(n=2000,</span></span>
<span id="cb66-3821"><a href="#cb66-3821" aria-hidden="true" tabindex="-1"></a><span class="in">                               tau=25,</span></span>
<span id="cb66-3822"><a href="#cb66-3822" aria-hidden="true" tabindex="-1"></a><span class="in">                               scenario="RCT1",</span></span>
<span id="cb66-3823"><a href="#cb66-3823" aria-hidden="true" tabindex="-1"></a><span class="in">                               coefC = 0.03)</span></span>
<span id="cb66-3824"><a href="#cb66-3824" aria-hidden="true" tabindex="-1"></a><span class="in"># Stratification by treatment </span></span>
<span id="cb66-3825"><a href="#cb66-3825" aria-hidden="true" tabindex="-1"></a><span class="in">group_0 &lt;- data_rct1 %&gt;%</span></span>
<span id="cb66-3826"><a href="#cb66-3826" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 0)%&gt;%</span></span>
<span id="cb66-3827"><a href="#cb66-3827" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,T_tild=T_obs)</span></span>
<span id="cb66-3828"><a href="#cb66-3828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3829"><a href="#cb66-3829" aria-hidden="true" tabindex="-1"></a><span class="in">group_1 &lt;- data_rct1 %&gt;%</span></span>
<span id="cb66-3830"><a href="#cb66-3830" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 1)%&gt;%</span></span>
<span id="cb66-3831"><a href="#cb66-3831" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,T_tild=T_obs)</span></span>
<span id="cb66-3832"><a href="#cb66-3832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3833"><a href="#cb66-3833" aria-hidden="true" tabindex="-1"></a><span class="in"># Summary statistics</span></span>
<span id="cb66-3834"><a href="#cb66-3834" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_0 &lt;- summary(group_0)</span></span>
<span id="cb66-3835"><a href="#cb66-3835" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_1 &lt;- summary(group_1)</span></span>
<span id="cb66-3836"><a href="#cb66-3836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3837"><a href="#cb66-3837" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=0:  ",nrow(group_0)))</span></span>
<span id="cb66-3838"><a href="#cb66-3838" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_0)</span></span>
<span id="cb66-3839"><a href="#cb66-3839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3840"><a href="#cb66-3840" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=1:  ",nrow(group_1)))</span></span>
<span id="cb66-3841"><a href="#cb66-3841" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_1)</span></span>
<span id="cb66-3842"><a href="#cb66-3842" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3843"><a href="#cb66-3843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3844"><a href="#cb66-3844" aria-hidden="true" tabindex="-1"></a>Covariates are balanced between groups, and censoring times are the same</span>
<span id="cb66-3845"><a href="#cb66-3845" aria-hidden="true" tabindex="-1"></a>(independent censoring). However, there are more censored observations</span>
<span id="cb66-3846"><a href="#cb66-3846" aria-hidden="true" tabindex="-1"></a>in the treated group ($A=1$) than in the control group ($A=0$). This is</span>
<span id="cb66-3847"><a href="#cb66-3847" aria-hidden="true" tabindex="-1"></a>due to the higher instantaneous hazard of the event in the treated group</span>
<span id="cb66-3848"><a href="#cb66-3848" aria-hidden="true" tabindex="-1"></a>(with $T_1=T_0+10$) compared to the constant hazard of censoring.</span>
<span id="cb66-3849"><a href="#cb66-3849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3850"><a href="#cb66-3850" aria-hidden="true" tabindex="-1"></a>The summary of the generated (observed and unobserved)  RCT with</span>
<span id="cb66-3851"><a href="#cb66-3851" aria-hidden="true" tabindex="-1"></a>conditionally independent censoring stratified</span>
<span id="cb66-3852"><a href="#cb66-3852" aria-hidden="true" tabindex="-1"></a>by treatment is displayed below.</span>
<span id="cb66-3853"><a href="#cb66-3853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3854"><a href="#cb66-3854" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3855"><a href="#cb66-3855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3856"><a href="#cb66-3856" aria-hidden="true" tabindex="-1"></a><span class="in"># data_rct2 simulate the data from RCT with dependent censoring </span></span>
<span id="cb66-3857"><a href="#cb66-3857" aria-hidden="true" tabindex="-1"></a><span class="in">data_rct2 &lt;- simulate_data_RCT(n=2000,</span></span>
<span id="cb66-3858"><a href="#cb66-3858" aria-hidden="true" tabindex="-1"></a><span class="in">                               tau=25,</span></span>
<span id="cb66-3859"><a href="#cb66-3859" aria-hidden="true" tabindex="-1"></a><span class="in">                               scenario="RCT2", </span></span>
<span id="cb66-3860"><a href="#cb66-3860" aria-hidden="true" tabindex="-1"></a><span class="in">                               coefC = 0.03, </span></span>
<span id="cb66-3861"><a href="#cb66-3861" aria-hidden="true" tabindex="-1"></a><span class="in">                               parsC = c(0.7,0.3,-0.25,-0.1),</span></span>
<span id="cb66-3862"><a href="#cb66-3862" aria-hidden="true" tabindex="-1"></a><span class="in">                               parsC_A = c(-0.2))</span></span>
<span id="cb66-3863"><a href="#cb66-3863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3864"><a href="#cb66-3864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3865"><a href="#cb66-3865" aria-hidden="true" tabindex="-1"></a><span class="in"># Stratification by treatment </span></span>
<span id="cb66-3866"><a href="#cb66-3866" aria-hidden="true" tabindex="-1"></a><span class="in">group_0 &lt;- data_rct2 %&gt;%</span></span>
<span id="cb66-3867"><a href="#cb66-3867" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 0)%&gt;%</span></span>
<span id="cb66-3868"><a href="#cb66-3868" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,status_tau,T_tild=T_obs)</span></span>
<span id="cb66-3869"><a href="#cb66-3869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3870"><a href="#cb66-3870" aria-hidden="true" tabindex="-1"></a><span class="in">group_1 &lt;- data_rct2 %&gt;%</span></span>
<span id="cb66-3871"><a href="#cb66-3871" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 1)%&gt;%</span></span>
<span id="cb66-3872"><a href="#cb66-3872" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,status_tau,T_tild=T_obs)</span></span>
<span id="cb66-3873"><a href="#cb66-3873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3874"><a href="#cb66-3874" aria-hidden="true" tabindex="-1"></a><span class="in"># Summary statistics</span></span>
<span id="cb66-3875"><a href="#cb66-3875" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_0 &lt;- summary(group_0)</span></span>
<span id="cb66-3876"><a href="#cb66-3876" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_1 &lt;- summary(group_1)</span></span>
<span id="cb66-3877"><a href="#cb66-3877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3878"><a href="#cb66-3878" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=0:  ",nrow(group_0)))</span></span>
<span id="cb66-3879"><a href="#cb66-3879" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_0)</span></span>
<span id="cb66-3880"><a href="#cb66-3880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3881"><a href="#cb66-3881" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=1:  ",nrow(group_1)))</span></span>
<span id="cb66-3882"><a href="#cb66-3882" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_1)</span></span>
<span id="cb66-3883"><a href="#cb66-3883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3884"><a href="#cb66-3884" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3885"><a href="#cb66-3885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3886"><a href="#cb66-3886" aria-hidden="true" tabindex="-1"></a>Covariates are balanced between the two groups. However, censoring times</span>
<span id="cb66-3887"><a href="#cb66-3887" aria-hidden="true" tabindex="-1"></a>differ between groups due to conditionally independent censoring based</span>
<span id="cb66-3888"><a href="#cb66-3888" aria-hidden="true" tabindex="-1"></a>on covariates and treatment group. Indeed, the distribution of $C$ is different between the treatment group. </span>
<span id="cb66-3889"><a href="#cb66-3889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3890"><a href="#cb66-3890" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observational study with linear relationship {#sec-stat_obs}</span></span>
<span id="cb66-3891"><a href="#cb66-3891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3892"><a href="#cb66-3892" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3893"><a href="#cb66-3893" aria-hidden="true" tabindex="-1"></a><span class="in"># Observational data with no informative censoring</span></span>
<span id="cb66-3894"><a href="#cb66-3894" aria-hidden="true" tabindex="-1"></a><span class="in">data_obs1 &lt;- simulate_data_obs(n = 2000, tau = 25, scenario = "Obs1")</span></span>
<span id="cb66-3895"><a href="#cb66-3895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3896"><a href="#cb66-3896" aria-hidden="true" tabindex="-1"></a><span class="in"># Observational data simulation with dependent censoring</span></span>
<span id="cb66-3897"><a href="#cb66-3897" aria-hidden="true" tabindex="-1"></a><span class="in">data_obs2 &lt;- simulate_data_obs(n = 2000, tau = 25, scenario = "Obs2", </span></span>
<span id="cb66-3898"><a href="#cb66-3898" aria-hidden="true" tabindex="-1"></a><span class="in">                               coefC = 0.03, parsC = c(0.7,0.3,-0.25,-0.1))</span></span>
<span id="cb66-3899"><a href="#cb66-3899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3900"><a href="#cb66-3900" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3901"><a href="#cb66-3901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3902"><a href="#cb66-3902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3903"><a href="#cb66-3903" aria-hidden="true" tabindex="-1"></a>The summary of the generated (observed and unobserved) data set</span>
<span id="cb66-3904"><a href="#cb66-3904" aria-hidden="true" tabindex="-1"></a>observational study with independent censoring </span>
<span id="cb66-3905"><a href="#cb66-3905" aria-hidden="true" tabindex="-1"></a>stratified by treatment is displayed below to enhance the difference</span>
<span id="cb66-3906"><a href="#cb66-3906" aria-hidden="true" tabindex="-1"></a>with the other scenario.</span>
<span id="cb66-3907"><a href="#cb66-3907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3908"><a href="#cb66-3908" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3909"><a href="#cb66-3909" aria-hidden="true" tabindex="-1"></a><span class="in"># Stratification by treatment </span></span>
<span id="cb66-3910"><a href="#cb66-3910" aria-hidden="true" tabindex="-1"></a><span class="in">group_0 &lt;- data_obs1 %&gt;%</span></span>
<span id="cb66-3911"><a href="#cb66-3911" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 0)%&gt;%</span></span>
<span id="cb66-3912"><a href="#cb66-3912" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,T_tild=T_obs)</span></span>
<span id="cb66-3913"><a href="#cb66-3913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3914"><a href="#cb66-3914" aria-hidden="true" tabindex="-1"></a><span class="in">group_1 &lt;- data_obs1 %&gt;%</span></span>
<span id="cb66-3915"><a href="#cb66-3915" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 1)%&gt;%</span></span>
<span id="cb66-3916"><a href="#cb66-3916" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,T_tild=T_obs)</span></span>
<span id="cb66-3917"><a href="#cb66-3917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3918"><a href="#cb66-3918" aria-hidden="true" tabindex="-1"></a><span class="in"># Summary statistics</span></span>
<span id="cb66-3919"><a href="#cb66-3919" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_0 &lt;- summary(group_0)</span></span>
<span id="cb66-3920"><a href="#cb66-3920" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_1 &lt;- summary(group_1)</span></span>
<span id="cb66-3921"><a href="#cb66-3921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3922"><a href="#cb66-3922" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=0:  ",nrow(group_0)))</span></span>
<span id="cb66-3923"><a href="#cb66-3923" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_0)</span></span>
<span id="cb66-3924"><a href="#cb66-3924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3925"><a href="#cb66-3925" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=1:  ",nrow(group_1)))</span></span>
<span id="cb66-3926"><a href="#cb66-3926" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_1)</span></span>
<span id="cb66-3927"><a href="#cb66-3927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3928"><a href="#cb66-3928" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3929"><a href="#cb66-3929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3930"><a href="#cb66-3930" aria-hidden="true" tabindex="-1"></a>The covariates between the two groups of treatment are unbalanced</span>
<span id="cb66-3931"><a href="#cb66-3931" aria-hidden="true" tabindex="-1"></a>because of dependent treatment assignation. The mean of $X1$, $X2$, $X3$</span>
<span id="cb66-3932"><a href="#cb66-3932" aria-hidden="true" tabindex="-1"></a>and $X4$ is bigger in the control group than in the treated group. The</span>
<span id="cb66-3933"><a href="#cb66-3933" aria-hidden="true" tabindex="-1"></a>censoring times have the same distribution (independent censoring).</span>
<span id="cb66-3934"><a href="#cb66-3934" aria-hidden="true" tabindex="-1"></a>There are more censored observation in the treated group (A=1) than in</span>
<span id="cb66-3935"><a href="#cb66-3935" aria-hidden="true" tabindex="-1"></a>the control group (A=0) for the same reason than in the RCT scenario.</span>
<span id="cb66-3936"><a href="#cb66-3936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3937"><a href="#cb66-3937" aria-hidden="true" tabindex="-1"></a>The summary of the generated (observed and unobserved) data set</span>
<span id="cb66-3938"><a href="#cb66-3938" aria-hidden="true" tabindex="-1"></a>observational study with conditionally independent censoring stratified by treatment is displayed below.</span>
<span id="cb66-3939"><a href="#cb66-3939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3940"><a href="#cb66-3940" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-3941"><a href="#cb66-3941" aria-hidden="true" tabindex="-1"></a><span class="in"># Stratification by treatment </span></span>
<span id="cb66-3942"><a href="#cb66-3942" aria-hidden="true" tabindex="-1"></a><span class="in">group_0 &lt;- data_obs2 %&gt;%</span></span>
<span id="cb66-3943"><a href="#cb66-3943" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 0)%&gt;%</span></span>
<span id="cb66-3944"><a href="#cb66-3944" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,status_tau,T_obs,e)</span></span>
<span id="cb66-3945"><a href="#cb66-3945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3946"><a href="#cb66-3946" aria-hidden="true" tabindex="-1"></a><span class="in">group_1 &lt;- data_obs2 %&gt;%</span></span>
<span id="cb66-3947"><a href="#cb66-3947" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 1)%&gt;%</span></span>
<span id="cb66-3948"><a href="#cb66-3948" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,X4,C,T1,T0,status,status_tau,T_obs,e)</span></span>
<span id="cb66-3949"><a href="#cb66-3949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3950"><a href="#cb66-3950" aria-hidden="true" tabindex="-1"></a><span class="in"># Summary statistics</span></span>
<span id="cb66-3951"><a href="#cb66-3951" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_0 &lt;- summary(group_0)</span></span>
<span id="cb66-3952"><a href="#cb66-3952" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_1 &lt;- summary(group_1)</span></span>
<span id="cb66-3953"><a href="#cb66-3953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3954"><a href="#cb66-3954" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=0:  ",nrow(group_0)))</span></span>
<span id="cb66-3955"><a href="#cb66-3955" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_0)</span></span>
<span id="cb66-3956"><a href="#cb66-3956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3957"><a href="#cb66-3957" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=1:  ",nrow(group_1)))</span></span>
<span id="cb66-3958"><a href="#cb66-3958" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_1)</span></span>
<span id="cb66-3959"><a href="#cb66-3959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3960"><a href="#cb66-3960" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-3961"><a href="#cb66-3961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3962"><a href="#cb66-3962" aria-hidden="true" tabindex="-1"></a>The covariates between the two groups are unbalanced. The censoring time</span>
<span id="cb66-3963"><a href="#cb66-3963" aria-hidden="true" tabindex="-1"></a>is dependent on the covariates also, as the covariates are unbalanced</span>
<span id="cb66-3964"><a href="#cb66-3964" aria-hidden="true" tabindex="-1"></a>between the two groups, the censoring time is also unbalanced. In</span>
<span id="cb66-3965"><a href="#cb66-3965" aria-hidden="true" tabindex="-1"></a>particular, the mean of $X1$, $X2$, $X3$ and $X4$ is bigger in the</span>
<span id="cb66-3966"><a href="#cb66-3966" aria-hidden="true" tabindex="-1"></a>control group than in the treated group. Also, the number of events is</span>
<span id="cb66-3967"><a href="#cb66-3967" aria-hidden="true" tabindex="-1"></a>bigger in the control than treated group.</span>
<span id="cb66-3968"><a href="#cb66-3968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3969"><a href="#cb66-3969" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Observational study with non-linear relationship {#sec-stat_complex} --&gt;</span></span>
<span id="cb66-3970"><a href="#cb66-3970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3971"><a href="#cb66-3971" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r, message=FALSE, warning=FALSE} --&gt;</span></span>
<span id="cb66-3972"><a href="#cb66-3972" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- complex &lt;- simulate_data_complex(n=2000,tau=2) --&gt;</span></span>
<span id="cb66-3973"><a href="#cb66-3973" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb66-3974"><a href="#cb66-3974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3975"><a href="#cb66-3975" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The summary of the generated (observed and unobserved) data set --&gt;</span></span>
<span id="cb66-3976"><a href="#cb66-3976" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- observational study with nonlinear relationships and conditionally --&gt;</span></span>
<span id="cb66-3977"><a href="#cb66-3977" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- independent censoring, stratified by treatment is displayed below. --&gt;</span></span>
<span id="cb66-3978"><a href="#cb66-3978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3979"><a href="#cb66-3979" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} --&gt;</span></span>
<span id="cb66-3980"><a href="#cb66-3980" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Stratification by treatment  --&gt;</span></span>
<span id="cb66-3981"><a href="#cb66-3981" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- group_0 &lt;- complex %&gt;% --&gt;</span></span>
<span id="cb66-3982"><a href="#cb66-3982" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   dplyr:: filter(A == 0)%&gt;% --&gt;</span></span>
<span id="cb66-3983"><a href="#cb66-3983" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   dplyr:: select(X1,X2,X3,C,T1,T0,status,T_obs,status_tau,e) --&gt;</span></span>
<span id="cb66-3984"><a href="#cb66-3984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3985"><a href="#cb66-3985" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- group_1 &lt;- complex %&gt;% --&gt;</span></span>
<span id="cb66-3986"><a href="#cb66-3986" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   dplyr:: filter(A == 1)%&gt;% --&gt;</span></span>
<span id="cb66-3987"><a href="#cb66-3987" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   dplyr:: select(X1,X2,X3,C,T1,T0,status,T_obs,status_tau,e) --&gt;</span></span>
<span id="cb66-3988"><a href="#cb66-3988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3989"><a href="#cb66-3989" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Summary statistics --&gt;</span></span>
<span id="cb66-3990"><a href="#cb66-3990" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- summary_group_0 &lt;- summary(group_0) --&gt;</span></span>
<span id="cb66-3991"><a href="#cb66-3991" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- summary_group_1 &lt;- summary(group_1) --&gt;</span></span>
<span id="cb66-3992"><a href="#cb66-3992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3993"><a href="#cb66-3993" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(paste("Descriptive statistics for group A=0:  ",nrow(group_0))) --&gt;</span></span>
<span id="cb66-3994"><a href="#cb66-3994" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(summary_group_0) --&gt;</span></span>
<span id="cb66-3995"><a href="#cb66-3995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3996"><a href="#cb66-3996" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(paste("Descriptive statistics for group A=1:  ",nrow(group_1))) --&gt;</span></span>
<span id="cb66-3997"><a href="#cb66-3997" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(summary_group_1) --&gt;</span></span>
<span id="cb66-3998"><a href="#cb66-3998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3999"><a href="#cb66-3999" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb66-4000"><a href="#cb66-4000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4001"><a href="#cb66-4001" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The observations are the same than the previous scenario: The covariates --&gt;</span></span>
<span id="cb66-4002"><a href="#cb66-4002" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- and the censoring time between the two groups are unbalanced. --&gt;</span></span>
<span id="cb66-4003"><a href="#cb66-4003" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- To be able to evaluate the estimators, we need to know the true --&gt;</span></span>
<span id="cb66-4004"><a href="#cb66-4004" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $\theta_{\mathrm{RMST}}$ at time $\tau$. --&gt;</span></span>
<span id="cb66-4005"><a href="#cb66-4005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4006"><a href="#cb66-4006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4007"><a href="#cb66-4007" aria-hidden="true" tabindex="-1"></a><span class="fu">## Observational study with interaction {#sec-stat_inter}</span></span>
<span id="cb66-4008"><a href="#cb66-4008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4009"><a href="#cb66-4009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4010"><a href="#cb66-4010" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-4011"><a href="#cb66-4011" aria-hidden="true" tabindex="-1"></a><span class="in">mis &lt;- simulate_data_mis(n=2000,tau=0.5)</span></span>
<span id="cb66-4012"><a href="#cb66-4012" aria-hidden="true" tabindex="-1"></a><span class="in">summary(mis)</span></span>
<span id="cb66-4013"><a href="#cb66-4013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-4014"><a href="#cb66-4014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4015"><a href="#cb66-4015" aria-hidden="true" tabindex="-1"></a>The summary of the generated (observed and unobserved) data set complex</span>
<span id="cb66-4016"><a href="#cb66-4016" aria-hidden="true" tabindex="-1"></a>observational study (conditionally independent censoring) stratified by</span>
<span id="cb66-4017"><a href="#cb66-4017" aria-hidden="true" tabindex="-1"></a>treatment is displayed below.</span>
<span id="cb66-4018"><a href="#cb66-4018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4019"><a href="#cb66-4019" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb66-4020"><a href="#cb66-4020" aria-hidden="true" tabindex="-1"></a><span class="in"># Stratification by treatment </span></span>
<span id="cb66-4021"><a href="#cb66-4021" aria-hidden="true" tabindex="-1"></a><span class="in">group_0 &lt;- mis %&gt;%</span></span>
<span id="cb66-4022"><a href="#cb66-4022" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 0)%&gt;%</span></span>
<span id="cb66-4023"><a href="#cb66-4023" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,C,T1,T0,status,T_obs,status_tau,e)</span></span>
<span id="cb66-4024"><a href="#cb66-4024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4025"><a href="#cb66-4025" aria-hidden="true" tabindex="-1"></a><span class="in">group_1 &lt;- mis %&gt;%</span></span>
<span id="cb66-4026"><a href="#cb66-4026" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: filter(A == 1)%&gt;%</span></span>
<span id="cb66-4027"><a href="#cb66-4027" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr:: select(X1,X2,X3,C,T1,T0,status,T_obs,status_tau,e)</span></span>
<span id="cb66-4028"><a href="#cb66-4028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4029"><a href="#cb66-4029" aria-hidden="true" tabindex="-1"></a><span class="in"># Summary statistics</span></span>
<span id="cb66-4030"><a href="#cb66-4030" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_0 &lt;- summary(group_0)</span></span>
<span id="cb66-4031"><a href="#cb66-4031" aria-hidden="true" tabindex="-1"></a><span class="in">summary_group_1 &lt;- summary(group_1)</span></span>
<span id="cb66-4032"><a href="#cb66-4032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4033"><a href="#cb66-4033" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=0:  ",nrow(group_0)))</span></span>
<span id="cb66-4034"><a href="#cb66-4034" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_0)</span></span>
<span id="cb66-4035"><a href="#cb66-4035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4036"><a href="#cb66-4036" aria-hidden="true" tabindex="-1"></a><span class="in">print(paste("Descriptive statistics for group A=1:  ",nrow(group_1)))</span></span>
<span id="cb66-4037"><a href="#cb66-4037" aria-hidden="true" tabindex="-1"></a><span class="in">print(summary_group_1)</span></span>
<span id="cb66-4038"><a href="#cb66-4038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4039"><a href="#cb66-4039" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-4040"><a href="#cb66-4040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4041"><a href="#cb66-4041" aria-hidden="true" tabindex="-1"></a>The observations are the same than the previous scenario: The covariates</span>
<span id="cb66-4042"><a href="#cb66-4042" aria-hidden="true" tabindex="-1"></a>and the censoring time between the two groups are unbalanced.</span>
<span id="cb66-4043"><a href="#cb66-4043" aria-hidden="true" tabindex="-1"></a>To be able to evaluate the estimators, we need to know the true</span>
<span id="cb66-4044"><a href="#cb66-4044" aria-hidden="true" tabindex="-1"></a>$\theta_{\mathrm{RMST}}$ at time $\tau$.</span>
<span id="cb66-4045"><a href="#cb66-4045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4046"><a href="#cb66-4046" aria-hidden="true" tabindex="-1"></a><span class="fu"># Session information {.appendix .unnumbered}</span></span>
<span id="cb66-4047"><a href="#cb66-4047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4048"><a href="#cb66-4048" aria-hidden="true" tabindex="-1"></a><span class="in">```{r session-info}</span></span>
<span id="cb66-4049"><a href="#cb66-4049" aria-hidden="true" tabindex="-1"></a><span class="in">sessionInfo()</span></span>
<span id="cb66-4050"><a href="#cb66-4050" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize || "1.2em",
          commentDelimiter: el.dataset.commentDelimiter || "//",
          lineNumber: el.dataset.lineNumber === "true" ? true : false,
          lineNumberPunc: el.dataset.lineNumberPunc || ":",
          noEnd: el.dataset.noEnd === "true" ? true : false,
          titlePrefix: el.dataset.captionPrefix || "Algorithm"
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  




</body></html>